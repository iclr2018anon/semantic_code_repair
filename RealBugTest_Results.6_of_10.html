<html><head><style>
.ast { font-family: monospace; font-size: 12pt; }
.correct_node { font-weight: bold; background-color: green; color: white; }
.incorrect_node { font-weight: bold; background-color: red; color: white; }
.ref_node { font-weight: bold; background-color: blue; color: white; }
.location_node { font-weight: bold; background-color: #ff00ff; color: white; }
.other_trans { color: #3333ff; }
.whitespace { background-color: white; color: black; }
.pred_rank_wrapper { font-weight: bold; }
.correct_pred_rank { font-weight: bold; color: green;}
.incorrect_pred_rank { font-weight: bold; color: red; }
.rank_type { font-weight: bold; }
.description { font-size: 16pt; }
</style></head><body><div class="description">
<div><b>This is part 7/10 of the system predictions for the Real-Bug Test set. This system achieves 41% Repair Accuracy and 54% Location Accuracy.</b></div><br /><div><b>Annotations</b>:</div><ul><li><span class="correct_node">foo &rarr; bar</span> - The bug was located at this node, and the system <i>correctly</i> predicted both the location and the repair as its top prediction.</li><li><span class="incorrect_node">foo &rarr; bar</span> - The system <i>incorrectly</i> predicted this repair as its top prediction.</li><li><span class="ref_node">foo &rarr; bar</span> - If the system incorrectly predicted the repair, this was the correct repair it should have made.</li><li><span class="location_node">foo &rarr; bar, pred: zap</span> - The system predicted the correct <i>location</i> of the repair, but the wrong repair label. It should have predicted 'bar', but it predicted 'zap' instead.</li></ul><div>The part before the arrow ('foo') is what the system actually saw at test time. Other candidate repair locations which the system could have chosen are marked in <span class="other_trans">this color</span>. For clarity the actual labels for those locations are not shown.</div></div><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_random_image(<span id="ast-2"><span id="ast-3" class="other_trans">n</span>,&nbsp;<span id="ast-5">delete</span>,&nbsp;<span id="ast-7" class="other_trans">verbose</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;a&nbsp;random&nbsp;image,&nbsp;which&nbsp;hasn't&nbsp;been&nbsp;used&nbsp;more&nbsp;than&nbsp;n&nbsp;times.&nbsp;Usages&nbsp;are\\u000a&nbsp;&nbsp;&nbsp;&nbsp;stored&nbsp;on&nbsp;disk.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;delete=True,&nbsp;delete&nbsp;files&nbsp;that&nbsp;have&nbsp;been&nbsp;used&nbsp;more&nbsp;than&nbsp;n&nbsp;times.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;the&nbsp;file&nbsp;path,&nbsp;or&nbsp;None&nbsp;if&nbsp;no&nbsp;files&nbsp;could&nbsp;be&nbsp;found.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12" class="other_trans">verbose</span>:<span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-14">(<span id="ast-15">'Max&nbsp;usage:'</span>,&nbsp;<span id="ast-16" class="other_trans">n</span>)</span></span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>usages</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20">defaultdict</span>(<span id="ast-21" class="other_trans">int</span>)</span></span><span id="ast-22"><span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.makedirs</span>(<span id="ast-26" class="other_trans">IMG_CACHE</span>,&nbsp;exist_ok=<span id="ast-28">True</span>)</span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33">os</span>.path</span>.exists</span>(<span id="ast-34">USAGES_FILE</span>)</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">open</span>(<span id="ast-38" class="other_trans">USAGES_FILE</span>,&nbsp;<span id="ast-39">'r'</span>)</span>&nbsp;as&nbsp;<span id="ast-40" class="other_trans">f</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-42" class="other_trans">line</span>&nbsp;in&nbsp;<span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans">f</span>.read</span>()</span>.splitlines</span>()</span>:<span id="ast-48"><span id="ast-49"><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>usages</span>.update</span>(<span id="ast-52">{<span id="ast-53" class="other_trans">img</span>:&nbsp;<span id="ast-54"><span id="ast-55">int</span>(<span id="ast-56">uses</span>)</span><span id="ast-57">&nbsp;for&nbsp;<span id="ast-58">(<span id="ast-59" class="other_trans">img</span>,&nbsp;<span id="ast-60" class="other_trans">uses</span>)</span>&nbsp;in&nbsp;<span id="ast-61">[<span id="ast-62"><span id="ast-63"><span id="ast-64" class="other_trans">line</span>.split</span>()</span>]</span></span>}</span>)</span></span></span></span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66" class="other_trans">verbose</span>:<span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-68">(<span id="ast-69">'Usages:'</span>,&nbsp;<span id="ast-70" class="other_trans">usages</span>)</span></span></span><span id="ast-71"><span id="ast-72" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>files</span>&nbsp;=&nbsp;<span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans">os</span>.listdir</span>(<span id="ast-76" class="other_trans">IMG_CACHE</span>)</span></span><span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>usable_files</span>&nbsp;=&nbsp;<span id="ast-79">{<span id="ast-80" class="other_trans">f</span><span id="ast-81">&nbsp;for&nbsp;<span id="ast-82" class="other_trans">f</span>&nbsp;in&nbsp;<span id="ast-83" class="other_trans">files</span>&nbsp;if&nbsp;<span id="ast-84">(<span id="ast-85"><span id="ast-86">usages</span>[<span id="ast-87"><span id="ast-88" class="other_trans">f</span></span>]</span><span id="ast-89" class="location_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-90" class="other_trans">n</span>)</span></span>}</span></span><span id="ast-91"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-92" class="other_trans">verbose</span>:<span id="ast-93"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-94">(<span id="ast-95">'Usable&nbsp;files:'</span>,&nbsp;<span id="ast-96">usable_files</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;match_rating_comparison(<span id="ast-2"><span id="ast-3">s1</span>,&nbsp;<span id="ast-4" class="other_trans">s2</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>codex1</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8">match_rating_codex</span>(<span id="ast-9" class="other_trans">s1</span>)</span></span><span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>codex2</span>&nbsp;=&nbsp;<span id="ast-12"><span id="ast-13">match_rating_codex</span>(<span id="ast-14">s2</span>)</span></span><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>len1</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18">len</span>(<span id="ast-19">codex1</span>)</span></span><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>len2</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23">len</span>(<span id="ast-24" class="other_trans">codex2</span>)</span></span><span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>res1</span>&nbsp;=&nbsp;<span id="ast-27">[]</span></span><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>res2</span>&nbsp;=&nbsp;<span id="ast-30">[]</span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-32">(<span id="ast-33"><span id="ast-34">abs</span>(<span id="ast-35">(<span id="ast-36" class="other_trans">len1</span>&nbsp;-&nbsp;<span id="ast-38">len2</span>)</span>)</span><span id="ast-39" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-40">3</span>)</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-42">None</span></span></span><span id="ast-43"><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>lensum</span>&nbsp;=&nbsp;<span id="ast-45">(<span id="ast-46">len1</span>&nbsp;+&nbsp;<span id="ast-48" class="other_trans">len2</span>)</span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-50">(<span id="ast-51">lensum</span><span id="ast-52" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-53">4</span>)</span>:<span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>min_rating</span>&nbsp;=&nbsp;<span id="ast-56">5</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-58">(<span id="ast-59" class="other_trans">lensum</span><span id="ast-60" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-61">7</span>)</span>:<span id="ast-62"><span id="ast-63" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>min_rating</span>&nbsp;=&nbsp;<span id="ast-64">4</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-66">(<span id="ast-67" class="other_trans">lensum</span><span id="ast-68" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-69">11</span>)</span>:<span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>min_rating</span>&nbsp;=&nbsp;<span id="ast-72">3</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-73"><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>min_rating</span>&nbsp;=&nbsp;<span id="ast-75">2</span></span></span><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-77">(<span id="ast-78" class="other_trans">c1</span>,&nbsp;<span id="ast-79" class="other_trans">c2</span>)</span>&nbsp;in&nbsp;<span id="ast-80"><span id="ast-81">_zip_longest</span>(<span id="ast-82" class="other_trans">codex1</span>,&nbsp;<span id="ast-83" class="other_trans">codex2</span>)</span>:<span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-85">(<span id="ast-86" class="other_trans">c1</span><span id="ast-87" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-88" class="other_trans">c2</span>)</span>:<span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-90">c1</span>:<span id="ast-91"><span id="ast-92"><span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>res1</span>.append</span>(<span id="ast-95" class="other_trans">c1</span>)</span></span></span><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-97">c2</span>:<span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>res2</span>.append</span>(<span id="ast-102">c2</span>)</span></span></span></span></span><span id="ast-103"><span id="ast-104"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>unmatched_count1</span>,&nbsp;<span id="ast-105">unmatched_count2</span>&nbsp;=&nbsp;<span id="ast-106">0</span></span><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-108">(<span id="ast-109">c1</span>,&nbsp;<span id="ast-110" class="other_trans">c2</span>)</span>&nbsp;in&nbsp;<span id="ast-111"><span id="ast-112">_zip_longest</span>(<span id="ast-113"><span id="ast-114" class="other_trans">reversed</span>(<span id="ast-115">res1</span>)</span>,&nbsp;<span id="ast-116"><span id="ast-117">reversed</span>(<span id="ast-118">res2</span>)</span>)</span>:<span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-120">(<span id="ast-121" class="other_trans">c1</span><span id="ast-122" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-123">c2</span>)</span>:<span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-125" class="other_trans">c1</span>:<span id="ast-126"><span id="ast-127" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>unmatched_count1</span>&nbsp;+=&nbsp;<span id="ast-129">1</span></span></span><span id="ast-130"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-131">c2</span>:<span id="ast-132"><span id="ast-133" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>unmatched_count2</span>&nbsp;+=&nbsp;<span id="ast-135">1</span></span></span></span></span><span id="ast-136"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-137">(<span id="ast-138">(<span id="ast-139">6</span>&nbsp;-&nbsp;<span id="ast-141"><span id="ast-142">max</span>(<span id="ast-143" class="other_trans">unmatched_count1</span>,&nbsp;<span id="ast-144">unmatched_count2</span>)</span>)</span><span id="ast-145" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-146" class="other_trans">min_rating</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;write_oplog_progress(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6"><span id="ast-7">self</span>.oplog_checkpoint</span><span id="ast-8" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-9" class="other_trans">None</span>)</span>:<span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-11" class="other_trans">None</span></span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ofile</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15" class="other_trans">file</span>(<span id="ast-16"><span id="ast-17">self</span>.oplog_checkpoint</span>,&nbsp;<span id="ast-18">'r+'</span>)</span></span><span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.rename</span>(<span id="ast-23"><span id="ast-24">self</span>.oplog_checkpoint</span>,&nbsp;<span id="ast-25">(<span id="ast-26"><span id="ast-27">self</span>.oplog_checkpoint</span>&nbsp;+&nbsp;<span id="ast-29">'~'</span>)</span>)</span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dest</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33" class="other_trans">open</span>(<span id="ast-34"><span id="ast-35">self</span>.oplog_checkpoint</span>,&nbsp;<span id="ast-36">'w'</span>)</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>source</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40" class="other_trans">open</span>(<span id="ast-41">(<span id="ast-42"><span id="ast-43">self</span>.oplog_checkpoint</span>&nbsp;+&nbsp;<span id="ast-45">'~'</span>)</span>,&nbsp;<span id="ast-46">'r'</span>)</span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-48">(<span id="ast-49" class="other_trans">oplog</span>,&nbsp;<span id="ast-50" class="incorrect_node">ts&nbsp;&rarr;&nbsp;oplog&nbsp;</span>)</span>&nbsp;in&nbsp;<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54">self</span>.oplog_progress_dict</span>.items</span>()</span>:<span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>oplog_str</span>&nbsp;=&nbsp;<span id="ast-57"><span id="ast-58">str</span>(<span id="ast-59"><span id="ast-60"><span id="ast-61" class="ref_node">oplog&nbsp;&rarr;&nbsp;self.&nbsp;</span>.database</span>.connection</span>)</span></span><span id="ast-62"><span id="ast-63" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>timestamp</span>&nbsp;=&nbsp;<span id="ast-64"><span id="ast-65" class="other_trans">bson_ts_to_long</span>(<span id="ast-66" class="other_trans">ts</span>)</span></span><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>json_str</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans">json</span>.dumps</span>(<span id="ast-72">[<span id="ast-73" class="other_trans">oplog_str</span>,&nbsp;<span id="ast-74" class="other_trans">timestamp</span>]</span>)</span></span><span id="ast-75"><span id="ast-76"><span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dest</span>.write</span>(<span id="ast-79" class="other_trans">json_str</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;request(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">verb</span>,&nbsp;<span id="ast-5" class="other_trans">method</span>,&nbsp;**kwargs</span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>verb</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">verb</span>.upper</span>()</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request_kwargs</span>&nbsp;=&nbsp;<span id="ast-13">{}</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-15">(<span id="ast-16" class="ref_node">method&nbsp;&rarr;&nbsp;verb&nbsp;</span><span id="ast-17" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-18">'GET'</span>)</span>:<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>request_kwargs</span>[<span id="ast-22"><span id="ast-23">'params'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-24" class="incorrect_node">kwargs&nbsp;&rarr;&nbsp;self.&nbsp;</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-25"><span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>request_kwargs</span>[<span id="ast-28"><span id="ast-29">'data'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-30" class="other_trans">kwargs</span></span></span><span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-33">(<span id="ast-34"><span id="ast-35"><span id="ast-36">self</span>.config</span>[<span id="ast-37"><span id="ast-38">'base_url'</span></span>]</span>&nbsp;+&nbsp;<span id="ast-40" class="other_trans">method</span>)</span></span><span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.debug</span>(<span id="ast-45">(<span id="ast-46">'%s&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-48">(<span id="ast-49" class="other_trans">verb</span>,&nbsp;<span id="ast-50" class="other_trans">url</span>)</span>)</span>)</span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55"><span id="ast-56">self</span>.requester</span>.request</span>(<span id="ast-57" class="other_trans">verb</span>,&nbsp;<span id="ast-58" class="other_trans">url</span>,&nbsp;**<span id="ast-59" class="other_trans">request_kwargs</span>)</span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62"><span id="ast-63" class="other_trans">r</span>.status_code</span><span id="ast-64" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-65">200</span>)</span>:<span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-67"><span id="ast-68" class="other_trans">APIError</span>(<span id="ast-69"><span id="ast-70" class="other_trans">r</span>.status_code</span>)</span></span></span><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans">r</span>.json</span>()</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;working(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">candidate</span>,&nbsp;<span id="ast-5" class="other_trans">status</span>,&nbsp;<span id="ast-6" class="other_trans">worker_id</span>,&nbsp;<span id="ast-8" class="other_trans">can_be_killed</span></span>):<span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>logging</span>.debug</span>(<span id="ast-14">(<span id="ast-15">(<span id="ast-16">(<span id="ast-17">(<span id="ast-18">(<span id="ast-19">'Worker&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-21"><span id="ast-22" class="other_trans">str</span>(<span id="ast-23" class="other_trans">worker_id</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-25">'&nbsp;informed&nbsp;me&nbsp;about&nbsp;work&nbsp;in&nbsp;status&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-27"><span id="ast-28" class="other_trans">str</span>(<span id="ast-29" class="other_trans">status</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-31">'on&nbsp;candidate&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-33"><span id="ast-34" class="other_trans">str</span>(<span id="ast-35" class="incorrect_node">candidate&nbsp;&rarr;&nbsp;worker_id&nbsp;</span>)</span>)</span>)</span></span><span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.perform_candidate_state_check</span>(<span id="ast-40" class="other_trans">candidate</span>)</span></span><span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-42">(<span id="ast-43" class="other_trans">status</span><span id="ast-44" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-45">'finished'</span>)</span>:<span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.deal_with_finished</span>(<span id="ast-50" class="other_trans">candidate</span>)</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52">(<span id="ast-53"><span id="ast-54" class="other_trans">len</span>(<span id="ast-55"><span id="ast-56">self</span>.finished_candidates</span>)</span><span id="ast-57" class="ref_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-58"><span id="ast-59">self</span>.initial_random_runs</span>)</span>:<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._refit_gp</span>()</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;disambiguate(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">results</span>,&nbsp;<span id="ast-5">ctxt</span>,&nbsp;<span id="ast-6" class="other_trans">action_verifier</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Try&nbsp;to&nbsp;disambiguate&nbsp;the&nbsp;results&nbsp;if&nbsp;needed&nbsp;using&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;action_verifier&nbsp;to&nbsp;get&nbsp;whether&nbsp;things&nbsp;work.&nbsp;&nbsp;Returns&nbsp;(action,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;did_disambiguate)&nbsp;pair,&nbsp;where&nbsp;did_disambiguate&nbsp;represents\\u000a&nbsp;&nbsp;&nbsp;&nbsp;whether&nbsp;there&nbsp;were&nbsp;multiple&nbsp;logical&nbsp;options.'</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-10">(<span id="ast-11"><span id="ast-12">len</span>(<span id="ast-13">results</span>)</span><span id="ast-14" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-15">1</span>)</span>:<span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-17">(<span id="ast-18"><span id="ast-19"><span id="ast-20" class="other_trans">results</span>[<span id="ast-21"><span id="ast-22">0</span></span>]</span>.value</span>,&nbsp;<span id="ast-23">False</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>scores</span>&nbsp;=&nbsp;<span id="ast-26">[<span id="ast-27">(<span id="ast-28" class="other_trans">r</span>,&nbsp;<span id="ast-29"><span id="ast-30" class="other_trans">action_verifier</span>(<span id="ast-31"><span id="ast-32" class="other_trans">r</span>.value</span>,&nbsp;<span id="ast-33">ctxt</span>)</span>)</span><span id="ast-34">&nbsp;for&nbsp;<span id="ast-35" class="other_trans">r</span>&nbsp;in&nbsp;<span id="ast-36" class="other_trans">results</span></span>]</span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>scores</span>.sort</span>(key=<span id="ast-42">lambda&nbsp;<span id="ast-43"><span id="ast-44" class="other_trans">z</span></span>:&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47">z</span>[<span id="ast-48"><span id="ast-49">1</span></span>]</span>.score</span></span>)</span></span><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>is_disambiguating</span>&nbsp;=&nbsp;<span id="ast-52">(<span id="ast-53">1</span><span id="ast-54" class="incorrect_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-55"><span id="ast-56">len</span>(<span id="ast-57">[<span id="ast-58">True</span><span id="ast-59">&nbsp;for&nbsp;<span id="ast-60">(<span id="ast-61">r</span>,&nbsp;<span id="ast-62">v</span>)</span>&nbsp;in&nbsp;<span id="ast-63" class="other_trans">scores</span>&nbsp;if&nbsp;<span id="ast-64"><span id="ast-65"><span id="ast-66">v</span>.is_acceptible</span>()</span></span>]</span>)</span>)</span></span><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans">scores</span>[<span id="ast-73"><span id="ast-74">-1</span></span>]</span>[<span id="ast-75"><span id="ast-76">1</span></span>]</span>.is_acceptible</span>()</span>:<span id="ast-77"><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>best_score</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82" class="other_trans">scores</span>[<span id="ast-83"><span id="ast-84">-1</span></span>]</span>[<span id="ast-85"><span id="ast-86">1</span></span>]</span>.score</span></span><span id="ast-87"><span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>best_results</span>&nbsp;=&nbsp;<span id="ast-89">[<span id="ast-90">r</span><span id="ast-91">&nbsp;for&nbsp;<span id="ast-92">(<span id="ast-93" class="other_trans">r</span>,&nbsp;<span id="ast-94" class="other_trans">v</span>)</span>&nbsp;in&nbsp;<span id="ast-95" class="other_trans">scores</span>&nbsp;if&nbsp;<span id="ast-96">(<span id="ast-97"><span id="ast-98" class="other_trans">v</span>.score</span><span id="ast-99" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-100" class="other_trans">best_score</span>)</span></span>]</span></span><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-102">(<span id="ast-103"><span id="ast-104" class="other_trans">len</span>(<span id="ast-105">best_results</span>)</span><span id="ast-106" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-107">1</span>)</span>:<span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-109">(<span id="ast-110"><span id="ast-111"><span id="ast-112">best_results</span>[<span id="ast-113"><span id="ast-114">0</span></span>]</span>.value</span>,&nbsp;<span id="ast-115" class="other_trans">is_disambiguating</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-116"><span id="ast-117" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ordered_best_results</span>&nbsp;=&nbsp;<span id="ast-118">[<span id="ast-119" class="other_trans">r</span><span id="ast-120">&nbsp;for&nbsp;<span id="ast-121">r</span>&nbsp;in&nbsp;<span id="ast-122">results</span>&nbsp;if&nbsp;<span id="ast-123">(<span id="ast-124">r</span><span id="ast-125">&nbsp;in&nbsp;</span><span id="ast-126">best_results</span>)</span></span>]</span></span><span id="ast-127"><span id="ast-128"><span id="ast-129"><span id="ast-130" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ordered_best_results</span>.reverse</span>()</span></span><span id="ast-131"><span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_results</span>&nbsp;=&nbsp;<span id="ast-133">[]</span></span><span id="ast-134"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-135" class="other_trans">r</span>&nbsp;in&nbsp;<span id="ast-136" class="other_trans">ordered_best_results</span>:<span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-138">(<span id="ast-139"><span id="ast-140">type</span>(<span id="ast-141"><span id="ast-142" class="other_trans">r</span>.value</span>)</span><span id="ast-143" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-144"><span id="ast-145">type</span>(<span id="ast-146"><span id="ast-147"><span id="ast-148" class="other_trans">ordered_best_results</span>[<span id="ast-149"><span id="ast-150">0</span></span>]</span>.value</span>)</span>)</span>:<span id="ast-151"><span id="ast-152"><span id="ast-153"><span id="ast-154" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_results</span>.append</span>(<span id="ast-155">r</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-156"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span></span><span id="ast-157"><span id="ast-158"><span id="ast-159"><span id="ast-160"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_results</span>.sort</span>(key=<span id="ast-162">lambda&nbsp;<span id="ast-163"><span id="ast-164">r</span></span>:&nbsp;<span id="ast-165"><span id="ast-166">r</span>.score</span></span>)</span></span><span id="ast-167"><span id="ast-168" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>best_score</span>&nbsp;=&nbsp;<span id="ast-169"><span id="ast-170"><span id="ast-171">new_results</span>[<span id="ast-172"><span id="ast-173">-1</span></span>]</span>.score</span></span><span id="ast-174"><span id="ast-175" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_best_results</span>&nbsp;=&nbsp;<span id="ast-176">[<span id="ast-177" class="other_trans">r</span><span id="ast-178">&nbsp;for&nbsp;<span id="ast-179">r</span>&nbsp;in&nbsp;<span id="ast-180">new_results</span>&nbsp;if&nbsp;<span id="ast-181">(<span id="ast-182"><span id="ast-183">r</span>.score</span><span id="ast-184" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-185">best_score</span>)</span></span>]</span></span><span id="ast-186"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-187">(<span id="ast-188"><span id="ast-189">len</span>(<span id="ast-190">new_best_results</span>)</span><span id="ast-191" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-192">1</span>)</span>:<span id="ast-193"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-194">(<span id="ast-195"><span id="ast-196"><span id="ast-197" class="other_trans">new_best_results</span>[<span id="ast-198"><span id="ast-199">0</span></span>]</span>.value</span>,&nbsp;<span id="ast-200">True</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-201"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-202"><span id="ast-203" class="ref_node">__construct_amb_exception&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-204">[<span id="ast-205"><span id="ast-206" class="other_trans">r</span>.value</span><span id="ast-207">&nbsp;for&nbsp;<span id="ast-208">r</span>&nbsp;in&nbsp;<span id="ast-209">new_best_results</span></span>]</span>)</span></span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-210"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-211">(<span id="ast-212"><span id="ast-213"><span id="ast-214"><span id="ast-215" class="other_trans">scores</span>[<span id="ast-216"><span id="ast-217">0</span></span>]</span>[<span id="ast-218"><span id="ast-219">0</span></span>]</span>.value</span>,&nbsp;<span id="ast-220">True</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;compute_best(<span id="ast-2"><span id="ast-3">phones</span>,&nbsp;<span id="ast-4" class="other_trans">bounds</span>,&nbsp;<span id="ast-5" class="other_trans">costs</span>,&nbsp;<span id="ast-6" class="other_trans">seqs</span>,&nbsp;<span id="ast-7">i</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>attempts</span>&nbsp;=&nbsp;<span id="ast-10">[]</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-12" class="other_trans">L</span>&nbsp;in&nbsp;<span id="ast-13"><span id="ast-14">range</span>(<span id="ast-15">1</span>,&nbsp;<span id="ast-16">(<span id="ast-17"><span id="ast-18">min</span>(<span id="ast-19">i</span>,&nbsp;<span id="ast-20" class="other_trans">longest</span>)</span>&nbsp;+&nbsp;<span id="ast-22">1</span>)</span>)</span>:<span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-24">(<span id="ast-25"><span id="ast-26" class="other_trans">len</span>(<span id="ast-27"><span id="ast-28" class="other_trans">phones</span>[<span id="ast-29">:<span id="ast-30">(<span id="ast-31">i</span>&nbsp;-&nbsp;<span id="ast-33">L</span>)</span></span>]</span>)</span><span id="ast-34" class="incorrect_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-35"><span id="ast-36">len</span>(<span id="ast-37">phones</span>)</span>)</span></span><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-40">subcost</span>,&nbsp;<span id="ast-41" class="other_trans">subwords</span>)</span>&nbsp;=&nbsp;<span id="ast-42">(<span id="ast-43"><span id="ast-44">costs</span>[<span id="ast-45"><span id="ast-46">(<span id="ast-47">i</span>&nbsp;-&nbsp;<span id="ast-49" class="other_trans">L</span>)</span></span>]</span>,&nbsp;<span id="ast-50"><span id="ast-51">seqs</span>[<span id="ast-52"><span id="ast-53">(<span id="ast-54">i</span>&nbsp;-&nbsp;<span id="ast-56" class="other_trans">L</span>)</span></span>]</span>)</span></span><span id="ast-57"><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subcost</span>&nbsp;+=&nbsp;<span id="ast-60">(<span id="ast-61">fit_cost</span>&nbsp;*&nbsp;<span id="ast-63">(<span id="ast-64" class="other_trans">None</span><span id="ast-65" class="ref_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-66"><span id="ast-67" class="other_trans">bounds</span>[<span id="ast-68"><span id="ast-69">(<span id="ast-70" class="other_trans">i</span>&nbsp;-&nbsp;<span id="ast-72" class="other_trans">L</span>)</span></span>]</span>)</span>)</span></span><span id="ast-73">def&nbsp;add(<span id="ast-74"><span id="ast-75">word</span>,&nbsp;<span id="ast-76" class="other_trans">common_cost</span></span>):<span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>attempts</span>.append</span>(<span id="ast-81">(<span id="ast-82">(<span id="ast-83">(<span id="ast-84">common_cost</span>&nbsp;-&nbsp;<span id="ast-86">(<span id="ast-87">rarity_cost</span>&nbsp;*&nbsp;<span id="ast-89"><span id="ast-90">log10</span>(<span id="ast-91"><span id="ast-92">Pw</span>(<span id="ast-93" class="other_trans">word</span>)</span>)</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-95">(<span id="ast-96">match_cost</span>&nbsp;*&nbsp;<span id="ast-98">(<span id="ast-99" class="other_trans">word</span><span id="ast-100" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-101"><span id="ast-102" class="other_trans">bounds</span>[<span id="ast-103"><span id="ast-104">(<span id="ast-105" class="other_trans">i</span>&nbsp;-&nbsp;<span id="ast-107" class="other_trans">L</span>)</span></span>]</span>)</span>)</span>)</span>,&nbsp;<span id="ast-108">(<span id="ast-109">subwords</span>&nbsp;+&nbsp;<span id="ast-111">(<span id="ast-112">word</span>)</span>)</span>)</span>)</span></span></span><span id="ast-113"><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>exacts</span>&nbsp;=&nbsp;<span id="ast-115"><span id="ast-116"><span id="ast-117" class="other_trans">words_of_phones</span>.get</span>(<span id="ast-118"><span id="ast-119" class="other_trans">phones</span>[<span id="ast-120"><span id="ast-121">(<span id="ast-122">i</span>&nbsp;-&nbsp;<span id="ast-124" class="other_trans">L</span>)</span>:<span id="ast-125">i</span></span>]</span>,&nbsp;<span id="ast-126">()</span>)</span></span><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-128">word</span>&nbsp;in&nbsp;<span id="ast-129" class="other_trans">exacts</span>:<span id="ast-130"><span id="ast-131"><span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>add</span>(<span id="ast-133">word</span>,&nbsp;<span id="ast-134" class="other_trans">subcost</span>)</span></span></span><span id="ast-135"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-136" class="other_trans">word</span>&nbsp;in&nbsp;<span id="ast-137"><span id="ast-138"><span id="ast-139">rough_words</span>.get</span>(<span id="ast-140"><span id="ast-141">roughen</span>(<span id="ast-142"><span id="ast-143">phones</span>[<span id="ast-144"><span id="ast-145">(<span id="ast-146">i</span>&nbsp;-&nbsp;<span id="ast-148">L</span>)</span>:<span id="ast-149" class="other_trans">i</span></span>]</span>)</span>,&nbsp;<span id="ast-150">()</span>)</span>:<span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-152">(<span id="ast-153" class="other_trans">word</span><span id="ast-154">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-155" class="other_trans">exacts</span>)</span>:<span id="ast-156"><span id="ast-157"><span id="ast-158" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>add</span>(<span id="ast-159" class="other_trans">word</span>,&nbsp;<span id="ast-160">(<span id="ast-161" class="other_trans">subcost</span>&nbsp;+&nbsp;<span id="ast-163">roughened_cost</span>)</span>)</span></span></span></span></span><span id="ast-164"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-165"><span id="ast-167"><span id="ast-168">min</span>(<span id="ast-169">attempts</span>)</span>&nbsp;if&nbsp;<span id="ast-166" class="other_trans">attempts</span>&nbsp;else&nbsp;<span id="ast-170">(<span id="ast-171">1000000.0</span>,&nbsp;<span id="ast-172">(<span id="ast-173">'XXX'</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">distribution</span>,&nbsp;<span id="ast-5" class="other_trans">dtype</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Creates&nbsp;an&nbsp;empty&nbsp;DistArray&nbsp;according&nbsp;to&nbsp;the&nbsp;`distribution`&nbsp;given.'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ctx</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12" class="other_trans">distribution</span>.context</span></span><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>comm_name</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16" class="correct_node">ctx&nbsp;&rarr;&nbsp;distribution&nbsp;</span>.comm</span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>da_key</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans">ctx</span>._generate_key</span>()</span></span><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ddpr</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26" class="other_trans">distribution</span>.get_dim_data_per_rank</span>()</span></span><span id="ast-27"><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-29">ddpr_name</span>,&nbsp;<span id="ast-30" class="other_trans">dtype_name</span>)</span>&nbsp;=&nbsp;<span id="ast-31"><span id="ast-32"><span id="ast-33" class="other_trans">ctx</span>._key_and_push</span>(<span id="ast-34" class="other_trans">ddpr</span>,&nbsp;<span id="ast-35" class="other_trans">dtype</span>)</span></span><span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd</span>&nbsp;=&nbsp;<span id="ast-38">'{da_key}&nbsp;=&nbsp;distarray.local.empty(distarray.local.maps.Distribution({ddpr_name}[{comm_name}.Get_rank()],&nbsp;{comm_name}),&nbsp;{dtype_name})'</span></span><span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ctx</span>._execute</span>(<span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans">cmd</span>.format</span>(**<span id="ast-46"><span id="ast-47" class="other_trans">locals</span>()</span>)</span>,&nbsp;targets=<span id="ast-49"><span id="ast-50" class="other_trans">distribution</span>.targets</span>)</span></span><span id="ast-51"><span id="ast-52"><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.distribution</span>&nbsp;=&nbsp;<span id="ast-54" class="other_trans">distribution</span></span><span id="ast-55"><span id="ast-56"><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.key</span>&nbsp;=&nbsp;<span id="ast-58" class="other_trans">da_key</span></span><span id="ast-59"><span id="ast-60"><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._dtype</span>&nbsp;=&nbsp;<span id="ast-62" class="other_trans">dtype</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">base_url</span>,&nbsp;<span id="ast-6" class="other_trans">full_commit</span>,&nbsp;<span id="ast-8" class="other_trans">authmethod</span></span>):<span id="ast-10"><span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.base_url</span>&nbsp;=&nbsp;<span id="ast-13" class="other_trans">base_url</span></span><span id="ast-14"><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-16"><span id="ast-17">self</span>.base_url</span>,&nbsp;<span id="ast-18" class="incorrect_node">credentials&nbsp;&rarr;&nbsp;base_url&nbsp;</span>)</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans">utils</span>._extract_credentials</span>(<span id="ast-22" class="other_trans">base_url</span>)</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.resource</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27" class="other_trans">Resource</span>(<span id="ast-28" class="ref_node">base_url&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-29" class="other_trans">full_commit</span>,&nbsp;credentials=<span id="ast-31" class="other_trans">credentials</span>,&nbsp;authmethod=<span id="ast-33" class="other_trans">authmethod</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;find_all_episodes(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">options</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>page</span>&nbsp;=&nbsp;<span id="ast-7">1</span></span><span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11"><span id="ast-12">re</span>.search</span>(<span id="ast-13">'"http://www.oppetarkiv.se/etikett/titel/([^"/]+)'</span>,&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.get_urldata</span>()</span>)</span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18">(<span id="ast-19">match</span><span id="ast-20" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-21">None</span>)</span>:<span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">re</span>.search</span>(<span id="ast-27">'"http://www.oppetarkiv.se/etikett/titel/([^"/]+)'</span>,&nbsp;<span id="ast-28"><span id="ast-29">self</span>.url</span>)</span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-31">(<span id="ast-32" class="other_trans">match</span><span id="ast-33" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-34" class="other_trans">None</span>)</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.error</span>(<span id="ast-39">"Couldn't&nbsp;find&nbsp;title"</span>)</span></span><span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.exit</span>(<span id="ast-44">2</span>)</span></span></span></span><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>program</span>&nbsp;=&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">match</span>.group</span>(<span id="ast-50">1</span>)</span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>more</span>&nbsp;=&nbsp;<span id="ast-53">True</span></span><span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>episodes</span>&nbsp;=&nbsp;<span id="ast-56">[]</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-58" class="other_trans">more</span>:<span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-61">(<span id="ast-62">'http://www.oppetarkiv.se/etikett/titel/%s/?sida=%s&amp;sort=tid_stigande&amp;embed=true'</span>&nbsp;%&nbsp;<span id="ast-64">(<span id="ast-65">program</span>,&nbsp;<span id="ast-66" class="other_trans">page</span>)</span>)</span></span><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70" class="correct_node">get_http_data&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-71" class="other_trans">url</span>)</span></span><span id="ast-72"><span id="ast-73" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>visa</span>&nbsp;=&nbsp;<span id="ast-74"><span id="ast-75"><span id="ast-76" class="other_trans">re</span>.search</span>(<span id="ast-77">'svtXColorDarkLightGrey'</span>,&nbsp;<span id="ast-78" class="other_trans">data</span>)</span></span><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-80">(<span id="ast-81">not</span>&nbsp;<span id="ast-82" class="other_trans">visa</span>)</span>:<span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>more</span>&nbsp;=&nbsp;<span id="ast-85">False</span></span></span><span id="ast-86"><span id="ast-87" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>regex</span>&nbsp;=&nbsp;<span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans">re</span>.compile</span>(<span id="ast-91">'(http://www.oppetarkiv.se/video/[^"]+)'</span>)</span></span><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-93" class="other_trans">match</span>&nbsp;in&nbsp;<span id="ast-94"><span id="ast-95"><span id="ast-96" class="other_trans">regex</span>.finditer</span>(<span id="ast-97" class="other_trans">data</span>)</span>:<span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>episodes</span>.append</span>(<span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans">match</span>.group</span>(<span id="ast-105">1</span>)</span>)</span></span></span><span id="ast-106"><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>page</span>&nbsp;+=&nbsp;<span id="ast-109">1</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_switch_user(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Switches&nbsp;the&nbsp;*uid*&nbsp;and&nbsp;*gui*&nbsp;of&nbsp;the&nbsp;current&nbsp;EMSM&nbsp;process&nbsp;to\\u000a&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;the&nbsp;expected&nbsp;user&nbsp;defined&nbsp;in&nbsp;the&nbsp;configuration&nbsp;(*main.conf*).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:raises&nbsp;WrongUserError:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;the&nbsp;effective&nbsp;user&nbsp;that&nbsp;executes&nbsp;the&nbsp;EMSM&nbsp;could&nbsp;not&nbsp;be&nbsp;changed.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;seealso::\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;:meth:`emsm.conf.Configuration.main`\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;:func:`os.setuid`\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;:func:`os.setgid`\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>username</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>._conf</span>.main</span>()</span>[<span id="ast-14"><span id="ast-15">'emsm'</span></span>]</span>[<span id="ast-16"><span id="ast-17">'user'</span></span>]</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">pwd</span>.getpwnam</span>(<span id="ast-23" class="other_trans">username</span>)</span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>group</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans">grp</span>.getgrgid</span>(<span id="ast-29"><span id="ast-30" class="other_trans">user</span>.pw_gid</span>)</span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-33">(<span id="ast-34"><span id="ast-35"><span id="ast-36" class="other_trans">os</span>.getegid</span>()</span><span id="ast-37" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-38"><span id="ast-39" class="other_trans">user</span>.pw_gid</span>)</span>:<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.setgid</span>(<span id="ast-44"><span id="ast-45" class="other_trans">user</span>.pw_gid</span>)</span></span><span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.info</span>(<span id="ast-50"><span id="ast-51"><span id="ast-52">"switched&nbsp;gid&nbsp;to&nbsp;'{}'&nbsp;('{}')."</span>.format</span>(<span id="ast-53"><span id="ast-54" class="other_trans">user</span>.pw_gid</span>,&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">group</span>.gr_name</span>)</span>)</span></span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-58">(<span id="ast-59"><span id="ast-60"><span id="ast-61" class="other_trans">os</span>.geteuid</span>()</span><span id="ast-62" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-63"><span id="ast-64" class="other_trans">user</span>.pw_uid</span>)</span>:<span id="ast-65"><span id="ast-66"><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.setuid</span>(<span id="ast-69"><span id="ast-70" class="other_trans">user</span>.pw_uid</span>)</span></span><span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.info</span>(<span id="ast-75"><span id="ast-76"><span id="ast-77">"switched&nbsp;uid&nbsp;to&nbsp;'{}'&nbsp;('{}')."</span>.format</span>(<span id="ast-78"><span id="ast-79" class="other_trans">user</span>.pw_uid</span>,&nbsp;<span id="ast-80"><span id="ast-81" class="incorrect_node">user&nbsp;&rarr;&nbsp;group&nbsp;</span>.pw_name</span>)</span>)</span></span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-83" class="other_trans">OSError</span>&nbsp;as&nbsp;<span id="ast-84" class="other_trans">err</span>:<span id="ast-85"><span id="ast-86"><span id="ast-87"><span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.critical</span>(<span id="ast-89" class="other_trans">err</span>,&nbsp;exc_info=<span id="ast-91">True</span>)</span></span><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-93"><span id="ast-94">WrongUserError</span>(<span id="ast-95" class="ref_node">err&nbsp;&rarr;&nbsp;username&nbsp;</span>)</span></span></span></span><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-97" class="other_trans">None</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;numpy2stl(<span id="ast-2"><span id="ast-3" class="other_trans">A</span>,&nbsp;<span id="ast-4">fn</span>,&nbsp;<span id="ast-5" class="other_trans">scale</span>,&nbsp;<span id="ast-7" class="other_trans">mask_val</span>,&nbsp;<span id="ast-12" class="other_trans">ascii</span>,&nbsp;<span id="ast-14" class="other_trans">calc_normals</span>,&nbsp;<span id="ast-16" class="other_trans">max_width</span>,&nbsp;<span id="ast-18" class="other_trans">max_depth</span>,&nbsp;<span id="ast-20" class="other_trans">max_height</span></span>):<span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Reads&nbsp;a&nbsp;numpy&nbsp;array,&nbsp;and&nbsp;outputs&nbsp;an&nbsp;STL&nbsp;file\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Inputs:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;(ndarray)&nbsp;-&nbsp;&nbsp;an&nbsp;'m'&nbsp;by&nbsp;'n'&nbsp;2D&nbsp;numpy&nbsp;array\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fn&nbsp;(string)&nbsp;-&nbsp;&nbsp;filename&nbsp;to&nbsp;use&nbsp;for&nbsp;STL&nbsp;file\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Optional&nbsp;input:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scale&nbsp;(float)&nbsp;&nbsp;-&nbsp;&nbsp;scales&nbsp;the&nbsp;height&nbsp;(surface)&nbsp;of&nbsp;the&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resulting&nbsp;STL&nbsp;mesh.&nbsp;Tune&nbsp;to&nbsp;match&nbsp;needs\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask_val&nbsp;(float)&nbsp;-&nbsp;any&nbsp;element&nbsp;of&nbsp;the&nbsp;inputted&nbsp;array&nbsp;that&nbsp;is&nbsp;less\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;than&nbsp;this&nbsp;value&nbsp;will&nbsp;not&nbsp;be&nbsp;included&nbsp;in&nbsp;the&nbsp;mesh.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default&nbsp;renders&nbsp;all&nbsp;vertices&nbsp;(x&nbsp;&gt;&nbsp;-inf&nbsp;for&nbsp;all&nbsp;float&nbsp;x)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ascii&nbsp;(bool)&nbsp;&nbsp;-&nbsp;&nbsp;sets&nbsp;the&nbsp;STL&nbsp;format&nbsp;to&nbsp;ascii&nbsp;or&nbsp;binary&nbsp;(default)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;calc_normals&nbsp;(bool)&nbsp;-&nbsp;sets&nbsp;whether&nbsp;surface&nbsp;normals&nbsp;are&nbsp;calculated&nbsp;or&nbsp;not&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_width,&nbsp;max_depth,&nbsp;max_height&nbsp;(floats)&nbsp;-&nbsp;maximum&nbsp;size&nbsp;of&nbsp;the&nbsp;stl\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;(in&nbsp;mm).&nbsp;Match&nbsp;this&nbsp;to\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;3D&nbsp;printer\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;platform&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns:&nbsp;(None)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-26" class="other_trans">m</span>,&nbsp;<span id="ast-27" class="other_trans">n</span>)</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">A</span>.shape</span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-31">(<span id="ast-32" class="other_trans">n</span><span id="ast-33" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-34" class="other_trans">m</span>)</span>:<span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>A</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">np</span>.rot90</span>(<span id="ast-40" class="other_trans">A</span>,&nbsp;k=<span id="ast-42">3</span>)</span></span><span id="ast-43"><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-45" class="other_trans">m</span>,&nbsp;<span id="ast-46" class="other_trans">n</span>)</span>&nbsp;=&nbsp;<span id="ast-47">(<span id="ast-48" class="other_trans">n</span>,&nbsp;<span id="ast-49" class="other_trans">m</span>)</span></span></span><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>A</span>&nbsp;=&nbsp;<span id="ast-52">(<span id="ast-53" class="incorrect_node">scale&nbsp;&rarr;&nbsp;A&nbsp;</span>&nbsp;*&nbsp;<span id="ast-55">(<span id="ast-56" class="other_trans">A</span>&nbsp;-&nbsp;<span id="ast-58"><span id="ast-59"><span id="ast-60" class="other_trans">A</span>.min</span>()</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;search(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">title</span>,&nbsp;<span id="ast-5" class="other_trans">year</span></span>):<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>year</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-11"><span id="ast-12">int</span>(<span id="ast-13" class="other_trans">year</span>)</span>&nbsp;if&nbsp;<span id="ast-10" class="other_trans">year</span>&nbsp;else&nbsp;<span id="ast-14" class="other_trans">None</span></span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>resp</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18">download</span>(<span id="ast-19">(<span id="ast-20">'http://www.csfd.cz/hledat/complete-films/?q='</span>&nbsp;+&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24" class="other_trans">urllib</span>.quote_plus</span>(<span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans">unicode</span>(<span id="ast-29">title</span>)</span>.encode</span>(<span id="ast-30">'utf-8'</span>)</span>)</span>)</span>)</span></span><span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>&nbsp;=&nbsp;<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36">self</span>.id_re</span>.search</span>(<span id="ast-37"><span id="ast-38" class="other_trans">resp</span>.url</span>)</span></span><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-40" class="other_trans">match</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44">self</span>.lookup</span>(<span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans">match</span>.group</span>(<span id="ast-48">1</span>)</span>)</span></span></span><span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>html</span>&nbsp;=&nbsp;<span id="ast-51"><span id="ast-52"><span id="ast-53" class="other_trans">parsers</span>.html</span>(<span id="ast-54"><span id="ast-55" class="other_trans">resp</span>.content</span>,&nbsp;base_url=<span id="ast-57"><span id="ast-58" class="other_trans">resp</span>.url</span>)</span></span><span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>items</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">self</span>._iterparse_items</span>(<span id="ast-64" class="other_trans">html</span>,&nbsp;<span id="ast-65" class="other_trans">year</span>)</span></span><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-67" class="other_trans">item</span>&nbsp;in&nbsp;<span id="ast-68" class="other_trans">items</span>:<span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>similarity_ratio</span>&nbsp;=&nbsp;<span id="ast-71"><span id="ast-72"><span id="ast-73">fuzz</span>.partial_ratio</span>(<span id="ast-74" class="other_trans">title</span>,&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77">self</span>._parse_title</span>(<span id="ast-78" class="other_trans">item</span>)</span>)</span></span><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-80">(<span id="ast-81" class="other_trans">similarity_ratio</span><span id="ast-82" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;<&nbsp;</span><span id="ast-83"><span id="ast-84">self</span>.min_similarity_ratio</span>)</span>:<span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88">self</span>.lookup</span>(<span id="ast-89"><span id="ast-90"><span id="ast-91">self</span>._parse_film_id</span>(<span id="ast-92">item</span>)</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;cached_polyline(<span id="ast-2"><span id="ast-3" class="other_trans">origin</span>,&nbsp;<span id="ast-4" class="other_trans">destination</span>,&nbsp;<span id="ast-5" class="other_trans">speed</span>,&nbsp;<span id="ast-6" class="other_trans">google_map_api_key</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Google&nbsp;API&nbsp;has&nbsp;limits,&nbsp;so&nbsp;we&nbsp;can't&nbsp;generate&nbsp;new&nbsp;Polyline&nbsp;at&nbsp;every&nbsp;tick...\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11">(<span id="ast-13"><span id="ast-14" class="other_trans">PolylineObjectHandler</span>._cache</span>&nbsp;and&nbsp;<span id="ast-15">(<span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19" class="other_trans">PolylineObjectHandler</span>._cache</span>.get_last_pos</span>()</span><span id="ast-20" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-21">(<span id="ast-22">None</span>,&nbsp;<span id="ast-23" class="other_trans">None</span>)</span>)</span>)</span>:<span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>abs_offset</span>&nbsp;=&nbsp;<span id="ast-26">(<span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">haversine</span>.haversine</span>(<span id="ast-30"><span id="ast-31">tuple</span>(<span id="ast-32" class="other_trans">origin</span>)</span>,&nbsp;<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36" class="other_trans">PolylineObjectHandler</span>._cache</span>.get_last_pos</span>()</span>)</span>&nbsp;*&nbsp;<span id="ast-38">1000</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>abs_offset</span>&nbsp;=&nbsp;<span id="ast-41"><span id="ast-42" class="other_trans">float</span>(<span id="ast-43">'inf'</span>)</span></span></span><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>is_old_cache</span>&nbsp;=&nbsp;<span id="ast-46">lambda&nbsp;<span id="ast-47"></span>:&nbsp;<span id="ast-48">(<span id="ast-49" class="other_trans">abs_offset</span><span id="ast-50" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-51">8</span>)</span></span></span><span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>new_dest_set</span>&nbsp;=&nbsp;<span id="ast-54">lambda&nbsp;<span id="ast-55"></span>:&nbsp;<span id="ast-56">(<span id="ast-57"><span id="ast-58" class="other_trans">tuple</span>(<span id="ast-59" class="other_trans">destination</span>)</span><span id="ast-60" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">PolylineObjectHandler</span>._cache</span>.destination</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;do_delete(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">line</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'deletes&nbsp;the&nbsp;property&nbsp;NUMBER'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>number</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.str_to_int</span>(<span id="ast-12" class="other_trans">line</span>)</span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-14">(<span id="ast-16">(<span id="ast-17" class="other_trans">number</span><span id="ast-18" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-19"><span id="ast-20" class="other_trans">len</span>(<span id="ast-21" class="other_trans">contact</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-22">(<span id="ast-23" class="other_trans">number</span><span id="ast-24" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-25">0</span>)</span>)</span>:<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>contact</span>[<span id="ast-31"><span id="ast-32">(<span id="ast-33" class="correct_node">line&nbsp;&rarr;&nbsp;number&nbsp;</span>&nbsp;-&nbsp;<span id="ast-35">1</span>)</span></span>]</span>.delete</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.help_delete</span>()</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;build_request(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-6">(<span id="ast-7">'#method#&nbsp;#uri##version#%s#headers#%s#data#'</span>&nbsp;%&nbsp;<span id="ast-9">(<span id="ast-10"><span id="ast-11">self</span>.CRLF</span>,&nbsp;<span id="ast-12"><span id="ast-13">self</span>.CRLF</span>)</span>)</span></span><span id="ast-14"><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17"><span id="ast-18">string</span>.replace</span>(<span id="ast-19">request</span>,&nbsp;<span id="ast-20">'#method#'</span>,&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23">self</span>.request_object</span>.method</span>)</span></span><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28">string</span>.replace</span>(<span id="ast-29" class="other_trans">request</span>,&nbsp;<span id="ast-30">'#uri#'</span>,&nbsp;<span id="ast-31">(<span id="ast-32"><span id="ast-33"><span id="ast-34">self</span>.request_object</span>.uri</span>&nbsp;+&nbsp;<span id="ast-36">'&nbsp;'</span>)</span>)</span></span><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41" class="other_trans">string</span>.replace</span>(<span id="ast-42" class="other_trans">request</span>,&nbsp;<span id="ast-43">'#version#'</span>,&nbsp;<span id="ast-44"><span id="ast-45"><span id="ast-46">self</span>.request_object</span>.version</span>)</span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>available_cookies</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50"><span id="ast-51">self</span>.find_cookie</span>()</span></span><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-53">available_cookies</span>:<span id="ast-54"><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookie_value</span>&nbsp;=&nbsp;<span id="ast-56">''</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-58">(<span id="ast-59">'cookie'</span><span id="ast-60">&nbsp;in&nbsp;</span><span id="ast-61"><span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65">self</span>.request_object</span>.headers</span>.keys</span>()</span>)</span>:<span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookieX</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71">Cookie</span>.SimpleCookie</span>()</span></span><span id="ast-72"><span id="ast-73"><span id="ast-74"><span id="ast-75"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookieX</span>.load</span>(<span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79">self</span>.request_object</span>.headers</span>[<span id="ast-80"><span id="ast-81">'cookie'</span></span>]</span>)</span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-83"><span id="ast-84">Cookie</span>.CookieError</span>&nbsp;as&nbsp;<span id="ast-85" class="other_trans">err</span>:<span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89">errors</span>.TestError</span>(<span id="ast-90">'Error&nbsp;processing&nbsp;the&nbsp;existing&nbsp;cookie&nbsp;into&nbsp;a&nbsp;SimpleCookie'</span>,&nbsp;<span id="ast-91">{<span id="ast-92">'msg'</span>:&nbsp;<span id="ast-95"><span id="ast-96" class="other_trans">str</span>(<span id="ast-97" class="other_trans">err</span>)</span>,&nbsp;<span id="ast-93">'set_cookie'</span>:&nbsp;<span id="ast-98"><span id="ast-99" class="other_trans">str</span>(<span id="ast-100"><span id="ast-101"><span id="ast-102"><span id="ast-103">self</span>.request_object</span>.headers</span>[<span id="ast-104"><span id="ast-105">'cookie'</span></span>]</span>)</span>,&nbsp;<span id="ast-94">'function'</span>:&nbsp;<span id="ast-106">'http.HttpResponse.build_request'</span>}</span>)</span></span></span></span><span id="ast-107"><span id="ast-108" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>TotalCookie</span>&nbsp;=&nbsp;<span id="ast-109">{}</span></span><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-111">(<span id="ast-112" class="other_trans">cookieKey</span>,&nbsp;<span id="ast-113" class="other_trans">cookieMorsal</span>)</span>&nbsp;in&nbsp;<span id="ast-114"><span id="ast-115"><span id="ast-116" class="incorrect_node">cookieX&nbsp;&rarr;&nbsp;TotalCookie&nbsp;</span>.iteritems</span>()</span>:<span id="ast-117"><span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>TotalCookie</span>[<span id="ast-120"><span id="ast-121" class="other_trans">cookieKey</span></span>]</span>&nbsp;=&nbsp;<span id="ast-122"><span id="ast-123"><span id="ast-124">cookieX</span>[<span id="ast-125"><span id="ast-126" class="other_trans">cookieKey</span></span>]</span>.value</span></span></span><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-128">cookie</span>&nbsp;in&nbsp;<span id="ast-129">available_cookies</span>:<span id="ast-130"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-131">(<span id="ast-132" class="other_trans">cookieKey</span>,&nbsp;<span id="ast-133" class="other_trans">cookieMorsal</span>)</span>&nbsp;in&nbsp;<span id="ast-134"><span id="ast-135"><span id="ast-136">cookie</span>.iteritems</span>()</span>:<span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-138">(<span id="ast-139" class="other_trans">cookieKey</span><span id="ast-140">&nbsp;in&nbsp;</span><span id="ast-141"><span id="ast-142"><span id="ast-143">TotalCookie</span>.keys</span>()</span>)</span>:<span id="ast-144"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pass</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-145"><span id="ast-146"><span id="ast-147" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>TotalCookie</span>[<span id="ast-148"><span id="ast-149">cookieKey</span></span>]</span>&nbsp;=&nbsp;<span id="ast-150"><span id="ast-151"><span id="ast-152" class="ref_node">cookieX&nbsp;&rarr;&nbsp;cookie&nbsp;</span>[<span id="ast-153"><span id="ast-154" class="other_trans">cookieKey</span></span>]</span>.value</span></span></span></span></span><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-156">(<span id="ast-157" class="other_trans">key</span>,&nbsp;<span id="ast-158" class="other_trans">value</span>)</span>&nbsp;in&nbsp;<span id="ast-159"><span id="ast-160"><span id="ast-161">TotalCookie</span>.iteritems</span>()</span>:<span id="ast-162"><span id="ast-163" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookie_value</span>&nbsp;+=&nbsp;<span id="ast-165">(<span id="ast-166">(<span id="ast-167">(<span id="ast-168"><span id="ast-169">str</span>(<span id="ast-170" class="other_trans">key</span>)</span>&nbsp;+&nbsp;<span id="ast-172">'='</span>)</span>&nbsp;+&nbsp;<span id="ast-174"><span id="ast-175">str</span>(<span id="ast-176" class="other_trans">value</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-178">';&nbsp;'</span>)</span></span></span><span id="ast-179"><span id="ast-180"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookie_value</span>&nbsp;=&nbsp;<span id="ast-181"><span id="ast-182" class="other_trans">cookie_value</span>[<span id="ast-183">:<span id="ast-184">-2</span></span>]</span></span><span id="ast-185"><span id="ast-186"><span id="ast-187"><span id="ast-188"><span id="ast-189"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.request_object</span>.headers</span>[<span id="ast-190"><span id="ast-191">'cookie'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-192" class="other_trans">cookie_value</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-193"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-194">cookie</span>&nbsp;in&nbsp;<span id="ast-195">available_cookies</span>:<span id="ast-196"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-197">(<span id="ast-198">cookieKey</span>,&nbsp;<span id="ast-199">cookieMorsal</span>)</span>&nbsp;in&nbsp;<span id="ast-200"><span id="ast-201"><span id="ast-202" class="other_trans">cookie</span>.iteritems</span>()</span>:<span id="ast-203"><span id="ast-204"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookie_value</span>&nbsp;+=&nbsp;<span id="ast-206">(<span id="ast-207">(<span id="ast-208">(<span id="ast-209"><span id="ast-210">str</span>(<span id="ast-211" class="other_trans">cookieKey</span>)</span>&nbsp;+&nbsp;<span id="ast-213">'='</span>)</span>&nbsp;+&nbsp;<span id="ast-215"><span id="ast-216">str</span>(<span id="ast-217"><span id="ast-218">cookieMorsal</span>.coded_value</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-220">';&nbsp;'</span>)</span></span></span><span id="ast-221"><span id="ast-222" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cookie_value</span>&nbsp;=&nbsp;<span id="ast-223"><span id="ast-224">cookie_value</span>[<span id="ast-225">:<span id="ast-226">-2</span></span>]</span></span><span id="ast-227"><span id="ast-228"><span id="ast-229"><span id="ast-230"><span id="ast-231"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.request_object</span>.headers</span>[<span id="ast-232"><span id="ast-233">'cookie'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-234" class="other_trans">cookie_value</span></span></span></span></span><span id="ast-235"><span id="ast-236"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>headers</span>&nbsp;=&nbsp;<span id="ast-237">''</span></span><span id="ast-238"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-239">(<span id="ast-240"><span id="ast-241"><span id="ast-242">self</span>.request_object</span>.headers</span><span id="ast-243" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-244">{}</span>)</span>:<span id="ast-245"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-246">(<span id="ast-247" class="other_trans">hname</span>,&nbsp;<span id="ast-248">hvalue</span>)</span>&nbsp;in&nbsp;<span id="ast-249"><span id="ast-250"><span id="ast-251"><span id="ast-252"><span id="ast-253">self</span>.request_object</span>.headers</span>.iteritems</span>()</span>:<span id="ast-254"><span id="ast-255"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>headers</span>&nbsp;+=&nbsp;<span id="ast-257">(<span id="ast-258">(<span id="ast-259">(<span id="ast-260"><span id="ast-261">str</span>(<span id="ast-262">hname</span>)</span>&nbsp;+&nbsp;<span id="ast-264">':&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-266"><span id="ast-267">str</span>(<span id="ast-268" class="other_trans">hvalue</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-270"><span id="ast-271">str</span>(<span id="ast-272"><span id="ast-273">self</span>.CRLF</span>)</span>)</span></span></span></span><span id="ast-274"><span id="ast-275"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-276"><span id="ast-277"><span id="ast-278">string</span>.replace</span>(<span id="ast-279">request</span>,&nbsp;<span id="ast-280">'#headers#'</span>,&nbsp;<span id="ast-281" class="other_trans">headers</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;on_change_tree_tables(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">event</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Handler&nbsp;for&nbsp;selecting&nbsp;an&nbsp;item&nbsp;in&nbsp;the&nbsp;tables&nbsp;list,&nbsp;loads&nbsp;the&nbsp;table&nbsp;data\\u000a&nbsp;&nbsp;&nbsp;&nbsp;into&nbsp;the&nbsp;table&nbsp;grid.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>table</span>&nbsp;=&nbsp;<span id="ast-9">None</span></span><span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>item</span>&nbsp;=&nbsp;<span id="ast-12"><span id="ast-13"><span id="ast-14">event</span>.GetItem</span>()</span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16">(<span id="ast-18" class="other_trans">item</span>&nbsp;and&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans">item</span>.IsOk</span>()</span>)</span>:<span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>table</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27">self</span>.tree_tables</span>.GetItemPyData</span>(<span id="ast-28">item</span>)</span></span><span id="ast-29"><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lower</span>&nbsp;=&nbsp;<span id="ast-31"><span id="ast-33"><span id="ast-34"><span id="ast-35">table</span>.lower</span>()</span>&nbsp;if&nbsp;<span id="ast-32">table</span>&nbsp;else&nbsp;<span id="ast-36">None</span></span></span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-38">(<span id="ast-40" class="other_trans">table</span>&nbsp;and&nbsp;<span id="ast-41">(<span id="ast-43">(<span id="ast-44">not</span>&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47">self</span>.grid_table</span>.Table</span>)</span>&nbsp;or&nbsp;<span id="ast-48">(<span id="ast-49"><span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54">self</span>.grid_table</span>.Table</span>.table</span>.lower</span>()</span><span id="ast-55" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-56" class="other_trans">lower</span>)</span>)</span>)</span>:<span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-59"><span id="ast-60"><span id="ast-61"><span id="ast-62">self</span>.tree_tables</span>.GetNext</span>(<span id="ast-63"><span id="ast-64"><span id="ast-65">self</span>.tree_tables</span>.RootItem</span>)</span></span><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-67">i</span>:<span id="ast-68"><span id="ast-69"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>text</span>&nbsp;=&nbsp;<span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74"><span id="ast-75">self</span>.tree_tables</span>.GetItemText</span>(<span id="ast-76">i</span>)</span>.lower</span>()</span></span><span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bgcolour</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-84"><span id="ast-85" class="other_trans">conf</span>.DBTableOpenedColour</span>&nbsp;if&nbsp;<span id="ast-80">(<span id="ast-81" class="other_trans">text</span><span id="ast-82" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-83" class="ref_node">table&nbsp;&rarr;&nbsp;lower&nbsp;</span>)</span>&nbsp;else&nbsp;<span id="ast-86"><span id="ast-87" class="other_trans">conf</span>.BgColour</span></span></span><span id="ast-88"><span id="ast-89"><span id="ast-90"><span id="ast-91"><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tree_tables</span>.SetItemBackgroundColour</span>(<span id="ast-93" class="other_trans">i</span>,&nbsp;<span id="ast-94" class="other_trans">bgcolour</span>)</span></span><span id="ast-95"><span id="ast-96" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99"><span id="ast-100">self</span>.tree_tables</span>.GetNextSibling</span>(<span id="ast-101">i</span>)</span></span></span><span id="ast-102"><span id="ast-103"><span id="ast-104"><span id="ast-105"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>main</span>.log</span>(<span id="ast-106">'Loading&nbsp;table&nbsp;%s&nbsp;(%s).'</span>,&nbsp;<span id="ast-107" class="other_trans">table</span>,&nbsp;<span id="ast-108"><span id="ast-109">self</span>.db</span>)</span></span><span id="ast-110"><span id="ast-111"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>busy</span>&nbsp;=&nbsp;<span id="ast-112"><span id="ast-113"><span id="ast-114" class="other_trans">controls</span>.BusyPanel</span>(<span id="ast-115">self</span>,&nbsp;<span id="ast-116">(<span id="ast-117">'Loading&nbsp;table&nbsp;"%s".'</span>&nbsp;%&nbsp;<span id="ast-119">table</span>)</span>)</span></span><span id="ast-120"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-121"><span id="ast-122"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>grid_data</span>&nbsp;=&nbsp;<span id="ast-123"><span id="ast-124"><span id="ast-125"><span id="ast-126">self</span>.db_grids</span>.get</span>(<span id="ast-127" class="other_trans">lower</span>)</span></span><span id="ast-128"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-129">(<span id="ast-130">not</span>&nbsp;<span id="ast-131" class="other_trans">grid_data</span>)</span>:<span id="ast-132"><span id="ast-133" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>grid_data</span>&nbsp;=&nbsp;<span id="ast-134"><span id="ast-135"><span id="ast-136" class="other_trans">GridTableBase</span>.from_table</span>(<span id="ast-137"><span id="ast-138">self</span>.db</span>,&nbsp;<span id="ast-139">table</span>)</span></span><span id="ast-140"><span id="ast-141"><span id="ast-142"><span id="ast-143"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.db_grids</span>[<span id="ast-144"><span id="ast-145">lower</span></span>]</span>&nbsp;=&nbsp;<span id="ast-146" class="other_trans">grid_data</span></span></span><span id="ast-147"><span id="ast-148"><span id="ast-149"><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.label_table</span>.Label</span>&nbsp;=&nbsp;<span id="ast-151">(<span id="ast-152">'Table&nbsp;"%s":'</span>&nbsp;%&nbsp;<span id="ast-154" class="other_trans">table</span>)</span></span><span id="ast-155"><span id="ast-156"><span id="ast-157"><span id="ast-158"><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.grid_table</span>.SetTable</span>(<span id="ast-160" class="other_trans">grid_data</span>)</span></span><span id="ast-161"><span id="ast-162"><span id="ast-163"><span id="ast-164"><span id="ast-165"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.page_tables</span>.Layout</span>()</span></span><span id="ast-166"><span id="ast-167"><span id="ast-168"><span id="ast-169"><span id="ast-170"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.grid_table</span>.Scroll</span>(<span id="ast-171">0</span>,&nbsp;<span id="ast-172">0</span>)</span></span><span id="ast-173"><span id="ast-174"><span id="ast-175"><span id="ast-176"><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.grid_table</span>.SetColMinimalAcceptableWidth</span>(<span id="ast-178">100</span>)</span></span><span id="ast-179"><span id="ast-180" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>col_range</span>&nbsp;=&nbsp;<span id="ast-181"><span id="ast-182" class="other_trans">range</span>(<span id="ast-183"><span id="ast-184"><span id="ast-185">grid_data</span>.GetNumberCols</span>()</span>)</span></span><span id="ast-186"><span id="ast-187"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>[<span id="ast-188"><span id="ast-189"><span id="ast-190"><span id="ast-191">self</span>.grid_table</span>.AutoSizeColLabelSize</span>(<span id="ast-192" class="other_trans">x</span>)</span><span id="ast-193">&nbsp;for&nbsp;<span id="ast-194" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-195">col_range</span></span>]</span></span><span id="ast-196"><span id="ast-197"><span id="ast-198"><span id="ast-199"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.on_change_table</span>(<span id="ast-200">None</span>)</span></span><span id="ast-201"><span id="ast-202"><span id="ast-203"><span id="ast-204"><span id="ast-205"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tb_grid</span>.EnableTool</span>(<span id="ast-206"><span id="ast-207">wx</span>.ID_ADD</span>,&nbsp;<span id="ast-208">True</span>)</span></span><span id="ast-209"><span id="ast-210"><span id="ast-211"><span id="ast-212"><span id="ast-213"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tb_grid</span>.EnableTool</span>(<span id="ast-214"><span id="ast-215">wx</span>.ID_DELETE</span>,&nbsp;<span id="ast-216">True</span>)</span></span><span id="ast-217"><span id="ast-218"><span id="ast-219"><span id="ast-220"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.button_export_table</span>.Enabled</span>&nbsp;=&nbsp;<span id="ast-221">True</span></span><span id="ast-222"><span id="ast-223"><span id="ast-224"><span id="ast-225"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.button_reset_grid_table</span>.Enabled</span>&nbsp;=&nbsp;<span id="ast-226">True</span></span><span id="ast-227"><span id="ast-228"><span id="ast-229"><span id="ast-230" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>busy</span>.Close</span>()</span></span><span id="ast-231"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-232">Exception</span>&nbsp;as&nbsp;<span id="ast-233">e</span>:<span id="ast-234"><span id="ast-235"><span id="ast-236"><span id="ast-237"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>busy</span>.Close</span>()</span></span><span id="ast-238"><span id="ast-239"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>errormsg</span>&nbsp;=&nbsp;<span id="ast-240">(<span id="ast-241">'Could&nbsp;not&nbsp;load&nbsp;table&nbsp;%s.\\u000a\\u000a%s'</span>&nbsp;%&nbsp;<span id="ast-243">(<span id="ast-244">table</span>,&nbsp;<span id="ast-245"><span id="ast-246"><span id="ast-247">traceback</span>.format_exc</span>()</span>)</span>)</span></span><span id="ast-248"><span id="ast-249"><span id="ast-250"><span id="ast-251" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>main</span>.logstatus_flash</span>(<span id="ast-252" class="other_trans">errormsg</span>)</span></span><span id="ast-253"><span id="ast-254"><span id="ast-255"><span id="ast-256"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>wx</span>.MessageBox</span>(<span id="ast-257" class="other_trans">errormsg</span>,&nbsp;<span id="ast-258"><span id="ast-259" class="other_trans">conf</span>.Title</span>,&nbsp;<span id="ast-260">(<span id="ast-261"><span id="ast-262">wx</span>.OK</span>&nbsp;|&nbsp;<span id="ast-264"><span id="ast-265" class="other_trans">wx</span>.ICON_WARNING</span>)</span>)</span></span><span id="ast-266"><span id="ast-267"><span id="ast-268"><span id="ast-269"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>wx</span>.CallAfter</span>(<span id="ast-270"><span id="ast-271" class="other_trans">support</span>.report_error</span>,&nbsp;<span id="ast-272" class="other_trans">errormsg</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;invalidate(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">proj</span></span>):<span id="ast-5"><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.painter</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9">BatchPainter</span>()</span></span><span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-12" class="other_trans">x</span>,&nbsp;<span id="ast-13" class="other_trans">y</span>)</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16" class="other_trans">proj</span>.lonlat_to_screen</span>(<span id="ast-17"><span id="ast-18"><span id="ast-19">self</span>.data</span>[<span id="ast-20"><span id="ast-21">'lon'</span></span>]</span>,&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24">self</span>.data</span>[<span id="ast-25"><span id="ast-26">'lat'</span></span>]</span>)</span></span><span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ix</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31">(<span id="ast-32" class="other_trans">x</span>&nbsp;/&nbsp;<span id="ast-34"><span id="ast-35">self</span>.binsize</span>)</span>.astype</span>(<span id="ast-36">int</span>)</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>iy</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41">(<span id="ast-42" class="other_trans">y</span>&nbsp;/&nbsp;<span id="ast-44"><span id="ast-45">self</span>.binsize</span>)</span>.astype</span>(<span id="ast-46">int</span>)</span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>groups</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50" class="other_trans">defaultdict</span>(<span id="ast-51" class="other_trans">list</span>)</span></span><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-53">(<span id="ast-54" class="other_trans">i</span>,&nbsp;<span id="ast-55">k</span>)</span>&nbsp;in&nbsp;<span id="ast-56"><span id="ast-57">enumerate</span>(<span id="ast-58"><span id="ast-59">zip</span>(<span id="ast-60">ix</span>,&nbsp;<span id="ast-61" class="other_trans">iy</span>)</span>)</span>:<span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65"><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>groups</span>[<span id="ast-67"><span id="ast-68" class="other_trans">k</span></span>]</span>.append</span>(<span id="ast-69" class="other_trans">i</span>)</span></span></span><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>results</span>&nbsp;=&nbsp;<span id="ast-72">{<span id="ast-73" class="other_trans">k</span>:&nbsp;<span id="ast-74"><span id="ast-75"><span id="ast-76">self</span>.f_group</span>(<span id="ast-77"><span id="ast-78">groups</span>[<span id="ast-79"><span id="ast-80" class="other_trans">k</span></span>]</span>)</span><span id="ast-81">&nbsp;for&nbsp;<span id="ast-82" class="other_trans">k</span>&nbsp;in&nbsp;<span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans">groups</span>.keys</span>()</span></span>}</span></span><span id="ast-86"><span id="ast-87"><span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.hotspot</span>&nbsp;=&nbsp;<span id="ast-89"><span id="ast-90">HotspotManager</span>()</span></span><span id="ast-91"><span id="ast-92" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>vmax</span>&nbsp;=&nbsp;<span id="ast-93"><span id="ast-94" class="other_trans">max</span>(<span id="ast-95"><span id="ast-96"><span id="ast-97">results</span>.values</span>()</span>)</span></span><span id="ast-98"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-99">(<span id="ast-100" class="other_trans">vmax</span><span id="ast-101" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-102">1</span>)</span>:<span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmap</span>&nbsp;=&nbsp;<span id="ast-105"><span id="ast-106"><span id="ast-107">colors</span>.create_log_cmap</span>(<span id="ast-108" class="other_trans">vmax</span>,&nbsp;<span id="ast-109"><span id="ast-110">self</span>.cmap</span>,&nbsp;alpha=<span id="ast-112"><span id="ast-113">self</span>.alpha</span>)</span></span><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-115">(<span id="ast-116">(<span id="ast-117" class="other_trans">ix</span>,&nbsp;<span id="ast-118" class="other_trans">iy</span>)</span>,&nbsp;<span id="ast-119">value</span>)</span>&nbsp;in&nbsp;<span id="ast-120"><span id="ast-121"><span id="ast-122">results</span>.items</span>()</span>:<span id="ast-123"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-124">(<span id="ast-125">value</span><span id="ast-126" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;<&nbsp;</span><span id="ast-127"><span id="ast-128">self</span>.vmin</span>)</span>:<span id="ast-129"><span id="ast-130"><span id="ast-131"><span id="ast-132"><span id="ast-133"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.painter</span>.set_color</span>(<span id="ast-134"><span id="ast-135" class="other_trans">cmap</span>(<span id="ast-136" class="other_trans">value</span>)</span>)</span></span><span id="ast-137"><span id="ast-138"><span id="ast-139"><span id="ast-140"><span id="ast-141"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.painter</span>.rect</span>(<span id="ast-142">(<span id="ast-143">ix</span>&nbsp;*&nbsp;<span id="ast-145"><span id="ast-146">self</span>.binsize</span>)</span>,&nbsp;<span id="ast-147">(<span id="ast-148" class="other_trans">iy</span>&nbsp;*&nbsp;<span id="ast-150"><span id="ast-151">self</span>.binsize</span>)</span>,&nbsp;<span id="ast-152">(<span id="ast-153">(<span id="ast-154">ix</span>&nbsp;+&nbsp;<span id="ast-156">1</span>)</span>&nbsp;*&nbsp;<span id="ast-158"><span id="ast-159">self</span>.binsize</span>)</span>,&nbsp;<span id="ast-160">(<span id="ast-161">(<span id="ast-162">iy</span>&nbsp;+&nbsp;<span id="ast-164">1</span>)</span>&nbsp;*&nbsp;<span id="ast-166"><span id="ast-167">self</span>.binsize</span>)</span>)</span></span><span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-169"><span id="ast-170">self</span>.show_tooltip</span>:<span id="ast-171"><span id="ast-172"><span id="ast-173"><span id="ast-174"><span id="ast-175"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.hotspot</span>.add_rect</span>(<span id="ast-176">(<span id="ast-177" class="other_trans">ix</span>&nbsp;*&nbsp;<span id="ast-179"><span id="ast-180">self</span>.binsize</span>)</span>,&nbsp;<span id="ast-181">(<span id="ast-182" class="other_trans">iy</span>&nbsp;*&nbsp;<span id="ast-184"><span id="ast-185">self</span>.binsize</span>)</span>,&nbsp;<span id="ast-186"><span id="ast-187">self</span>.binsize</span>,&nbsp;<span id="ast-188"><span id="ast-189">self</span>.binsize</span>,&nbsp;<span id="ast-190">(<span id="ast-191">'Value:&nbsp;%d'</span>&nbsp;%&nbsp;<span id="ast-193" class="other_trans">value</span>)</span>)</span></span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;render_templates(<span id="ast-2"><span id="ast-3" class="other_trans">env</span>,&nbsp;<span id="ast-4" class="other_trans">contexts</span>,&nbsp;<span id="ast-6" class="other_trans">filter_func</span>,&nbsp;<span id="ast-8">rules</span></span>):<span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Render&nbsp;each&nbsp;template&nbsp;inside&nbsp;of&nbsp;`env`.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;env&nbsp;should&nbsp;be&nbsp;a&nbsp;Jinja&nbsp;environment&nbsp;object.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;contexts&nbsp;should&nbsp;be&nbsp;a&nbsp;list&nbsp;of&nbsp;regex-function&nbsp;pairs&nbsp;where&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;should&nbsp;return&nbsp;a&nbsp;context&nbsp;for&nbsp;that&nbsp;template&nbsp;and&nbsp;the&nbsp;regex,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;matched&nbsp;against&nbsp;a&nbsp;filename,&nbsp;will&nbsp;cause&nbsp;the&nbsp;context&nbsp;to&nbsp;be&nbsp;used.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;filter_func&nbsp;should&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;filename&nbsp;and&nbsp;returns\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;boolean&nbsp;indicating&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;template&nbsp;should&nbsp;be&nbsp;rendered.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;rules&nbsp;are&nbsp;used&nbsp;to&nbsp;override&nbsp;template&nbsp;compilation.&nbsp;The&nbsp;value&nbsp;of&nbsp;rules\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;should&nbsp;be&nbsp;a&nbsp;list&nbsp;of&nbsp;`regex`-`function`&nbsp;pairs&nbsp;where&nbsp;`function`&nbsp;takes\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;jinja2&nbsp;Environment,&nbsp;the&nbsp;filename,&nbsp;and&nbsp;the&nbsp;context&nbsp;and&nbsp;builds&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;template,&nbsp;and&nbsp;`regex`&nbsp;is&nbsp;a&nbsp;regex&nbsp;that&nbsp;if&nbsp;matched&nbsp;against&nbsp;a&nbsp;filename\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;cause&nbsp;`function`&nbsp;to&nbsp;be&nbsp;used&nbsp;instead&nbsp;of&nbsp;the&nbsp;default.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13">(<span id="ast-14" class="other_trans">contexts</span><span id="ast-15" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-16">None</span>)</span>:<span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>contexts</span>&nbsp;=&nbsp;<span id="ast-19">[]</span></span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-21">(<span id="ast-22" class="other_trans">filter_func</span><span id="ast-23" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-24" class="other_trans">None</span>)</span>:<span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>filter_func</span>&nbsp;=&nbsp;<span id="ast-27">should_render</span></span></span><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-29">(<span id="ast-30" class="other_trans">rules</span><span id="ast-31" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-32">None</span>)</span>:<span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rules</span>&nbsp;=&nbsp;<span id="ast-35">[]</span></span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-37" class="other_trans">template_name</span>&nbsp;in&nbsp;<span id="ast-38"><span id="ast-39"><span id="ast-40" class="other_trans">env</span>.list_templates</span>(filter_func=<span id="ast-42" class="other_trans">filter_func</span>)</span>:<span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-44">(<span id="ast-45">'Building&nbsp;%s...'</span>&nbsp;%&nbsp;<span id="ast-47" class="other_trans">template_name</span>)</span></span><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>filename</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53" class="other_trans">env</span>.get_template</span>(<span id="ast-54" class="other_trans">template_name</span>)</span>.filename</span></span><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-56">(<span id="ast-57" class="other_trans">regex</span>,&nbsp;<span id="ast-58" class="other_trans">context_generator</span>)</span>&nbsp;in&nbsp;<span id="ast-59" class="other_trans">contexts</span>:<span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">re</span>.match</span>(<span id="ast-64" class="other_trans">regex</span>,&nbsp;<span id="ast-65" class="ref_node">filename&nbsp;&rarr;&nbsp;template_name&nbsp;</span>)</span>:<span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>context</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70" class="other_trans">context_generator</span>(<span id="ast-71" class="other_trans">filename</span>)</span></span><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-73" class="other_trans">TypeError</span>:<span id="ast-74"><span id="ast-75"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>context</span>&nbsp;=&nbsp;<span id="ast-76"><span id="ast-77" class="other_trans">context_generator</span>()</span></span></span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-79"><span id="ast-80" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>context</span>&nbsp;=&nbsp;<span id="ast-81">{}</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">stream_file</span>,&nbsp;<span id="ast-5" class="other_trans">attachments</span>,&nbsp;<span id="ast-7" class="other_trans">attr_regex</span>,&nbsp;<span id="ast-9" class="other_trans">targets</span></span>):<span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-13" class="other_trans">targets</span><span id="ast-14" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-15" class="other_trans">None</span>)</span>:<span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>targets</span>&nbsp;=&nbsp;<span id="ast-18">[]</span></span></span><span id="ast-19"><span id="ast-20"><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.stream_file</span>&nbsp;=&nbsp;<span id="ast-22" class="other_trans">stream_file</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.stream</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans">subunit</span>.ByteStreamToStreamResult</span>(<span id="ast-29" class="ref_node">stream_file&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>starts</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans">testtools</span>.StreamResult</span>()</span></span><span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>summary</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">testtools</span>.StreamSummary</span>()</span></span><span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>outcomes</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">testtools</span>.StreamToDict</span>(<span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans">functools</span>.partial</span>(<span id="ast-48"><span id="ast-49">self</span>.parse_outcome</span>)</span>)</span></span><span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>targets</span>.extend</span>(<span id="ast-54">[<span id="ast-55" class="other_trans">starts</span>,&nbsp;<span id="ast-56" class="other_trans">outcomes</span>,&nbsp;<span id="ast-57" class="other_trans">summary</span>]</span>)</span></span><span id="ast-58"><span id="ast-59"><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.result</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">testtools</span>.CopyStreamResult</span>(<span id="ast-64" class="other_trans">targets</span>)</span></span><span id="ast-65"><span id="ast-66"><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.results</span>&nbsp;=&nbsp;<span id="ast-68">{}</span></span><span id="ast-69"><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attachments</span>&nbsp;=&nbsp;<span id="ast-72" class="other_trans">attachments</span></span><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-74" class="incorrect_node">attr_regex&nbsp;&rarr;&nbsp;attachments&nbsp;</span>:<span id="ast-75"><span id="ast-76"><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_regex</span>&nbsp;=&nbsp;<span id="ast-78"><span id="ast-79"><span id="ast-80" class="other_trans">re</span>.compile</span>(<span id="ast-81" class="other_trans">attr_regex</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-82"><span id="ast-83"><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_regex</span>&nbsp;=&nbsp;<span id="ast-85"><span id="ast-86"><span id="ast-87" class="other_trans">re</span>.compile</span>(<span id="ast-88">'\\\\[(.*)\\\\]'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;display(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">image</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Takes&nbsp;an&nbsp;image,&nbsp;scales&nbsp;it&nbsp;according&nbsp;to&nbsp;the&nbsp;nominated&nbsp;transform,&nbsp;and\\u000a&nbsp;&nbsp;&nbsp;&nbsp;stores&nbsp;it&nbsp;for&nbsp;later&nbsp;building&nbsp;into&nbsp;an&nbsp;animated&nbsp;GIF.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-8">(<span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">image</span>.size</span>[<span id="ast-12"><span id="ast-13">0</span></span>]</span><span id="ast-14" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-15"><span id="ast-16">self</span>.width</span>)</span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-18">(<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans">image</span>.size</span>[<span id="ast-22"><span id="ast-23">1</span></span>]</span><span id="ast-24" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-25"><span id="ast-26">self</span>.height</span>)</span></span><span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>surface</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31">self</span>.to_surface</span>(<span id="ast-32" class="other_trans">image</span>)</span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>rawbytes</span>&nbsp;=&nbsp;<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39">self</span>._pygame</span>.image</span>.tostring</span>(<span id="ast-40" class="other_trans">surface</span>,&nbsp;<span id="ast-41">'RGB'</span>,&nbsp;<span id="ast-42">False</span>)</span></span><span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>im</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans">Image</span>.frombytes</span>(<span id="ast-48"><span id="ast-49">self</span>.mode</span>,&nbsp;<span id="ast-50">(<span id="ast-51">(<span id="ast-52"><span id="ast-53">self</span>.width</span>&nbsp;*&nbsp;<span id="ast-55"><span id="ast-56">self</span>.scale</span>)</span>,&nbsp;<span id="ast-57">(<span id="ast-58"><span id="ast-59">self</span>.height</span>&nbsp;*&nbsp;<span id="ast-61"><span id="ast-62">self</span>.scale</span>)</span>)</span>,&nbsp;<span id="ast-63" class="other_trans">rawbytes</span>)</span></span><span id="ast-64"><span id="ast-65"><span id="ast-66"><span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._images</span>.append</span>(<span id="ast-69" class="other_trans">im</span>)</span></span><span id="ast-70"><span id="ast-71"><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._count</span>&nbsp;+=&nbsp;<span id="ast-74">1</span></span><span id="ast-75"><span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.stdout</span>.write</span>(<span id="ast-80"><span id="ast-81"><span id="ast-82">'Recording&nbsp;frame:&nbsp;{0}\\u000d'</span>.format</span>(<span id="ast-83"><span id="ast-84">self</span>._count</span>)</span>)</span></span><span id="ast-85"><span id="ast-86"><span id="ast-87"><span id="ast-88"><span id="ast-89" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.stdout</span>.flush</span>()</span></span><span id="ast-90"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-91">(<span id="ast-93"><span id="ast-94">self</span>._max_frames</span>&nbsp;and&nbsp;<span id="ast-95">(<span id="ast-96"><span id="ast-97">self</span>._count</span><span id="ast-98" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-99"><span id="ast-100">self</span>._max_frames</span>)</span>)</span>:<span id="ast-101"><span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.exit</span>(<span id="ast-105">0</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;chain(<span id="ast-2"><span id="ast-3">_cosmo</span>,&nbsp;<span id="ast-4">data</span>,&nbsp;<span id="ast-5" class="other_trans">command_line</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>num_failure</span>&nbsp;=&nbsp;<span id="ast-8">10</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>loglike</span>&nbsp;=&nbsp;<span id="ast-11">0</span></span><span id="ast-12"><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>failure</span>&nbsp;=&nbsp;<span id="ast-14">False</span></span><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-17">sigma_eig</span>,&nbsp;<span id="ast-18">U</span>)</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20">get_cov</span>(<span id="ast-21">data</span>,&nbsp;<span id="ast-22" class="other_trans">command_line</span>)</span></span><span id="ast-23"><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>failed</span>&nbsp;=&nbsp;<span id="ast-25">0</span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-27">(<span id="ast-28"><span id="ast-29" class="other_trans">command_line</span>.restart</span><span id="ast-30" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-31">None</span>)</span>:<span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>read_args_from_chain</span>(<span id="ast-35">data</span>,&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">command_line</span>.restart</span>)</span></span></span><span id="ast-38"><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>get_new_pos</span>(<span id="ast-41">data</span>,&nbsp;<span id="ast-42">sigma_eig</span>,&nbsp;<span id="ast-43">U</span>,&nbsp;<span id="ast-44">failed</span>)</span></span><span id="ast-45"><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-47">failure</span>,&nbsp;<span id="ast-48" class="other_trans">loglike</span>)</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50">compute_lkl</span>(<span id="ast-51" class="other_trans">_cosmo</span>,&nbsp;<span id="ast-52" class="other_trans">data</span>)</span></span><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-54">(<span id="ast-56">(<span id="ast-57" class="other_trans">failure</span><span id="ast-58" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-59">True</span>)</span>&nbsp;and&nbsp;<span id="ast-60">(<span id="ast-61" class="other_trans">failed</span><span id="ast-62" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-63">num_failure</span>)</span>)</span>:<span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>failed</span>&nbsp;+=&nbsp;<span id="ast-67">1</span></span><span id="ast-68"><span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>get_new_pos</span>(<span id="ast-71" class="other_trans">data</span>,&nbsp;<span id="ast-72" class="other_trans">sigma_eig</span>,&nbsp;<span id="ast-73" class="other_trans">U</span>,&nbsp;<span id="ast-74" class="other_trans">failed</span>)</span></span><span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-77">failure</span>,&nbsp;<span id="ast-78">loglike</span>)</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80">compute_lkl</span>(<span id="ast-81" class="other_trans">_cosmo</span>,&nbsp;<span id="ast-82">data</span>)</span></span></span><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-84">(<span id="ast-85">failure</span><span id="ast-86" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-87">True</span>)</span>:<span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-89"><span id="ast-90"><span id="ast-91">'&nbsp;/|\\\\&nbsp;&nbsp;&nbsp;Class&nbsp;tried&nbsp;{0}&nbsp;times&nbsp;to&nbsp;initialize&nbsp;with&nbsp;given&nbsp;parameters,&nbsp;and&nbsp;failed...'</span>.format</span>(<span id="ast-92">(<span id="ast-93" class="other_trans">num_failure</span>&nbsp;+&nbsp;<span id="ast-95">2</span>)</span>)</span></span><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-97">'/_o_\\\\&nbsp;&nbsp;You&nbsp;might&nbsp;want&nbsp;to&nbsp;change&nbsp;your&nbsp;starting&nbsp;values,&nbsp;or&nbsp;pick&nbsp;default&nbsp;ones!'</span></span><span id="ast-98"><span id="ast-99"><span id="ast-100" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>exit</span>()</span></span></span><span id="ast-101"><span id="ast-102"><span id="ast-103" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>accept_step</span>(<span id="ast-104">data</span>)</span></span><span id="ast-105"><span id="ast-106"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>max_loglike</span>&nbsp;=&nbsp;<span id="ast-107" class="other_trans">loglike</span></span><span id="ast-108"><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-110">acc</span>,&nbsp;<span id="ast-111">rej</span>)</span>&nbsp;=&nbsp;<span id="ast-112">(<span id="ast-113">0.0</span>,&nbsp;<span id="ast-114">0.0</span>)</span></span><span id="ast-115"><span id="ast-116" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>N</span>&nbsp;=&nbsp;<span id="ast-117">1</span></span><span id="ast-118"><span id="ast-119"><span id="ast-120"><span id="ast-121"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>io</span>.print_parameters</span>(<span id="ast-122"><span id="ast-123">sys</span>.stdout</span>,&nbsp;<span id="ast-124" class="other_trans">data</span>)</span></span><span id="ast-125"><span id="ast-126"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>k</span>&nbsp;=&nbsp;<span id="ast-127">1</span></span><span id="ast-128"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-129">(<span id="ast-131">(<span id="ast-132" class="other_trans">k</span><span id="ast-133" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-134"><span id="ast-135" class="other_trans">command_line</span>.N</span>)</span>&nbsp;and&nbsp;<span id="ast-136">(<span id="ast-137" class="other_trans">failed</span><span id="ast-138" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-139" class="other_trans">num_failure</span>)</span>)</span>:<span id="ast-140"><span id="ast-141"><span id="ast-142"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>get_new_pos</span>(<span id="ast-143" class="other_trans">data</span>,&nbsp;<span id="ast-144">sigma_eig</span>,&nbsp;<span id="ast-145" class="other_trans">U</span>,&nbsp;<span id="ast-146" class="ref_node">failed&nbsp;&rarr;&nbsp;k&nbsp;</span>)</span></span><span id="ast-147"><span id="ast-148"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-149">failure</span>,&nbsp;<span id="ast-150">newloglike</span>)</span>&nbsp;=&nbsp;<span id="ast-151"><span id="ast-152">compute_lkl</span>(<span id="ast-153" class="other_trans">_cosmo</span>,&nbsp;<span id="ast-154" class="other_trans">data</span>)</span></span><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-156">(<span id="ast-157">failure</span><span id="ast-158" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-159">True</span>)</span>:<span id="ast-160"><span id="ast-161"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>failed</span>&nbsp;+=&nbsp;<span id="ast-163">1</span></span><span id="ast-164"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-165">'Warning:&nbsp;Class&nbsp;failed&nbsp;due&nbsp;to&nbsp;choice&nbsp;of&nbsp;parameters,&nbsp;picking&nbsp;up&nbsp;new&nbsp;values'</span></span><span id="ast-166"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-167"><span id="ast-168" class="other_trans">data</span>.Class_arguments</span></span><span id="ast-169"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_create_wsgi_environ(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">json_headers</span>,&nbsp;<span id="ast-5" class="other_trans">body</span></span>):<span id="ast-7"><span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>json_headers</span>.pop</span>(<span id="ast-11">'URI'</span>,&nbsp;<span id="ast-12" class="other_trans">None</span>)</span></span><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-17"><span id="ast-18">'wsgi.multithread'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-19">False</span></span><span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-24"><span id="ast-25">'wsgi.multiprocess'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-26">True</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-31"><span id="ast-32">'wsgi.run_once'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-33">True</span></span><span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-38"><span id="ast-39">'wsgi.version'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-40">(<span id="ast-41">1</span>,&nbsp;<span id="ast-42">0</span>)</span></span><span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-47"><span id="ast-48">self</span>.environ</span>,&nbsp;<span id="ast-49">'wsgi.url_scheme'</span>,&nbsp;<span id="ast-50">'http'</span>)</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52" class="other_trans">body</span>:<span id="ast-53"><span id="ast-54"><span id="ast-55"><span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-57"><span id="ast-58">'wsgi.input'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-59"><span id="ast-60">StringIO</span>(<span id="ast-61">body</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-66"><span id="ast-67">'wsgi.input'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69" class="other_trans">StringIO</span>(<span id="ast-70">''</span>)</span></span></span><span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-75"><span id="ast-76">self</span>.environ</span>,&nbsp;<span id="ast-77">'REQUEST_METHOD'</span>,&nbsp;<span id="ast-78"><span id="ast-79"><span id="ast-80" class="other_trans">json_headers</span>.pop</span>(<span id="ast-81">'METHOD'</span>)</span>)</span></span><span id="ast-82"><span id="ast-83"><span id="ast-84"><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-86"><span id="ast-87">self</span>.environ</span>,&nbsp;<span id="ast-88">'SERVER_PROTOCOL'</span>,&nbsp;<span id="ast-89"><span id="ast-90"><span id="ast-91" class="other_trans">json_headers</span>.pop</span>(<span id="ast-92">'VERSION'</span>)</span>)</span></span><span id="ast-93"><span id="ast-94"><span id="ast-95"><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-97"><span id="ast-98">self</span>.environ</span>,&nbsp;<span id="ast-99">'SCRIPT_NAME'</span>,&nbsp;<span id="ast-100"><span id="ast-101"><span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans">json_headers</span>.pop</span>(<span id="ast-105">'PATTERN'</span>)</span>.rstrip</span>(<span id="ast-106">'/'</span>)</span>)</span></span><span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-111"><span id="ast-112">self</span>.environ</span>,&nbsp;<span id="ast-113">'QUERY_STRING'</span>,&nbsp;<span id="ast-114"><span id="ast-115"><span id="ast-116" class="other_trans">json_headers</span>.pop</span>(<span id="ast-117">'QUERY'</span>,&nbsp;<span id="ast-118">''</span>)</span>)</span></span><span id="ast-119"><span id="ast-120" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>script_name</span>&nbsp;=&nbsp;<span id="ast-121"><span id="ast-122"><span id="ast-123">self</span>.environ</span>[<span id="ast-124"><span id="ast-125">'SCRIPT_NAME'</span></span>]</span></span><span id="ast-126"><span id="ast-127" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>path_info</span>&nbsp;=&nbsp;<span id="ast-128"><span id="ast-129"><span id="ast-130"><span id="ast-131" class="other_trans">json_headers</span>.pop</span>(<span id="ast-132">'PATH'</span>)</span>[<span id="ast-133"><span id="ast-134"><span id="ast-135">len</span>(<span id="ast-136" class="other_trans">script_name</span>)</span>:</span>]</span></span><span id="ast-137"><span id="ast-138"><span id="ast-139"><span id="ast-140"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-141"><span id="ast-142">self</span>.environ</span>,&nbsp;<span id="ast-143">'PATH_INFO'</span>,&nbsp;<span id="ast-144"><span id="ast-145"><span id="ast-146" class="other_trans">urllib</span>.unquote</span>(<span id="ast-147" class="other_trans">path_info</span>)</span>)</span></span><span id="ast-148"><span id="ast-149" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>server_port</span>&nbsp;=&nbsp;<span id="ast-150">'80'</span></span><span id="ast-151"><span id="ast-152" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>host_header</span>&nbsp;=&nbsp;<span id="ast-153"><span id="ast-154"><span id="ast-155" class="other_trans">json_headers</span>.pop</span>(<span id="ast-156">'host'</span>)</span></span><span id="ast-157"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-158">(<span id="ast-159">':'</span><span id="ast-160">&nbsp;in&nbsp;</span><span id="ast-161" class="other_trans">host_header</span>)</span>:<span id="ast-162"><span id="ast-163"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-164">server_name</span>,&nbsp;<span id="ast-165" class="other_trans">server_port</span>)</span>&nbsp;=&nbsp;<span id="ast-166"><span id="ast-167"><span id="ast-168" class="other_trans">host_header</span>.split</span>(<span id="ast-169">':'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-170"><span id="ast-171" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>server_name</span>&nbsp;=&nbsp;<span id="ast-172" class="other_trans">host_header</span></span></span><span id="ast-173"><span id="ast-174"><span id="ast-175"><span id="ast-176"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-177"><span id="ast-178">self</span>.environ</span>,&nbsp;<span id="ast-179">'HTTP_HOST'</span>,&nbsp;<span id="ast-180" class="location_node">server_name&nbsp;&rarr;&nbsp;host_header,&nbsp;pred:&nbsp;server_port&nbsp;</span>)</span></span><span id="ast-181"><span id="ast-182"><span id="ast-183"><span id="ast-184"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-185"><span id="ast-186">self</span>.environ</span>,&nbsp;<span id="ast-187">'SERVER_PORT'</span>,&nbsp;<span id="ast-188" class="other_trans">server_port</span>)</span></span><span id="ast-189"><span id="ast-190"><span id="ast-191"><span id="ast-192"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-193"><span id="ast-194">self</span>.environ</span>,&nbsp;<span id="ast-195">'SERVER_NAME'</span>,&nbsp;<span id="ast-196" class="other_trans">server_name</span>)</span></span><span id="ast-197"><span id="ast-198"><span id="ast-199"><span id="ast-200"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-201"><span id="ast-202">self</span>.environ</span>,&nbsp;<span id="ast-203">'CONTENT_TYPE'</span>,&nbsp;<span id="ast-204"><span id="ast-205"><span id="ast-206">json_headers</span>.pop</span>(<span id="ast-207">'content-type'</span>,&nbsp;<span id="ast-208">''</span>)</span>)</span></span><span id="ast-209"><span id="ast-210"><span id="ast-211"><span id="ast-212"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-213"><span id="ast-214">'content-type'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-215"><span id="ast-216"><span id="ast-217">self</span>.environ</span>[<span id="ast-218"><span id="ast-219">'CONTENT_TYPE'</span></span>]</span></span><span id="ast-220"><span id="ast-221"><span id="ast-222"><span id="ast-223"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._set</span>(<span id="ast-224"><span id="ast-225">self</span>.environ</span>,&nbsp;<span id="ast-226">'CONTENT_LENGTH'</span>,&nbsp;<span id="ast-227"><span id="ast-228"><span id="ast-229" class="other_trans">json_headers</span>.pop</span>(<span id="ast-230">'content-length'</span>,&nbsp;<span id="ast-231">''</span>)</span>)</span></span><span id="ast-232"><span id="ast-233"><span id="ast-234"><span id="ast-235"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.environ</span>[<span id="ast-236"><span id="ast-237">'content-length'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-238"><span id="ast-239"><span id="ast-240">self</span>.environ</span>[<span id="ast-241"><span id="ast-242">'CONTENT_LENGTH'</span></span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;post(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>username</span>&nbsp;=&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8"><span id="ast-9">self</span>.request</span>.get</span>(<span id="ast-10">'username'</span>)</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>password</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.request</span>.get</span>(<span id="ast-17">'password'</span>)</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>username_code</span>&nbsp;=&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">util</span>.get_code</span>(<span id="ast-23" class="other_trans">username</span>)</span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">runners</span>.Runners</span>.get_by_key_name</span>(<span id="ast-30" class="other_trans">username_code</span>,&nbsp;parent=<span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans">runners</span>.key</span>()</span>)</span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-36">(<span id="ast-37">not</span>&nbsp;<span id="ast-38" class="other_trans">user</span>)</span>:<span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-43">'login.html'</span>,&nbsp;username=<span id="ast-45" class="other_trans">username</span>,&nbsp;error=<span id="ast-47">'Invalid&nbsp;login'</span>)</span></span><span id="ast-48"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52" class="other_trans">util</span>.valid_pw</span>(<span id="ast-53" class="ref_node">username&nbsp;&rarr;&nbsp;username_code&nbsp;</span>,&nbsp;<span id="ast-54" class="other_trans">password</span>,&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">user</span>.password</span>)</span>:<span id="ast-57"><span id="ast-58"><span id="ast-59"><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.login</span>(<span id="ast-61" class="incorrect_node">username_code&nbsp;&rarr;&nbsp;username&nbsp;</span>)</span></span><span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.goto_return_url</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-66"><span id="ast-67"><span id="ast-68"><span id="ast-69"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-70">'login.html'</span>,&nbsp;username=<span id="ast-72" class="other_trans">username</span>,&nbsp;error=<span id="ast-74">'Invalid&nbsp;login'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_markup_choices(<span id="ast-2"></span>):<span id="ast-3"><span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Receives&nbsp;available&nbsp;markup&nbsp;options&nbsp;as&nbsp;list.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>available_reader_list</span>&nbsp;=&nbsp;<span id="ast-7">[]</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>module_dir</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13" class="other_trans">os</span>.path</span>.realpath</span>(<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans">os</span>.path</span>.dirname</span>(<span id="ast-18">__file__</span>)</span>)</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>module_names</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22" class="other_trans">filter</span>(<span id="ast-23">lambda&nbsp;<span id="ast-24"><span id="ast-25" class="other_trans">x</span></span>:&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans">x</span>.endswith</span>(<span id="ast-29">'.py'</span>)</span></span>,&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32" class="other_trans">os</span>.listdir</span>(<span id="ast-33" class="other_trans">module_dir</span>)</span>)</span></span><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-35" class="other_trans">module_name</span>&nbsp;in&nbsp;<span id="ast-36" class="other_trans">module_names</span>:<span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-38"><span id="ast-39"><span id="ast-40" class="other_trans">module_name</span>.startswith</span>(<span id="ast-41">'__'</span>)</span>:<span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49">os</span>.path</span>.splitext</span>(<span id="ast-50" class="other_trans">module_name</span>)</span>[<span id="ast-51"><span id="ast-52">0</span></span>]</span></span><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>reader</span>&nbsp;=&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">get_reader</span>(name=<span id="ast-58" class="other_trans">name</span>)</span></span><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-60">(<span id="ast-61"><span id="ast-62" class="other_trans">reader</span>.enabled</span><span id="ast-63" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-64">True</span>)</span>:<span id="ast-65"><span id="ast-66"><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>available_reader_list</span>.append</span>(<span id="ast-69">(<span id="ast-70" class="ref_node">module_name&nbsp;&rarr;&nbsp;name&nbsp;</span>,&nbsp;<span id="ast-71"><span id="ast-72" class="other_trans">reader</span>.name</span>)</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_find_working_version(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">version</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>versions_available</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>._fetch_available_versions</span>()</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-13">Exception</span>&nbsp;as&nbsp;<span id="ast-14" class="other_trans">e</span>:<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-19">'Unable&nbsp;to&nbsp;read&nbsp;openstack&nbsp;versions&nbsp;from&nbsp;%s&nbsp;due&nbsp;to:&nbsp;%s'</span>,&nbsp;<span id="ast-20"><span id="ast-21">self</span>.base_path</span>,&nbsp;<span id="ast-22" class="other_trans">e</span>)</span></span><span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>versions_available</span>&nbsp;=&nbsp;<span id="ast-25">[]</span></span></span></span><span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>supported</span>&nbsp;=&nbsp;<span id="ast-28">[<span id="ast-29">v</span><span id="ast-30">&nbsp;for&nbsp;<span id="ast-31" class="other_trans">v</span>&nbsp;in&nbsp;<span id="ast-32"><span id="ast-33">reversed</span>(<span id="ast-34"><span id="ast-35">list</span>(<span id="ast-36">OS_VERSIONS</span>)</span>)</span></span>]</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-38">(<span id="ast-39" class="other_trans">version</span><span id="ast-40" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-41" class="other_trans">None</span>)</span>:<span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>search_versions</span>&nbsp;=&nbsp;<span id="ast-44">(<span id="ast-45">[<span id="ast-46" class="other_trans">version</span>]</span>&nbsp;+&nbsp;<span id="ast-48" class="other_trans">supported</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>search_versions</span>&nbsp;=&nbsp;<span id="ast-51" class="other_trans">supported</span></span></span><span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>selected_version</span>&nbsp;=&nbsp;<span id="ast-54">OS_LATEST</span></span><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-56" class="other_trans">potential_version</span>&nbsp;in&nbsp;<span id="ast-57" class="other_trans">search_versions</span>:<span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59">(<span id="ast-60" class="other_trans">potential_version</span><span id="ast-61">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-62" class="other_trans">versions_available</span>)</span>:<span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>selected_version</span>&nbsp;=&nbsp;<span id="ast-66" class="other_trans">potential_version</span></span><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-69">(<span id="ast-71">(<span id="ast-72" class="other_trans">version</span><span id="ast-73" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-74" class="other_trans">None</span>)</span>&nbsp;and&nbsp;<span id="ast-75">(<span id="ast-76" class="other_trans">selected_version</span><span id="ast-77" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-78" class="other_trans">version</span>)</span>)</span>:<span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.warn</span>(<span id="ast-83">"Version&nbsp;'%s'&nbsp;not&nbsp;available,&nbsp;attempting&nbsp;to&nbsp;use&nbsp;version&nbsp;'%s'&nbsp;instead"</span>,&nbsp;<span id="ast-84" class="other_trans">version</span>,&nbsp;<span id="ast-85">selected_version</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-86"><span id="ast-87"><span id="ast-88"><span id="ast-89" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-90">"Selected&nbsp;version&nbsp;'%s'&nbsp;from&nbsp;%s"</span>,&nbsp;<span id="ast-91" class="ref_node">version&nbsp;&rarr;&nbsp;selected_version&nbsp;</span>,&nbsp;<span id="ast-92" class="incorrect_node">versions_available&nbsp;&rarr;&nbsp;selected_version&nbsp;</span>)</span></span></span><span id="ast-93"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-94" class="other_trans">selected_version</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;to_vega(<span id="ast-2"><span id="ast-3" class="other_trans">df</span>,&nbsp;<span id="ast-4" class="other_trans">vega_type</span>,&nbsp;<span id="ast-5" class="other_trans">grid</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Convert&nbsp;dataframe&nbsp;to&nbsp;vega.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>stacked</span>&nbsp;=&nbsp;<span id="ast-11">(<span id="ast-12"><span id="ast-13" class="other_trans">len</span>(<span id="ast-14"><span id="ast-15" class="other_trans">df</span>.columns</span>)</span><span id="ast-16" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-17">2</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;ffmpeg(<span id="ast-2"><span id="ast-3" class="other_trans">dst</span>,&nbsp;<span id="ast-4" class="other_trans">frame_path</span>,&nbsp;<span id="ast-5" class="other_trans">framerate</span>,&nbsp;<span id="ast-7">codec</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Run&nbsp;FFmpeg&nbsp;in&nbsp;a&nbsp;subprocess&nbsp;to&nbsp;convert&nbsp;an&nbsp;image&nbsp;sequence&nbsp;into&nbsp;a&nbsp;movie\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;dst&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Destination&nbsp;path.&nbsp;If&nbsp;the&nbsp;extension&nbsp;is&nbsp;not&nbsp;".mov"&nbsp;or&nbsp;".avi",&nbsp;".mov"&nbsp;is\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;added.&nbsp;If&nbsp;the&nbsp;file&nbsp;already&nbsp;exists&nbsp;it&nbsp;is&nbsp;overwritten.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;frame_path&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Path&nbsp;to&nbsp;the&nbsp;source&nbsp;frames&nbsp;(with&nbsp;a&nbsp;frame&nbsp;number&nbsp;field&nbsp;like&nbsp;\'%04d\').\\u000a&nbsp;&nbsp;&nbsp;&nbsp;framerate&nbsp;:&nbsp;float\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Framerate&nbsp;of&nbsp;the&nbsp;movie&nbsp;(frames&nbsp;per&nbsp;second,&nbsp;default&nbsp;24).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;codec&nbsp;:&nbsp;str&nbsp;|&nbsp;None\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Codec&nbsp;to&nbsp;use&nbsp;(default&nbsp;\'mpeg4\').&nbsp;If&nbsp;None,&nbsp;the&nbsp;codec&nbsp;argument&nbsp;is&nbsp;not\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forwarded&nbsp;to&nbsp;ffmpeg,&nbsp;which&nbsp;preserves&nbsp;compatibility&nbsp;with&nbsp;very&nbsp;old\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;versions&nbsp;of&nbsp;ffmpeg\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Notes\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-----\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Requires&nbsp;FFmpeg&nbsp;to&nbsp;be&nbsp;in&nbsp;the&nbsp;path.&nbsp;FFmpeg&nbsp;can&nbsp;be&nbsp;downlaoded&nbsp;from&nbsp;`here\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&lt;http://ffmpeg.org/download.html&gt;`_.&nbsp;Stdout&nbsp;and&nbsp;stderr&nbsp;are&nbsp;written&nbsp;to&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;logger.&nbsp;If&nbsp;the&nbsp;movie&nbsp;file&nbsp;is&nbsp;not&nbsp;created,&nbsp;a&nbsp;RuntimeError&nbsp;is&nbsp;raised.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-11"><span id="ast-12"><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assert_ffmpeg_is_available</span>()</span></span><span id="ast-14"><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dst</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19" class="other_trans">os</span>.path</span>.expanduser</span>(<span id="ast-20" class="other_trans">dst</span>)</span></span><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dst</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24"><span id="ast-25"><span id="ast-26">os</span>.path</span>.abspath</span>(<span id="ast-27" class="other_trans">dst</span>)</span></span><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-30">root</span>,&nbsp;<span id="ast-31" class="other_trans">ext</span>)</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34"><span id="ast-35">os</span>.path</span>.splitext</span>(<span id="ast-36" class="other_trans">dst</span>)</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dirname</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42" class="other_trans">os</span>.path</span>.dirname</span>(<span id="ast-43" class="other_trans">dst</span>)</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-46" class="other_trans">ext</span><span id="ast-47">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-48">[<span id="ast-49">'.mov'</span>,&nbsp;<span id="ast-50">'.avi'</span>]</span>)</span>:<span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dst</span>&nbsp;+=&nbsp;<span id="ast-54">'.mov'</span></span></span><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-60" class="other_trans">dst</span>)</span>:<span id="ast-61"><span id="ast-62"><span id="ast-63"><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.remove</span>(<span id="ast-65">dst</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-67">(<span id="ast-68">not</span>&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72">os</span>.path</span>.exists</span>(<span id="ast-73" class="other_trans">dirname</span>)</span>)</span>:<span id="ast-74"><span id="ast-75"><span id="ast-76"><span id="ast-77" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.mkdir</span>(<span id="ast-78" class="other_trans">dirname</span>)</span></span></span><span id="ast-79"><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-81" class="other_trans">frame_dir</span>,&nbsp;<span id="ast-82" class="other_trans">frame_fmt</span>)</span>&nbsp;=&nbsp;<span id="ast-83"><span id="ast-84"><span id="ast-85"><span id="ast-86" class="other_trans">os</span>.path</span>.split</span>(<span id="ast-87" class="other_trans">frame_path</span>)</span></span><span id="ast-88"><span id="ast-89" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd</span>&nbsp;=&nbsp;<span id="ast-90">[<span id="ast-91">'ffmpeg'</span>,&nbsp;<span id="ast-92">'-i'</span>,&nbsp;<span id="ast-93" class="other_trans">frame_fmt</span>,&nbsp;<span id="ast-94">'-r'</span>,&nbsp;<span id="ast-95"><span id="ast-96">str</span>(<span id="ast-97" class="other_trans">framerate</span>)</span>]</span></span><span id="ast-98"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-99">(<span id="ast-100" class="other_trans">codec</span><span id="ast-101" class="correct_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-102">None</span>)</span>:<span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd</span>&nbsp;+=&nbsp;<span id="ast-106">[<span id="ast-107">'-c'</span>,&nbsp;<span id="ast-108">codec</span>]</span></span></span><span id="ast-109"><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd</span>&nbsp;+=&nbsp;<span id="ast-112">[<span id="ast-113">dst</span>]</span></span><span id="ast-114"><span id="ast-115"><span id="ast-116"><span id="ast-117"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.info</span>(<span id="ast-118">'Running&nbsp;FFmpeg&nbsp;with&nbsp;command:&nbsp;%s'</span>,&nbsp;<span id="ast-119"><span id="ast-120"><span id="ast-121">'&nbsp;'</span>.join</span>(<span id="ast-122" class="other_trans">cmd</span>)</span>)</span></span><span id="ast-123"><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sp</span>&nbsp;=&nbsp;<span id="ast-125"><span id="ast-126"><span id="ast-127" class="other_trans">subprocess</span>.Popen</span>(<span id="ast-128">cmd</span>,&nbsp;cwd=<span id="ast-130" class="other_trans">frame_dir</span>,&nbsp;stdout=<span id="ast-132"><span id="ast-133">subprocess</span>.PIPE</span>,&nbsp;stderr=<span id="ast-135"><span id="ast-136" class="other_trans">subprocess</span>.PIPE</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;post(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8">auth</span>.getCurrentUser</span>()</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>&nbsp;=&nbsp;<span id="ast-11">{}</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13" class="other_trans">user</span>:<span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user_data</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19">models</span>.getUser</span>(<span id="ast-20" class="other_trans">user</span>)</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-22"><span id="ast-23" class="other_trans">models</span>.UserDoesNotExistError</span>:<span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user_data</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30">models</span>.UserData</span>(user=<span id="ast-32">user</span>)</span>.save</span>()</span></span></span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38">self</span>.request</span>.get</span>(<span id="ast-39">'name'</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41">(<span id="ast-42">not</span>&nbsp;<span id="ast-43" class="other_trans">name</span>)</span>:<span id="ast-44"><span id="ast-45"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-46">'Chrome'</span></span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>device</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52">models</span>.getDevice</span>(<span id="ast-53">(<span id="ast-54">'%s/%s'</span>&nbsp;%&nbsp;<span id="ast-56">(<span id="ast-57"><span id="ast-58"><span id="ast-59" class="other_trans">user</span>.email</span>()</span>,&nbsp;<span id="ast-60">name</span>)</span>)</span>)</span></span><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-62"><span id="ast-63">models</span>.DeviceDoesNotExistError</span>:<span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>device</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70">models</span>.DeviceData</span>(name=<span id="ast-72" class="other_trans">name</span>,&nbsp;user=<span id="ast-74">user_data</span>)</span>.save</span>()</span></span></span></span><span id="ast-75"><span id="ast-76" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiver</span>&nbsp;=&nbsp;<span id="ast-77" class="other_trans">None</span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82">self</span>.request</span>.get</span>(<span id="ast-83">'receiver'</span>)</span>:<span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-85"><span id="ast-86" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiver</span>&nbsp;=&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89">models</span>.getDevice</span>(<span id="ast-90">(<span id="ast-91">'%s/%s'</span>&nbsp;%&nbsp;<span id="ast-93">(<span id="ast-94"><span id="ast-95"><span id="ast-96">user</span>.email</span>()</span>,&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99"><span id="ast-100">self</span>.request</span>.get</span>(<span id="ast-101">'receiver'</span>)</span>)</span>)</span>)</span></span><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-103"><span id="ast-104" class="other_trans">models</span>.DeviceDoesNotExistError</span>:<span id="ast-105"><span id="ast-106" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiver</span>&nbsp;=&nbsp;<span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110"><span id="ast-111">models</span>.DeviceData</span>(name=<span id="ast-113"><span id="ast-114"><span id="ast-115"><span id="ast-116">self</span>.request</span>.get</span>(<span id="ast-117">'receiver'</span>)</span>,&nbsp;user=<span id="ast-119" class="other_trans">user_data</span>)</span>.save</span>()</span></span></span></span></span><span id="ast-120"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-121">(<span id="ast-122" class="other_trans">receiver</span><span id="ast-123" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-124">None</span>)</span>:<span id="ast-125"><span id="ast-126" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiver</span>&nbsp;=&nbsp;<span id="ast-127">device</span></span></span><span id="ast-128"><span id="ast-129" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>link</span>&nbsp;=&nbsp;<span id="ast-130"><span id="ast-131"><span id="ast-132"><span id="ast-133"><span id="ast-134">models</span>.LinkData</span>(url=<span id="ast-136"><span id="ast-137"><span id="ast-138"><span id="ast-139">self</span>.request</span>.get</span>(<span id="ast-140">'link'</span>)</span>,&nbsp;sender=<span id="ast-142" class="other_trans">device</span>,&nbsp;receiver=<span id="ast-144" class="other_trans">receiver</span>)</span>.save</span>()</span></span><span id="ast-145"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-146">(<span id="ast-147"><span id="ast-148"><span id="ast-149"><span id="ast-150" class="other_trans">models</span>.getQuota</span>()</span>.amount</span><span id="ast-151" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;<&nbsp;</span><span id="ast-152"><span id="ast-153"><span id="ast-154"><span id="ast-155">models</span>.getStats</span>(<span id="ast-156">'quota'</span>)</span>.count</span>)</span>:<span id="ast-157"><span id="ast-158" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>channel</span>&nbsp;=&nbsp;<span id="ast-159"><span id="ast-160"><span id="ast-161">channels</span>.Channel</span>(<span id="ast-162"><span id="ast-163" class="other_trans">receiver</span>.address</span>,&nbsp;<span id="ast-164">False</span>)</span></span><span id="ast-165"><span id="ast-166"><span id="ast-167"><span id="ast-168" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>channel</span>.sendLink</span>(<span id="ast-169">link</span>)</span></span><span id="ast-170"><span id="ast-171"><span id="ast-172" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-173"><span id="ast-174">'code'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-175">200</span></span><span id="ast-176"><span id="ast-177"><span id="ast-178"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-179"><span id="ast-180">'link'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-181"><span id="ast-182" class="other_trans">link</span>.url</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-183"><span id="ast-184"><span id="ast-185" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-186"><span id="ast-187">'code'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-188">503</span></span><span id="ast-189"><span id="ast-190"><span id="ast-191" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-192"><span id="ast-193">'link'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-194"><span id="ast-195" class="other_trans">link</span>.url</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-196"><span id="ast-197"><span id="ast-198" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-199"><span id="ast-200">'code'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-201">401</span></span><span id="ast-202"><span id="ast-203"><span id="ast-204" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>[<span id="ast-205"><span id="ast-206">'link'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-207"><span id="ast-208"><span id="ast-209"><span id="ast-210">self</span>.request</span>.get</span>(<span id="ast-211">'link'</span>)</span></span></span><span id="ast-212"><span id="ast-213"><span id="ast-214"><span id="ast-215"><span id="ast-216"><span id="ast-217"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.response</span>.out</span>.write</span>(<span id="ast-218"><span id="ast-219"><span id="ast-220">simplejson</span>.dumps</span>(<span id="ast-221">response</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;plot(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">offset</span>,&nbsp;<span id="ast-6" class="other_trans">color</span>,&nbsp;<span id="ast-8" class="other_trans">linestyle</span>,&nbsp;<span id="ast-10">linewidth</span>,&nbsp;<span id="ast-12" class="other_trans">errstyle</span>,&nbsp;<span id="ast-14">erralpha</span>,&nbsp;<span id="ast-16" class="other_trans">silent</span>,&nbsp;**kwargs</span>):<span id="ast-18"><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Plot&nbsp;the&nbsp;spectrum!\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Tries&nbsp;to&nbsp;automatically&nbsp;find&nbsp;a&nbsp;reasonable&nbsp;plotting&nbsp;range&nbsp;if&nbsp;one&nbsp;is&nbsp;not&nbsp;set.&nbsp;&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;-&nbsp;vertical&nbsp;offset&nbsp;to&nbsp;add&nbsp;to&nbsp;the&nbsp;spectrum&nbsp;before&nbsp;plotting.&nbsp;&nbsp;Useful&nbsp;if&nbsp;you\\u000a&nbsp;&nbsp;&nbsp;&nbsp;want&nbsp;to&nbsp;overlay&nbsp;multiple&nbsp;spectra&nbsp;on&nbsp;a&nbsp;single&nbsp;plot\\u000a&nbsp;&nbsp;&nbsp;&nbsp;color&nbsp;-&nbsp;default&nbsp;to&nbsp;plotting&nbsp;spectrum&nbsp;in&nbsp;black\\u000a&nbsp;&nbsp;&nbsp;&nbsp;linestyle&nbsp;-&nbsp;histogram-style&nbsp;plotting\\u000a&nbsp;&nbsp;&nbsp;&nbsp;linewidth&nbsp;-&nbsp;narrow&nbsp;lines&nbsp;are&nbsp;helpful&nbsp;when&nbsp;histo-plotting\\u000a&nbsp;&nbsp;&nbsp;&nbsp;xmin/xmax/ymin/ymax&nbsp;-&nbsp;override&nbsp;defaults&nbsp;for&nbsp;plot&nbsp;range.&nbsp;&nbsp;Once&nbsp;set,&nbsp;these&nbsp;parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;sticky&nbsp;(i.e.,&nbsp;replotting&nbsp;will&nbsp;use&nbsp;the&nbsp;same&nbsp;ranges)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;reset_[xy]limits&nbsp;-&nbsp;Reset&nbsp;the&nbsp;limits&nbsp;to&nbsp;"sensible&nbsp;defaults"&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;ypeakscale&nbsp;-&nbsp;Scale&nbsp;up&nbsp;the&nbsp;Y&nbsp;maximum&nbsp;value.&nbsp;&nbsp;Useful&nbsp;to&nbsp;keep&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;annotations&nbsp;away&nbsp;from&nbsp;the&nbsp;data.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-21">(<span id="ast-22"><span id="ast-23">self</span>.axis</span><span id="ast-24" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-25" class="other_trans">None</span>)</span>:<span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-27"><span id="ast-28" class="other_trans">Exception</span>(<span id="ast-29">'You&nbsp;must&nbsp;call&nbsp;the&nbsp;Plotter&nbsp;class&nbsp;to&nbsp;initiate&nbsp;the&nbsp;canvas&nbsp;before&nbsp;plotting.'</span>)</span></span></span><span id="ast-30"><span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.offset</span>&nbsp;+=&nbsp;<span id="ast-34">offset</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.label</span>(**<span id="ast-39">kwargs</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-41" class="other_trans">arg</span>&nbsp;in&nbsp;<span id="ast-42">[<span id="ast-43">'title'</span>,&nbsp;<span id="ast-44">'xlabel'</span>,&nbsp;<span id="ast-45">'ylabel'</span>]</span>:<span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">kwargs</span>.has_key</span>(<span id="ast-50" class="other_trans">arg</span>)</span>:<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>kwargs</span>.pop</span>(<span id="ast-55" class="other_trans">arg</span>)</span></span></span></span><span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>reset_kwargs</span>&nbsp;=&nbsp;<span id="ast-58">{}</span></span><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-60">arg</span>&nbsp;in&nbsp;<span id="ast-61">[<span id="ast-62">'xmin'</span>,&nbsp;<span id="ast-63">'xmax'</span>,&nbsp;<span id="ast-64">'ymin'</span>,&nbsp;<span id="ast-65">'ymax'</span>,&nbsp;<span id="ast-66">'reset_xlimits'</span>,&nbsp;<span id="ast-67">'reset_ylimits'</span>,&nbsp;<span id="ast-68">'ypeakscale'</span>]</span>:<span id="ast-69"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans">kwargs</span>.has_key</span>(<span id="ast-73" class="other_trans">arg</span>)</span>:<span id="ast-74"><span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>reset_kwargs</span>[<span id="ast-77"><span id="ast-78" class="other_trans">arg</span></span>]</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81">kwargs</span>.pop</span>(<span id="ast-82" class="other_trans">arg</span>)</span></span></span></span><span id="ast-83"><span id="ast-84"><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._spectrumplot</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88"><span id="ast-89">self</span>.axis</span>.plot</span>(<span id="ast-90"><span id="ast-91"><span id="ast-92">self</span>.Spectrum</span>.xarr</span>,&nbsp;<span id="ast-93">(<span id="ast-94"><span id="ast-95"><span id="ast-96">self</span>.Spectrum</span>.data</span>&nbsp;+&nbsp;<span id="ast-98"><span id="ast-99">self</span>.offset</span>)</span>,&nbsp;color=<span id="ast-101" class="other_trans">color</span>,&nbsp;linestyle=<span id="ast-103" class="other_trans">linestyle</span>,&nbsp;linewidth=<span id="ast-105" class="other_trans">linewidth</span>,&nbsp;**<span id="ast-106">kwargs</span>)</span></span><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-108">(<span id="ast-109" class="other_trans">errstyle</span><span id="ast-110" class="incorrect_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-111">None</span>)</span>:<span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-113">(<span id="ast-114" class="other_trans">errstyle</span><span id="ast-115" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-116">'fill'</span>)</span>:<span id="ast-117"><span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.errorplot</span>&nbsp;=&nbsp;<span id="ast-120">[<span id="ast-121"><span id="ast-122"><span id="ast-123"><span id="ast-124">self</span>.axis</span>.fill_between</span>(<span id="ast-125"><span id="ast-126">steppify</span>(<span id="ast-127"><span id="ast-128"><span id="ast-129">self</span>.Spectrum</span>.xarr</span>,&nbsp;isX=<span id="ast-131">True</span>)</span>,&nbsp;<span id="ast-132"><span id="ast-133">steppify</span>(<span id="ast-134">(<span id="ast-135">(<span id="ast-136"><span id="ast-137"><span id="ast-138">self</span>.Spectrum</span>.data</span>&nbsp;+&nbsp;<span id="ast-140"><span id="ast-141">self</span>.offset</span>)</span>&nbsp;-&nbsp;<span id="ast-143"><span id="ast-144"><span id="ast-145">self</span>.Spectrum</span>.error</span>)</span>)</span>,&nbsp;<span id="ast-146"><span id="ast-147" class="other_trans">steppify</span>(<span id="ast-148">(<span id="ast-149">(<span id="ast-150"><span id="ast-151"><span id="ast-152">self</span>.Spectrum</span>.data</span>&nbsp;+&nbsp;<span id="ast-154"><span id="ast-155">self</span>.offset</span>)</span>&nbsp;+&nbsp;<span id="ast-157"><span id="ast-158"><span id="ast-159">self</span>.Spectrum</span>.error</span>)</span>)</span>,&nbsp;facecolor=<span id="ast-161" class="other_trans">color</span>,&nbsp;alpha=<span id="ast-163" class="other_trans">erralpha</span>,&nbsp;**<span id="ast-164">kwargs</span>)</span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-166">(<span id="ast-167" class="other_trans">errstyle</span><span id="ast-168" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-169">'bars'</span>)</span>:<span id="ast-170"><span id="ast-171"><span id="ast-172"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.errorplot</span>&nbsp;=&nbsp;<span id="ast-173"><span id="ast-174"><span id="ast-175" class="other_trans">axis</span>.errorbar</span>(<span id="ast-176"><span id="ast-177"><span id="ast-178">self</span>.Spectrum</span>.xarr</span>,&nbsp;<span id="ast-179">(<span id="ast-180"><span id="ast-181"><span id="ast-182">self</span>.Spectrum</span>.data</span>&nbsp;+&nbsp;<span id="ast-184"><span id="ast-185">self</span>.offset</span>)</span>,&nbsp;yerr=<span id="ast-187"><span id="ast-188"><span id="ast-189">self</span>.Spectrum</span>.error</span>,&nbsp;ecolor=<span id="ast-191" class="other_trans">color</span>,&nbsp;fmt=<span id="ast-193" class="other_trans">None</span>,&nbsp;**<span id="ast-194" class="other_trans">kwargs</span>)</span></span></span></span><span id="ast-195"><span id="ast-196"><span id="ast-197"><span id="ast-198"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.reset_limits</span>(silent=<span id="ast-200" class="other_trans">silent</span>,&nbsp;offset=<span id="ast-202" class="ref_node">offset&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;**<span id="ast-203">reset_kwargs</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;cleanup_websocket(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">socket_id</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>con</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.hub</span>.connections</span>.pop</span>(<span id="ast-12" class="other_trans">socket_id</span>,&nbsp;<span id="ast-13" class="other_trans">None</span>)</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-15">(<span id="ast-16" class="other_trans">con</span><span id="ast-17" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-18" class="other_trans">None</span>)</span>:<span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-20" class="other_trans">channel</span>&nbsp;in&nbsp;<span id="ast-21"><span id="ast-22" class="other_trans">con</span>.subscriptions</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subs</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29">self</span>.hub</span>.subscriptions</span>.get</span>(<span id="ast-30" class="incorrect_node">channel&nbsp;&rarr;&nbsp;socket_id&nbsp;</span>)</span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-32" class="other_trans">subs</span>:<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subs</span>.discard</span>(<span id="ast-37" class="ref_node">channel&nbsp;&rarr;&nbsp;socket_id&nbsp;</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;migrate_vms(<span id="ast-2"><span id="ast-3">db</span>,&nbsp;<span id="ast-4" class="other_trans">nova</span>,&nbsp;<span id="ast-5">vm_instance_directory</span>,&nbsp;<span id="ast-6" class="other_trans">placement</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Synchronously&nbsp;live&nbsp;migrate&nbsp;a&nbsp;set&nbsp;of&nbsp;VMs.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;db:&nbsp;The&nbsp;database&nbsp;object.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;db:&nbsp;Database\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;nova:&nbsp;A&nbsp;Nova&nbsp;client.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;nova:&nbsp;*\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;vm_instance_directory:&nbsp;The&nbsp;VM&nbsp;instance&nbsp;directory.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;vm_instance_directory:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;placement:&nbsp;A&nbsp;dict&nbsp;of&nbsp;VM&nbsp;UUIDs&nbsp;to&nbsp;host&nbsp;names.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;placement:&nbsp;dict(str:&nbsp;str)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>vms</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13">placement</span>.keys</span>()</span></span><span id="ast-14"><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>vm_pairs</span>&nbsp;=&nbsp;<span id="ast-16">[<span id="ast-17"><span id="ast-18">vms</span>[<span id="ast-19"><span id="ast-20" class="other_trans">x</span>:<span id="ast-21">(<span id="ast-22" class="other_trans">x</span>&nbsp;+&nbsp;<span id="ast-24">2</span>)</span></span>]</span><span id="ast-25">&nbsp;for&nbsp;<span id="ast-26">x</span>&nbsp;in&nbsp;<span id="ast-27"><span id="ast-28" class="other_trans">xrange</span>(<span id="ast-29">0</span>,&nbsp;<span id="ast-30"><span id="ast-31">len</span>(<span id="ast-32" class="other_trans">vms</span>)</span>,&nbsp;<span id="ast-33">2</span>)</span></span>]</span></span><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-35">vm_pair</span>&nbsp;in&nbsp;<span id="ast-36">vm_pairs</span>:<span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subprocess</span>.call</span>(<span id="ast-41">(<span id="ast-42">'chown&nbsp;-R&nbsp;nova:nova&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-44">vm_instance_directory</span>)</span>,&nbsp;shell=<span id="ast-46">True</span>)</span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-48">vm</span>&nbsp;in&nbsp;<span id="ast-49" class="other_trans">vm_pair</span>:<span id="ast-50"><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>host</span>&nbsp;=&nbsp;<span id="ast-52"><span id="ast-53" class="other_trans">placement</span>[<span id="ast-54"><span id="ast-55" class="other_trans">vm</span></span>]</span></span><span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59"><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>nova</span>.servers</span>.live_migrate</span>(<span id="ast-61" class="other_trans">vm</span>,&nbsp;<span id="ast-62" class="other_trans">host</span>,&nbsp;<span id="ast-63">False</span>,&nbsp;<span id="ast-64">False</span>)</span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68">log</span>.isEnabledFor</span>(<span id="ast-69"><span id="ast-70" class="other_trans">logging</span>.INFO</span>)</span>:<span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.info</span>(<span id="ast-75">'Started&nbsp;migration&nbsp;of&nbsp;VM&nbsp;%s&nbsp;to&nbsp;%s'</span>,&nbsp;<span id="ast-76" class="other_trans">vm</span>,&nbsp;<span id="ast-77">host</span>)</span></span></span></span><span id="ast-78"><span id="ast-79"><span id="ast-80"><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>time</span>.sleep</span>(<span id="ast-82">10</span>)</span></span><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-84">True</span>:<span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-86" class="other_trans">vm_uuid</span>&nbsp;in&nbsp;<span id="ast-87"><span id="ast-88">list</span>(<span id="ast-89">vm_pair</span>)</span>:<span id="ast-90"><span id="ast-91"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>vm</span>&nbsp;=&nbsp;<span id="ast-92"><span id="ast-93"><span id="ast-94"><span id="ast-95" class="other_trans">nova</span>.servers</span>.get</span>(<span id="ast-96" class="other_trans">vm_uuid</span>)</span></span><span id="ast-97"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-98"><span id="ast-99"><span id="ast-100">log</span>.isEnabledFor</span>(<span id="ast-101"><span id="ast-102">logging</span>.DEBUG</span>)</span>:<span id="ast-103"><span id="ast-104"><span id="ast-105"><span id="ast-106"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.debug</span>(<span id="ast-107">'VM&nbsp;%s:&nbsp;%s,&nbsp;%s'</span>,&nbsp;<span id="ast-108" class="other_trans">vm_uuid</span>,&nbsp;<span id="ast-109"><span id="ast-110" class="other_trans">vm_hostname</span>(<span id="ast-111">vm</span>)</span>,&nbsp;<span id="ast-112"><span id="ast-113">vm</span>.status</span>)</span></span></span><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-115">(<span id="ast-117">(<span id="ast-118"><span id="ast-119">vm_hostname</span>(<span id="ast-120" class="other_trans">vm</span>)</span><span id="ast-121" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-122"><span id="ast-123" class="other_trans">placement</span>[<span id="ast-124"><span id="ast-125" class="other_trans">vm_uuid</span></span>]</span>)</span>&nbsp;or&nbsp;<span id="ast-126">(<span id="ast-127"><span id="ast-128" class="other_trans">vm</span>.status</span><span id="ast-129" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-130">u'ACTIVE'</span>)</span>)</span>:<span id="ast-131"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-132"><span id="ast-133"><span id="ast-134"><span id="ast-135" class="ref_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>vms&nbsp;&rarr;&nbsp;vm_pair&nbsp;</span>.remove</span>(<span id="ast-136" class="other_trans">vm_uuid</span>)</span></span><span id="ast-137"><span id="ast-138"><span id="ast-139"><span id="ast-140" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>db</span>.insert_vm_migration</span>(<span id="ast-141">vm_uuid</span>,&nbsp;<span id="ast-142"><span id="ast-143" class="other_trans">placement</span>[<span id="ast-144"><span id="ast-145" class="other_trans">vm_uuid</span></span>]</span>)</span></span><span id="ast-146"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-147"><span id="ast-148"><span id="ast-149">log</span>.isEnabledFor</span>(<span id="ast-150"><span id="ast-151" class="other_trans">logging</span>.INFO</span>)</span>:<span id="ast-152"><span id="ast-153"><span id="ast-154"><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.info</span>(<span id="ast-156">'Completed&nbsp;migration&nbsp;of&nbsp;VM&nbsp;%s&nbsp;to&nbsp;%s'</span>,&nbsp;<span id="ast-157" class="other_trans">vm_uuid</span>,&nbsp;<span id="ast-158"><span id="ast-159" class="other_trans">placement</span>[<span id="ast-160"><span id="ast-161" class="other_trans">vm_uuid</span></span>]</span>)</span></span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-162"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span><span id="ast-163"><span id="ast-164"><span id="ast-165"><span id="ast-166"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>time</span>.sleep</span>(<span id="ast-167">3</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;capture(<span id="ast-2"><span id="ast-3" class="other_trans">charge</span>,&nbsp;<span id="ast-4" class="other_trans">amount</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>stripe_charge</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">charge</span>.stripe_charge</span>.capture</span>(amount=<span id="ast-12"><span id="ast-13"><span id="ast-14" class="other_trans">utils</span>.convert_amount_for_api</span>(<span id="ast-15" class="other_trans">amount</span>,&nbsp;<span id="ast-16"><span id="ast-17" class="correct_node">amount&nbsp;&rarr;&nbsp;charge&nbsp;</span>.currency</span>)</span>)</span></span><span id="ast-18"><span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>syncs</span>.sync_charge_from_stripe_data</span>(<span id="ast-22" class="other_trans">stripe_charge</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;sobel(<span id="ast-2"><span id="ast-3" class="other_trans">img</span>,&nbsp;<span id="ast-4">just_filter</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;edges&nbsp;=&nbsp;sobel(img,&nbsp;just_filter=False)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Compute&nbsp;edges&nbsp;using&nbsp;Sobel's&nbsp;algorithm\\u000a&nbsp;&nbsp;&nbsp;&nbsp;`edges`&nbsp;is&nbsp;a&nbsp;binary&nbsp;image&nbsp;of&nbsp;edges&nbsp;computed&nbsp;according&nbsp;to&nbsp;Sobel's&nbsp;algorithm.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;implementation&nbsp;is&nbsp;tuned&nbsp;to&nbsp;match&nbsp;MATLAB's&nbsp;implementation.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;img&nbsp;:&nbsp;Any&nbsp;2D-ndarray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;just_filter&nbsp;:&nbsp;boolean,&nbsp;optional\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;true,&nbsp;then&nbsp;return&nbsp;the&nbsp;result&nbsp;of&nbsp;filtering&nbsp;the&nbsp;image&nbsp;with&nbsp;the&nbsp;sobel\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filters,&nbsp;but&nbsp;do&nbsp;not&nbsp;threashold&nbsp;(default&nbsp;is&nbsp;False).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;edges&nbsp;:&nbsp;ndarray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Binary&nbsp;image&nbsp;of&nbsp;edges,&nbsp;unless&nbsp;`just_filter`,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;will&nbsp;be\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;an&nbsp;array&nbsp;of&nbsp;floating&nbsp;point&nbsp;values.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>img</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11"><span id="ast-12" class="other_trans">img</span>.astype</span>(<span id="ast-13"><span id="ast-14" class="other_trans">np</span>.float</span>)</span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>img</span>&nbsp;-=&nbsp;<span id="ast-18"><span id="ast-19"><span id="ast-20" class="other_trans">img</span>.min</span>()</span></span><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ptp</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24"><span id="ast-25" class="other_trans">img</span>.ptp</span>()</span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-27">(<span id="ast-28" class="other_trans">ptp</span><span id="ast-29" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-30">0</span>)</span>:<span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-32" class="other_trans">img</span></span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>img</span>&nbsp;/=&nbsp;<span id="ast-36">ptp</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>vfiltered</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40" class="other_trans">convolve</span>(<span id="ast-41" class="other_trans">img</span>,&nbsp;<span id="ast-42">_vsobel_filter</span>,&nbsp;mode=<span id="ast-44">'nearest'</span>)</span></span><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>hfiltered</span>&nbsp;=&nbsp;<span id="ast-47"><span id="ast-48" class="other_trans">convolve</span>(<span id="ast-49">img</span>,&nbsp;<span id="ast-50" class="other_trans">_hsobel_filter</span>,&nbsp;mode=<span id="ast-52">'nearest'</span>)</span></span><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>vfiltered</span>&nbsp;**=&nbsp;<span id="ast-56">2</span></span><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>hfiltered</span>&nbsp;**=&nbsp;<span id="ast-60">2</span></span><span id="ast-61"><span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filtered</span>&nbsp;=&nbsp;<span id="ast-63" class="other_trans">vfiltered</span></span><span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filtered</span>&nbsp;+=&nbsp;<span id="ast-67" class="other_trans">hfiltered</span></span><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-69" class="other_trans">just_filter</span>:<span id="ast-70"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-71" class="other_trans">filtered</span></span></span><span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>thresh</span>&nbsp;=&nbsp;<span id="ast-74">(<span id="ast-75">2</span>&nbsp;*&nbsp;<span id="ast-77"><span id="ast-78"><span id="ast-79">np</span>.sqrt</span>(<span id="ast-80"><span id="ast-81"><span id="ast-82" class="other_trans">filtered</span>.mean</span>()</span>)</span>)</span></span><span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filtered</span>&nbsp;*=&nbsp;<span id="ast-86">(<span id="ast-87"><span id="ast-88"><span id="ast-89">np</span>.sqrt</span>(<span id="ast-90" class="other_trans">filtered</span>)</span><span id="ast-91" class="correct_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-92" class="other_trans">thresh</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;uninstall(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span id="ast-6"><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>super</span>(<span id="ast-9">YumDependencyHandler</span>,&nbsp;<span id="ast-10">self</span>)</span>.uninstall</span>()</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>scan_packages</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15">self</span>._all_rpm_names</span>()</span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>rpm_names</span>&nbsp;=&nbsp;<span id="ast-18">[]</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-20" class="other_trans">p</span>&nbsp;in&nbsp;<span id="ast-21" class="other_trans">scan_packages</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24" class="other_trans">p</span><span id="ast-25">&nbsp;in&nbsp;</span><span id="ast-26"><span id="ast-27">self</span>.no_remove</span>)</span>:<span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33">self</span>.helper</span>.is_installed</span>(<span id="ast-34" class="other_trans">p</span>)</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rpm_names</span>.append</span>(<span id="ast-39" class="other_trans">p</span>)</span></span></span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41" class="other_trans">rpm_names</span>:<span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmdline</span>&nbsp;=&nbsp;<span id="ast-44">[<span id="ast-45">'yum'</span>,&nbsp;<span id="ast-46">'remove'</span>,&nbsp;<span id="ast-47">'--remove-leaves'</span>,&nbsp;<span id="ast-48">'-y'</span>]</span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-50" class="other_trans">p</span>&nbsp;in&nbsp;<span id="ast-51" class="correct_node">no_remove&nbsp;&rarr;&nbsp;self.&nbsp;</span>:<span id="ast-52"><span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmdline</span>.append</span>(<span id="ast-56">(<span id="ast-57">'--exclude=%s'</span>&nbsp;%&nbsp;<span id="ast-59" class="other_trans">p</span>)</span>)</span></span></span><span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmdline</span>.extend</span>(<span id="ast-64"><span id="ast-65" class="other_trans">sorted</span>(<span id="ast-66"><span id="ast-67" class="other_trans">set</span>(<span id="ast-68" class="other_trans">rpm_names</span>)</span>)</span>)</span></span><span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sh</span>.execute</span>(<span id="ast-73" class="other_trans">cmdline</span>,&nbsp;stdout_fh=<span id="ast-75"><span id="ast-76" class="other_trans">sys</span>.stdout</span>,&nbsp;stderr_fh=<span id="ast-78"><span id="ast-79" class="other_trans">sys</span>.stderr</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_get_property(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">key</span>,&nbsp;<span id="ast-5" class="other_trans">default</span></span>):<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>attr</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10" class="other_trans">getattr</span>(<span id="ast-11">self</span>,&nbsp;<span id="ast-12">(<span id="ast-13">'_%s'</span>&nbsp;%&nbsp;<span id="ast-15" class="other_trans">key</span>)</span>)</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17" class="other_trans">attr</span>:<span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-19" class="other_trans">attr</span></span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-21">(<span id="ast-23">(<span id="ast-24" class="other_trans">default</span><span id="ast-25" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-26">False</span>)</span>&nbsp;and&nbsp;<span id="ast-27">(<span id="ast-28">not</span>&nbsp;<span id="ast-29"><span id="ast-30">self</span>.app_key</span>)</span>)</span>:<span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-32" class="ref_node">attr&nbsp;&rarr;&nbsp;default&nbsp;</span></span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>app</span>&nbsp;=&nbsp;<span id="ast-35">(<span id="ast-37"><span id="ast-38"><span id="ast-39">self</span>.oauth</span>.app</span>&nbsp;or&nbsp;<span id="ast-40" class="other_trans">current_app</span>)</span></span><span id="ast-41"><span id="ast-42" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>config</span>&nbsp;=&nbsp;<span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans">app</span>.config</span>[<span id="ast-46"><span id="ast-47"><span id="ast-48">self</span>.app_key</span></span>]</span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-50">(<span id="ast-51" class="other_trans">default</span><span id="ast-52" class="incorrect_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-53">False</span>)</span>:<span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans">config</span>.get</span>(<span id="ast-58" class="other_trans">key</span>,&nbsp;<span id="ast-59" class="other_trans">default</span>)</span></span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-61"><span id="ast-62" class="other_trans">config</span>[<span id="ast-63"><span id="ast-64" class="other_trans">key</span></span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;decode_timeseries(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">resp_ttb</span>,&nbsp;<span id="ast-5">tsobj</span>,&nbsp;<span id="ast-6" class="other_trans">convert_timestamp</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Fills&nbsp;an&nbsp;TsObject&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;data&nbsp;and\\u000a&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;from&nbsp;a&nbsp;TTB-encoded&nbsp;TsGetResp&nbsp;/&nbsp;TsQueryResp.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;resp_ttb:&nbsp;the&nbsp;decoded&nbsp;TTB&nbsp;data\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;resp_ttb:&nbsp;TTB-encoded&nbsp;tsqueryrsp&nbsp;or&nbsp;tsgetresp\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;tsobj:&nbsp;a&nbsp;TsObject\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;tsobj:&nbsp;TsObject\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;convert_timestamp:&nbsp;Convert&nbsp;timestamps&nbsp;to&nbsp;datetime&nbsp;objects\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;tsobj:&nbsp;boolean\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11">(<span id="ast-12" class="other_trans">resp_ttb</span><span id="ast-13" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-14">None</span>)</span>:<span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-16" class="other_trans">tsobj</span></span></span><span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.maybe_err_ttb</span>(<span id="ast-21" class="other_trans">resp_ttb</span>)</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24" class="incorrect_node">resp_ttb&nbsp;&rarr;&nbsp;resp_a&nbsp;</span><span id="ast-25" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-26">tsqueryresp_a</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-28" class="other_trans">tsobj</span></span></span><span id="ast-29"><span id="ast-30" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>resp_a</span>&nbsp;=&nbsp;<span id="ast-31"><span id="ast-32" class="other_trans">resp_ttb</span>[<span id="ast-33"><span id="ast-34">0</span></span>]</span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-36">(<span id="ast-37" class="other_trans">resp_a</span><span id="ast-38" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-39">tsputresp_a</span>)</span>:<span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-42">(<span id="ast-44">(<span id="ast-45" class="other_trans">resp_a</span><span id="ast-46" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-47">tsgetresp_a</span>)</span>&nbsp;or&nbsp;<span id="ast-48">(<span id="ast-49" class="other_trans">resp_a</span><span id="ast-50" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-51">tsqueryresp_a</span>)</span>)</span>:<span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>resp_data</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55" class="other_trans">resp_ttb</span>[<span id="ast-56"><span id="ast-57">1</span></span>]</span></span><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59">(<span id="ast-60"><span id="ast-61">len</span>(<span id="ast-62" class="other_trans">resp_data</span>)</span><span id="ast-63" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-64">0</span>)</span>:<span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-67">(<span id="ast-68"><span id="ast-69" class="other_trans">len</span>(<span id="ast-70" class="other_trans">resp_data</span>)</span><span id="ast-71" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-72">3</span>)</span>:<span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>resp_colnames</span>&nbsp;=&nbsp;<span id="ast-75"><span id="ast-76" class="other_trans">resp_data</span>[<span id="ast-77"><span id="ast-78">0</span></span>]</span></span><span id="ast-79"><span id="ast-80" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>resp_coltypes</span>&nbsp;=&nbsp;<span id="ast-81"><span id="ast-82">resp_data</span>[<span id="ast-83"><span id="ast-84">1</span></span>]</span></span><span id="ast-85"><span id="ast-86"><span id="ast-87" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tsobj</span>.columns</span>&nbsp;=&nbsp;<span id="ast-88"><span id="ast-89"><span id="ast-90">self</span>.decode_timeseries_cols</span>(<span id="ast-91" class="other_trans">resp_colnames</span>,&nbsp;<span id="ast-92" class="other_trans">resp_coltypes</span>)</span></span><span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>resp_rows</span>&nbsp;=&nbsp;<span id="ast-95"><span id="ast-96" class="other_trans">resp_data</span>[<span id="ast-97"><span id="ast-98">2</span></span>]</span></span><span id="ast-99"><span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tsobj</span>.rows</span>&nbsp;=&nbsp;<span id="ast-102">[]</span></span><span id="ast-103"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-104" class="other_trans">resp_row</span>&nbsp;in&nbsp;<span id="ast-105">resp_rows</span>:<span id="ast-106"><span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tsobj</span>.rows</span>.append</span>(<span id="ast-111"><span id="ast-112"><span id="ast-113">self</span>.decode_timeseries_row</span>(<span id="ast-114" class="other_trans">resp_row</span>,&nbsp;<span id="ast-115">resp_coltypes</span>,&nbsp;<span id="ast-116" class="other_trans">convert_timestamp</span>)</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-117"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-118"><span id="ast-119" class="other_trans">RiakError</span>(<span id="ast-120"><span id="ast-121"><span id="ast-122">'Expected&nbsp;3-tuple&nbsp;in&nbsp;response,&nbsp;got:&nbsp;{}'</span>.format</span>(<span id="ast-123" class="other_trans">resp_data</span>)</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-125"><span id="ast-126">RiakError</span>(<span id="ast-127"><span id="ast-128"><span id="ast-129">'Unknown&nbsp;TTB&nbsp;response&nbsp;type:&nbsp;{}'</span>.format</span>(<span id="ast-130" class="ref_node">resp_ttb&nbsp;&rarr;&nbsp;resp_a&nbsp;</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;serve(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-5">True</span>:<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>trans</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.transport_factory</span>.accept</span>()</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>processor</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15" class="correct_node">processor_factory&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-16" class="other_trans">trans</span>)</span></span><span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._serve_client</span>(<span id="ast-21" class="other_trans">processor</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;remove(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">ppa</span>,&nbsp;<span id="ast-6" class="other_trans">repo_url</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;function&nbsp;used&nbsp;to&nbsp;remove&nbsp;ppa's\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;ppa&nbsp;is&nbsp;provided&nbsp;adds&nbsp;repo&nbsp;file&nbsp;to\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/etc/apt/sources.list.d/\\u000a&nbsp;&nbsp;&nbsp;&nbsp;command.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11" class="other_trans">ppa</span>:<span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>EEShellExec</span>.cmd_exec</span>(<span id="ast-16">self</span>,&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19">"add-apt-repository&nbsp;-y&nbsp;--remove&nbsp;'{ppa_name}'"</span>.format</span>(ppa_name=<span id="ast-21" class="correct_node">repo_url&nbsp;&rarr;&nbsp;ppa&nbsp;</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-23" class="other_trans">repo_url</span>:<span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>repo_file_path</span>&nbsp;=&nbsp;<span id="ast-26">(<span id="ast-27">'/etc/apt/sources.list.d/'</span>&nbsp;+&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">EEVariables</span>()</span>.ee_repo_file</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;submit_bm(<span id="ast-2"><span id="ast-3" class="other_trans">feed</span>,&nbsp;<span id="ast-4">user</span>,&nbsp;<span id="ast-5">title</span>,&nbsp;<span id="ast-6">url</span>,&nbsp;<span id="ast-7">comment</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>bm</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11">Bookmarks</span>()</span></span><span id="ast-12"><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">urlfetch</span>.fetch</span>(url=<span id="ast-18">url</span>,&nbsp;follow_redirects=<span id="ast-20">True</span>,&nbsp;allow_truncated=<span id="ast-22">True</span>,&nbsp;deadline=<span id="ast-24">60</span>)</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-28">(<span id="ast-29"><span id="ast-30" class="other_trans">result</span>.status_code</span><span id="ast-31" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-32">200</span>)</span>&nbsp;and&nbsp;<span id="ast-33"><span id="ast-34">result</span>.final_url</span>)</span>:<span id="ast-35"><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>a</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38" class="other_trans">result</span>.final_url</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>a</span>&nbsp;=&nbsp;<span id="ast-41" class="other_trans">url</span></span></span><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>b</span>&nbsp;=&nbsp;<span id="ast-44"><span id="ast-45"><span id="ast-46"><span id="ast-47"><span id="ast-48" class="other_trans">a</span>.lstrip</span>()</span>.rstrip</span>()</span></span><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>c</span>&nbsp;=&nbsp;<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans">b</span>.split</span>(<span id="ast-55">'?utm_source'</span>)</span>[<span id="ast-56"><span id="ast-57">0</span></span>]</span></span><span id="ast-58"><span id="ast-59" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url_candidate</span>&nbsp;=&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">c</span>.split</span>(<span id="ast-64">'&amp;feature'</span>)</span>[<span id="ast-65"><span id="ast-66">0</span></span>]</span></span><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>bmq</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans">Bookmarks</span>.query</span>(<span id="ast-72">(<span id="ast-73"><span id="ast-74" class="other_trans">Bookmarks</span>.user</span><span id="ast-75" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-76" class="other_trans">user</span>)</span>,&nbsp;<span id="ast-77">(<span id="ast-78"><span id="ast-79" class="other_trans">Bookmarks</span>.url</span><span id="ast-80" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-81">url_candidate</span>)</span>)</span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-83"><span id="ast-84"><span id="ast-85">bmq</span>.get</span>()</span>:<span id="ast-86"><span id="ast-87" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tag_list</span>&nbsp;=&nbsp;<span id="ast-88">[]</span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-90" class="other_trans">bm</span>&nbsp;in&nbsp;<span id="ast-91">bmq</span>:<span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-93" class="other_trans">t</span>&nbsp;in&nbsp;<span id="ast-94"><span id="ast-95" class="other_trans">bm</span>.tags</span>:<span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-97">(<span id="ast-98" class="other_trans">t</span><span id="ast-99">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-100">tag_list</span>)</span>:<span id="ast-101"><span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tag_list</span>.append</span>(<span id="ast-105" class="other_trans">t</span>)</span></span><span id="ast-106"><span id="ast-107"><span id="ast-108" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bm</span>.tags</span>&nbsp;=&nbsp;<span id="ast-109" class="other_trans">tag_list</span></span></span></span></span><span id="ast-110"><span id="ast-111"><span id="ast-112"><span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ndb</span>.delete_multi</span>(<span id="ast-114">[<span id="ast-115"><span id="ast-116">bm</span>.key</span><span id="ast-117">&nbsp;for&nbsp;<span id="ast-118" class="other_trans">bm</span>&nbsp;in&nbsp;<span id="ast-119" class="incorrect_node">bmq&nbsp;&rarr;&nbsp;tag_list&nbsp;</span></span>]</span>)</span></span></span><span id="ast-120"><span id="ast-121" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url_parsed</span>&nbsp;=&nbsp;<span id="ast-122"><span id="ast-123" class="other_trans">urlparse</span>(<span id="ast-124" class="other_trans">url_candidate</span>)</span></span><span id="ast-125"><span id="ast-126" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>query</span>&nbsp;=&nbsp;<span id="ast-127"><span id="ast-128">parse_qs</span>(<span id="ast-129"><span id="ast-130">url_parsed</span>.query</span>)</span></span><span id="ast-131"><span id="ast-132" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-133"><span id="ast-134"><span id="ast-135"><span id="ast-136"><span id="ast-137">url_parsed</span>.path</span>.split</span>(<span id="ast-138">'/'</span>)</span>[<span id="ast-139"><span id="ast-140">-1</span></span>]</span></span><span id="ast-141"><span id="ast-142" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ext</span>&nbsp;=&nbsp;<span id="ast-143"><span id="ast-144"><span id="ast-145"><span id="ast-146"><span id="ast-147"><span id="ast-148" class="other_trans">name</span>.split</span>(<span id="ast-149">'.'</span>)</span>[<span id="ast-150"><span id="ast-151">-1</span></span>]</span>.lower</span>()</span></span><span id="ast-152"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-153">(<span id="ast-154" class="other_trans">title</span><span id="ast-155" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-156">''</span>)</span>:<span id="ast-157"><span id="ast-158"><span id="ast-159" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bm</span>.title</span>&nbsp;=&nbsp;<span id="ast-160" class="ref_node">name&nbsp;&rarr;&nbsp;url_candidate&nbsp;</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-161"><span id="ast-162"><span id="ast-163"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bm</span>.title</span>&nbsp;=&nbsp;<span id="ast-164" class="other_trans">title</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;print_nodes(<span id="ast-2"><span id="ast-3" class="other_trans">nodes</span>,&nbsp;<span id="ast-4" class="other_trans">detailed</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Prints&nbsp;all&nbsp;the&nbsp;given&nbsp;nodes'</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;=&nbsp;<span id="ast-10">0</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-12" class="other_trans">node</span>&nbsp;in&nbsp;<span id="ast-13" class="other_trans">nodes</span>:<span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;+=&nbsp;<span id="ast-17">1</span></span><span id="ast-18"><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print_node</span>(<span id="ast-21" class="other_trans">node</span>,&nbsp;detailed=<span id="ast-23" class="other_trans">detailed</span>)</span></span></span><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27">'\\u000aFound&nbsp;{0}&nbsp;node{1}'</span>.format</span>(<span id="ast-28" class="other_trans">found</span>,&nbsp;<span id="ast-29"><span id="ast-34">'s'</span>&nbsp;if&nbsp;<span id="ast-30">(<span id="ast-31" class="other_trans">found</span><span id="ast-32" class="location_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;>,&nbsp;pred:&nbsp;!=&nbsp;</span><span id="ast-33">1</span>)</span>&nbsp;else&nbsp;<span id="ast-35">''</span></span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;unpack_attr_set(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>attr_len</span>&nbsp;=&nbsp;<span id="ast-6">(<span id="ast-7"><span id="ast-8">self</span>.p</span>&nbsp;+&nbsp;<span id="ast-10"><span id="ast-11">self</span>.len</span>)</span></span><span id="ast-12"><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_set</span>&nbsp;=&nbsp;<span id="ast-15">{}</span></span><span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_set</span>[<span id="ast-20"><span id="ast-21">'origin_as'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24">self</span>.val_asn</span>(<span id="ast-25">4</span>)</span></span><span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>attr_len</span>&nbsp;-=&nbsp;<span id="ast-29">4</span></span><span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_set</span>[<span id="ast-34"><span id="ast-35">'attr'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-36">[]</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-38">(<span id="ast-39"><span id="ast-40">self</span>.p</span><span id="ast-41" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-42" class="other_trans">attr_len</span>)</span>:<span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>attr</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">BgpAttr</span>(<span id="ast-47"><span id="ast-48" class="correct_node">buf&nbsp;&rarr;&nbsp;self.&nbsp;</span>[<span id="ast-49"><span id="ast-50"><span id="ast-51">self</span>.p</span>:</span>]</span>)</span></span><span id="ast-52"><span id="ast-53"><span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.p</span>&nbsp;+=&nbsp;<span id="ast-56"><span id="ast-57"><span id="ast-58" class="other_trans">attr</span>.unpack</span>()</span></span><span id="ast-59"><span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63"><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.attr_set</span>[<span id="ast-65"><span id="ast-66">'attr'</span></span>]</span>.append</span>(<span id="ast-67" class="other_trans">attr</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;archive_root(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>key</span>&nbsp;=&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8">'{}.archive_root'</span>.format</span>(<span id="ast-9"><span id="ast-10">self</span>.name</span>)</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>value</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.ctx</span>.state</span>.get</span>(<span id="ast-18" class="other_trans">key</span>)</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-20">(<span id="ast-21">not</span>&nbsp;<span id="ast-22" class="correct_node">key&nbsp;&rarr;&nbsp;value&nbsp;</span>)</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>value</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27">self</span>.get_archive_rootdir</span>(<span id="ast-28"><span id="ast-29">self</span>.archive_fn</span>)</span></span><span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ctx</span>.state</span>[<span id="ast-35"><span id="ast-36" class="other_trans">key</span></span>]</span>&nbsp;=&nbsp;<span id="ast-37" class="other_trans">value</span></span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-39" class="other_trans">value</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_token_at_offset(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">offset</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Returns&nbsp;the&nbsp;token&nbsp;that&nbsp;is&nbsp;on&nbsp;position&nbsp;offset.'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>idx</span>&nbsp;=&nbsp;<span id="ast-9">0</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-11" class="other_trans">token</span>&nbsp;in&nbsp;<span id="ast-12"><span id="ast-13"><span id="ast-14">self</span>.flatten</span>()</span>:<span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>end</span>&nbsp;=&nbsp;<span id="ast-17">(<span id="ast-18" class="other_trans">idx</span>&nbsp;+&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">len</span>(<span id="ast-22"><span id="ast-23" class="other_trans">token</span>.value</span>)</span>)</span></span><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-25">(<span id="ast-26" class="other_trans">idx</span><span id="ast-27" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-29" class="other_trans">offset</span><span id="ast-28" class="correct_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-30" class="other_trans">end</span>)</span>:<span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-32" class="other_trans">token</span></span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>idx</span>&nbsp;=&nbsp;<span id="ast-35" class="other_trans">end</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;downloadManga(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-5">'Parsing&nbsp;XML&nbsp;File...'</span></span><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dom</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">minidom</span>.parse</span>(<span id="ast-11"><span id="ast-12">self</span>.xmlfile_path</span>)</span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-14" class="other_trans">node</span>&nbsp;in&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17">dom</span>.getElementsByTagName</span>(<span id="ast-18">'MangaSeries'</span>)</span>:<span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>iLastChap</span>&nbsp;=&nbsp;<span id="ast-21">0</span></span><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">MangaXmlParser</span>.getText</span>(<span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">node</span>.getElementsByTagName</span>(<span id="ast-32">'name'</span>)</span>[<span id="ast-33"><span id="ast-34">0</span></span>]</span>.childNodes</span>)</span></span><span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>site</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">MangaXmlParser</span>.getText</span>(<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">node</span>.getElementsByTagName</span>(<span id="ast-45">'HostSite'</span>)</span>[<span id="ast-46"><span id="ast-47">0</span></span>]</span>.childNodes</span>)</span></span><span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lastDownloaded</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52">MangaXmlParser</span>.getText</span>(<span id="ast-53"><span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans">node</span>.getElementsByTagName</span>(<span id="ast-58">'LastChapterDownloaded'</span>)</span>[<span id="ast-59"><span id="ast-60">0</span></span>]</span>.childNodes</span>)</span></span><span id="ast-61"><span id="ast-62" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>download_path</span>&nbsp;=&nbsp;<span id="ast-63"><span id="ast-64"><span id="ast-65">MangaXmlParser</span>.getText</span>(<span id="ast-66"><span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70" class="other_trans">node</span>.getElementsByTagName</span>(<span id="ast-71">'downloadPath'</span>)</span>[<span id="ast-72"><span id="ast-73">0</span></span>]</span>.childNodes</span>)</span></span><span id="ast-74"><span id="ast-75"><span id="ast-76"><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.options</span>.site</span>&nbsp;=&nbsp;<span id="ast-78" class="other_trans">site</span></span><span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.options</span>.manga</span>&nbsp;=&nbsp;<span id="ast-83" class="other_trans">name</span></span><span id="ast-84"><span id="ast-85"><span id="ast-86"><span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.options</span>.download_path</span>&nbsp;=&nbsp;<span id="ast-88">download_path</span></span><span id="ast-89"><span id="ast-90"><span id="ast-91"><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.options</span>.lastDownloaded</span>&nbsp;=&nbsp;<span id="ast-93" class="other_trans">lastDownloaded</span></span><span id="ast-94"><span id="ast-95"><span id="ast-96"><span id="ast-97"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.options</span>.auto</span>&nbsp;=&nbsp;<span id="ast-98">True</span></span><span id="ast-99"><span id="ast-100" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>siteParser</span>&nbsp;=&nbsp;<span id="ast-101"><span id="ast-102"><span id="ast-103">SiteParserFactory</span>.getInstance</span>(<span id="ast-104" class="correct_node">options&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span></span><span id="ast-105"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-106"><span id="ast-107"><span id="ast-108"><span id="ast-109" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>siteParser</span>.parseSite</span>()</span></span><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-111"><span id="ast-112" class="other_trans">siteParser</span>.MangaNotFound</span>:<span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-114">(<span id="ast-115">(<span id="ast-116">'Manga&nbsp;('</span>&nbsp;+&nbsp;<span id="ast-118" class="other_trans">name</span>)</span>&nbsp;+&nbsp;<span id="ast-120">')&nbsp;Missing.&nbsp;Check&nbsp;if&nbsp;still&nbsp;available\\u000a'</span>)</span></span><span id="ast-121"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-122"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-123"><span id="ast-124" class="other_trans">siteParser</span>.NoUpdates</span>:<span id="ast-125"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-126">(<span id="ast-127">(<span id="ast-128">'Manga&nbsp;('</span>&nbsp;+&nbsp;<span id="ast-130" class="other_trans">name</span>)</span>&nbsp;+&nbsp;<span id="ast-132">')&nbsp;up-to-date.\\u000a'</span>)</span></span><span id="ast-133"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span></span><span id="ast-134"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-135" class="other_trans">current_chapter</span>&nbsp;in&nbsp;<span id="ast-136"><span id="ast-137" class="other_trans">siteParser</span>.chapters</span>:<span id="ast-138"><span id="ast-139" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>iLastChap</span>&nbsp;=&nbsp;<span id="ast-140"><span id="ast-141" class="other_trans">current_chapter</span>[<span id="ast-142"><span id="ast-143">1</span></span>]</span></span></span><span id="ast-144"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-145"><span id="ast-146"><span id="ast-147"><span id="ast-148" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>siteParser</span>.downloadChapters</span>()</span></span><span id="ast-149"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-150">'\\u000a'</span></span><span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-152"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-153">(<span id="ast-154">(<span id="ast-155">'Unknown&nbsp;Error&nbsp;-&nbsp;('</span>&nbsp;+&nbsp;<span id="ast-157" class="other_trans">name</span>)</span>&nbsp;+&nbsp;<span id="ast-159">')\\u000a'</span>)</span></span><span id="ast-160"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span></span><span id="ast-161"><span id="ast-162"><span id="ast-163"><span id="ast-164"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>MangaXmlParser</span>.setText</span>(<span id="ast-165"><span id="ast-166"><span id="ast-167"><span id="ast-168"><span id="ast-169" class="other_trans">node</span>.getElementsByTagName</span>(<span id="ast-170">'LastChapterDownloaded'</span>)</span>[<span id="ast-171"><span id="ast-172">0</span></span>]</span>.childNodes</span>,&nbsp;<span id="ast-173"><span id="ast-174">str</span>(<span id="ast-175">iLastChap</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;removeBelowValue(<span id="ast-2"><span id="ast-3" class="other_trans">requestContext</span>,&nbsp;<span id="ast-4" class="other_trans">seriesList</span>,&nbsp;<span id="ast-5" class="other_trans">n</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Removes&nbsp;data&nbsp;above&nbsp;the&nbsp;given&nbsp;threshold&nbsp;from&nbsp;the&nbsp;series&nbsp;or&nbsp;list&nbsp;of&nbsp;series&nbsp;provided.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Values&nbsp;below&nbsp;this&nbsp;threshole&nbsp;are&nbsp;assigned&nbsp;a&nbsp;value&nbsp;of&nbsp;None\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-9" class="other_trans">s</span>&nbsp;in&nbsp;<span id="ast-10" class="other_trans">seriesList</span>:<span id="ast-11"><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>s</span>.name</span>&nbsp;=&nbsp;<span id="ast-14">(<span id="ast-15">'removeBelowValue(%s,&nbsp;%d)'</span>&nbsp;%&nbsp;<span id="ast-17">(<span id="ast-18"><span id="ast-19" class="other_trans">s</span>.name</span>,&nbsp;<span id="ast-20" class="other_trans">n</span>)</span>)</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-22">(<span id="ast-23" class="other_trans">index</span>,&nbsp;<span id="ast-24" class="other_trans">val</span>)</span>&nbsp;in&nbsp;<span id="ast-25"><span id="ast-26" class="other_trans">enumerate</span>(<span id="ast-27" class="other_trans">s</span>)</span>:<span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-29">(<span id="ast-30" class="other_trans">val</span><span id="ast-31" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-32" class="other_trans">n</span>)</span>:<span id="ast-33"><span id="ast-34"><span id="ast-35" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>s</span>[<span id="ast-36"><span id="ast-37" class="other_trans">index</span></span>]</span>&nbsp;=&nbsp;<span id="ast-38" class="other_trans">None</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;on_enter(<span id="ast-2"><span id="ast-3">event_data</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;The&nbsp;unit&nbsp;is&nbsp;tracking&nbsp;the&nbsp;target.&nbsp;Proceed&nbsp;to&nbsp;observations.&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">event_data</span>.model</span></span><span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>.say</span>(<span id="ast-14">'Checking&nbsp;our&nbsp;tracking'</span>)</span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>target</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19" class="other_trans">pan</span>.observatory</span>.current_target</span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-21">(<span id="ast-22"><span id="ast-23" class="other_trans">target</span>.current_visit</span><span id="ast-24" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-25">None</span>)</span>:<span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-27">d</span>&nbsp;in&nbsp;<span id="ast-28">[<span id="ast-29">'ra'</span>,&nbsp;<span id="ast-30">'dec'</span>]</span>:<span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>key</span>&nbsp;=&nbsp;<span id="ast-33"><span id="ast-34"><span id="ast-35">'{}_ms_offset'</span>.format</span>(<span id="ast-36" class="other_trans">d</span>)</span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40"><span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>.logger</span>.debug</span>(<span id="ast-42"><span id="ast-43"><span id="ast-44">'{}'</span>.format</span>(<span id="ast-45" class="other_trans">key</span>)</span>)</span></span><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-47">(<span id="ast-48">key</span><span id="ast-49">&nbsp;in&nbsp;</span><span id="ast-50"><span id="ast-51">target</span>._offset_info</span>)</span>:<span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ms_offset</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55">int</span>(<span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59"><span id="ast-60" class="other_trans">target</span>._offset_info</span>.get</span>(<span id="ast-61">key</span>,&nbsp;<span id="ast-62">(<span id="ast-63">0</span>&nbsp;*&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">u</span>.ms</span>)</span>)</span>.value</span>)</span></span><span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>.logger</span>.debug</span>(<span id="ast-72"><span id="ast-73"><span id="ast-74">'Checking&nbsp;{}&nbsp;{}'</span>.format</span>(<span id="ast-75" class="other_trans">key</span>,&nbsp;<span id="ast-76" class="other_trans">ms_offset</span>)</span>)</span></span><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-78">(<span id="ast-80">(<span id="ast-81"><span id="ast-82" class="other_trans">abs</span>(<span id="ast-83" class="other_trans">ms_offset</span>)</span><span id="ast-84" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-85">20.0</span>)</span>&nbsp;and&nbsp;<span id="ast-86">(<span id="ast-87"><span id="ast-88">abs</span>(<span id="ast-89" class="other_trans">ms_offset</span>)</span><span id="ast-90" class="incorrect_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-91">5000.0</span>)</span>)</span>:<span id="ast-92"><span id="ast-93" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>processing_time_delay</span>&nbsp;=&nbsp;<span id="ast-94"><span id="ast-95" class="other_trans">int</span>(<span id="ast-96">(<span id="ast-97" class="other_trans">ms_offset</span>&nbsp;/&nbsp;<span id="ast-99">4</span>)</span>)</span></span><span id="ast-100"><span id="ast-101"><span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>.logger</span>.debug</span>(<span id="ast-105"><span id="ast-106"><span id="ast-107">'Processing&nbsp;time&nbsp;delay:&nbsp;{}'</span>.format</span>(<span id="ast-108" class="other_trans">processing_time_delay</span>)</span>)</span></span><span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ms_offset</span>&nbsp;=&nbsp;<span id="ast-111">(<span id="ast-112" class="other_trans">ms_offset</span>&nbsp;+&nbsp;<span id="ast-114">processing_time_delay</span>)</span></span><span id="ast-115"><span id="ast-116"><span id="ast-117"><span id="ast-118"><span id="ast-119" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pan</span>.logger</span>.debug</span>(<span id="ast-120"><span id="ast-121"><span id="ast-122">'Total&nbsp;offset:&nbsp;{}'</span>.format</span>(<span id="ast-123" class="other_trans">ms_offset</span>)</span>)</span></span><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-125">(<span id="ast-126" class="other_trans">d</span><span id="ast-127" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-128">'ra'</span>)</span>:<span id="ast-129"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-130">(<span id="ast-131" class="other_trans">ms_offset</span><span id="ast-132" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-133">0</span>)</span>:<span id="ast-134"><span id="ast-135" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>direction</span>&nbsp;=&nbsp;<span id="ast-136">'west'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-137"><span id="ast-138"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>direction</span>&nbsp;=&nbsp;<span id="ast-139">'east'</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-141">(<span id="ast-142">d</span><span id="ast-143" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-144">'dec'</span>)</span>:<span id="ast-145"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-146">(<span id="ast-147" class="other_trans">ms_offset</span><span id="ast-148" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-149">0</span>)</span>:<span id="ast-150"><span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>direction</span>&nbsp;=&nbsp;<span id="ast-152">'south'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-153"><span id="ast-154"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>direction</span>&nbsp;=&nbsp;<span id="ast-155">'north'</span></span></span></span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_source(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">environment</span>,&nbsp;<span id="ast-5" class="other_trans">template</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8" class="other_trans">template</span><span id="ast-9">&nbsp;in&nbsp;</span><span id="ast-10"><span id="ast-11">self</span>.mapping</span>)</span>:<span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>source</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.mapping</span>[<span id="ast-17"><span id="ast-18" class="other_trans">template</span></span>]</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-20">(<span id="ast-21" class="other_trans">source</span>,&nbsp;<span id="ast-22" class="other_trans">None</span>,&nbsp;<span id="ast-23">lambda&nbsp;<span id="ast-24"></span>:&nbsp;<span id="ast-25">(<span id="ast-26" class="other_trans">source</span><span id="ast-27" class="correct_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31">self</span>.mapping</span>.get</span>(<span id="ast-32" class="other_trans">template</span>)</span>)</span></span>)</span></span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-34"><span id="ast-35" class="other_trans">TemplateNotFound</span>(<span id="ast-36" class="other_trans">template</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_parse_shortcode_args(<span id="ast-2"><span id="ast-3" class="other_trans">data</span>,&nbsp;<span id="ast-4" class="other_trans">start</span>,&nbsp;<span id="ast-5" class="other_trans">name</span>,&nbsp;<span id="ast-6">start_pos</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"When&nbsp;pointed&nbsp;to&nbsp;after&nbsp;a&nbsp;shortcode's&nbsp;name&nbsp;in&nbsp;a&nbsp;shortcode&nbsp;tag,&nbsp;parses&nbsp;the&nbsp;shortcode's&nbsp;arguments&nbsp;until&nbsp;'%}}'.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;the&nbsp;position&nbsp;after&nbsp;'%}}',&nbsp;followed&nbsp;by&nbsp;a&nbsp;tuple&nbsp;(args,&nbsp;kw).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;and&nbsp;start_pos&nbsp;are&nbsp;only&nbsp;used&nbsp;for&nbsp;formatting&nbsp;error&nbsp;messages.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>args</span>&nbsp;=&nbsp;<span id="ast-11">[]</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>kwargs</span>&nbsp;=&nbsp;<span id="ast-14">{}</span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-17">start</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-19">True</span>:<span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23">_skip_whitespace</span>(<span id="ast-24" class="other_trans">data</span>,&nbsp;<span id="ast-25">pos</span>,&nbsp;must_be_nontrivial=<span id="ast-27">True</span>)</span></span><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-29">(<span id="ast-30" class="other_trans">pos</span><span id="ast-31" class="incorrect_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-32"><span id="ast-33">len</span>(<span id="ast-34" class="other_trans">data</span>)</span>)</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-37">(<span id="ast-39">(<span id="ast-40">(<span id="ast-41" class="other_trans">pos</span>&nbsp;+&nbsp;<span id="ast-43">3</span>)</span><span id="ast-44" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-45"><span id="ast-46">len</span>(<span id="ast-47" class="other_trans">data</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-48">(<span id="ast-49"><span id="ast-50">data</span>[<span id="ast-51"><span id="ast-52">pos</span>:<span id="ast-53">(<span id="ast-54" class="other_trans">pos</span>&nbsp;+&nbsp;<span id="ast-56">3</span>)</span></span>]</span><span id="ast-57" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-58">'%}}'</span>)</span>)</span>:<span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-60">(<span id="ast-61">(<span id="ast-62">pos</span>&nbsp;+&nbsp;<span id="ast-64">3</span>)</span>,&nbsp;<span id="ast-65">(<span id="ast-66" class="other_trans">args</span>,&nbsp;<span id="ast-67" class="other_trans">kwargs</span>)</span>)</span></span></span><span id="ast-68"><span id="ast-69"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-70" class="other_trans">pos</span>,&nbsp;<span id="ast-71" class="other_trans">name</span>,&nbsp;<span id="ast-72" class="other_trans">next_is_equals</span>)</span>&nbsp;=&nbsp;<span id="ast-73"><span id="ast-74" class="other_trans">_parse_string</span>(<span id="ast-75" class="other_trans">data</span>,&nbsp;<span id="ast-76" class="other_trans">pos</span>,&nbsp;stop_at_equals=<span id="ast-78">True</span>,&nbsp;must_have_content=<span id="ast-80">True</span>)</span></span><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-82" class="other_trans">next_is_equals</span>:<span id="ast-83"><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-85">pos</span>,&nbsp;<span id="ast-86" class="other_trans">value</span>,&nbsp;<span id="ast-87" class="other_trans">_</span>)</span>&nbsp;=&nbsp;<span id="ast-88"><span id="ast-89" class="other_trans">_parse_string</span>(<span id="ast-90" class="other_trans">data</span>,&nbsp;<span id="ast-91">(<span id="ast-92" class="other_trans">pos</span>&nbsp;+&nbsp;<span id="ast-94">1</span>)</span>,&nbsp;stop_at_equals=<span id="ast-96">False</span>,&nbsp;must_have_content=<span id="ast-98">False</span>)</span></span><span id="ast-99"><span id="ast-100"><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>kwargs</span>[<span id="ast-102"><span id="ast-103" class="other_trans">name</span></span>]</span>&nbsp;=&nbsp;<span id="ast-104" class="other_trans">value</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-105"><span id="ast-106"><span id="ast-107"><span id="ast-108" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>args</span>.append</span>(<span id="ast-109" class="other_trans">name</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_run_interface(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">runtime</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>n_runs</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8">len</span>(<span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.inputs</span>.rigids</span>)</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>first_rigid</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.inputs</span>.rigids</span>[<span id="ast-18"><span id="ast-19">0</span></span>]</span></span><span id="ast-20"><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>out_files</span>&nbsp;=&nbsp;<span id="ast-22">[]</span></span><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-24" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-25"><span id="ast-26" class="other_trans">range</span>(<span id="ast-27">n_runs</span>)</span>:<span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_dir</span>&nbsp;=&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32">'run_{}/'</span>.format</span>(<span id="ast-33">(<span id="ast-34" class="other_trans">i</span>&nbsp;+&nbsp;<span id="ast-36">1</span>)</span>)</span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.mkdir</span>(<span id="ast-41" class="other_trans">out_dir</span>)</span></span><span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_files</span>.append</span>(<span id="ast-46"><span id="ast-47"><span id="ast-48">op</span>.realpath</span>(<span id="ast-49">out_dir</span>)</span>)</span></span><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>run_rigid</span>&nbsp;=&nbsp;<span id="ast-52"><span id="ast-53"><span id="ast-54"><span id="ast-55">self</span>.inputs</span>.rigids</span>[<span id="ast-56"><span id="ast-57" class="other_trans">i</span></span>]</span></span><span id="ast-58"><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-60" class="other_trans">runtime</span>,&nbsp;<span id="ast-61" class="other_trans">full_rigid</span>)</span>&nbsp;=&nbsp;<span id="ast-62"><span id="ast-63"><span id="ast-64">self</span>.combine_rigids</span>(<span id="ast-65" class="other_trans">runtime</span>,&nbsp;<span id="ast-66" class="other_trans">first_rigid</span>,&nbsp;<span id="ast-67">run_rigid</span>)</span></span><span id="ast-68"><span id="ast-69" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>run_timeseries</span>&nbsp;=&nbsp;<span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73">self</span>.inputs</span>.timeseries</span>[<span id="ast-74"><span id="ast-75">i</span></span>]</span></span><span id="ast-76"><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-78"><span id="ast-82">'res4d'</span>&nbsp;if&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81">self</span>.inputs</span>.residual</span>&nbsp;else&nbsp;<span id="ast-83">'timeseries'</span></span></span><span id="ast-84"><span id="ast-85" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_timeseries</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88">op</span>.join</span>(<span id="ast-89">out_dir</span>,&nbsp;<span id="ast-90">(<span id="ast-91" class="other_trans">name</span>&nbsp;+&nbsp;<span id="ast-93">'_xfm.nii.gz'</span>)</span>)</span></span><span id="ast-94"><span id="ast-95"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>runtime</span>&nbsp;=&nbsp;<span id="ast-96"><span id="ast-97"><span id="ast-98">self</span>.apply_fsl_rigid</span>(<span id="ast-99">runtime</span>,&nbsp;<span id="ast-100">run_timeseries</span>,&nbsp;<span id="ast-101">out_timeseries</span>,&nbsp;<span id="ast-102" class="other_trans">full_rigid</span>)</span></span><span id="ast-103"><span id="ast-104"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>run_mask</span>&nbsp;=&nbsp;<span id="ast-105"><span id="ast-106"><span id="ast-107"><span id="ast-108">self</span>.inputs</span>.masks</span>[<span id="ast-109"><span id="ast-110" class="other_trans">i</span></span>]</span></span><span id="ast-111"><span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_mask_fname</span>&nbsp;=&nbsp;<span id="ast-113"><span id="ast-114"><span id="ast-115" class="other_trans">op</span>.basename</span>(<span id="ast-116"><span id="ast-117" class="other_trans">add_suffix</span>(<span id="ast-118">run_mask</span>,&nbsp;<span id="ast-119">'xfm'</span>)</span>)</span></span><span id="ast-120"><span id="ast-121" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_mask</span>&nbsp;=&nbsp;<span id="ast-122"><span id="ast-123"><span id="ast-124">op</span>.join</span>(<span id="ast-125">out_dir</span>,&nbsp;<span id="ast-126" class="other_trans">out_mask_fname</span>)</span></span><span id="ast-127"><span id="ast-128"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>runtime</span>&nbsp;=&nbsp;<span id="ast-129"><span id="ast-130"><span id="ast-131">self</span>.apply_fsl_rigid</span>(<span id="ast-132" class="other_trans">runtime</span>,&nbsp;<span id="ast-133" class="other_trans">run_mask</span>,&nbsp;<span id="ast-134">out_mask</span>,&nbsp;<span id="ast-135" class="other_trans">full_rigid</span>)</span></span><span id="ast-136"><span id="ast-137" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>run_mean</span>&nbsp;=&nbsp;<span id="ast-138"><span id="ast-139"><span id="ast-140"><span id="ast-141">self</span>.inputs</span>.means</span>[<span id="ast-142"><span id="ast-143">i</span></span>]</span></span><span id="ast-144"><span id="ast-145" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_mean_fname</span>&nbsp;=&nbsp;<span id="ast-146"><span id="ast-147"><span id="ast-148">op</span>.basename</span>(<span id="ast-149"><span id="ast-150">add_suffix</span>(<span id="ast-151">run_mean</span>,&nbsp;<span id="ast-152">'xfm'</span>)</span>)</span></span><span id="ast-153"><span id="ast-154"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>out_mean</span>&nbsp;=&nbsp;<span id="ast-155"><span id="ast-156"><span id="ast-157" class="other_trans">op</span>.join</span>(<span id="ast-158" class="incorrect_node">out_dir&nbsp;&rarr;&nbsp;out_files&nbsp;</span>,&nbsp;<span id="ast-159" class="other_trans">out_mean_fname</span>)</span></span><span id="ast-160"><span id="ast-161" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>runtime</span>&nbsp;=&nbsp;<span id="ast-162"><span id="ast-163"><span id="ast-164">self</span>.apply_fsl_rigid</span>(<span id="ast-165" class="other_trans">runtime</span>,&nbsp;<span id="ast-166">run_mean</span>,&nbsp;<span id="ast-167">out_mean</span>,&nbsp;<span id="ast-168" class="ref_node">run_rigid&nbsp;&rarr;&nbsp;full_rigid&nbsp;</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;purge_posts(<span id="ast-2"><span id="ast-3" class="other_trans">app</span>,&nbsp;<span id="ast-4" class="other_trans">env</span>,&nbsp;<span id="ast-5" class="other_trans">docname</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Remove&nbsp;post&nbsp;and&nbsp;reference&nbsp;to&nbsp;it&nbsp;from&nbsp;the&nbsp;standard&nbsp;domain&nbsp;when&nbsp;its\\u000a&nbsp;&nbsp;&nbsp;&nbsp;document&nbsp;is&nbsp;removed&nbsp;or&nbsp;changed.'</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>obj</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11">(<span id="ast-12" class="other_trans">env</span>,&nbsp;<span id="ast-13" class="incorrect_node">app&nbsp;&rarr;&nbsp;env&nbsp;</span>)</span>[<span id="ast-14"><span id="ast-15" class="other_trans">ON_RTD</span></span>]</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">hasattr</span>(<span id="ast-19" class="other_trans">obj</span>,&nbsp;<span id="ast-20">'ablog_posts'</span>)</span>:<span id="ast-21"><span id="ast-22"><span id="ast-23"><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>obj</span>.ablog_posts</span>.pop</span>(<span id="ast-26" class="other_trans">docname</span>,&nbsp;<span id="ast-27" class="other_trans">None</span>)</span></span></span><span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filename</span>&nbsp;=&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans">os</span>.path</span>.split</span>(<span id="ast-35" class="other_trans">docname</span>)</span>[<span id="ast-36"><span id="ast-37">1</span></span>]</span></span><span id="ast-38"><span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="ref_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>obj&nbsp;&rarr;&nbsp;env&nbsp;</span>.domains</span>[<span id="ast-46"><span id="ast-47">'std'</span></span>]</span>.data</span>[<span id="ast-48"><span id="ast-49">'labels'</span></span>]</span>.pop</span>(<span id="ast-50" class="other_trans">filename</span>,&nbsp;<span id="ast-51" class="other_trans">None</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">func</span></span>):<span id="ast-5"><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.func</span>&nbsp;=&nbsp;<span id="ast-8" class="other_trans">func</span></span><span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-11">arg_names</span>,&nbsp;<span id="ast-12" class="other_trans">vararg_name</span>,&nbsp;<span id="ast-13">keyarg_name</span>,&nbsp;<span id="ast-14" class="other_trans">arg_defaults</span>)</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16">getargspec</span>(<span id="ast-17">func</span>)</span></span><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_names</span>&nbsp;=&nbsp;<span id="ast-21" class="other_trans">arg_names</span></span><span id="ast-22"><span id="ast-23"><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.vararg_name</span>&nbsp;=&nbsp;<span id="ast-25">vararg_name</span></span><span id="ast-26"><span id="ast-27"><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.keyarg_name</span>&nbsp;=&nbsp;<span id="ast-29">keyarg_name</span></span><span id="ast-30"><span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_defaults</span>&nbsp;=&nbsp;<span id="ast-33" class="other_trans">arg_defaults</span></span><span id="ast-34"><span id="ast-35"><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_name_set</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38" class="other_trans">set</span>(<span id="ast-39">arg_names</span>)</span></span><span id="ast-40"><span id="ast-41"><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_default_map</span>&nbsp;=&nbsp;<span id="ast-43"><span id="ast-44">dict</span>(<span id="ast-45">(<span id="ast-46">(<span id="ast-47">k</span>,&nbsp;<span id="ast-48" class="other_trans">v</span>)</span><span id="ast-49">&nbsp;for&nbsp;<span id="ast-50">(<span id="ast-51">k</span>,&nbsp;<span id="ast-52">v</span>)</span>&nbsp;in&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">zip</span>(*<span id="ast-55"><span id="ast-56">map</span>(<span id="ast-57">reversed</span>,&nbsp;<span id="ast-58">(<span id="ast-59">(<span id="ast-61" class="other_trans">arg_names</span>&nbsp;or&nbsp;<span id="ast-62">[]</span>)</span>,&nbsp;<span id="ast-63">(<span id="ast-65" class="other_trans">arg_defaults</span>&nbsp;or&nbsp;<span id="ast-66">[]</span>)</span>)</span>)</span>)</span></span>)</span>)</span></span><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>doc</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70" class="other_trans">getdoc</span>(<span id="ast-71">func</span>)</span></span><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-73">(<span id="ast-74">not</span>&nbsp;<span id="ast-75" class="other_trans">doc</span>)</span>:<span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-77"><span id="ast-78"><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_alias_map</span>&nbsp;=&nbsp;<span id="ast-80">{}</span></span><span id="ast-81"><span id="ast-82"><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_meta_map</span>&nbsp;=&nbsp;<span id="ast-84">{}</span></span><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-86" class="other_trans">line</span>&nbsp;in&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89" class="other_trans">doc</span>.splitlines</span>()</span>:<span id="ast-90"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-91"><span id="ast-92"><span id="ast-93"><span id="ast-94">self</span>.arg_desc_re</span>.match</span>(<span id="ast-95" class="other_trans">line</span>)</span>:<span id="ast-96"><span id="ast-97"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>meta_map</span>&nbsp;=&nbsp;<span id="ast-98">{}</span></span><span id="ast-99"><span id="ast-100"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>aliases_set</span>&nbsp;=&nbsp;<span id="ast-101"><span id="ast-102" class="other_trans">set</span>()</span></span><span id="ast-103"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-104" class="other_trans">m</span>&nbsp;in&nbsp;<span id="ast-105"><span id="ast-106"><span id="ast-107"><span id="ast-108">self</span>.arg_re</span>.finditer</span>(<span id="ast-109" class="other_trans">line</span>)</span>:<span id="ast-110"><span id="ast-111"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-112">key</span>,&nbsp;<span id="ast-113">meta</span>)</span>&nbsp;=&nbsp;<span id="ast-114"><span id="ast-115"><span id="ast-116" class="other_trans">m</span>.group</span>(<span id="ast-117">'key'</span>,&nbsp;<span id="ast-118">'meta'</span>)</span></span><span id="ast-119"><span id="ast-120"><span id="ast-121"><span id="ast-122" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>aliases_set</span>.add</span>(<span id="ast-123">key</span>)</span></span><span id="ast-124"><span id="ast-125"><span id="ast-126" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>meta_map</span>[<span id="ast-127"><span id="ast-128">key</span></span>]</span>&nbsp;=&nbsp;<span id="ast-129" class="other_trans">meta</span></span></span><span id="ast-130"><span id="ast-131" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>arg_name_set</span>&nbsp;=&nbsp;<span id="ast-132">(<span id="ast-133"><span id="ast-134">self</span>.arg_name_set</span>&nbsp;&amp;&nbsp;<span id="ast-136" class="other_trans">aliases_set</span>)</span></span><span id="ast-137"><span id="ast-138"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>aliases_set</span>&nbsp;-=&nbsp;<span id="ast-140">arg_name_set</span></span><span id="ast-141"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-142" class="ref_node">arg_names&nbsp;&rarr;&nbsp;arg_name_set&nbsp;</span>:<span id="ast-143"><span id="ast-144" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>arg_name</span>&nbsp;=&nbsp;<span id="ast-145"><span id="ast-146"><span id="ast-147" class="other_trans">arg_name_set</span>.pop</span>()</span></span><span id="ast-148"><span id="ast-149"><span id="ast-150"><span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_meta_map</span>[<span id="ast-152"><span id="ast-153" class="other_trans">arg_name</span></span>]</span>&nbsp;=&nbsp;<span id="ast-154"><span id="ast-155" class="incorrect_node">meta_map&nbsp;&rarr;&nbsp;self.&nbsp;</span>[<span id="ast-156"><span id="ast-157">arg_name</span></span>]</span></span><span id="ast-158"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-159" class="other_trans">alias</span>&nbsp;in&nbsp;<span id="ast-160">aliases_set</span>:<span id="ast-161"><span id="ast-162"><span id="ast-163"><span id="ast-164"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.arg_alias_map</span>[<span id="ast-165"><span id="ast-166" class="other_trans">alias</span></span>]</span>&nbsp;=&nbsp;<span id="ast-167" class="other_trans">arg_name</span></span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_get(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">url</span></span>):<span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-6">(<span id="ast-7">not</span>&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">hasattr</span>(<span id="ast-10">self</span>,&nbsp;<span id="ast-11">'_token'</span>)</span>)</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">errors</span>.InitializationError</span></span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22">self</span>._session</span>.get</span>(<span id="ast-23"><span id="ast-24"><span id="ast-25">self</span>._url</span>(<span id="ast-26" class="other_trans">url</span>)</span>)</span>.json</span>()</span></span><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-28">(<span id="ast-30">(<span id="ast-31">'status'</span><span id="ast-32">&nbsp;in&nbsp;</span><span id="ast-33" class="other_trans">result</span>)</span>&nbsp;and&nbsp;<span id="ast-34">(<span id="ast-35"><span id="ast-36" class="other_trans">result</span>[<span id="ast-37"><span id="ast-38">'status'</span></span>]</span><span id="ast-39" class="correct_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-40">200</span>)</span>)</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">errors</span>.RequestError</span>(<span id="ast-45"><span id="ast-46" class="other_trans">result</span>[<span id="ast-47"><span id="ast-48">'status'</span></span>]</span>)</span></span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-50" class="other_trans">result</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_on_write(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">fd</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sent_messages</span>&nbsp;=&nbsp;<span id="ast-7">[]</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-9"><span id="ast-10">self</span>.send_queue_lock</span>:<span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-14">(<span id="ast-15">not</span>&nbsp;<span id="ast-16" class="correct_node">tls&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span>&nbsp;and&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">hasattr</span>(<span id="ast-19" class="other_trans">socket</span>,&nbsp;<span id="ast-20">'MSG_NOSIGNAL'</span>)</span>)</span>:<span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>send_flags</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24" class="other_trans">socket</span>.MSG_NOSIGNAL</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>send_flags</span>&nbsp;=&nbsp;<span id="ast-27">0</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;expand_actions(<span id="ast-2"><span id="ast-3" class="other_trans">configurable</span>,&nbsp;<span id="ast-4" class="other_trans">actions</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Expand&nbsp;any&nbsp;:class:`Composite`&nbsp;instances&nbsp;into&nbsp;:class:`Action`&nbsp;instances.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Expansion&nbsp;is&nbsp;recursive;&nbsp;composites&nbsp;that&nbsp;return&nbsp;composites&nbsp;are&nbsp;expanded\\u000a&nbsp;&nbsp;&nbsp;&nbsp;again.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;configurable:&nbsp;a&nbsp;:class:`Configurable`&nbsp;instance.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;actions:&nbsp;an&nbsp;iterable&nbsp;of&nbsp;:class:`Composite`&nbsp;and&nbsp;:class:`Action`\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instances.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return:&nbsp;an&nbsp;iterable&nbsp;of&nbsp;:class:`Action`&nbsp;instances.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-8">(<span id="ast-9" class="other_trans">action</span>,&nbsp;<span id="ast-10" class="other_trans">obj</span>)</span>&nbsp;in&nbsp;<span id="ast-11" class="other_trans">actions</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">isinstance</span>(<span id="ast-15" class="other_trans">action</span>,&nbsp;<span id="ast-16">Composite</span>)</span>:<span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>kw</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans">action</span>._get_config_kw</span>(<span id="ast-22">configurable</span>)</span></span><span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sub_actions</span>&nbsp;=&nbsp;<span id="ast-25">[]</span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-27">(<span id="ast-28" class="other_trans">sub_action</span>,&nbsp;<span id="ast-29" class="other_trans">sub_obj</span>)</span>&nbsp;in&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32">action</span>.actions</span>(<span id="ast-33" class="other_trans">obj</span>,&nbsp;**<span id="ast-34">kw</span>)</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sub_action</span>.directive</span>&nbsp;=&nbsp;<span id="ast-38"><span id="ast-39" class="other_trans">action</span>.directive</span></span><span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sub_actions</span>.append</span>(<span id="ast-44">(<span id="ast-45" class="other_trans">sub_action</span>,&nbsp;<span id="ast-46" class="correct_node">obj&nbsp;&rarr;&nbsp;sub_obj&nbsp;</span>)</span>)</span></span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-48">(<span id="ast-49">sub_action</span>,&nbsp;<span id="ast-50">sub_obj</span>)</span>&nbsp;in&nbsp;<span id="ast-51"><span id="ast-52" class="other_trans">expand_actions</span>(<span id="ast-53" class="other_trans">configurable</span>,&nbsp;<span id="ast-54" class="other_trans">sub_actions</span>)</span>:<span id="ast-55"><span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>yield&nbsp;<span id="ast-57">(<span id="ast-58" class="other_trans">sub_action</span>,&nbsp;<span id="ast-59" class="other_trans">sub_obj</span>)</span></span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62">not</span>&nbsp;<span id="ast-63"><span id="ast-64" class="other_trans">hasattr</span>(<span id="ast-65" class="other_trans">action</span>,&nbsp;<span id="ast-66">'order'</span>)</span>)</span>:<span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>global&nbsp;order_count</span><span id="ast-68"><span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>action</span>.order</span>&nbsp;=&nbsp;<span id="ast-71" class="other_trans">order_count</span></span><span id="ast-72"><span id="ast-73" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>order_count</span>&nbsp;+=&nbsp;<span id="ast-75">1</span></span></span><span id="ast-76"><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>yield&nbsp;<span id="ast-78">(<span id="ast-79" class="other_trans">action</span>,&nbsp;<span id="ast-80" class="other_trans">obj</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;bs(<span id="ast-2"><span id="ast-3" class="other_trans">s</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-6" class="other_trans">y</span>,&nbsp;<span id="ast-7" class="other_trans">x</span>)</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.win</span>.getyx</span>()</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13">(<span id="ast-14" class="other_trans">x</span><span id="ast-15" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-16">ix</span>)</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-18" class="other_trans">s</span></span></span><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>s</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22" class="other_trans">s</span>[<span id="ast-23">:<span id="ast-24">-1</span></span>]</span></span><span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.win</span>.delch</span>(<span id="ast-30" class="incorrect_node">y&nbsp;&rarr;&nbsp;s&nbsp;</span>,&nbsp;<span id="ast-31">(<span id="ast-32" class="other_trans">x</span>&nbsp;-&nbsp;<span id="ast-34">1</span>)</span>)</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.win</span>.move</span>(<span id="ast-40" class="other_trans">y</span>,&nbsp;<span id="ast-41">(<span id="ast-42" class="other_trans">x</span>&nbsp;-&nbsp;<span id="ast-44">1</span>)</span>)</span></span><span id="ast-45"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-46" class="other_trans">s</span></span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
</span>o</span>&nbsp;=&nbsp;<span id="ast-49">''</span></span><span id="ast-50"><span class="whitespace"><br />
</span>while&nbsp;<span id="ast-51">True</span>:<span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>c</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57">self</span>.win</span>.getch</span>()</span></span><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59">(<span id="ast-60" class="other_trans">c</span><span id="ast-61" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-62">127</span>)</span>:<span id="ast-63"><span id="ast-64" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>o</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">bs</span>(<span id="ast-67" class="other_trans">o</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-69">(<span id="ast-70" class="other_trans">c</span><span id="ast-71" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-72">10</span>)</span>:<span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-75">(<span id="ast-76" class="other_trans">c</span><span id="ast-77" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-78">27</span>)</span>:<span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>curses</span>.flushinp</span>()</span></span><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-84" class="other_trans">ValueError</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-86">(<span id="ast-87">0</span><span id="ast-88" class="ref_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-90" class="other_trans">c</span><span id="ast-89" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-91">127</span>)</span>:<span id="ast-92"><span id="ast-93" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>c</span>&nbsp;=&nbsp;<span id="ast-94"><span id="ast-95">chr</span>(<span id="ast-96" class="other_trans">c</span>)</span></span><span id="ast-97"><span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.win</span>.addstr</span>(<span id="ast-102" class="other_trans">c</span>,&nbsp;<span id="ast-103"><span id="ast-104" class="other_trans">get_colpair</span>(<span id="ast-105"><span id="ast-106">self</span>.config</span>,&nbsp;<span id="ast-107">'prompt'</span>)</span>)</span></span><span id="ast-108"><span id="ast-109" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>o</span>&nbsp;+=&nbsp;<span id="ast-111" class="other_trans">c</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;to_numpy(<span id="ast-2"><span id="ast-3" class="other_trans">ds</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Downcast&nbsp;a&nbsp;datashape&nbsp;object&nbsp;into&nbsp;a&nbsp;Numpy&nbsp;(shape,&nbsp;dtype)&nbsp;tuple&nbsp;if\\u000a&nbsp;&nbsp;&nbsp;&nbsp;possible.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;to_numpy(dshape('5,&nbsp;5,&nbsp;int32'))\\u000a&nbsp;&nbsp;&nbsp;&nbsp;(5,5),&nbsp;dtype('int32')\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7"><span id="ast-8">isinstance</span>(<span id="ast-9" class="other_trans">ds</span>,&nbsp;<span id="ast-10">CType</span>)</span>:<span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-12"><span id="ast-13"><span id="ast-14" class="other_trans">ds</span>.to_dtype</span>()</span></span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>shape</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">tuple</span>()</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dtype</span>&nbsp;=&nbsp;<span id="ast-21" class="other_trans">None</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-23" class="other_trans">dim</span>&nbsp;in&nbsp;<span id="ast-24"><span id="ast-25">extract_dims</span>(<span id="ast-26" class="other_trans">ds</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-28"><span id="ast-29">isinstance</span>(<span id="ast-30" class="other_trans">dim</span>,&nbsp;<span id="ast-31" class="other_trans">IntegerConstant</span>)</span>:<span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>shape</span>&nbsp;+=&nbsp;<span id="ast-35">(<span id="ast-36" class="other_trans">dim</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-38"><span id="ast-39">isinstance</span>(<span id="ast-40" class="other_trans">dim</span>,&nbsp;<span id="ast-41">Fixed</span>)</span>:<span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>shape</span>&nbsp;+=&nbsp;<span id="ast-45">(<span id="ast-46"><span id="ast-47" class="other_trans">dim</span>.val</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-49"><span id="ast-50" class="other_trans">isinstance</span>(<span id="ast-51" class="other_trans">dim</span>,&nbsp;<span id="ast-52" class="other_trans">TypeVar</span>)</span>:<span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>shape</span>&nbsp;+=&nbsp;<span id="ast-56">(<span id="ast-57">-1</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-59"><span id="ast-60" class="other_trans">NotNumpyCompatible</span>(<span id="ast-61">(<span id="ast-62">'Datashape&nbsp;dimension&nbsp;%s&nbsp;is&nbsp;not&nbsp;NumPy-compatible'</span>&nbsp;%&nbsp;<span id="ast-64" class="other_trans">dim</span>)</span>)</span></span></span></span><span id="ast-65"><span id="ast-66" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>msr</span>&nbsp;=&nbsp;<span id="ast-67"><span id="ast-68">extract_measure</span>(<span id="ast-69" class="other_trans">ds</span>)</span></span><span id="ast-70"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-71"><span id="ast-72" class="other_trans">isinstance</span>(<span id="ast-73" class="other_trans">msr</span>,&nbsp;<span id="ast-74">CType</span>)</span>:<span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dtype</span>&nbsp;=&nbsp;<span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans">msr</span>.to_dtype</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-81"><span id="ast-82" class="other_trans">isinstance</span>(<span id="ast-83" class="other_trans">msr</span>,&nbsp;<span id="ast-84">Record</span>)</span>:<span id="ast-85"><span id="ast-86" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dtype</span>&nbsp;=&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89" class="other_trans">msr</span>.to_dtype</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-90"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-91"><span id="ast-92" class="other_trans">NotNumpyCompatible</span>(<span id="ast-93">(<span id="ast-94">'Datashape&nbsp;measure&nbsp;%s&nbsp;is&nbsp;not&nbsp;NumPy-compatible'</span>&nbsp;%&nbsp;<span id="ast-96" class="correct_node">dim&nbsp;&rarr;&nbsp;msr&nbsp;</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;update(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">max_retries</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8" class="other_trans">max_retries</span><span id="ast-9" class="incorrect_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-10">0</span>)</span>:<span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-12"><span id="ast-13" class="other_trans">Exception</span>(<span id="ast-14">'index&nbsp;server&nbsp;out&nbsp;of&nbsp;sync'</span>)</span></span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18">GetRequest</span>(<span id="ast-19"><span id="ast-20">urljoin</span>(<span id="ast-21"><span id="ast-22">self</span>.repository_url</span>,&nbsp;<span id="ast-23">'/index'</span>)</span>)</span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>session</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27">Session</span>(<span id="ast-28"><span id="ast-29">self</span>.data_path</span>,&nbsp;s=<span id="ast-31"><span id="ast-32">self</span>.s</span>)</span></span><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cache</span>&nbsp;=&nbsp;<span id="ast-35"><span id="ast-36">Cache</span>(<span id="ast-37"><span id="ast-38">self</span>.data_path</span>,&nbsp;s=<span id="ast-40"><span id="ast-41">self</span>.s</span>)</span></span><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packages</span>&nbsp;=&nbsp;<span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans">cache</span>.list_all</span>()</span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>index</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50"><span id="ast-51">json</span>.load</span>(<span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans">session</span>.open</span>(<span id="ast-55" class="other_trans">request</span>,&nbsp;<span id="ast-56">'utf8'</span>)</span>)</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-58">(<span id="ast-59" class="other_trans">ident</span>,&nbsp;<span id="ast-60">(<span id="ast-61" class="other_trans">meta_url</span>,&nbsp;<span id="ast-62" class="other_trans">etag</span>)</span>)</span>&nbsp;in&nbsp;<span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">index</span>.items</span>()</span>:<span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-67">(<span id="ast-68">not</span>&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans">cache</span>.exists</span>(<span id="ast-72" class="other_trans">ident</span>,&nbsp;<span id="ast-73">etag</span>)</span>)</span>:<span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-76"><span id="ast-77">urljoin</span>(<span id="ast-78"><span id="ast-79">self</span>.repository_url</span>,&nbsp;<span id="ast-80" class="other_trans">meta_url</span>)</span></span><span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>request</span>&nbsp;=&nbsp;<span id="ast-83"><span id="ast-84">GetRequest</span>(<span id="ast-85" class="other_trans">url</span>)</span></span><span id="ast-86"><span id="ast-87" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>&nbsp;=&nbsp;<span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans">session</span>.open</span>(<span id="ast-91">request</span>,&nbsp;<span id="ast-92">'utf8'</span>)</span></span><span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>meta</span>&nbsp;=&nbsp;<span id="ast-95"><span id="ast-96"><span id="ast-97">json</span>.load</span>(<span id="ast-98" class="other_trans">response</span>)</span></span><span id="ast-99"><span id="ast-100" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>package</span>&nbsp;=&nbsp;<span id="ast-101"><span id="ast-102" class="other_trans">PackageStub</span>(<span id="ast-103"><span id="ast-104" class="other_trans">meta</span>[<span id="ast-105"><span id="ast-106">'package'</span></span>]</span>,&nbsp;s=<span id="ast-108"><span id="ast-109">self</span>.s</span>)</span></span><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-111">(<span id="ast-112">ident</span><span id="ast-113" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-114"><span id="ast-115">package</span>.ident</span>)</span></span><span id="ast-116"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-117">(<span id="ast-118"><span id="ast-119"><span id="ast-120">util</span>.unquote</span>(<span id="ast-121"><span id="ast-122"><span id="ast-123" class="other_trans">response</span>.headers</span>[<span id="ast-124"><span id="ast-125">'etag'</span></span>]</span>)</span><span id="ast-126" class="ref_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-127" class="other_trans">etag</span>)</span>:<span id="ast-128"><span id="ast-129"><span id="ast-130"><span id="ast-131"><span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.s</span>.log</span>(<span id="ast-133">'wait&nbsp;for&nbsp;index&nbsp;server&nbsp;to&nbsp;sync'</span>)</span></span><span id="ast-134"><span id="ast-135"><span id="ast-136"><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>time</span>.sleep</span>(<span id="ast-138">10</span>)</span></span><span id="ast-139"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-140"><span id="ast-141"><span id="ast-142">self</span>.update</span>(<span id="ast-143">(<span id="ast-144" class="other_trans">max_retries</span>&nbsp;-&nbsp;<span id="ast-146">1</span>)</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_step(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Make&nbsp;a&nbsp;single&nbsp;gradient&nbsp;update.&nbsp;This&nbsp;is&nbsp;called&nbsp;by&nbsp;train()&nbsp;and&nbsp;should&nbsp;not\\u000a&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;called&nbsp;manually.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>num_train</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.X_train</span>.shape</span>[<span id="ast-12"><span id="ast-13">0</span></span>]</span></span><span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>batch_mask</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19" class="other_trans">np</span>.random</span>.choice</span>(<span id="ast-20" class="other_trans">num_train</span>,&nbsp;<span id="ast-21"><span id="ast-22">self</span>.batch_size</span>)</span></span><span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>X_batch</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27">self</span>.X_train</span>[<span id="ast-28"><span id="ast-29" class="other_trans">batch_mask</span></span>]</span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>y_batch</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34">self</span>.y_train</span>[<span id="ast-35"><span id="ast-36" class="other_trans">batch_mask</span></span>]</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-38"><span id="ast-39">self</span>.batch_augment_func</span>:<span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>X_batch</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44">self</span>.batch_augment_func</span>(<span id="ast-45" class="other_trans">X_batch</span>)</span></span></span><span id="ast-46"><span id="ast-47" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>n</span>&nbsp;=&nbsp;<span id="ast-48" class="correct_node">n_threads&nbsp;&rarr;&nbsp;self.&nbsp;</span></span><span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>threads</span>&nbsp;=&nbsp;<span id="ast-51">(<span id="ast-52">[<span id="ast-53" class="other_trans">None</span>]</span>&nbsp;*&nbsp;<span id="ast-55" class="other_trans">n</span>)</span></span><span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>results</span>&nbsp;=&nbsp;<span id="ast-58">(<span id="ast-59">[<span id="ast-60" class="other_trans">None</span>]</span>&nbsp;*&nbsp;<span id="ast-62" class="other_trans">n</span>)</span></span><span id="ast-63"><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>X_batches</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans">np</span>.split</span>(<span id="ast-68" class="other_trans">X_batch</span>,&nbsp;<span id="ast-69" class="other_trans">n</span>)</span></span><span id="ast-70"><span id="ast-71" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>y_batches</span>&nbsp;=&nbsp;<span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans">np</span>.split</span>(<span id="ast-75" class="other_trans">y_batch</span>,&nbsp;<span id="ast-76" class="other_trans">n</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_fetch(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">start</span>,&nbsp;<span id="ast-5" class="other_trans">end</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-9">(<span id="ast-10"><span id="ast-11">self</span>.start</span><span id="ast-12" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-13" class="other_trans">None</span>)</span>&nbsp;and&nbsp;<span id="ast-14">(<span id="ast-15"><span id="ast-16">self</span>.end</span><span id="ast-17" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-18" class="other_trans">None</span>)</span>)</span>:<span id="ast-19"><span id="ast-20"><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.start</span>&nbsp;=&nbsp;<span id="ast-22" class="other_trans">start</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.end</span>&nbsp;=&nbsp;<span id="ast-26">(<span id="ast-27" class="other_trans">end</span>&nbsp;+&nbsp;<span id="ast-29"><span id="ast-30">self</span>.blocksize</span>)</span></span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.cache</span>&nbsp;=&nbsp;<span id="ast-34"><span id="ast-35" class="other_trans">_fetch_range</span>(<span id="ast-36"><span id="ast-37"><span id="ast-38">self</span>.s3</span>.s3</span>,&nbsp;<span id="ast-39"><span id="ast-40">self</span>.bucket</span>,&nbsp;<span id="ast-41"><span id="ast-42">self</span>.key</span>,&nbsp;<span id="ast-43" class="other_trans">start</span>,&nbsp;<span id="ast-44"><span id="ast-45">self</span>.end</span>)</span></span></span><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-47">(<span id="ast-48" class="other_trans">start</span><span id="ast-49" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-50"><span id="ast-51">self</span>.start</span>)</span>:<span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55" class="other_trans">_fetch_range</span>(<span id="ast-56"><span id="ast-57"><span id="ast-58">self</span>.s3</span>.s3</span>,&nbsp;<span id="ast-59"><span id="ast-60">self</span>.bucket</span>,&nbsp;<span id="ast-61"><span id="ast-62">self</span>.key</span>,&nbsp;<span id="ast-63" class="other_trans">start</span>,&nbsp;<span id="ast-64"><span id="ast-65">self</span>.start</span>)</span></span><span id="ast-66"><span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.start</span>&nbsp;=&nbsp;<span id="ast-69" class="other_trans">start</span></span><span id="ast-70"><span id="ast-71"><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.cache</span>&nbsp;=&nbsp;<span id="ast-73">(<span id="ast-74" class="other_trans">new</span>&nbsp;+&nbsp;<span id="ast-76"><span id="ast-77">self</span>.cache</span>)</span></span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-79">(<span id="ast-80" class="other_trans">end</span><span id="ast-81" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-82"><span id="ast-83">self</span>.end</span>)</span>:<span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-85">(<span id="ast-86" class="ref_node">end&nbsp;&rarr;&nbsp;self.&nbsp;</span><span id="ast-87" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-88"><span id="ast-89">self</span>.size</span>)</span>:<span id="ast-90"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-91"><span id="ast-92" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new</span>&nbsp;=&nbsp;<span id="ast-93"><span id="ast-94" class="other_trans">_fetch_range</span>(<span id="ast-95"><span id="ast-96"><span id="ast-97">self</span>.s3</span>.s3</span>,&nbsp;<span id="ast-98"><span id="ast-99">self</span>.bucket</span>,&nbsp;<span id="ast-100"><span id="ast-101">self</span>.key</span>,&nbsp;<span id="ast-102"><span id="ast-103">self</span>.end</span>,&nbsp;<span id="ast-104">(<span id="ast-105" class="other_trans">end</span>&nbsp;+&nbsp;<span id="ast-107"><span id="ast-108">self</span>.blocksize</span>)</span>)</span></span><span id="ast-109"><span id="ast-110"><span id="ast-111"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.end</span>&nbsp;=&nbsp;<span id="ast-112">(<span id="ast-113" class="incorrect_node">end&nbsp;&rarr;&nbsp;new&nbsp;</span>&nbsp;+&nbsp;<span id="ast-115"><span id="ast-116">self</span>.blocksize</span>)</span></span><span id="ast-117"><span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.cache</span>&nbsp;=&nbsp;<span id="ast-120">(<span id="ast-121"><span id="ast-122">self</span>.cache</span>&nbsp;+&nbsp;<span id="ast-124" class="other_trans">new</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;run_pkgbuild(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">working_dir</span>,&nbsp;<span id="ast-5">package_type</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>info</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>.package_info</span>(<span id="ast-11" class="other_trans">package_type</span>)</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>output</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">os</span>.path</span>.join</span>(<span id="ast-18"><span id="ast-19">self</span>.self_dir</span>,&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">info</span>[<span id="ast-22"><span id="ast-23">'filename'</span></span>]</span>)</span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>temp</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">os</span>.path</span>.join</span>(<span id="ast-30"><span id="ast-31">self</span>.self_dir</span>,&nbsp;<span id="ast-32">(<span id="ast-33">'mono-%s.pkg'</span>&nbsp;%&nbsp;<span id="ast-35">package_type</span>)</span>)</span></span><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>identifier</span>&nbsp;=&nbsp;<span id="ast-38">(<span id="ast-39">(<span id="ast-40">'com.xamarin.mono-'</span>&nbsp;+&nbsp;<span id="ast-42"><span id="ast-43">info</span>[<span id="ast-44"><span id="ast-45">'type'</span></span>]</span>)</span>&nbsp;+&nbsp;<span id="ast-47">'.pkg'</span>)</span></span><span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>resources_dir</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53">os</span>.path</span>.join</span>(<span id="ast-54" class="other_trans">working_dir</span>,&nbsp;<span id="ast-55">'resources'</span>)</span></span><span id="ast-56"><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>distribution_xml</span>&nbsp;=&nbsp;<span id="ast-58"><span id="ast-59"><span id="ast-60"><span id="ast-61">os</span>.path</span>.join</span>(<span id="ast-62" class="other_trans">resources_dir</span>,&nbsp;<span id="ast-63">'distribution.xml'</span>)</span></span><span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>old_cwd</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68">os</span>.getcwd</span>()</span></span><span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.chdir</span>(<span id="ast-73">working_dir</span>)</span></span><span id="ast-74"><span id="ast-75"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pkgbuild</span>&nbsp;=&nbsp;<span id="ast-76">'/usr/bin/pkgbuild'</span></span><span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pkgbuild_cmd</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81">'&nbsp;'</span>.join</span>(<span id="ast-82">[<span id="ast-83">pkgbuild</span>,&nbsp;<span id="ast-84">(<span id="ast-85">'--identifier&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-87" class="other_trans">identifier</span>)</span>,&nbsp;<span id="ast-88">(<span id="ast-89">"--root&nbsp;'%s/PKGROOT'"</span>&nbsp;%&nbsp;<span id="ast-91">working_dir</span>)</span>,&nbsp;<span id="ast-92">(<span id="ast-93">"--version&nbsp;'%s'"</span>&nbsp;%&nbsp;<span id="ast-95"><span id="ast-96">self</span>.RELEASE_VERSION</span>)</span>,&nbsp;<span id="ast-97">"--install-location&nbsp;'/'"</span>,&nbsp;<span id="ast-98">(<span id="ast-99">"--scripts&nbsp;'%s'"</span>&nbsp;%&nbsp;<span id="ast-101" class="other_trans">resources_dir</span>)</span>,&nbsp;<span id="ast-102">'--quiet'</span>,&nbsp;<span id="ast-103"><span id="ast-104"><span id="ast-105"><span id="ast-106">os</span>.path</span>.join</span>(<span id="ast-107" class="other_trans">working_dir</span>,&nbsp;<span id="ast-108">'mono.pkg'</span>)</span>]</span>)</span></span><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-110" class="other_trans">pkgbuild_cmd</span></span><span id="ast-111"><span id="ast-112"><span id="ast-113" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>backtick</span>(<span id="ast-114" class="other_trans">pkgbuild_cmd</span>)</span></span><span id="ast-115"><span id="ast-116"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>productbuild</span>&nbsp;=&nbsp;<span id="ast-117">'/usr/bin/productbuild'</span></span><span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>productbuild_cmd</span>&nbsp;=&nbsp;<span id="ast-120"><span id="ast-121"><span id="ast-122">'&nbsp;'</span>.join</span>(<span id="ast-123">[<span id="ast-124" class="other_trans">productbuild</span>,&nbsp;<span id="ast-125">(<span id="ast-126">'--resources&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-128" class="other_trans">resources_dir</span>)</span>,&nbsp;<span id="ast-129">(<span id="ast-130">'--distribution&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-132">distribution_xml</span>)</span>,&nbsp;<span id="ast-133">(<span id="ast-134">'--package-path&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-136">working_dir</span>)</span>,&nbsp;<span id="ast-137">'--quiet'</span>,&nbsp;<span id="ast-138" class="other_trans">temp</span>]</span>)</span></span><span id="ast-139"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-140">productbuild_cmd</span></span><span id="ast-141"><span id="ast-142"><span id="ast-143"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>backtick</span>(<span id="ast-144" class="other_trans">productbuild_cmd</span>)</span></span><span id="ast-145"><span id="ast-146" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>productsign</span>&nbsp;=&nbsp;<span id="ast-147">'/usr/bin/productsign'</span></span><span id="ast-148"><span id="ast-149"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>productsign_cmd</span>&nbsp;=&nbsp;<span id="ast-150"><span id="ast-151"><span id="ast-152">'&nbsp;'</span>.join</span>(<span id="ast-153">[<span id="ast-154">productsign</span>,&nbsp;<span id="ast-155">(<span id="ast-156">"-s&nbsp;'%s'"</span>&nbsp;%&nbsp;<span id="ast-158"><span id="ast-159">self</span>.identity</span>)</span>,&nbsp;<span id="ast-160">(<span id="ast-161">"'%s'"</span>&nbsp;%&nbsp;<span id="ast-163" class="other_trans">temp</span>)</span>,&nbsp;<span id="ast-164">(<span id="ast-165">"'%s'"</span>&nbsp;%&nbsp;<span id="ast-167" class="incorrect_node">output&nbsp;&rarr;&nbsp;identifier&nbsp;</span>)</span>]</span>)</span></span><span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-169" class="other_trans">productsign_cmd</span></span><span id="ast-170"><span id="ast-171"><span id="ast-172"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>backtick</span>(<span id="ast-173" class="other_trans">productsign_cmd</span>)</span></span><span id="ast-174"><span id="ast-175"><span id="ast-176"><span id="ast-177" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.remove</span>(<span id="ast-178">temp</span>)</span></span><span id="ast-179"><span id="ast-180"><span id="ast-181"><span id="ast-182"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.chdir</span>(<span id="ast-183" class="other_trans">old_cwd</span>)</span></span><span id="ast-184"><span id="ast-185"><span id="ast-186" class="ref_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>verify_codesign&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-187" class="other_trans">output</span>)</span></span><span id="ast-188"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-189" class="other_trans">output</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;update_config(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">config</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Fire&nbsp;the&nbsp;traits&nbsp;events&nbsp;when&nbsp;the&nbsp;config&nbsp;is&nbsp;updated.'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>newconfig</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10" class="other_trans">deepcopy</span>(<span id="ast-11"><span id="ast-12">self</span>.config</span>)</span></span><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>newconfig</span>._merge</span>(<span id="ast-17" class="other_trans">config</span>)</span></span><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.config</span>&nbsp;=&nbsp;<span id="ast-21" class="correct_node">config&nbsp;&rarr;&nbsp;newconfig&nbsp;</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;resize(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">width</span>,&nbsp;<span id="ast-5" class="other_trans">height</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>image</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9">self</span>.image</span></span><span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-12" class="other_trans">old_w</span>,&nbsp;<span id="ast-13" class="other_trans">old_h</span>)</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15" class="other_trans">image</span>.size</span></span><span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>keep_height</span>&nbsp;=&nbsp;<span id="ast-18">(<span id="ast-20">(<span id="ast-22">(<span id="ast-23" class="other_trans">old_w</span><span id="ast-24" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-25" class="other_trans">old_h</span>)</span>&nbsp;and&nbsp;<span id="ast-26">(<span id="ast-27" class="other_trans">width</span><span id="ast-28" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-29" class="other_trans">height</span>)</span>)</span>&nbsp;or&nbsp;<span id="ast-30">(<span id="ast-32">(<span id="ast-33" class="other_trans">old_w</span><span id="ast-34" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-35" class="other_trans">old_h</span>)</span>&nbsp;and&nbsp;<span id="ast-36">(<span id="ast-37" class="other_trans">width</span><span id="ast-38" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-39" class="other_trans">height</span>)</span>)</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41" class="other_trans">keep_height</span>:<span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>size</span>&nbsp;=&nbsp;<span id="ast-44">(<span id="ast-45">(<span id="ast-46">(<span id="ast-47" class="other_trans">old_w</span>&nbsp;*&nbsp;<span id="ast-49" class="other_trans">height</span>)</span>&nbsp;/&nbsp;<span id="ast-51" class="incorrect_node">old_h&nbsp;&rarr;&nbsp;width&nbsp;</span>)</span>,&nbsp;<span id="ast-52" class="other_trans">height</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>size</span>&nbsp;=&nbsp;<span id="ast-55">(<span id="ast-56" class="other_trans">width</span>,&nbsp;<span id="ast-57">(<span id="ast-58">(<span id="ast-59">old_h</span>&nbsp;*&nbsp;<span id="ast-61" class="other_trans">width</span>)</span>&nbsp;/&nbsp;<span id="ast-63" class="other_trans">old_w</span>)</span>)</span></span></span><span id="ast-64"><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>image</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68" class="other_trans">image</span>.resize</span>(<span id="ast-69" class="other_trans">size</span>,&nbsp;<span id="ast-70"><span id="ast-71" class="other_trans">PILImage</span>.ANTIALIAS</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;Run(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5"><span id="ast-6">self</span>._verbose</span>:<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>timeoutStr</span>&nbsp;=&nbsp;<span id="ast-9">''</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11">(<span id="ast-13">(<span id="ast-14"><span id="ast-15">self</span>.timeout</span><span id="ast-16" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-17" class="other_trans">None</span>)</span>&nbsp;and&nbsp;<span id="ast-18" class="other_trans">gUsingKillableProcess</span>)</span>:<span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>secondsStr</span>&nbsp;=&nbsp;<span id="ast-21">'seconds'</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24" class="correct_node">timeout&nbsp;&rarr;&nbsp;self.&nbsp;</span><span id="ast-25" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-26">1</span>)</span>:<span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>secondsStr</span>&nbsp;=&nbsp;<span id="ast-29">'second'</span></span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>timeoutStr</span>&nbsp;=&nbsp;<span id="ast-32">(<span id="ast-33">'&nbsp;with&nbsp;timeout&nbsp;%d&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-35">(<span id="ast-36"><span id="ast-37">self</span>.timeout</span>,&nbsp;<span id="ast-38" class="other_trans">secondsStr</span>)</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;unpack(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">buf</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>f</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9" class="other_trans">cStringIO</span>.StringIO</span>(<span id="ast-10" class="other_trans">buf</span>)</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>line</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans">f</span>.readline</span>()</span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>l</span>&nbsp;=&nbsp;<span id="ast-18"><span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">line</span>.strip</span>()</span>.split</span>(<span id="ast-23" class="other_trans">None</span>,&nbsp;<span id="ast-24">2</span>)</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-28">(<span id="ast-29"><span id="ast-30">len</span>(<span id="ast-31" class="other_trans">l</span>)</span><span id="ast-32" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-33">2</span>)</span>&nbsp;or&nbsp;<span id="ast-34">(<span id="ast-35">not</span>&nbsp;<span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">l</span>[<span id="ast-40"><span id="ast-41">0</span></span>]</span>.startswith</span>(<span id="ast-42"><span id="ast-43">self</span>.__proto</span>)</span>)</span>&nbsp;or&nbsp;<span id="ast-44">(<span id="ast-45">not</span>&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">l</span>[<span id="ast-50"><span id="ast-51">1</span></span>]</span>.isdigit</span>()</span>)</span>)</span>:<span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans">dpkt</span>.UnpackError</span>(<span id="ast-56">(<span id="ast-57">'invalid&nbsp;response:&nbsp;%r'</span>&nbsp;%&nbsp;<span id="ast-59" class="other_trans">line</span>)</span>)</span></span></span><span id="ast-60"><span id="ast-61"><span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.version</span>&nbsp;=&nbsp;<span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">l</span>[<span id="ast-66"><span id="ast-67">0</span></span>]</span>[<span id="ast-68"><span id="ast-69">(<span id="ast-70"><span id="ast-71" class="other_trans">len</span>(<span id="ast-72"><span id="ast-73">self</span>.__proto</span>)</span>&nbsp;+&nbsp;<span id="ast-75">1</span>)</span>:</span>]</span></span><span id="ast-76"><span id="ast-77"><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.status</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80" class="other_trans">l</span>[<span id="ast-81"><span id="ast-82">1</span></span>]</span></span><span id="ast-83"><span id="ast-84"><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.reason</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-93"><span id="ast-94" class="other_trans">l</span>[<span id="ast-95"><span id="ast-96">2</span></span>]</span>&nbsp;if&nbsp;<span id="ast-87">(<span id="ast-88"><span id="ast-89">len</span>(<span id="ast-90" class="other_trans">l</span>)</span><span id="ast-91" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-92">2</span>)</span>&nbsp;else&nbsp;<span id="ast-97">''</span></span></span><span id="ast-98"><span id="ast-99" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>is_body_allowed</span>&nbsp;=&nbsp;<span id="ast-100">(<span id="ast-102">(<span id="ast-103"><span id="ast-104">int</span>(<span id="ast-105"><span id="ast-106">self</span>.status</span>)</span><span id="ast-107" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-108">200</span>)</span>&nbsp;and&nbsp;<span id="ast-109">(<span id="ast-110">204</span><span id="ast-111" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-113"><span id="ast-114" class="other_trans">int</span>(<span id="ast-115" class="ref_node">status&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span><span id="ast-112" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-116">304</span>)</span>)</span></span><span id="ast-117"><span id="ast-118"><span id="ast-119"><span id="ast-120"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>Message</span>.unpack</span>(<span id="ast-121">self</span>,&nbsp;<span id="ast-122"><span id="ast-123"><span id="ast-124" class="other_trans">f</span>.read</span>()</span>,&nbsp;<span id="ast-125" class="other_trans">is_body_allowed</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;export(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">command</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result_url</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9">self</span>._get_url</span>()</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11"><span id="ast-12">result_url</span>[<span id="ast-13"><span id="ast-14">'returncode'</span></span>]</span>:<span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-16" class="other_trans">result_url</span></span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20" class="other_trans">result_url</span>[<span id="ast-21"><span id="ast-22">'output'</span></span>]</span></span><span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd_id</span>&nbsp;=&nbsp;<span id="ast-25">[<span id="ast-26"><span id="ast-27">HgClient</span>._executable</span>,&nbsp;<span id="ast-28">'identify'</span>,&nbsp;<span id="ast-29">'--id'</span>]</span></span><span id="ast-30"><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result_id</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34">self</span>._run_command</span>(<span id="ast-35">cmd_id</span>)</span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-37"><span id="ast-38" class="other_trans">result_id</span>[<span id="ast-39"><span id="ast-40">'returncode'</span></span>]</span>:<span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result_id</span>[<span id="ast-44"><span id="ast-45">'output'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-46">(<span id="ast-47">'Could&nbsp;not&nbsp;determine&nbsp;id:&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-49"><span id="ast-50" class="other_trans">result_id</span>[<span id="ast-51"><span id="ast-52">'output'</span></span>]</span>)</span></span><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-54">result_id</span></span></span><span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>id_</span>&nbsp;=&nbsp;<span id="ast-57"><span id="ast-58" class="other_trans">result_id</span>[<span id="ast-59"><span id="ast-60">'output'</span></span>]</span></span><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-62">(<span id="ast-63">not</span>&nbsp;<span id="ast-64"><span id="ast-65" class="other_trans">command</span>.exact</span>)</span>:<span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd_branch</span>&nbsp;=&nbsp;<span id="ast-68">[<span id="ast-69"><span id="ast-70">HgClient</span>._executable</span>,&nbsp;<span id="ast-71">'identify'</span>,&nbsp;<span id="ast-72">'--branch'</span>]</span></span><span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result_branch</span>&nbsp;=&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77">self</span>._run_command</span>(<span id="ast-78">cmd_branch</span>)</span></span><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-80"><span id="ast-81" class="other_trans">result_branch</span>[<span id="ast-82"><span id="ast-83">'returncode'</span></span>]</span>:<span id="ast-84"><span id="ast-85"><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result_branch</span>[<span id="ast-87"><span id="ast-88">'output'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-89">(<span id="ast-90">'Could&nbsp;not&nbsp;determine&nbsp;branch:&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-92"><span id="ast-93">result_branch</span>[<span id="ast-94"><span id="ast-95">'output'</span></span>]</span>)</span></span><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-97" class="other_trans">result_branch</span></span></span><span id="ast-98"><span id="ast-99" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>branch</span>&nbsp;=&nbsp;<span id="ast-100"><span id="ast-101" class="other_trans">result_branch</span>[<span id="ast-102"><span id="ast-103">'output'</span></span>]</span></span><span id="ast-104"><span id="ast-105" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd_branch_id</span>&nbsp;=&nbsp;<span id="ast-106">[<span id="ast-107"><span id="ast-108" class="other_trans">HgClient</span>._executable</span>,&nbsp;<span id="ast-109">'identify'</span>,&nbsp;<span id="ast-110">'-r'</span>,&nbsp;<span id="ast-111">branch</span>,&nbsp;<span id="ast-112">'--id'</span>]</span></span><span id="ast-113"><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result_branch_id</span>&nbsp;=&nbsp;<span id="ast-115"><span id="ast-116"><span id="ast-117">self</span>._run_command</span>(<span id="ast-118" class="incorrect_node">cmd_branch_id&nbsp;&rarr;&nbsp;cmd_branch&nbsp;</span>)</span></span><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-120"><span id="ast-121">result_branch_id</span>[<span id="ast-122"><span id="ast-123">'returncode'</span></span>]</span>:<span id="ast-124"><span id="ast-125"><span id="ast-126" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result_branch_id</span>[<span id="ast-127"><span id="ast-128">'output'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-129">(<span id="ast-130">'Could&nbsp;not&nbsp;determine&nbsp;branch&nbsp;id:&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-132"><span id="ast-133" class="other_trans">result_branch_id</span>[<span id="ast-134"><span id="ast-135">'output'</span></span>]</span>)</span></span><span id="ast-136"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-137">result_branch_id</span></span></span><span id="ast-138"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-139">(<span id="ast-140"><span id="ast-141">result_branch_id</span>[<span id="ast-142"><span id="ast-143">'output'</span></span>]</span><span id="ast-144" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-145">id_</span>)</span>:<span id="ast-146"><span id="ast-147" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>id_</span>&nbsp;=&nbsp;<span id="ast-148" class="other_trans">branch</span></span><span id="ast-149"><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd_branch</span>&nbsp;=&nbsp;<span id="ast-151" class="other_trans">cmd_branch_id</span></span></span></span><span id="ast-152"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-153">{<span id="ast-154">'cmd'</span>:&nbsp;<span id="ast-159">(<span id="ast-160">'%s&nbsp;&amp;&amp;&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-162">(<span id="ast-163"><span id="ast-164" class="other_trans">result_url</span>[<span id="ast-165"><span id="ast-166">'cmd'</span></span>]</span>,&nbsp;<span id="ast-167"><span id="ast-168"><span id="ast-169">'&nbsp;'</span>.join</span>(<span id="ast-170" class="other_trans">cmd_id</span>)</span>)</span>)</span>,&nbsp;<span id="ast-155">'cwd'</span>:&nbsp;<span id="ast-171"><span id="ast-172">self</span>.path</span>,&nbsp;<span id="ast-156">'output'</span>:&nbsp;<span id="ast-173"><span id="ast-174"><span id="ast-175">'\\u000a'</span>.join</span>(<span id="ast-176">[<span id="ast-177" class="other_trans">url</span>,&nbsp;<span id="ast-178" class="ref_node">branch&nbsp;&rarr;&nbsp;id_&nbsp;</span>]</span>)</span>,&nbsp;<span id="ast-157">'returncode'</span>:&nbsp;<span id="ast-179">0</span>,&nbsp;<span id="ast-158">'export_data'</span>:&nbsp;<span id="ast-180">{<span id="ast-181">'url'</span>:&nbsp;<span id="ast-183">url</span>,&nbsp;<span id="ast-182">'version'</span>:&nbsp;<span id="ast-184" class="other_trans">id_</span>}</span>}</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;addToAssignment(<span id="ast-2"></span>):<span id="ast-3"><span id="ast-4" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assignment_id</span>&nbsp;=&nbsp;<span id="ast-5"><span id="ast-6">int</span>(<span id="ast-7"><span id="ast-8"><span id="ast-9" class="other_trans">request</span>.vars</span>[<span id="ast-10"><span id="ast-11">'assignment'</span></span>]</span>)</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>question_name</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">request</span>.vars</span>[<span id="ast-17"><span id="ast-18">'question'</span></span>]</span></span><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>qtype</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23">request</span>.vars</span>[<span id="ast-24"><span id="ast-25">'type'</span></span>]</span></span><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>question_id</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans">db</span>(<span id="ast-35">(<span id="ast-36"><span id="ast-37"><span id="ast-38">db</span>.questions</span>.name</span><span id="ast-39" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-40" class="other_trans">question_name</span>)</span>)</span>.select</span>(<span id="ast-41"><span id="ast-42"><span id="ast-43">db</span>.questions</span>.id</span>)</span>.first</span>()</span>.id</span></span><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>timed</span>&nbsp;=&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48">request</span>.vars</span>[<span id="ast-49"><span id="ast-50">'timed'</span></span>]</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>points</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55">int</span>(<span id="ast-56"><span id="ast-57"><span id="ast-58">request</span>.vars</span>[<span id="ast-59"><span id="ast-60">'points'</span></span>]</span>)</span></span><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-62"><span id="ast-63" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>points</span>&nbsp;=&nbsp;<span id="ast-64">0</span></span></span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-66"><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>type_id</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74">db</span>(<span id="ast-75">(<span id="ast-76"><span id="ast-77"><span id="ast-78" class="other_trans">db</span>.assignment_types</span>.name</span><span id="ast-79" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-80" class="other_trans">qtype</span>)</span>)</span>.select</span>(<span id="ast-81"><span id="ast-82"><span id="ast-83" class="other_trans">db</span>.assignment_types</span>.id</span>)</span>.first</span>()</span>.id</span></span><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-85" class="other_trans">Exception</span>&nbsp;as&nbsp;<span id="ast-86" class="other_trans">ex</span>:<span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-88">ex</span></span></span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93"><span id="ast-94"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>db</span>.assignment_questions</span>.insert</span>(assignment_id=<span id="ast-96" class="other_trans">assignment_id</span>,&nbsp;question_id=<span id="ast-98" class="other_trans">question_id</span>,&nbsp;points=<span id="ast-100">points</span>,&nbsp;timed=<span id="ast-102" class="other_trans">timed</span>,&nbsp;assessment_type=<span id="ast-104" class="other_trans">type_id</span>)</span></span><span id="ast-105"><span id="ast-106" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>assignment</span>&nbsp;=&nbsp;<span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110"><span id="ast-111"><span id="ast-112" class="other_trans">db</span>(<span id="ast-113">(<span id="ast-114"><span id="ast-115"><span id="ast-116">db</span>.assignments</span>.id</span><span id="ast-117" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-118">assignment_id</span>)</span>)</span>.select</span>()</span>.first</span>()</span></span><span id="ast-119"><span id="ast-120" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>assignment_points</span>&nbsp;=&nbsp;<span id="ast-121"><span id="ast-122"><span id="ast-123"><span id="ast-124"><span id="ast-125"><span id="ast-126"><span id="ast-127">db</span>(<span id="ast-128">(<span id="ast-129"><span id="ast-130"><span id="ast-131" class="other_trans">db</span>.assignments</span>.id</span><span id="ast-132" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-133" class="other_trans">assignment_id</span>)</span>)</span>.select</span>(<span id="ast-134"><span id="ast-135"><span id="ast-136">db</span>.assignments</span>.points</span>)</span>.first</span>()</span>.points</span></span><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-138">(<span id="ast-139" class="other_trans">assignment_points</span><span id="ast-140" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-141" class="other_trans">None</span>)</span>:<span id="ast-142"><span id="ast-143" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_points</span>&nbsp;=&nbsp;<span id="ast-144" class="other_trans">points</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-145"><span id="ast-146" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_points</span>&nbsp;=&nbsp;<span id="ast-147">(<span id="ast-148"><span id="ast-149">int</span>(<span id="ast-150" class="other_trans">assignment_points</span>)</span>&nbsp;+&nbsp;<span id="ast-152" class="other_trans">points</span>)</span></span></span><span id="ast-153"><span id="ast-154"><span id="ast-155"><span id="ast-156" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>assignment</span>.update_record</span>(points=<span id="ast-158" class="other_trans">new_points</span>)</span></span><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-160"><span id="ast-161"><span id="ast-162">json</span>.dumps</span>(<span id="ast-163">[<span id="ast-164" class="other_trans">new_points</span>,&nbsp;<span id="ast-165" class="location_node">type_id&nbsp;&rarr;&nbsp;qtype,&nbsp;pred:&nbsp;assignment&nbsp;</span>]</span>)</span></span><span id="ast-166"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-167">Exception</span>&nbsp;as&nbsp;<span id="ast-168" class="other_trans">ex</span>:<span id="ast-169"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-170">ex</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;getLinks(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">outwardOnly</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8"><span id="ast-9" class="other_trans">getattr</span>(<span id="ast-10">self</span>,&nbsp;<span id="ast-11">'links'</span>,&nbsp;<span id="ast-12" class="other_trans">None</span>)</span><span id="ast-13" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-14" class="other_trans">None</span>)</span>:<span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19">self</span>.youtrack</span>.getLinks</span>(<span id="ast-20"><span id="ast-21">self</span>.id</span>,&nbsp;<span id="ast-22" class="other_trans">outwardOnly</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-24">[<span id="ast-25" class="other_trans">l</span><span id="ast-26">&nbsp;for&nbsp;<span id="ast-27" class="other_trans">l</span>&nbsp;in&nbsp;<span id="ast-28"><span id="ast-29">self</span>.links</span>&nbsp;if&nbsp;<span id="ast-30">(<span id="ast-32">(<span id="ast-33"><span id="ast-34" class="other_trans">l</span>.source</span><span id="ast-35" class="ref_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-36"><span id="ast-37">self</span>.id</span>)</span>&nbsp;or&nbsp;<span id="ast-38">(<span id="ast-39">not</span>&nbsp;<span id="ast-40" class="other_trans">outwardOnly</span>)</span>)</span></span>]</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;download_corpus(<span id="ast-2"><span id="ast-3" class="other_trans">todir</span>,&nbsp;<span id="ast-4" class="other_trans">download_opts</span>,&nbsp;<span id="ast-5" class="other_trans">limit</span>,&nbsp;<span id="ast-7" class="other_trans">delay</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Downloads&nbsp;the&nbsp;entire&nbsp;Project&nbsp;Gutenberg&nbsp;corpus&nbsp;to&nbsp;disk.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Args:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;todir&nbsp;(str):&nbsp;directory&nbsp;to&nbsp;which&nbsp;to&nbsp;download&nbsp;the&nbsp;corpus&nbsp;files\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;download_opts&nbsp;(CorpusDownloadContext):\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.filetypes&nbsp;(str)&nbsp;=&gt;&nbsp;download&nbsp;extexts&nbsp;in&nbsp;these&nbsp;formats&nbsp;(eg.&nbsp;"txt")\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.langs&nbsp;(str)&nbsp;=&gt;&nbsp;download&nbsp;etexts&nbsp;in&nbsp;these&nbsp;languages&nbsp;(eg.&nbsp;"en")\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.offset&nbsp;(int)&nbsp;=&gt;&nbsp;start&nbsp;downloading&nbsp;from&nbsp;this&nbsp;results&nbsp;page&nbsp;onwards\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;limit&nbsp;(int,&nbsp;optional):&nbsp;download&nbsp;at&nbsp;most&nbsp;this&nbsp;many&nbsp;bytes&nbsp;of&nbsp;content\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay&nbsp;(int,&nbsp;optional):&nbsp;in-between&nbsp;request&nbsp;wait-time&nbsp;(in&nbsp;seconds)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int:&nbsp;the&nbsp;last&nbsp;offset&nbsp;location&nbsp;from&nbsp;which&nbsp;etexts&nbsp;were&nbsp;downloaded\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>todir</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15">osutil</span>.canonical</span>(<span id="ast-16" class="other_trans">todir</span>)</span></span><span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>osutil</span>.makedirs</span>(<span id="ast-21" class="other_trans">todir</span>)</span></span><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>seen</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25" class="other_trans">dict</span>(<span id="ast-26">(<span id="ast-27">(<span id="ast-28"><span id="ast-29"><span id="ast-30">canonicalize</span>(<span id="ast-31" class="other_trans">path</span>)</span>[<span id="ast-32"><span id="ast-33">0</span></span>]</span>,&nbsp;<span id="ast-34" class="other_trans">path</span>)</span><span id="ast-35">&nbsp;for&nbsp;<span id="ast-36" class="other_trans">path</span>&nbsp;in&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39">osutil</span>.listfiles</span>(<span id="ast-40" class="other_trans">todir</span>)</span></span>)</span>)</span></span><span id="ast-41"><span id="ast-42" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>total_download_size</span>&nbsp;=&nbsp;<span id="ast-43">0</span></span><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>offset</span>&nbsp;=&nbsp;<span id="ast-46"><span id="ast-47" class="other_trans">download_opts</span>.offset</span></span><span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>download</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53">functutil</span>.ignore</span>(<span id="ast-54" class="other_trans">Exception</span>)</span>(<span id="ast-55" class="other_trans">download_link</span>)</span></span><span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-57">(<span id="ast-58" class="other_trans">link</span>,&nbsp;<span id="ast-59" class="other_trans">offset</span>)</span>&nbsp;in&nbsp;<span id="ast-60"><span id="ast-61">gutenberg_links</span>(<span id="ast-62">download_opts</span>)</span>:<span id="ast-63"><span id="ast-64" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>download_result</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">download</span>(<span id="ast-67">link</span>,&nbsp;<span id="ast-68" class="other_trans">todir</span>,&nbsp;seen=<span id="ast-70" class="other_trans">seen</span>)</span></span><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-72">(<span id="ast-74">(<span id="ast-75" class="other_trans">download_result</span><span id="ast-76" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-77">None</span>)</span>&nbsp;and&nbsp;<span id="ast-78"><span id="ast-79">download_result</span>.did_download</span>)</span>:<span id="ast-80"><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>total_download_size</span>&nbsp;+=&nbsp;<span id="ast-83"><span id="ast-84" class="other_trans">download_result</span>.download_size</span></span><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-86">(<span id="ast-88">(<span id="ast-89" class="other_trans">limit</span><span id="ast-90" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-91" class="other_trans">None</span>)</span>&nbsp;and&nbsp;<span id="ast-92">(<span id="ast-93">total_download_size</span><span id="ast-94" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-95" class="other_trans">limit</span>)</span>)</span>:<span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span><span id="ast-97"><span id="ast-98"><span id="ast-99"><span id="ast-100" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>time</span>.sleep</span>(<span id="ast-101">delay</span>)</span></span></span></span><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-103" class="other_trans">offset</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;create_roi_mask_dataflow(<span id="ast-2"><span id="ast-3" class="other_trans">dir_path</span>,&nbsp;<span id="ast-4" class="other_trans">mask_type</span>,&nbsp;<span id="ast-5" class="other_trans">wf_name</span></span>):<span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>import&nbsp;<span id="ast-8">nipype.interfaces.io&nbsp;as&nbsp;nio</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>import&nbsp;<span id="ast-10">os</span></span><span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>wf</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans">pe</span>.Workflow</span>(name=<span id="ast-17" class="other_trans">wf_name</span>)</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-20" class="other_trans">mask_type</span><span id="ast-21" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-22">'roi'</span>)</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tab</span>&nbsp;=&nbsp;<span id="ast-25">'ROI&nbsp;Average&nbsp;TSE'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-27">(<span id="ast-28">mask_type</span><span id="ast-29" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-30">'voxel'</span>)</span>:<span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tab</span>&nbsp;=&nbsp;<span id="ast-33">'ROI&nbsp;Voxelwise&nbsp;TSE'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-35">(<span id="ast-36">mask_type</span><span id="ast-37" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-38">'centrality'</span>)</span>:<span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tab</span>&nbsp;=&nbsp;<span id="ast-41">'Network&nbsp;Centrality'</span></span></span><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-43">(<span id="ast-44">'.nii'</span><span id="ast-45">&nbsp;in&nbsp;</span><span id="ast-46" class="other_trans">dir_path</span>)</span>:<span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>masks</span>&nbsp;=&nbsp;<span id="ast-49">[]</span></span><span id="ast-50"><span id="ast-51"><span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>masks</span>.append</span>(<span id="ast-54" class="other_trans">dir_path</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-56">(<span id="ast-57">'.txt'</span><span id="ast-58">&nbsp;in&nbsp;</span><span id="ast-59" class="other_trans">dir_path</span>)</span>:<span id="ast-60"><span id="ast-61" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>masks</span>&nbsp;=&nbsp;<span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">open</span>(<span id="ast-66" class="other_trans">dir_path</span>,&nbsp;<span id="ast-67">'r'</span>)</span>.readlines</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-69">(<span id="ast-70">'\\u000a\\u000a[!]&nbsp;CPAC&nbsp;says:&nbsp;Your&nbsp;ROI/mask&nbsp;specification&nbsp;file&nbsp;(under&nbsp;%s&nbsp;options)&nbsp;either&nbsp;needs&nbsp;to&nbsp;be&nbsp;a&nbsp;NIFTI&nbsp;file&nbsp;(.nii&nbsp;or&nbsp;.nii.gz)&nbsp;of&nbsp;an&nbsp;ROI/mask&nbsp;or&nbsp;a&nbsp;text&nbsp;file&nbsp;(.txt)&nbsp;containing&nbsp;a&nbsp;list&nbsp;of&nbsp;NIFTI&nbsp;files&nbsp;of&nbsp;ROI/mask&nbsp;files.\\u000aPlease&nbsp;change&nbsp;this&nbsp;in&nbsp;your&nbsp;pipeline&nbsp;configuration&nbsp;file&nbsp;and&nbsp;try&nbsp;again.\\u000a\\u000a'</span>&nbsp;%&nbsp;<span id="ast-72" class="incorrect_node">tab&nbsp;&rarr;&nbsp;mask_type&nbsp;</span>)</span></span><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-74" class="other_trans">Exception</span></span></span><span id="ast-75"><span id="ast-76" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>mask_dict</span>&nbsp;=&nbsp;<span id="ast-77">{}</span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-79" class="other_trans">mask_file</span>&nbsp;in&nbsp;<span id="ast-80" class="other_trans">masks</span>:<span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>mask_file</span>&nbsp;=&nbsp;<span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans">mask_file</span>.rstrip</span>(<span id="ast-86">'\\u000d\\u000a'</span>)</span></span><span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-88">(<span id="ast-89">not</span>&nbsp;<span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-94" class="other_trans">mask_file</span>)</span>)</span>:<span id="ast-95"><span id="ast-96" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>err</span>&nbsp;=&nbsp;<span id="ast-97">(<span id="ast-98">'\\u000a\\u000a[!]&nbsp;CPAC&nbsp;says:&nbsp;One&nbsp;of&nbsp;your&nbsp;ROI/mask&nbsp;specification&nbsp;files&nbsp;(under&nbsp;%s&nbsp;options)&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;correct&nbsp;path&nbsp;or&nbsp;does&nbsp;not&nbsp;exist.\\u000aTip:&nbsp;If&nbsp;all&nbsp;the&nbsp;paths&nbsp;are&nbsp;okay,&nbsp;then&nbsp;ensure&nbsp;there&nbsp;are&nbsp;no&nbsp;whitespaces&nbsp;or&nbsp;blank&nbsp;lines&nbsp;in&nbsp;your&nbsp;ROI&nbsp;specification&nbsp;file.\\u000a\\u000a'</span>&nbsp;%&nbsp;<span id="ast-100" class="ref_node">mask_type&nbsp;&rarr;&nbsp;tab&nbsp;</span>)</span></span><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-102"><span id="ast-103">Exception</span>(<span id="ast-104" class="other_trans">err</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;*data,&nbsp;**kwargs</span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Create&nbsp;a&nbsp;minibatch&nbsp;dataset&nbsp;from&nbsp;a&nbsp;number&nbsp;of&nbsp;different&nbsp;data&nbsp;arrays.'</span></span><span id="ast-6"><span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.label</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11">kwargs</span>.get</span>(<span id="ast-12">'label'</span>,&nbsp;<span id="ast-13">'dataset'</span>)</span></span><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.number_batches</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19" class="other_trans">kwargs</span>.get</span>(<span id="ast-20">'batches'</span>)</span></span><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batch</span>&nbsp;=&nbsp;<span id="ast-24">0</span></span><span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>size</span>&nbsp;=&nbsp;<span id="ast-27"><span id="ast-28"><span id="ast-29">kwargs</span>.get</span>(<span id="ast-30">'size'</span>,&nbsp;<span id="ast-31"><span id="ast-32"><span id="ast-33" class="other_trans">kwargs</span>.get</span>(<span id="ast-34">'batch_size'</span>,&nbsp;<span id="ast-35">32</span>)</span>)</span></span><span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.callable</span>&nbsp;=&nbsp;<span id="ast-39">None</span></span><span id="ast-40"><span id="ast-41"><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batches</span>&nbsp;=&nbsp;<span id="ast-43" class="other_trans">None</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-47">(<span id="ast-48"><span id="ast-49">len</span>(<span id="ast-50" class="incorrect_node">data&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span><span id="ast-51" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-52">1</span>)</span>&nbsp;and&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">isinstance</span>(<span id="ast-55"><span id="ast-56">data</span>[<span id="ast-57"><span id="ast-58">0</span></span>]</span>,&nbsp;<span id="ast-59"><span id="ast-60" class="other_trans">collections</span>.Callable</span>)</span>)</span>:<span id="ast-61"><span id="ast-62"><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.callable</span>&nbsp;=&nbsp;<span id="ast-64"><span id="ast-65">data</span>[<span id="ast-66"><span id="ast-67">0</span></span>]</span></span><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-69">(<span id="ast-70">not</span>&nbsp;<span id="ast-71"><span id="ast-72">self</span>.number_batches</span>)</span>:<span id="ast-73"><span id="ast-74"><span id="ast-75"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.number_batches</span>&nbsp;=&nbsp;<span id="ast-76" class="other_trans">size</span></span></span><span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logging</span>.info</span>(<span id="ast-81">'data&nbsp;%s:&nbsp;%dx&nbsp;mini-batches&nbsp;from&nbsp;callable'</span>,&nbsp;<span id="ast-82"><span id="ast-83">self</span>.label</span>,&nbsp;<span id="ast-84"><span id="ast-85">self</span>.number_batches</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-86"><span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>shape</span>&nbsp;=&nbsp;<span id="ast-88"><span id="ast-89"><span id="ast-90">data</span>[<span id="ast-91"><span id="ast-92">0</span></span>]</span>.shape</span></span><span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>axis</span>&nbsp;=&nbsp;<span id="ast-95"><span id="ast-96"><span id="ast-97" class="other_trans">kwargs</span>.get</span>(<span id="ast-98">'axis'</span>,&nbsp;<span id="ast-99"><span id="ast-106">1</span>&nbsp;if&nbsp;<span id="ast-100">(<span id="ast-101"><span id="ast-102">len</span>(<span id="ast-103" class="other_trans">shape</span>)</span><span id="ast-104" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-105">3</span>)</span>&nbsp;else&nbsp;<span id="ast-107">0</span></span>)</span></span><span id="ast-108"><span id="ast-109" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>slices</span>&nbsp;=&nbsp;<span id="ast-110">[<span id="ast-111"><span id="ast-112">slice</span>(<span id="ast-113" class="other_trans">None</span>)</span>,&nbsp;<span id="ast-114"><span id="ast-115" class="other_trans">slice</span>(<span id="ast-116" class="other_trans">None</span>)</span>]</span></span><span id="ast-117"><span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batches</span>&nbsp;=&nbsp;<span id="ast-120">[]</span></span><span id="ast-121"><span id="ast-122" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-123">0</span></span><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-125">(<span id="ast-126">(<span id="ast-127" class="other_trans">i</span>&nbsp;+&nbsp;<span id="ast-129" class="other_trans">size</span>)</span><span id="ast-130" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-131"><span id="ast-132">shape</span>[<span id="ast-133"><span id="ast-134" class="other_trans">axis</span></span>]</span>)</span>:<span id="ast-135"><span id="ast-136"><span id="ast-137" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>slices</span>[<span id="ast-138"><span id="ast-139" class="other_trans">axis</span></span>]</span>&nbsp;=&nbsp;<span id="ast-140"><span id="ast-141">slice</span>(<span id="ast-142" class="other_trans">i</span>,&nbsp;<span id="ast-143">(<span id="ast-144" class="other_trans">i</span>&nbsp;+&nbsp;<span id="ast-146" class="other_trans">size</span>)</span>)</span></span><span id="ast-147"><span id="ast-148"><span id="ast-149"><span id="ast-150"><span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batches</span>.append</span>(<span id="ast-152">[<span id="ast-153"><span id="ast-154" class="other_trans">d</span>[<span id="ast-155"><span id="ast-156"><span id="ast-157">tuple</span>(<span id="ast-158">slices</span>)</span></span>]</span><span id="ast-159">&nbsp;for&nbsp;<span id="ast-160" class="other_trans">d</span>&nbsp;in&nbsp;<span id="ast-161" class="other_trans">data</span></span>]</span>)</span></span><span id="ast-162"><span id="ast-163" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;+=&nbsp;<span id="ast-165" class="other_trans">size</span></span></span><span id="ast-166"><span id="ast-167"><span id="ast-168"><span id="ast-169"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.shuffle</span>()</span></span><span id="ast-170"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-171">(<span id="ast-172">not</span>&nbsp;<span id="ast-173"><span id="ast-174">self</span>.number_batches</span>)</span>:<span id="ast-175"><span id="ast-176"><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.number_batches</span>&nbsp;=&nbsp;<span id="ast-178"><span id="ast-179" class="other_trans">len</span>(<span id="ast-180"><span id="ast-181">self</span>.batches</span>)</span></span></span><span id="ast-182"><span id="ast-183"><span id="ast-184"><span id="ast-185"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logging</span>.info</span>(<span id="ast-186">'data&nbsp;%s:&nbsp;%dx&nbsp;%s&nbsp;mini-batches&nbsp;of&nbsp;%s'</span>,&nbsp;<span id="ast-187"><span id="ast-188">self</span>.label</span>,&nbsp;<span id="ast-189"><span id="ast-190">self</span>.number_batches</span>,&nbsp;<span id="ast-191"><span id="ast-192">len</span>(<span id="ast-193"><span id="ast-194">self</span>.batches</span>)</span>,&nbsp;<span id="ast-195"><span id="ast-196"><span id="ast-197">',&nbsp;'</span>.join</span>(<span id="ast-198">(<span id="ast-199"><span id="ast-200">str</span>(<span id="ast-201"><span id="ast-202" class="other_trans">x</span>.shape</span>)</span><span id="ast-203">&nbsp;for&nbsp;<span id="ast-204" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-205"><span id="ast-206"><span id="ast-207">self</span>.batches</span>[<span id="ast-208"><span id="ast-209">0</span></span>]</span></span>)</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;translate_message(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">msg</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sender</span>&nbsp;=&nbsp;<span id="ast-7">(<span id="ast-9"><span id="ast-10"><span id="ast-11">msg</span>.get_unixfrom</span>()</span>&nbsp;or&nbsp;<span id="ast-12"><span id="ast-13">msg</span>[<span id="ast-14"><span id="ast-15">'From'</span></span>]</span>)</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17">(<span id="ast-18">not</span>&nbsp;<span id="ast-19" class="other_trans">sender</span>)</span>:<span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-21"><span id="ast-22">self</span>.fix_sender</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sender</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26">self</span>.default_sender</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-28"><span id="ast-29">BadMessageError</span>(<span id="ast-30">'No&nbsp;sender&nbsp;specified'</span>)</span></span></span></span><span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>to</span>&nbsp;=&nbsp;<span id="ast-33"><span id="ast-34">msg</span>[<span id="ast-35"><span id="ast-36">'To'</span></span>]</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-38">(<span id="ast-39">not</span>&nbsp;<span id="ast-40">to</span>)</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-42"><span id="ast-43">BadMessageError</span>(<span id="ast-44">'No&nbsp;destination&nbsp;addresses&nbsp;specified'</span>)</span></span></span><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>&nbsp;=&nbsp;<span id="ast-47"><span id="ast-48">EmailMessage</span>(sender=<span id="ast-50">(<span id="ast-52">sender</span>&nbsp;or&nbsp;<span id="ast-53"><span id="ast-54">msg</span>[<span id="ast-55"><span id="ast-56">'From'</span></span>]</span>)</span>,&nbsp;to=<span id="ast-58" class="other_trans">to</span>)</span></span><span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cc</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62">msg</span>[<span id="ast-63"><span id="ast-64">'Cc'</span></span>]</span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66" class="other_trans">cc</span>:<span id="ast-67"><span id="ast-68"><span id="ast-69" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.cc</span>&nbsp;=&nbsp;<span id="ast-70" class="other_trans">cc</span></span></span><span id="ast-71"><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>bcc</span>&nbsp;=&nbsp;<span id="ast-73"><span id="ast-74" class="other_trans">msg</span>[<span id="ast-75"><span id="ast-76">'Bcc'</span></span>]</span></span><span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-78">bcc</span>:<span id="ast-79"><span id="ast-80"><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.bcc</span>&nbsp;=&nbsp;<span id="ast-82" class="other_trans">cc</span></span></span><span id="ast-83"><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>reply_to</span>&nbsp;=&nbsp;<span id="ast-85"><span id="ast-86">msg</span>[<span id="ast-87"><span id="ast-88">'Reply-To'</span></span>]</span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-90" class="other_trans">reply_to</span>:<span id="ast-91"><span id="ast-92"><span id="ast-93" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.reply_to</span>&nbsp;=&nbsp;<span id="ast-94">reply_to</span></span></span><span id="ast-95"><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>subject</span>&nbsp;=&nbsp;<span id="ast-97"><span id="ast-98">msg</span>[<span id="ast-99"><span id="ast-100">'Subject'</span></span>]</span></span><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-102" class="other_trans">subject</span>:<span id="ast-103"><span id="ast-104"><span id="ast-105" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.subject</span>&nbsp;=&nbsp;<span id="ast-106">subject</span></span></span><span id="ast-107"><span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>payload</span>&nbsp;=&nbsp;<span id="ast-109"><span id="ast-110"><span id="ast-111" class="other_trans">msg</span>.get_payload</span>(decode=<span id="ast-113">True</span>)</span></span><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-115"><span id="ast-116">isinstance</span>(<span id="ast-117" class="other_trans">payload</span>,&nbsp;<span id="ast-118">basestring</span>)</span>:<span id="ast-119"><span id="ast-120"><span id="ast-121" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.body</span>&nbsp;=&nbsp;<span id="ast-122" class="other_trans">payload</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-123"><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>body</span>&nbsp;=&nbsp;<span id="ast-125">''</span></span><span id="ast-126"><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>html</span>&nbsp;=&nbsp;<span id="ast-128">''</span></span><span id="ast-129"><span id="ast-130"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>attachments</span>&nbsp;=&nbsp;<span id="ast-131">[]</span></span><span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-133">part</span>&nbsp;in&nbsp;<span id="ast-134"><span id="ast-135"><span id="ast-136" class="other_trans">msg</span>.walk</span>()</span>:<span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-138">(<span id="ast-140">(<span id="ast-141"><span id="ast-142"><span id="ast-143">part</span>.get_content_type</span>()</span><span id="ast-144" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-145">'text/plain'</span>)</span>&nbsp;and&nbsp;<span id="ast-146">(<span id="ast-147">not</span>&nbsp;<span id="ast-148">body</span>)</span>)</span>:<span id="ast-149"><span id="ast-150" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>body</span>&nbsp;=&nbsp;<span id="ast-151"><span id="ast-152"><span id="ast-153">part</span>.get_payload</span>(decode=<span id="ast-155">True</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-157">(<span id="ast-159">(<span id="ast-160"><span id="ast-161"><span id="ast-162">part</span>.get_content_type</span>()</span><span id="ast-163" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-164">'text/html'</span>)</span>&nbsp;and&nbsp;<span id="ast-165">(<span id="ast-166">not</span>&nbsp;<span id="ast-167" class="incorrect_node">html&nbsp;&rarr;&nbsp;body&nbsp;</span>)</span>)</span>:<span id="ast-168"><span id="ast-169"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>html</span>&nbsp;=&nbsp;<span id="ast-170"><span id="ast-171"><span id="ast-172">part</span>.get_payload</span>(decode=<span id="ast-174">True</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-176">(<span id="ast-177">not</span>&nbsp;<span id="ast-178"><span id="ast-179"><span id="ast-180"><span id="ast-181"><span id="ast-182" class="other_trans">part</span>.get_content_type</span>()</span>.startswith</span>(<span id="ast-183">'multipart'</span>)</span>)</span>:<span id="ast-184"><span id="ast-185"><span id="ast-186"><span id="ast-187" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>attachments</span>.append</span>(<span id="ast-188">(<span id="ast-189"><span id="ast-190" class="ref_node">get_filename&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-191" class="other_trans">part</span>)</span>,&nbsp;<span id="ast-192"><span id="ast-193"><span id="ast-194">part</span>.get_payload</span>(decode=<span id="ast-196">True</span>)</span>)</span>)</span></span></span></span><span id="ast-197"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-198">(<span id="ast-199">not</span>&nbsp;<span id="ast-200" class="other_trans">body</span>)</span>:<span id="ast-201"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-202"><span id="ast-203" class="other_trans">BadMessageError</span>(<span id="ast-204">'No&nbsp;message&nbsp;body&nbsp;specified'</span>)</span></span></span><span id="ast-205"><span id="ast-206"><span id="ast-207" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.body</span>&nbsp;=&nbsp;<span id="ast-208">body</span></span><span id="ast-209"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-210">html</span>:<span id="ast-211"><span id="ast-212"><span id="ast-213"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.html</span>&nbsp;=&nbsp;<span id="ast-214" class="other_trans">html</span></span></span><span id="ast-215"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-216">attachments</span>:<span id="ast-217"><span id="ast-218"><span id="ast-219" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>.attachments</span>&nbsp;=&nbsp;<span id="ast-220" class="other_trans">attachments</span></span></span></span><span id="ast-221"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-222" class="other_trans">message</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;invoke_war(<span id="ast-2"><span id="ast-3" class="other_trans">fingerengine</span>,&nbsp;<span id="ast-4" class="other_trans">fingerprint</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"&nbsp;&nbsp;Invoke&nbsp;a&nbsp;deployed&nbsp;WAR&nbsp;or&nbsp;JSP&nbsp;file&nbsp;on&nbsp;the&nbsp;remote&nbsp;server.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;uses&nbsp;unzip&nbsp;because&nbsp;Python's&nbsp;zip&nbsp;module&nbsp;isn't&nbsp;very&nbsp;portable&nbsp;or\\u000a&nbsp;&nbsp;&nbsp;&nbsp;fault&nbsp;tolerant;&nbsp;i.e.&nbsp;it&nbsp;fails&nbsp;to&nbsp;parse&nbsp;msfpayload-generated&nbsp;WARs,&nbsp;though\\u000a&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;is&nbsp;a&nbsp;fault&nbsp;of&nbsp;metasploit,&nbsp;not&nbsp;the&nbsp;Python&nbsp;module.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dfile</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">fingerengine</span>.options</span>.deploy</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>jsp</span>&nbsp;=&nbsp;<span id="ast-14">''</span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16">(<span id="ast-17">'.war'</span><span id="ast-18">&nbsp;in&nbsp;</span><span id="ast-19" class="other_trans">dfile</span>)</span>:<span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>jsp</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24"><span id="ast-25"><span id="ast-26" class="other_trans">getoutput</span>(<span id="ast-27">(<span id="ast-28">'unzip&nbsp;-l&nbsp;%s&nbsp;|&nbsp;grep&nbsp;jsp'</span>&nbsp;%&nbsp;<span id="ast-30">dfile</span>)</span>)</span>.split</span>(<span id="ast-31">'&nbsp;'</span>)</span>[<span id="ast-32"><span id="ast-33">-1</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-35">(<span id="ast-36">'.jsp'</span><span id="ast-37">&nbsp;in&nbsp;</span><span id="ast-38" class="other_trans">dfile</span>)</span>:<span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>jsp</span>&nbsp;=&nbsp;<span id="ast-41" class="other_trans">dfile</span></span></span><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-43">(<span id="ast-44" class="other_trans">jsp</span><span id="ast-45" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-46">''</span>)</span>:<span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>utility</span>.Msg</span>(<span id="ast-51">'Failed&nbsp;to&nbsp;find&nbsp;a&nbsp;JSP&nbsp;in&nbsp;the&nbsp;deployed&nbsp;WAR'</span>,&nbsp;<span id="ast-52"><span id="ast-53">LOG</span>.DEBUG</span>)</span></span><span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>utility</span>.Msg</span>(<span id="ast-59"><span id="ast-60"><span id="ast-61">'Using&nbsp;JSP&nbsp;{0}&nbsp;from&nbsp;{1}&nbsp;to&nbsp;invoke'</span>.format</span>(<span id="ast-62">jsp</span>,&nbsp;<span id="ast-63">dfile</span>)</span>,&nbsp;<span id="ast-64"><span id="ast-65">LOG</span>.DEBUG</span>)</span></span><span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>war_path</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69" class="other_trans">parse_war_path</span>(<span id="ast-70" class="other_trans">dfile</span>)</span></span><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-73"><span id="ast-74" class="other_trans">fingerengine</span>.random_int</span>:<span id="ast-75"><span id="ast-76" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>war_path</span>&nbsp;+=&nbsp;<span id="ast-78"><span id="ast-79">fingerengine</span>.random_int</span></span></span><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pass</span></span></span><span id="ast-82"><span id="ast-83" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-84">'http://{0}:{1}/{2}/{3}'</span></span><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-86">(<span id="ast-87">'random_int'</span><span id="ast-88">&nbsp;in&nbsp;</span><span id="ast-89"><span id="ast-90">dir</span>(<span id="ast-91" class="other_trans">fingerengine</span>)</span>)</span>:<span id="ast-92"><span id="ast-93"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-94"><span id="ast-95"><span id="ast-96" class="other_trans">url</span>.format</span>(<span id="ast-97"><span id="ast-98"><span id="ast-99" class="other_trans">fingerengine</span>.options</span>.ip</span>,&nbsp;<span id="ast-100"><span id="ast-101" class="other_trans">fingerprint</span>.port</span>,&nbsp;<span id="ast-102">(<span id="ast-103" class="other_trans">war_path</span>&nbsp;+&nbsp;<span id="ast-105"><span id="ast-106">str</span>(<span id="ast-107"><span id="ast-108" class="other_trans">fingerengine</span>.random_int</span>)</span>)</span>,&nbsp;<span id="ast-109">jsp</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-110"><span id="ast-111" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-112"><span id="ast-113"><span id="ast-114" class="other_trans">url</span>.format</span>(<span id="ast-115"><span id="ast-116"><span id="ast-117">fingerengine</span>.options</span>.ip</span>,&nbsp;<span id="ast-118"><span id="ast-119" class="other_trans">fingerprint</span>.port</span>,&nbsp;<span id="ast-120" class="other_trans">war_path</span>,&nbsp;<span id="ast-121" class="other_trans">jsp</span>)</span></span></span><span id="ast-122"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-123"><span id="ast-124">_invoke</span>(<span id="ast-125" class="other_trans">url</span>)</span>:<span id="ast-126"><span id="ast-127"><span id="ast-128"><span id="ast-129"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>utility</span>.Msg</span>(<span id="ast-130"><span id="ast-131"><span id="ast-132">'{0}&nbsp;invoked&nbsp;at&nbsp;{1}'</span>.format</span>(<span id="ast-133" class="ref_node">dfile&nbsp;&rarr;&nbsp;war_path&nbsp;</span>,&nbsp;<span id="ast-134"><span id="ast-135"><span id="ast-136" class="other_trans">fingerengine</span>.options</span>.ip</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-137"><span id="ast-138"><span id="ast-139"><span id="ast-140" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>utility</span>.Msg</span>(<span id="ast-141"><span id="ast-142"><span id="ast-143">'Failed&nbsp;to&nbsp;invoke&nbsp;{0}'</span>.format</span>(<span id="ast-144"><span id="ast-145">parse_war_path</span>(<span id="ast-146" class="incorrect_node">dfile&nbsp;&rarr;&nbsp;url&nbsp;</span>,&nbsp;<span id="ast-147">True</span>)</span>)</span>,&nbsp;<span id="ast-148"><span id="ast-149">LOG</span>.ERROR</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;migrate_flavor(<span id="ast-2"><span id="ast-3" class="other_trans">context</span>,&nbsp;<span id="ast-4" class="other_trans">flavor_id</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>flavor_binding</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9">'flavor-{}'</span>.format</span>(<span id="ast-10" class="other_trans">flavor_id</span>)</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>flavor_retrieve</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15">'{}-retrieve'</span>.format</span>(<span id="ast-16" class="other_trans">flavor_binding</span>)</span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>flavor_ensure</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21">'{}-ensure'</span>.format</span>(<span id="ast-22" class="other_trans">flavor_binding</span>)</span></span><span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>flow</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">linear_flow</span>.Flow</span>(<span id="ast-30"><span id="ast-31"><span id="ast-32">'migrate-flavor-{}'</span>.format</span>(<span id="ast-33" class="other_trans">flavor_id</span>)</span>)</span>.add</span>(<span id="ast-34"><span id="ast-35" class="other_trans">RetrieveFlavor</span>(<span id="ast-36"><span id="ast-37" class="other_trans">context</span>.src_cloud</span>,&nbsp;name=<span id="ast-39" class="ref_node">flavor_retrieve&nbsp;&rarr;&nbsp;flavor_binding&nbsp;</span>,&nbsp;provides=<span id="ast-41" class="other_trans">flavor_binding</span>,&nbsp;rebind=<span id="ast-43">[<span id="ast-44" class="other_trans">flavor_retrieve</span>]</span>)</span>,&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">EnsureFlavor</span>(<span id="ast-47"><span id="ast-48" class="other_trans">context</span>.dst_cloud</span>,&nbsp;name=<span id="ast-50" class="incorrect_node">flavor_ensure&nbsp;&rarr;&nbsp;flavor_id&nbsp;</span>,&nbsp;provides=<span id="ast-52" class="other_trans">flavor_ensure</span>,&nbsp;rebind=<span id="ast-54">[<span id="ast-55" class="other_trans">flavor_binding</span>]</span>)</span>)</span></span><span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>context</span>.store</span>[<span id="ast-60"><span id="ast-61" class="other_trans">flavor_retrieve</span></span>]</span>&nbsp;=&nbsp;<span id="ast-62" class="other_trans">flavor_id</span></span><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-64" class="other_trans">flow</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;split_code_and_text(<span id="ast-2"><span id="ast-3" class="other_trans">source_file</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"Return&nbsp;list&nbsp;with&nbsp;source&nbsp;file&nbsp;separated&nbsp;into&nbsp;code&nbsp;and&nbsp;text&nbsp;blocks.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;blocks&nbsp;:&nbsp;list&nbsp;of&nbsp;(label,&nbsp;(start,&nbsp;end+1),&nbsp;content)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&nbsp;where&nbsp;each&nbsp;element&nbsp;is&nbsp;a&nbsp;tuple&nbsp;with&nbsp;the&nbsp;label&nbsp;('text'&nbsp;or&nbsp;'code'),\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;(start,&nbsp;end+1)&nbsp;line&nbsp;numbers,&nbsp;and&nbsp;content&nbsp;string&nbsp;of&nbsp;block.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-7"><span id="ast-8">open</span>(<span id="ast-9">source_file</span>)</span>&nbsp;as&nbsp;<span id="ast-10" class="other_trans">f</span>:<span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>source_lines</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans">f</span>.readlines</span>()</span></span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>blocks</span>&nbsp;=&nbsp;<span id="ast-18">[]</span></span><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-21">0</span></span><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>last_line</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25">len</span>(<span id="ast-26" class="other_trans">source_lines</span>)</span></span><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-28">True</span>:<span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30"><span id="ast-31">start_of_text</span>(<span id="ast-32"><span id="ast-33" class="other_trans">source_lines</span>[<span id="ast-34"><span id="ast-35" class="other_trans">i</span></span>]</span>)</span>:<span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>label</span>&nbsp;=&nbsp;<span id="ast-38">'text'</span></span><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>token</span>&nbsp;=&nbsp;<span id="ast-41">(<span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">source_lines</span>[<span id="ast-45"><span id="ast-46">i</span></span>]</span>[<span id="ast-47">:<span id="ast-48">3</span></span>]</span>&nbsp;+&nbsp;<span id="ast-50">'\\u000a'</span>)</span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>j</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54">_end_index</span>(<span id="ast-55" class="other_trans">i</span>,&nbsp;<span id="ast-56">lambda&nbsp;<span id="ast-57"><span id="ast-58" class="other_trans">k</span></span>:&nbsp;<span id="ast-59"><span id="ast-60"><span id="ast-61"><span id="ast-62" class="other_trans">source_lines</span>[<span id="ast-63"><span id="ast-64" class="other_trans">k</span></span>]</span>.endswith</span>(<span id="ast-65" class="other_trans">token</span>)</span></span>)</span></span><span id="ast-66"><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>j</span>&nbsp;+=&nbsp;<span id="ast-69">1</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>label</span>&nbsp;=&nbsp;<span id="ast-72">'code'</span></span><span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>j</span>&nbsp;=&nbsp;<span id="ast-75"><span id="ast-76" class="other_trans">_end_index</span>(<span id="ast-77" class="other_trans">i</span>,&nbsp;<span id="ast-78">lambda&nbsp;<span id="ast-79"><span id="ast-80" class="other_trans">k</span></span>:&nbsp;<span id="ast-81"><span id="ast-82">start_of_text</span>(<span id="ast-83"><span id="ast-84" class="other_trans">source_lines</span>[<span id="ast-85"><span id="ast-86" class="other_trans">k</span></span>]</span>)</span></span>)</span></span></span><span id="ast-87"><span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>blocks</span>.append</span>(<span id="ast-91">(<span id="ast-92">label</span>,&nbsp;<span id="ast-93">(<span id="ast-94">(<span id="ast-95">i</span>&nbsp;+&nbsp;<span id="ast-97">1</span>)</span>,&nbsp;<span id="ast-98">(<span id="ast-99">j</span>&nbsp;+&nbsp;<span id="ast-101">1</span>)</span>)</span>,&nbsp;<span id="ast-102"><span id="ast-103"><span id="ast-104">''</span>.join</span>(<span id="ast-105"><span id="ast-106">source_lines</span>[<span id="ast-107"><span id="ast-108" class="other_trans">i</span>:<span id="ast-109" class="other_trans">j</span></span>]</span>)</span>)</span>)</span></span><span id="ast-110"><span id="ast-111" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-112" class="other_trans">j</span></span><span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-114">(<span id="ast-115" class="other_trans">i</span><span id="ast-116" class="location_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;!=&nbsp;</span><span id="ast-117" class="other_trans">last_line</span>)</span>:<span id="ast-118"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span></span><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-120" class="other_trans">blocks</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;index(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">index</span>,&nbsp;<span id="ast-5" class="other_trans">doc_type</span>,&nbsp;<span id="ast-6" class="other_trans">doc</span>,&nbsp;<span id="ast-7" class="other_trans">id</span>,&nbsp;<span id="ast-9" class="other_trans">force_insert</span></span>):<span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Index&nbsp;a&nbsp;typed&nbsp;JSON&nbsp;document&nbsp;into&nbsp;a&nbsp;specific&nbsp;index,&nbsp;and&nbsp;make&nbsp;it\\u000a&nbsp;&nbsp;&nbsp;&nbsp;searchable.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>._send_request</span>(<span id="ast-17"><span id="ast-22">'PUT'</span>&nbsp;if&nbsp;<span id="ast-18">(<span id="ast-19" class="other_trans">id</span><span id="ast-20" class="correct_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-21" class="other_trans">None</span>)</span>&nbsp;else&nbsp;<span id="ast-23">'POST'</span></span>,&nbsp;<span id="ast-24">[<span id="ast-25" class="other_trans">index</span>,&nbsp;<span id="ast-26" class="other_trans">doc_type</span>,&nbsp;<span id="ast-27" class="other_trans">id</span>]</span>,&nbsp;<span id="ast-28" class="other_trans">doc</span>,&nbsp;<span id="ast-29"><span id="ast-31">{<span id="ast-32">'op_type'</span>:&nbsp;<span id="ast-33">'create'</span>}</span>&nbsp;if&nbsp;<span id="ast-30" class="other_trans">force_insert</span>&nbsp;else&nbsp;<span id="ast-34">{}</span></span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;generate_checksum(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.__data__</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9">self</span>.write</span>()</span></span><span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>checksum_offset</span>&nbsp;=&nbsp;<span id="ast-12">(<span id="ast-13"><span id="ast-14"><span id="ast-15">self</span>.OPTIONAL_HEADER</span>.__file_offset__</span>&nbsp;+&nbsp;<span id="ast-17">64</span>)</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>checksum</span>&nbsp;=&nbsp;<span id="ast-20">0</span></span><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>remainder</span>&nbsp;=&nbsp;<span id="ast-23">(<span id="ast-24"><span id="ast-25">len</span>(<span id="ast-26"><span id="ast-27">self</span>.__data__</span>)</span>&nbsp;%&nbsp;<span id="ast-29">4</span>)</span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>data_len</span>&nbsp;=&nbsp;<span id="ast-32">(<span id="ast-33"><span id="ast-34" class="other_trans">len</span>(<span id="ast-35"><span id="ast-36">self</span>.__data__</span>)</span>&nbsp;+&nbsp;<span id="ast-38">(<span id="ast-39">(<span id="ast-40">4</span>&nbsp;-&nbsp;<span id="ast-42" class="other_trans">remainder</span>)</span>&nbsp;*&nbsp;<span id="ast-44">(<span id="ast-45" class="other_trans">remainder</span><span id="ast-46" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-47">0</span>)</span>)</span>)</span></span><span id="ast-48"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-49" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-50"><span id="ast-51" class="other_trans">range</span>(<span id="ast-52"><span id="ast-53" class="other_trans">old_div</span>(<span id="ast-54">data_len</span>,&nbsp;<span id="ast-55">4</span>)</span>)</span>:<span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-57">(<span id="ast-58" class="other_trans">i</span><span id="ast-59" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-60"><span id="ast-61">old_div</span>(<span id="ast-62" class="other_trans">checksum_offset</span>,&nbsp;<span id="ast-63">4</span>)</span>)</span>:<span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66">(<span id="ast-68">(<span id="ast-69">(<span id="ast-70" class="other_trans">i</span>&nbsp;+&nbsp;<span id="ast-72">1</span>)</span><span id="ast-73" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-74"><span id="ast-75">old_div</span>(<span id="ast-76" class="other_trans">data_len</span>,&nbsp;<span id="ast-77">4</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-78" class="other_trans">remainder</span>)</span>:<span id="ast-79"><span id="ast-80" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dword</span>&nbsp;=&nbsp;<span id="ast-81"><span id="ast-82"><span id="ast-83"><span id="ast-84" class="other_trans">struct</span>.unpack</span>(<span id="ast-85">'I'</span>,&nbsp;<span id="ast-86">(<span id="ast-87"><span id="ast-88"><span id="ast-89">self</span>.__data__</span>[<span id="ast-90"><span id="ast-91">(<span id="ast-92">i</span>&nbsp;*&nbsp;<span id="ast-94">4</span>)</span>:</span>]</span>&nbsp;+&nbsp;<span id="ast-96">(<span id="ast-97">'\\u0000'</span>&nbsp;*&nbsp;<span id="ast-99">(<span id="ast-100">4</span>&nbsp;-&nbsp;<span id="ast-102" class="other_trans">remainder</span>)</span>)</span>)</span>)</span>[<span id="ast-103"><span id="ast-104">0</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-105"><span id="ast-106" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dword</span>&nbsp;=&nbsp;<span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110">struct</span>.unpack</span>(<span id="ast-111">'I'</span>,&nbsp;<span id="ast-112"><span id="ast-113"><span id="ast-114">self</span>.__data__</span>[<span id="ast-115"><span id="ast-116">(<span id="ast-117">i</span>&nbsp;*&nbsp;<span id="ast-119">4</span>)</span>:<span id="ast-120">(<span id="ast-121">(<span id="ast-122" class="other_trans">i</span>&nbsp;*&nbsp;<span id="ast-124">4</span>)</span>&nbsp;+&nbsp;<span id="ast-126">4</span>)</span></span>]</span>)</span>[<span id="ast-127"><span id="ast-128">0</span></span>]</span></span></span><span id="ast-129"><span id="ast-130" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>checksum</span>&nbsp;+=&nbsp;<span id="ast-132" class="other_trans">dword</span></span><span id="ast-133"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-134">(<span id="ast-135" class="other_trans">checksum</span><span id="ast-136" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-137">(<span id="ast-138">2</span>&nbsp;**&nbsp;<span id="ast-140">32</span>)</span>)</span>:<span id="ast-141"><span id="ast-142" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>checksum</span>&nbsp;=&nbsp;<span id="ast-143">(<span id="ast-144">(<span id="ast-145" class="other_trans">checksum</span>&nbsp;&amp;&nbsp;<span id="ast-147">4294967295L</span>)</span>&nbsp;+&nbsp;<span id="ast-149">(<span id="ast-150" class="other_trans">checksum</span>&nbsp;&gt;&gt;&nbsp;<span id="ast-152">32</span>)</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;search_entities(<span id="ast-2"><span id="ast-3" class="other_trans">request</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>search_terms_raw</span>&nbsp;=&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">request</span>.GET</span>.get</span>(<span id="ast-12">'query'</span>,&nbsp;<span id="ast-13">''</span>)</span>.strip</span>()</span></span><span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>op</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17" class="other_trans">getattr</span>(<span id="ast-18">settings</span>,&nbsp;<span id="ast-19">'PG_FTS_OPERATOR'</span>,&nbsp;<span id="ast-20">'&amp;'</span>)</span></span><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sid</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24"><span id="ast-25">transaction</span>.savepoint</span>()</span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-27">(<span id="ast-28"><span id="ast-29"><span id="ast-30" class="other_trans">db</span>.database</span>[<span id="ast-31"><span id="ast-32">'ENGINE'</span></span>]</span><span id="ast-33" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-34">'django.db.backends.postgresql_psycopg2'</span>)</span>:<span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>search_terms</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">re</span>.sub</span>(<span id="ast-40">u'\\\\s+'</span>,&nbsp;<span id="ast-41" class="other_trans">op</span>,&nbsp;<span id="ast-42" class="other_trans">search_terms_raw</span>)</span></span><span id="ast-43"><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>entities</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">_search_entities</span>(<span id="ast-47" class="other_trans">search_terms</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>search_terms_list</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52" class="other_trans">search_terms_raw</span>.split</span>(<span id="ast-53">'&nbsp;'</span>)</span></span><span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>where</span>&nbsp;=&nbsp;<span id="ast-56"><span id="ast-57"><span id="ast-58">(<span id="ast-59">u'&nbsp;%s&nbsp;'</span>&nbsp;%&nbsp;<span id="ast-61" class="other_trans">op</span>)</span>.join</span>(<span id="ast-62">(<span id="ast-63">[<span id="ast-64">u"name&nbsp;ilike&nbsp;'%s'"</span>]</span>&nbsp;*&nbsp;<span id="ast-66"><span id="ast-67">len</span>(<span id="ast-68" class="other_trans">search_terms_list</span>)</span>)</span>)</span></span><span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sql</span>&nbsp;=&nbsp;<span id="ast-71">(<span id="ast-72">u'select&nbsp;*&nbsp;from&nbsp;entity_entity&nbsp;where&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-74" class="other_trans">where</span>)</span></span><span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>entities</span>&nbsp;=&nbsp;<span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80" class="other_trans">Entity</span>.objects</span>.raw</span>(<span id="ast-81" class="other_trans">sql</span>,&nbsp;<span id="ast-82" class="other_trans">search_terms_list</span>)</span></span><span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>search_terms</span>&nbsp;=&nbsp;<span id="ast-85"><span id="ast-86"><span id="ast-87" class="incorrect_node">op&nbsp;&rarr;&nbsp;where&nbsp;</span>.join</span>(<span id="ast-88" class="ref_node">search_terms&nbsp;&rarr;&nbsp;search_terms_raw&nbsp;</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;appleSoftwareUpdatesAvailable(<span id="ast-2"><span id="ast-3" class="other_trans">forcecheck</span>,&nbsp;<span id="ast-5" class="other_trans">suppresscheck</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Checks&nbsp;for&nbsp;available&nbsp;Apple&nbsp;Software&nbsp;Updates,&nbsp;trying&nbsp;not&nbsp;to&nbsp;hit&nbsp;the&nbsp;SUS\\u000a&nbsp;&nbsp;&nbsp;&nbsp;more&nbsp;than&nbsp;needed'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>updatesindexfile</span>&nbsp;=&nbsp;<span id="ast-11">'/Library/Updates/index.plist'</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13">(<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-19">appleUpdatesFile</span>)</span>&nbsp;and&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23">os</span>.path</span>.exists</span>(<span id="ast-24">updatesindexfile</span>)</span>)</span>:<span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>appleUpdatesFile_modtime</span>&nbsp;=&nbsp;<span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30">os</span>.stat</span>(<span id="ast-31">appleUpdatesFile</span>)</span>.st_mtime</span></span><span id="ast-32"><span id="ast-33" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>updatesindexfile_modtime</span>&nbsp;=&nbsp;<span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37">os</span>.stat</span>(<span id="ast-38" class="other_trans">updatesindexfile</span>)</span>.st_mtime</span></span><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-40">(<span id="ast-41" class="other_trans">appleUpdatesFile_modtime</span><span id="ast-42" class="incorrect_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-43" class="other_trans">updatesindexfile_modtime</span>)</span>:<span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-45">True</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-47"><span id="ast-48" class="other_trans">writeAppleUpdatesFile</span>()</span></span></span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-50" class="other_trans">forcecheck</span>:<span id="ast-51"><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>retcode</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">checkForSoftwareUpdates</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-56">suppresscheck</span>:<span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-58">False</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>now</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">NSDate</span>.new</span>()</span></span><span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>nextSUcheck</span>&nbsp;=&nbsp;<span id="ast-66" class="other_trans">now</span></span><span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cmd</span>&nbsp;=&nbsp;<span id="ast-69">[<span id="ast-70">'/usr/bin/defaults'</span>,&nbsp;<span id="ast-71">'read'</span>,&nbsp;<span id="ast-72">'/Library/Preferences/com.apple.softwareupdate'</span>,&nbsp;<span id="ast-73">'LastSuccessfulDate'</span>]</span></span><span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>p</span>&nbsp;=&nbsp;<span id="ast-76"><span id="ast-77"><span id="ast-78">subprocess</span>.Popen</span>(<span id="ast-79">cmd</span>,&nbsp;shell=<span id="ast-81">False</span>,&nbsp;bufsize=<span id="ast-83">1</span>,&nbsp;stdin=<span id="ast-85"><span id="ast-86" class="other_trans">subprocess</span>.PIPE</span>,&nbsp;stdout=<span id="ast-88"><span id="ast-89" class="other_trans">subprocess</span>.PIPE</span>,&nbsp;stderr=<span id="ast-91"><span id="ast-92">subprocess</span>.PIPE</span>)</span></span><span id="ast-93"><span id="ast-94"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-95" class="other_trans">out</span>,&nbsp;<span id="ast-96" class="other_trans">err</span>)</span>&nbsp;=&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99" class="other_trans">p</span>.communicate</span>()</span></span><span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lastSUcheckString</span>&nbsp;=&nbsp;<span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans">out</span>.rstrip</span>(<span id="ast-105">'\\u000a'</span>)</span></span><span id="ast-106"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-107">lastSUcheckString</span>:<span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lastSUcheck</span>&nbsp;=&nbsp;<span id="ast-111"><span id="ast-112"><span id="ast-113" class="other_trans">NSDate</span>.dateWithString_</span>(<span id="ast-114" class="other_trans">lastSUcheckString</span>)</span></span><span id="ast-115"><span id="ast-116" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>interval</span>&nbsp;=&nbsp;<span id="ast-117">(<span id="ast-118">(<span id="ast-119">24</span>&nbsp;*&nbsp;<span id="ast-121">60</span>)</span>&nbsp;*&nbsp;<span id="ast-123">60</span>)</span></span><span id="ast-124"><span id="ast-125" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>nextSUcheck</span>&nbsp;=&nbsp;<span id="ast-126"><span id="ast-127"><span id="ast-128" class="other_trans">lastSUcheck</span>.dateByAddingTimeInterval_</span>(<span id="ast-129">interval</span>)</span></span><span id="ast-130"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-131">ValueError</span>:<span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pass</span></span></span></span><span id="ast-133"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-134">(<span id="ast-135"><span id="ast-136"><span id="ast-137" class="other_trans">now</span>.timeIntervalSinceDate_</span>(<span id="ast-138" class="other_trans">nextSUcheck</span>)</span><span id="ast-139" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-140">0</span>)</span>:<span id="ast-141"><span id="ast-142"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>retcode</span>&nbsp;=&nbsp;<span id="ast-143"><span id="ast-144">checkForSoftwareUpdates</span>()</span></span></span></span><span id="ast-145"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-146"><span id="ast-147">writeAppleUpdatesFile</span>()</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;upload(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">capsule</span>,&nbsp;<span id="ast-5" class="other_trans">archive</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>.endpoints</span>[<span id="ast-11"><span id="ast-12">'capsule'</span></span>]</span></span><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cs</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18">self</span>._get</span>(<span id="ast-19" class="other_trans">url</span>)</span>[<span id="ast-20"><span id="ast-21">'objects'</span></span>]</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24" class="other_trans">capsule</span><span id="ast-25" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;!=&nbsp;</span><span id="ast-26"><span id="ast-27" class="other_trans">len</span>(<span id="ast-28" class="other_trans">cs</span>)</span>)</span>:<span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-30"><span id="ast-31" class="other_trans">ValueError</span>(<span id="ast-32">'No&nbsp;such&nbsp;capsule'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;match(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">req</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>body</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8" class="other_trans">req</span>.body</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-10">(<span id="ast-11" class="other_trans">body</span><span id="ast-12" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-13"><span id="ast-14">self</span>.expectation</span>)</span>:<span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-16">True</span></span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">isregex</span>(<span id="ast-20"><span id="ast-21">self</span>.expectation</span>)</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-23">(<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27">self</span>.expectation</span>.match</span>(<span id="ast-28">(<span id="ast-30" class="other_trans">body</span>&nbsp;or&nbsp;<span id="ast-31">''</span>)</span>)</span><span id="ast-32" class="incorrect_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-33" class="other_trans">None</span>)</span></span></span><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-35">(<span id="ast-37">(<span id="ast-38">not</span>&nbsp;<span id="ast-39" class="other_trans">body</span>)</span>&nbsp;and&nbsp;<span id="ast-40"><span id="ast-41">self</span>.expectation</span>)</span>:<span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-43">False</span></span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-46">not</span>&nbsp;<span id="ast-47"><span id="ast-48" class="other_trans">isinstance</span>(<span id="ast-49" class="other_trans">body</span>,&nbsp;<span id="ast-50" class="other_trans">str</span>)</span>)</span>:<span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-52">False</span></span></span><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-54"><span id="ast-55" class="ref_node">compare&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-56"><span id="ast-57">self</span>.expectation</span>,&nbsp;<span id="ast-58" class="other_trans">body</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">name</span>,&nbsp;<span id="ast-5" class="other_trans">regexp</span>,&nbsp;**kwargs</span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>prefix</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">kwargs</span>.get</span>(<span id="ast-11">'prefix'</span>,&nbsp;<span id="ast-12">''</span>)</span></span><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>suffix</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans">kwargs</span>.get</span>(<span id="ast-18">'suffix'</span>,&nbsp;<span id="ast-19">'/'</span>)</span></span><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>min_v</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24" class="other_trans">kwargs</span>.get</span>(<span id="ast-25">'min'</span>,&nbsp;<span id="ast-26">1</span>)</span></span><span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>max_v</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">kwargs</span>.get</span>(<span id="ast-32">'max'</span>,&nbsp;<span id="ast-33">0</span>)</span></span><span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>super</span>(<span id="ast-39">Variable</span>,&nbsp;<span id="ast-40">self</span>)</span>.__init__</span>(<span id="ast-41" class="other_trans">name</span>,&nbsp;<span id="ast-42" class="other_trans">prefix</span>,&nbsp;<span id="ast-43" class="other_trans">suffix</span>)</span></span><span id="ast-44"><span id="ast-45"><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.regexp</span>&nbsp;=&nbsp;<span id="ast-47" class="other_trans">regexp</span></span><span id="ast-48"><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.separator</span>&nbsp;=&nbsp;<span id="ast-51"><span id="ast-52"><span id="ast-53" class="other_trans">kwargs</span>.get</span>(<span id="ast-54">'separator'</span>,&nbsp;<span id="ast-55">None</span>)</span></span><span id="ast-56"><span id="ast-57"><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.min</span>&nbsp;=&nbsp;<span id="ast-59"><span id="ast-64" class="other_trans">min_v</span>&nbsp;if&nbsp;<span id="ast-60">(<span id="ast-61" class="other_trans">min_v</span><span id="ast-62" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-63">1</span>)</span>&nbsp;else&nbsp;<span id="ast-65">1</span></span></span><span id="ast-66"><span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.max</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-74" class="other_trans">max_v</span>&nbsp;if&nbsp;<span id="ast-70">(<span id="ast-71" class="other_trans">max_v</span><span id="ast-72" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-73">0</span>)</span>&nbsp;else&nbsp;<span id="ast-75">0</span></span></span><span id="ast-76"><span id="ast-77"><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.unambiguous</span>&nbsp;=&nbsp;<span id="ast-79"><span id="ast-80"><span id="ast-81" class="other_trans">kwargs</span>.get</span>(<span id="ast-82">'unambiguous'</span>,&nbsp;<span id="ast-83">False</span>)</span></span><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-85">(<span id="ast-87">(<span id="ast-88" class="correct_node">max&nbsp;&rarr;&nbsp;self.&nbsp;</span><span id="ast-89" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-90">0</span>)</span>&nbsp;and&nbsp;<span id="ast-91">(<span id="ast-92"><span id="ast-93">self</span>.min</span><span id="ast-94" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-95"><span id="ast-96">self</span>.max</span>)</span>)</span>:<span id="ast-97"><span id="ast-98"><span id="ast-99"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.max</span>&nbsp;=&nbsp;<span id="ast-100"><span id="ast-101">self</span>.min</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;init_tasks(<span id="ast-2"><span id="ast-3">app</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Extracts&nbsp;modules&nbsp;(task&nbsp;types)&nbsp;from&nbsp;global&nbsp;configuration\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;app:&nbsp;Current&nbsp;Flask&nbsp;application&nbsp;instance\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;app:&nbsp;flask.Flask\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return:&nbsp;Dictionary&nbsp;with&nbsp;instantiated&nbsp;*TaskType&nbsp;objects\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:rtype:&nbsp;dict\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>task_types</span>&nbsp;=&nbsp;<span id="ast-8">{}</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>loaders</span>&nbsp;=&nbsp;<span id="ast-11">{}</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>enabled_tasks</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">app</span>.config</span>.get</span>(<span id="ast-18">'ENABLED_TASKS'</span>,&nbsp;<span id="ast-19">{}</span>)</span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-21">(<span id="ast-22">plugin</span>,&nbsp;<span id="ast-23" class="other_trans">task</span>)</span>&nbsp;in&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">enabled_tasks</span>.iteritems</span>()</span>:<span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>task_settings</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30" class="other_trans">import_string</span>(<span id="ast-31"><span id="ast-32"><span id="ast-33">'{plugin_name}.settings'</span>.format</span>(plugin_name=<span id="ast-35" class="other_trans">plugin</span>)</span>)</span></span><span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>plugin_instance</span>&nbsp;=&nbsp;<span id="ast-38"><span id="ast-39" class="other_trans">import_string</span>(<span id="ast-40"><span id="ast-41"><span id="ast-42">'{plugin_name}'</span>.format</span>(plugin_name=<span id="ast-44" class="other_trans">plugin</span>)</span>)</span></span><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>settings</span>&nbsp;=&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">plugin_instance</span>.configure</span>(<span id="ast-50" class="other_trans">task_settings</span>)</span></span><span id="ast-51"><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>task_instance</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">import_string</span>(<span id="ast-55"><span id="ast-56"><span id="ast-57">'{plugin_name}.models.task_types.{task}'</span>.format</span>(plugin_name=<span id="ast-59" class="other_trans">plugin</span>,&nbsp;task=<span id="ast-61" class="other_trans">task</span>)</span>)</span></span><span id="ast-62"><span id="ast-63"><span id="ast-64" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>loaders</span>[<span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans">task_instance</span>.type_name</span></span>]</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70">jinja2</span>.PackageLoader</span>(<span id="ast-71" class="other_trans">plugin</span>)</span></span><span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>task_types</span>[<span id="ast-75"><span id="ast-76"><span id="ast-77">task_instance</span>.type_name</span></span>]</span>&nbsp;=&nbsp;<span id="ast-78"><span id="ast-79" class="other_trans">task_instance</span>(settings=<span id="ast-81">settings</span>)</span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-83">(<span id="ast-84">'COLLECT_STATIC_ROOT'</span><span id="ast-85">&nbsp;in&nbsp;</span><span id="ast-86"><span id="ast-87" class="other_trans">app</span>.config</span>)</span>:<span id="ast-88"><span id="ast-89" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>prefix</span>&nbsp;=&nbsp;<span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93" class="other_trans">app</span>.config</span>.get</span>(<span id="ast-94">'COLLECT_PLUGIN_DIR_PREFIX'</span>,&nbsp;<span id="ast-95">''</span>)</span></span><span id="ast-96"><span id="ast-97"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>static_path</span>&nbsp;=&nbsp;<span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101">os</span>.path</span>.join</span>(<span id="ast-102"><span id="ast-103" class="other_trans">app</span>.static_folder</span>,&nbsp;<span id="ast-104"><span id="ast-105"><span id="ast-106">'{}{}'</span>.format</span>(<span id="ast-107" class="other_trans">prefix</span>,&nbsp;<span id="ast-108" class="other_trans">plugin</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>static_path</span>&nbsp;=&nbsp;<span id="ast-111"><span id="ast-112"><span id="ast-113" class="location_node">task_instance&nbsp;&rarr;&nbsp;plugin_instance,&nbsp;pred:&nbsp;app&nbsp;</span>.__path__</span>[<span id="ast-114"><span id="ast-115">0</span></span>]</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;create_version(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">name</span>,&nbsp;<span id="ast-5" class="other_trans">project</span>,&nbsp;<span id="ast-6" class="other_trans">description</span>,&nbsp;<span id="ast-8" class="other_trans">releaseDate</span>,&nbsp;<span id="ast-10" class="other_trans">startDate</span>,&nbsp;<span id="ast-12" class="other_trans">archived</span>,&nbsp;<span id="ast-14" class="other_trans">released</span></span>):<span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Create&nbsp;a&nbsp;version&nbsp;in&nbsp;a&nbsp;project&nbsp;and&nbsp;return&nbsp;a&nbsp;Resource&nbsp;for&nbsp;it.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;name:&nbsp;name&nbsp;of&nbsp;the&nbsp;version&nbsp;to&nbsp;create\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;project:&nbsp;key&nbsp;of&nbsp;the&nbsp;project&nbsp;to&nbsp;create&nbsp;the&nbsp;version&nbsp;in\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;description:&nbsp;a&nbsp;description&nbsp;of&nbsp;the&nbsp;version\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;releaseDate:&nbsp;the&nbsp;release&nbsp;date&nbsp;assigned&nbsp;to&nbsp;the&nbsp;version\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;startDate:&nbsp;The&nbsp;start&nbsp;date&nbsp;for&nbsp;the&nbsp;version\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-20">{<span id="ast-21">'name'</span>:&nbsp;<span id="ast-25" class="other_trans">name</span>,&nbsp;<span id="ast-22">'project'</span>:&nbsp;<span id="ast-26" class="other_trans">project</span>,&nbsp;<span id="ast-23">'archived'</span>:&nbsp;<span id="ast-27" class="other_trans">archived</span>,&nbsp;<span id="ast-24">'released'</span>:&nbsp;<span id="ast-28" class="other_trans">released</span>}</span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30">(<span id="ast-31" class="other_trans">description</span><span id="ast-32" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-33" class="other_trans">None</span>)</span>:<span id="ast-34"><span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>[<span id="ast-37"><span id="ast-38">'description'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-39" class="other_trans">description</span></span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41">(<span id="ast-42" class="other_trans">releaseDate</span><span id="ast-43" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-44" class="other_trans">None</span>)</span>:<span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>[<span id="ast-48"><span id="ast-49">'releaseDate'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-50" class="other_trans">releaseDate</span></span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52">(<span id="ast-53" class="other_trans">startDate</span><span id="ast-54" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-55">None</span>)</span>:<span id="ast-56"><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>[<span id="ast-59"><span id="ast-60">'startDate'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-61" class="correct_node">releaseDate&nbsp;&rarr;&nbsp;startDate&nbsp;</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;set(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">enable</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Sets&nbsp;the&nbsp;glColorPointer.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;note::&nbsp;This&nbsp;function&nbsp;automatically&nbsp;handles&nbsp;a&nbsp;quirk&nbsp;in&nbsp;PyOpenGL\\u000a&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;an&nbsp;offset&nbsp;of&nbsp;0&nbsp;must&nbsp;be&nbsp;specified&nbsp;as&nbsp;None.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;..&nbsp;warning::&nbsp;This&nbsp;function&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;OpenGL&nbsp;Core&nbsp;profile&nbsp;and&nbsp;**only**\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists&nbsp;in&nbsp;OpenGL&nbsp;Legacy&nbsp;profile&nbsp;(OpenGL&nbsp;version&nbsp;&lt;=2.1).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10">not</span>&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>.buffer</span>.bound</span>)</span>:<span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-15"><span id="ast-16" class="other_trans">ValueError</span>(<span id="ast-17">'Buffer&nbsp;is&nbsp;not&nbsp;bound'</span>)</span></span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19" class="other_trans">enable</span>:<span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.enable</span>()</span></span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>offset</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">ctypes</span>.c_void_p</span>(<span id="ast-32"><span id="ast-33">self</span>.offset</span>)</span>&nbsp;if&nbsp;<span id="ast-27"><span id="ast-28">self</span>.offset</span>&nbsp;else&nbsp;<span id="ast-34" class="other_trans">None</span></span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>GL</span>.glTexCoordPointer</span>(<span id="ast-39" class="correct_node">values_per_vertex&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-40"><span id="ast-41">self</span>.gl_type</span>,&nbsp;<span id="ast-42"><span id="ast-43">self</span>.stride</span>,&nbsp;<span id="ast-44" class="other_trans">offset</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;process_request(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">request</span></span>):<span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-6"><span id="ast-7" class="other_trans">settings</span>.DEBUG</span>:<span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11"><span id="ast-12" class="correct_node">regex&nbsp;&rarr;&nbsp;self.&nbsp;</span>.search</span>(<span id="ast-13"><span id="ast-14" class="other_trans">request</span>.path</span>)</span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16" class="other_trans">match</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">serve</span>(<span id="ast-20" class="other_trans">request</span>,&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23" class="other_trans">match</span>.group</span>(<span id="ast-24">1</span>)</span>,&nbsp;<span id="ast-25"><span id="ast-26" class="other_trans">settings</span>.MEDIA_ROOT</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;generate_thumbnail_from_jpeg(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">document</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Generating&nbsp;a&nbsp;thumbnail&nbsp;based&nbsp;on&nbsp;document&nbsp;first&nbsp;file'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8">(<span id="ast-9">Image</span><span id="ast-10" class="correct_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-11" class="other_trans">None</span>)</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">PluginError</span>(<span id="ast-15">'Can&nbsp;not&nbsp;generate&nbsp;thumbnail&nbsp;for&nbsp;JPEG&nbsp;file.&nbsp;PIL&nbsp;(Pillow)&nbsp;is&nbsp;not&nbsp;set&nbsp;up&nbsp;correctly.'</span>,&nbsp;<span id="ast-16">404</span>)</span></span></span><span id="ast-17"><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-19" class="other_trans">thumbnail_temporary</span>,&nbsp;<span id="ast-20" class="other_trans">thumbnail_directory</span>)</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23">self</span>.get_thumbnail_path</span>(<span id="ast-24" class="other_trans">document</span>)</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-27">not</span>&nbsp;<span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-32" class="other_trans">thumbnail_directory</span>)</span>)</span>:<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.makedirs</span>(<span id="ast-37" class="other_trans">thumbnail_directory</span>)</span></span></span><span id="ast-38"><span id="ast-39" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tmp_jpg</span>&nbsp;=&nbsp;<span id="ast-40"><span id="ast-41" class="other_trans">open</span>(<span id="ast-42" class="other_trans">thumbnail_temporary</span>,&nbsp;<span id="ast-43">'w'</span>)</span></span><span id="ast-44"><span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tmp_jpg</span>.write</span>(<span id="ast-48"><span id="ast-49"><span id="ast-50"><span id="ast-51"><span id="ast-52" class="other_trans">document</span>.get_file_obj</span>()</span>.read</span>()</span>)</span></span><span id="ast-53"><span id="ast-54"><span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tmp_jpg</span>.close</span>()</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-58"><span id="ast-59" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>im</span>&nbsp;=&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62">Image</span>.open</span>(<span id="ast-63" class="other_trans">thumbnail_temporary</span>)</span></span><span id="ast-64"><span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>im</span>.thumbnail</span>(<span id="ast-68"><span id="ast-69">self</span>.jpeg_size</span>,&nbsp;<span id="ast-70"><span id="ast-71" class="other_trans">Image</span>.ANTIALIAS</span>)</span></span><span id="ast-72"><span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>im</span>.save</span>(<span id="ast-76">(<span id="ast-77" class="other_trans">thumbnail_temporary</span>&nbsp;+&nbsp;<span id="ast-79">'.png'</span>)</span>,&nbsp;<span id="ast-80">'PNG'</span>)</span></span><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-82">Exception</span>&nbsp;as&nbsp;<span id="ast-83" class="other_trans">e</span>:<span id="ast-84"><span id="ast-85" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>error</span>&nbsp;=&nbsp;<span id="ast-86">(<span id="ast-87">'ThumbnailsFilesystemHandler.generate_thumbnail&nbsp;(jpeg)&nbsp;method&nbsp;error:&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-89" class="other_trans">e</span>)</span></span><span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.error</span>(<span id="ast-94" class="other_trans">error</span>)</span></span><span id="ast-95"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-96"><span id="ast-97">PluginError</span>(<span id="ast-98" class="other_trans">error</span>,&nbsp;<span id="ast-99">404</span>)</span></span></span></span><span id="ast-100"><span id="ast-101"><span id="ast-102"><span id="ast-103" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.unlink</span>(<span id="ast-104" class="other_trans">thumbnail_temporary</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;render_template(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">template_name</span>,&nbsp;<span id="ast-5" class="other_trans">output_name</span>,&nbsp;<span id="ast-6" class="other_trans">context</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Render&nbsp;the&nbsp;template&nbsp;into&nbsp;output_name&nbsp;using&nbsp;context.'</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-10">(<span id="ast-11" class="other_trans">jinja2</span><span id="ast-12" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-13" class="other_trans">None</span>)</span>:<span id="ast-14"><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>req_missing</span>(<span id="ast-17">[<span id="ast-18">'jinja2'</span>]</span>,&nbsp;<span id="ast-19">'use&nbsp;this&nbsp;theme'</span>)</span></span></span><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>template</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24"><span id="ast-25">self</span>.lookup</span>.get_template</span>(<span id="ast-26" class="other_trans">template_name</span>)</span></span><span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">template</span>.render</span>(**<span id="ast-32" class="other_trans">context</span>)</span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-34">(<span id="ast-35" class="other_trans">output_name</span><span id="ast-36" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-37" class="other_trans">None</span>)</span>:<span id="ast-38"><span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>makedirs</span>(<span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">os</span>.path</span>.dirname</span>(<span id="ast-45" class="other_trans">output_name</span>)</span>)</span></span><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">io</span>.open</span>(<span id="ast-50" class="other_trans">output_name</span>,&nbsp;<span id="ast-51">'w'</span>,&nbsp;encoding=<span id="ast-53">'utf-8'</span>)</span>&nbsp;as&nbsp;<span id="ast-54" class="other_trans">output</span>:<span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>output</span>.write</span>(<span id="ast-59" class="other_trans">data</span>)</span></span></span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-61" class="correct_node">output&nbsp;&rarr;&nbsp;data&nbsp;</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;submit(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>body_text</span>&nbsp;=&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8">'\\u000a'</span>.join</span>(<span id="ast-9"><span id="ast-10"><span id="ast-11"><span id="ast-12" class="other_trans">super</span>()</span>.submit</span>()</span>)</span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-14">(<span id="ast-15">not</span>&nbsp;<span id="ast-16" class="other_trans">body_text</span>)</span>:<span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.debug</span>(<span id="ast-21">'Not&nbsp;sending&nbsp;%s&nbsp;(no&nbsp;changes)'</span>,&nbsp;<span id="ast-22"><span id="ast-23">self</span>.__kind__</span>)</span></span><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-27"><span id="ast-28" class="other_trans">len</span>(<span id="ast-29" class="other_trans">body_text</span>)</span><span id="ast-30" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-31"><span id="ast-32">self</span>.MAX_LENGTH</span>)</span>:<span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>body_text</span>&nbsp;=&nbsp;<span id="ast-35"><span id="ast-36" class="other_trans">body_text</span>[<span id="ast-37">:<span id="ast-38" class="correct_node">MAX_LENGTH&nbsp;&rarr;&nbsp;self.&nbsp;</span></span>]</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;render(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">name</span>,&nbsp;<span id="ast-5" class="other_trans">value</span>,&nbsp;<span id="ast-6" class="other_trans">attrs</span></span>):<span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10" class="other_trans">value</span><span id="ast-11" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-12" class="other_trans">None</span>)</span>:<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>value</span>&nbsp;=&nbsp;<span id="ast-15">''</span></span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17">(<span id="ast-18">'class'</span><span id="ast-19">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-20" class="other_trans">attrs</span>)</span>:<span id="ast-21"><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>attrs</span>[<span id="ast-24"><span id="ast-25">'class'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-26">''</span></span></span><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>attrs</span>[<span id="ast-30"><span id="ast-31">'class'</span></span>]</span>&nbsp;+=&nbsp;<span id="ast-33">'&nbsp;wmd-input'</span></span><span id="ast-34"><span id="ast-35" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>final_attrs</span>&nbsp;=&nbsp;<span id="ast-36"><span id="ast-37"><span id="ast-38">self</span>.build_attrs</span>(<span id="ast-39" class="other_trans">attrs</span>,&nbsp;name=<span id="ast-41" class="other_trans">name</span>)</span></span><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>html</span>&nbsp;=&nbsp;<span id="ast-44">(<span id="ast-45">'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class="wmd-wrapper"&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;class="wmd-panel"&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;id="%(id)s_wmd_button_bar"&gt;&lt;/div&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;textarea%(attrs)s&gt;%(body)s&lt;/textarea&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&nbsp;id="%(id)s_wmd_preview"&nbsp;class="wmd-panel&nbsp;wmd-preview"&gt;&lt;/div&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script&nbsp;type="text/javascript"&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(function&nbsp;()&nbsp;{\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;converter&nbsp;=&nbsp;Markdown.getSanitizingConverter();\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selectors&nbsp;=&nbsp;{\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input&nbsp;:&nbsp;"%(id)s",\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;button&nbsp;:&nbsp;"%(id)s_wmd_button_bar",\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preview&nbsp;:&nbsp;"%(id)s_wmd_preview",\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;editor&nbsp;=&nbsp;new&nbsp;Markdown.Editor(converter,&nbsp;"",&nbsp;selectors);\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editor.run();\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})();\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'</span>&nbsp;%&nbsp;<span id="ast-47">{<span id="ast-48">'attrs'</span>:&nbsp;<span id="ast-51"><span id="ast-52" class="other_trans">flatatt</span>(<span id="ast-53" class="other_trans">final_attrs</span>)</span>,&nbsp;<span id="ast-49">'body'</span>:&nbsp;<span id="ast-54"><span id="ast-55" class="other_trans">conditional_escape</span>(<span id="ast-56"><span id="ast-57" class="other_trans">force_unicode</span>(<span id="ast-58" class="incorrect_node">value&nbsp;&rarr;&nbsp;name&nbsp;</span>)</span>)</span>,&nbsp;<span id="ast-50">'id'</span>:&nbsp;<span id="ast-59"><span id="ast-60" class="ref_node">attrs&nbsp;&rarr;&nbsp;final_attrs&nbsp;</span>[<span id="ast-61"><span id="ast-62">'id'</span></span>]</span>}</span>)</span></span><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-64"><span id="ast-65" class="other_trans">mark_safe</span>(<span id="ast-66" class="other_trans">html</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;do_copy(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">cmd</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Copy&nbsp;the&nbsp;given&nbsp;set&nbsp;of&nbsp;messages&nbsp;to&nbsp;the&nbsp;destination&nbsp;mailbox.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;NOTE:&nbsp;Causes&nbsp;a&nbsp;resync&nbsp;of&nbsp;the&nbsp;destination&nbsp;mailbox.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Arguments:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;`cmd`:&nbsp;The&nbsp;IMAP&nbsp;command&nbsp;we&nbsp;are&nbsp;executing\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8"><span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.send_pending_expunges</span>()</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-13"><span id="ast-14">self</span>.state</span><span id="ast-15" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-16">'selected'</span>)</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">No</span>(<span id="ast-20">'Client&nbsp;must&nbsp;be&nbsp;in&nbsp;the&nbsp;selected&nbsp;state'</span>)</span></span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-22">(<span id="ast-23"><span id="ast-24">self</span>.mbox</span><span id="ast-25" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-26" class="other_trans">None</span>)</span>:<span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.client</span>.push</span>(<span id="ast-32">'*&nbsp;BYE&nbsp;Your&nbsp;selected&nbsp;mailbox&nbsp;no&nbsp;longer&nbsp;exists\\u000d\\u000a'</span>)</span></span><span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.client</span>.close</span>()</span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dest_mbox</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45">self</span>.server</span>.get_mailbox</span>(<span id="ast-46"><span id="ast-47" class="other_trans">cmd</span>.mailbox_name</span>,&nbsp;expiry=<span id="ast-49">0</span>)</span></span><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dest_mbox</span>.mailbox</span>.lock</span>()</span></span><span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59" class="ref_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>mbox&nbsp;&rarr;&nbsp;self.&nbsp;</span>.copy</span>(<span id="ast-60"><span id="ast-61" class="other_trans">cmd</span>.msg_set</span>,&nbsp;<span id="ast-62" class="other_trans">dest_mbox</span>,&nbsp;<span id="ast-63"><span id="ast-64" class="other_trans">cmd</span>.uid_command</span>)</span></span><span id="ast-65"><span id="ast-66"><span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dest_mbox</span>.resync</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>finally:<span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dest_mbox&nbsp;&rarr;&nbsp;cmd&nbsp;</span>.mailbox</span>.unlock</span>()</span></span></span><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77" class="other_trans">asimap</span>.mbox</span>.NoSuchMailbox</span>:<span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-79"><span id="ast-80" class="other_trans">No</span>(<span id="ast-81">(<span id="ast-82">"[TRYCREATE]&nbsp;No&nbsp;such&nbsp;mailbox:&nbsp;'%s'"</span>&nbsp;%&nbsp;<span id="ast-84"><span id="ast-85" class="other_trans">cmd</span>.mailbox_name</span>)</span>)</span></span></span></span><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_ranking(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">nn</span>,&nbsp;<span id="ast-5" class="other_trans">H</span>,&nbsp;<span id="ast-7" class="other_trans">T</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Return&nbsp;ranking&nbsp;of&nbsp;hidden&nbsp;neurons;&nbsp;random&nbsp;or&nbsp;OP.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-13"><span id="ast-14">self</span>.ranking</span><span id="ast-15" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-16">'OP'</span>)</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18">(<span id="ast-19"><span id="ast-20">self</span>.kmax_op</span><span id="ast-21" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-22">None</span>)</span>:<span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.kmax_op</span>&nbsp;=&nbsp;<span id="ast-26" class="other_trans">nn</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>nn</span>&nbsp;=&nbsp;<span id="ast-29"><span id="ast-30">self</span>.kmax_op</span></span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-32">(<span id="ast-33"><span id="ast-34"><span id="ast-35" class="incorrect_node">T&nbsp;&rarr;&nbsp;nn&nbsp;</span>.shape</span>[<span id="ast-36"><span id="ast-37">1</span></span>]</span><span id="ast-38" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-39">10</span>)</span>:<span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rank</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43" class="other_trans">mrsr</span>(<span id="ast-44" class="other_trans">H</span>,&nbsp;<span id="ast-45" class="other_trans">T</span>,&nbsp;<span id="ast-46"><span id="ast-47">self</span>.kmax_op</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rank</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51" class="other_trans">mrsr2</span>(<span id="ast-52" class="other_trans">H</span>,&nbsp;<span id="ast-53" class="other_trans">T</span>,&nbsp;<span id="ast-54"><span id="ast-55">self</span>.kmax_op</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-56"><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-58" class="other_trans">rank</span>,&nbsp;<span id="ast-59" class="other_trans">nn</span>)</span>&nbsp;=&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">super</span>(<span id="ast-64" class="other_trans">ELM</span>,&nbsp;<span id="ast-65">self</span>)</span>._ranking</span>(<span id="ast-66" class="other_trans">nn</span>)</span></span></span><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-68">(<span id="ast-69" class="other_trans">rank</span>,&nbsp;<span id="ast-70" class="other_trans">nn</span>)</span></span></span></span></span><br /><br /><hr />
</body></html>
