<html><head><style>
.ast { font-family: monospace; font-size: 12pt; }
.correct_node { font-weight: bold; background-color: green; color: white; }
.incorrect_node { font-weight: bold; background-color: red; color: white; }
.ref_node { font-weight: bold; background-color: blue; color: white; }
.location_node { font-weight: bold; background-color: #ff00ff; color: white; }
.other_trans { color: #3333ff; }
.whitespace { background-color: white; color: black; }
.pred_rank_wrapper { font-weight: bold; }
.correct_pred_rank { font-weight: bold; color: green;}
.incorrect_pred_rank { font-weight: bold; color: red; }
.rank_type { font-weight: bold; }
.description { font-size: 16pt; }
</style></head><body><div class="description">
<div><b>This is part 3/10 of the system predictions for the Real-Bug Test set. This system achieves 41% Repair Accuracy and 54% Location Accuracy.</b></div><br /><div><b>Annotations</b>:</div><ul><li><span class="correct_node">foo &rarr; bar</span> - The bug was located at this node, and the system <i>correctly</i> predicted both the location and the repair as its top prediction.</li><li><span class="incorrect_node">foo &rarr; bar</span> - The system <i>incorrectly</i> predicted this repair as its top prediction.</li><li><span class="ref_node">foo &rarr; bar</span> - If the system incorrectly predicted the repair, this was the correct repair it should have made.</li><li><span class="location_node">foo &rarr; bar, pred: zap</span> - The system predicted the correct <i>location</i> of the repair, but the wrong repair label. It should have predicted 'bar', but it predicted 'zap' instead.</li></ul><div>The part before the arrow ('foo') is what the system actually saw at test time. Other candidate repair locations which the system could have chosen are marked in <span class="other_trans">this color</span>. For clarity the actual labels for those locations are not shown.</div></div><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;post(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;*args,&nbsp;**kwargs</span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Attempts&nbsp;to&nbsp;create&nbsp;an&nbsp;account,&nbsp;with&nbsp;shitty&nbsp;form&nbsp;validation&nbsp;'</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user_name</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.get_argument</span>(<span id="ast-12">'username'</span>)</span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-18">'public/registration.html'</span>,&nbsp;errors=<span id="ast-20">'Please&nbsp;enter&nbsp;a&nbsp;valid&nbsp;account&nbsp;name'</span>)</span></span></span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>handle</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">self</span>.get_argument</span>(<span id="ast-27">'handle'</span>)</span></span><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-29"><span id="ast-30"><span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-33">'public/registration.html'</span>,&nbsp;errors=<span id="ast-35">'Please&nbsp;enter&nbsp;a&nbsp;valid&nbsp;handle'</span>)</span></span></span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password1</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41">self</span>.get_argument</span>(<span id="ast-42">'pass1'</span>)</span></span><span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password2</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47">self</span>.get_argument</span>(<span id="ast-48">'pass2'</span>)</span></span><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-50">(<span id="ast-51" class="other_trans">password1</span><span id="ast-52" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-53" class="other_trans">password2</span>)</span>:<span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-58">'public/registration.html'</span>,&nbsp;errors=<span id="ast-60">'Passwords&nbsp;did&nbsp;not&nbsp;match'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-61"><span id="ast-62" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password</span>&nbsp;=&nbsp;<span id="ast-63">password1</span></span></span><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-65"><span id="ast-66"><span id="ast-67"><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-69">'public/registration.html'</span>,&nbsp;errors=<span id="ast-71">'Please&nbsp;enter&nbsp;a&nbsp;password'</span>)</span></span></span></span><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>response</span>&nbsp;=&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77" class="other_trans">captcha</span>.submit</span>(<span id="ast-78"><span id="ast-79"><span id="ast-80">self</span>.get_argument</span>(<span id="ast-81">'recaptcha_challenge_field'</span>)</span>,&nbsp;<span id="ast-82"><span id="ast-83"><span id="ast-84">self</span>.get_argument</span>(<span id="ast-85">'recaptcha_response_field'</span>)</span>,&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88"><span id="ast-89">self</span>.application</span>.settings</span>[<span id="ast-90"><span id="ast-91">'recaptcha_private_key'</span></span>]</span>,&nbsp;<span id="ast-92"><span id="ast-93"><span id="ast-94">self</span>.request</span>.remote_ip</span>)</span></span><span id="ast-95"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-96"><span id="ast-97"><span id="ast-98"><span id="ast-99"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-100">'public/registration.html'</span>,&nbsp;errors=<span id="ast-102">'Please&nbsp;fill&nbsp;out&nbsp;recaptcha!'</span>)</span></span></span></span><span id="ast-103"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-104">(<span id="ast-105"><span id="ast-106"><span id="ast-107" class="other_trans">User</span>.by_user_name</span>(<span id="ast-108" class="other_trans">user_name</span>)</span><span id="ast-109" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-110">None</span>)</span>:<span id="ast-111"><span id="ast-112"><span id="ast-113"><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-115">'public/registration.html'</span>,&nbsp;errors=<span id="ast-117">'Account&nbsp;name&nbsp;already&nbsp;taken'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-119">(<span id="ast-120" class="other_trans">user_name</span><span id="ast-121" class="ref_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-122" class="other_trans">handle</span>)</span>:<span id="ast-123"><span id="ast-124"><span id="ast-125"><span id="ast-126"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-127">'public/registration.html'</span>,&nbsp;errors=<span id="ast-129">'Account&nbsp;name&nbsp;and&nbsp;hacker&nbsp;name&nbsp;must&nbsp;differ'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-131">(<span id="ast-132"><span id="ast-133"><span id="ast-134">User</span>.by_display_name</span>(<span id="ast-135" class="other_trans">handle</span>)</span><span id="ast-136" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-137">None</span>)</span>:<span id="ast-138"><span id="ast-139"><span id="ast-140"><span id="ast-141"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-142">'public/registration.html'</span>,&nbsp;errors=<span id="ast-144">'Handle&nbsp;already&nbsp;taken'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-146">(<span id="ast-147">not</span>&nbsp;<span id="ast-148">(<span id="ast-149">0</span><span id="ast-150" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-152"><span id="ast-153">len</span>(<span id="ast-154" class="incorrect_node">password&nbsp;&rarr;&nbsp;response&nbsp;</span>)</span><span id="ast-151" class="other_trans">&nbsp;&lt;=&nbsp;</span><span id="ast-155">7</span>)</span>)</span>:<span id="ast-156"><span id="ast-157"><span id="ast-158"><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-160">'public/registration.html'</span>,&nbsp;errors=<span id="ast-162">'Password&nbsp;must&nbsp;be&nbsp;1-7&nbsp;characters'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-164">(<span id="ast-165">not</span>&nbsp;<span id="ast-166"><span id="ast-167" class="other_trans">response</span>.is_valid</span>)</span>:<span id="ast-168"><span id="ast-169"><span id="ast-170"><span id="ast-171"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.render</span>(<span id="ast-172">'public/registration.html'</span>,&nbsp;errors=<span id="ast-174">'Invalid&nbsp;Recaptcha!'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-175"><span id="ast-176" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>char_white_list</span>&nbsp;=&nbsp;<span id="ast-177">(<span id="ast-178" class="other_trans">ascii_letters</span>&nbsp;+&nbsp;<span id="ast-180">digits</span>)</span></span><span id="ast-181"><span id="ast-182"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user_name</span>&nbsp;=&nbsp;<span id="ast-183"><span id="ast-184" class="other_trans">filter</span>(<span id="ast-185">lambda&nbsp;<span id="ast-186"><span id="ast-187" class="other_trans">char</span></span>:&nbsp;<span id="ast-188">(<span id="ast-189" class="other_trans">char</span><span id="ast-190">&nbsp;in&nbsp;</span><span id="ast-191">char_white_list</span>)</span></span>,&nbsp;<span id="ast-192">user_name</span>)</span></span><span id="ast-193"><span id="ast-194" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>display_name</span>&nbsp;=&nbsp;<span id="ast-195"><span id="ast-196" class="other_trans">filter</span>(<span id="ast-197">lambda&nbsp;<span id="ast-198"><span id="ast-199" class="other_trans">char</span></span>:&nbsp;<span id="ast-200">(<span id="ast-201" class="other_trans">char</span><span id="ast-202">&nbsp;in&nbsp;</span><span id="ast-203" class="other_trans">char_white_list</span>)</span></span>,&nbsp;<span id="ast-204" class="other_trans">handle</span>)</span></span><span id="ast-205"><span id="ast-206" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-207"><span id="ast-208">User</span>(user_name=<span id="ast-210"><span id="ast-211">unicode</span>(<span id="ast-212" class="other_trans">user_name</span>)</span>,&nbsp;display_name=<span id="ast-214"><span id="ast-215" class="other_trans">unicode</span>(<span id="ast-216" class="other_trans">display_name</span>)</span>,&nbsp;password=<span id="ast-218" class="other_trans">password</span>)</span></span><span id="ast-219"><span id="ast-220"><span id="ast-221"><span id="ast-222"><span id="ast-223"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.dbsession</span>.add</span>(<span id="ast-224" class="other_trans">user</span>)</span></span><span id="ast-225"><span id="ast-226"><span id="ast-227"><span id="ast-228"><span id="ast-229"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.dbsession</span>.flush</span>()</span></span></span><span id="ast-230"><span id="ast-231"><span id="ast-232"><span id="ast-233"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.redirect</span>(<span id="ast-234">'/login'</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;outputterminal(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Print&nbsp;a&nbsp;slice&nbsp;(or&nbsp;layer)&nbsp;of&nbsp;the&nbsp;dungeon&nbsp;block&nbsp;buffer&nbsp;to&nbsp;the&nbsp;termial.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;"look-through"&nbsp;any&nbsp;air&nbsp;blocks&nbsp;to&nbsp;blocks&nbsp;underneath'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>floor</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="ref_node">args&nbsp;&rarr;&nbsp;self.&nbsp;</span>.term</span></span><span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>layer</span>&nbsp;=&nbsp;<span id="ast-12">(<span id="ast-13">(<span id="ast-14" class="other_trans">floor</span>&nbsp;-&nbsp;<span id="ast-16">1</span>)</span>&nbsp;*&nbsp;<span id="ast-18"><span id="ast-19">self</span>.room_height</span>)</span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-21" class="other_trans">z</span>&nbsp;in&nbsp;<span id="ast-22"><span id="ast-23">xrange</span>(<span id="ast-24">(<span id="ast-25"><span id="ast-26">self</span>.zsize</span>&nbsp;*&nbsp;<span id="ast-28"><span id="ast-29">self</span>.room_size</span>)</span>)</span>:<span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-31" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-32"><span id="ast-33">xrange</span>(<span id="ast-34">(<span id="ast-35"><span id="ast-36">self</span>.xsize</span>&nbsp;*&nbsp;<span id="ast-38"><span id="ast-39">self</span>.room_size</span>)</span>)</span>:<span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>y</span>&nbsp;=&nbsp;<span id="ast-42" class="other_trans">layer</span></span><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-44">(<span id="ast-46">(<span id="ast-47" class="other_trans">y</span><span id="ast-48" class="incorrect_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-49">(<span id="ast-50">(<span id="ast-51" class="other_trans">layer</span>&nbsp;+&nbsp;<span id="ast-53"><span id="ast-54">self</span>.room_height</span>)</span>&nbsp;-&nbsp;<span id="ast-56">1</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-57">(<span id="ast-58"><span id="ast-59">Vec</span>(<span id="ast-60">x</span>,&nbsp;<span id="ast-61">y</span>,&nbsp;<span id="ast-62">z</span>)</span><span id="ast-63">&nbsp;in&nbsp;</span><span id="ast-64"><span id="ast-65">self</span>.blocks</span>)</span>&nbsp;and&nbsp;<span id="ast-66">(<span id="ast-68">(<span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72">self</span>.blocks</span>[<span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans">Vec</span>(<span id="ast-76" class="other_trans">x</span>,&nbsp;<span id="ast-77" class="other_trans">y</span>,&nbsp;<span id="ast-78">z</span>)</span></span>]</span>.hide</span><span id="ast-79" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-80">True</span>)</span>&nbsp;or&nbsp;<span id="ast-81">(<span id="ast-82"><span id="ast-83"><span id="ast-84"><span id="ast-85">self</span>.blocks</span>[<span id="ast-86"><span id="ast-87"><span id="ast-88">Vec</span>(<span id="ast-89" class="other_trans">x</span>,&nbsp;<span id="ast-90" class="other_trans">y</span>,&nbsp;<span id="ast-91" class="other_trans">z</span>)</span></span>]</span>.material</span><span id="ast-92" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-93"><span id="ast-94">materials</span>.Air</span>)</span>&nbsp;or&nbsp;<span id="ast-95">(<span id="ast-96"><span id="ast-97"><span id="ast-98"><span id="ast-99">self</span>.blocks</span>[<span id="ast-100"><span id="ast-101"><span id="ast-102" class="other_trans">Vec</span>(<span id="ast-103" class="other_trans">x</span>,&nbsp;<span id="ast-104" class="other_trans">y</span>,&nbsp;<span id="ast-105" class="other_trans">z</span>)</span></span>]</span>.material</span><span id="ast-106" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-107"><span id="ast-108">materials</span>._ceiling</span>)</span>)</span>)</span>:<span id="ast-109"><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>y</span>&nbsp;+=&nbsp;<span id="ast-112">1</span></span></span><span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-114">(<span id="ast-116">(<span id="ast-117"><span id="ast-118">Vec</span>(<span id="ast-119" class="other_trans">x</span>,&nbsp;<span id="ast-120">y</span>,&nbsp;<span id="ast-121">z</span>)</span><span id="ast-122">&nbsp;in&nbsp;</span><span id="ast-123"><span id="ast-124">self</span>.blocks</span>)</span>&nbsp;and&nbsp;<span id="ast-125">(<span id="ast-126"><span id="ast-127"><span id="ast-128"><span id="ast-129">self</span>.blocks</span>[<span id="ast-130"><span id="ast-131"><span id="ast-132">Vec</span>(<span id="ast-133">x</span>,&nbsp;<span id="ast-134">y</span>,&nbsp;<span id="ast-135" class="other_trans">z</span>)</span></span>]</span>.hide</span><span id="ast-136" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-137">False</span>)</span>)</span>:<span id="ast-138"><span id="ast-139" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>mat</span>&nbsp;=&nbsp;<span id="ast-140"><span id="ast-141"><span id="ast-142"><span id="ast-143">self</span>.blocks</span>[<span id="ast-144"><span id="ast-145"><span id="ast-146" class="other_trans">Vec</span>(<span id="ast-147" class="other_trans">x</span>,&nbsp;<span id="ast-148" class="other_trans">y</span>,&nbsp;<span id="ast-149">z</span>)</span></span>]</span>.material</span></span><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-151">(<span id="ast-152"><span id="ast-153" class="other_trans">mat</span>._meta</span><span id="ast-154" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-155">True</span>)</span>:<span id="ast-156"><span id="ast-157"><span id="ast-158"><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>mat</span>.update</span>(<span id="ast-160" class="other_trans">x</span>,&nbsp;<span id="ast-161" class="other_trans">y</span>,&nbsp;<span id="ast-162" class="other_trans">z</span>,&nbsp;<span id="ast-163">(<span id="ast-164"><span id="ast-165">self</span>.xsize</span>&nbsp;*&nbsp;<span id="ast-167"><span id="ast-168">self</span>.room_size</span>)</span>,&nbsp;<span id="ast-169">(<span id="ast-170"><span id="ast-171">self</span>.levels</span>&nbsp;*&nbsp;<span id="ast-173"><span id="ast-174">self</span>.room_height</span>)</span>,&nbsp;<span id="ast-175">(<span id="ast-176"><span id="ast-177">self</span>.zsize</span>&nbsp;*&nbsp;<span id="ast-179"><span id="ast-180">self</span>.room_size</span>)</span>)</span></span></span><span id="ast-181"><span id="ast-182"><span id="ast-183"><span id="ast-184"><span id="ast-185" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.stdout</span>.write</span>(<span id="ast-186"><span id="ast-187" class="other_trans">mat</span>.c</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-188"><span id="ast-189"><span id="ast-190"><span id="ast-191"><span id="ast-192"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.stdout</span>.write</span>(<span id="ast-193"><span id="ast-194" class="other_trans">materials</span>.NOBLOCK</span>)</span></span></span></span><span id="ast-195"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;set_starttime(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">rule</span>,&nbsp;<span id="ast-5" class="other_trans">endtime</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Given&nbsp;a&nbsp;rule&nbsp;and&nbsp;an&nbsp;endtime,&nbsp;sets&nbsp;the&nbsp;appropriate&nbsp;starttime&nbsp;for&nbsp;it.&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10">'starttime'</span><span id="ast-11">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-12" class="other_trans">rule</span>)</span>:<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>last_run_end</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.get_starttime</span>(<span id="ast-18" class="other_trans">rule</span>)</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-20" class="other_trans">last_run_end</span>:<span id="ast-21"><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-24"><span id="ast-25">'minimum_starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-26" class="other_trans">last_run_end</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-30"><span id="ast-31">'starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-32" class="other_trans">last_run_end</span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span></span><span id="ast-34"><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>buffer_time</span>&nbsp;=&nbsp;<span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans">rule</span>.get</span>(<span id="ast-39">'buffer_time'</span>,&nbsp;<span id="ast-40"><span id="ast-41">self</span>.buffer_time</span>)</span></span><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-43">(<span id="ast-45">(<span id="ast-46">not</span>&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">rule</span>.get</span>(<span id="ast-50">'use_count_query'</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-51">(<span id="ast-52">not</span>&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans">rule</span>.get</span>(<span id="ast-56">'use_terms_query'</span>)</span>)</span>)</span>:<span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>buffer_delta</span>&nbsp;=&nbsp;<span id="ast-59">(<span id="ast-60">endtime</span>&nbsp;-&nbsp;<span id="ast-62" class="other_trans">buffer_time</span>)</span></span><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-64">(<span id="ast-66">(<span id="ast-67">'minimum_starttime'</span><span id="ast-68">&nbsp;in&nbsp;</span><span id="ast-69" class="other_trans">rule</span>)</span>&nbsp;and&nbsp;<span id="ast-70">(<span id="ast-71"><span id="ast-72" class="other_trans">rule</span>[<span id="ast-73"><span id="ast-74">'minimum_starttime'</span></span>]</span><span id="ast-75" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-76" class="other_trans">buffer_delta</span>)</span>)</span>:<span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-80"><span id="ast-81">'starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-82"><span id="ast-83" class="other_trans">rule</span>[<span id="ast-84"><span id="ast-85">'minimum_starttime'</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-87">(<span id="ast-89">(<span id="ast-90">'previous_endtime'</span><span id="ast-91">&nbsp;in&nbsp;</span><span id="ast-92" class="other_trans">rule</span>)</span>&nbsp;and&nbsp;<span id="ast-93">(<span id="ast-94"><span id="ast-95" class="other_trans">rule</span>[<span id="ast-96"><span id="ast-97">'previous_endtime'</span></span>]</span><span id="ast-98" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-99" class="other_trans">buffer_delta</span>)</span>)</span>:<span id="ast-100"><span id="ast-101"><span id="ast-102" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-103"><span id="ast-104">'starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-105"><span id="ast-106" class="other_trans">rule</span>[<span id="ast-107"><span id="ast-108">'previous_endtime'</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-109"><span id="ast-110"><span id="ast-111" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-112"><span id="ast-113">'starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-114" class="other_trans">buffer_delta</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-115"><span id="ast-116"><span id="ast-117" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rule</span>[<span id="ast-118"><span id="ast-119">'starttime'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-120"><span id="ast-121"><span id="ast-122" class="other_trans">rule</span>.get</span>(<span id="ast-123">'previous_endtime'</span>,&nbsp;<span id="ast-124">(<span id="ast-125" class="other_trans">endtime</span>&nbsp;-&nbsp;<span id="ast-127"><span id="ast-128">self</span>.run_every</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;shouldRebuildDB(<span id="ast-2"><span id="ast-3">pkgdbpath</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Checks&nbsp;to&nbsp;see&nbsp;if&nbsp;our&nbsp;internal&nbsp;package&nbsp;DB&nbsp;should&nbsp;be&nbsp;rebuilt.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;anything&nbsp;in&nbsp;/Library/Receipts,&nbsp;/Library/Receipts/boms,&nbsp;or\\u000a&nbsp;&nbsp;&nbsp;&nbsp;/Library/Receipts/db/a.receiptdb&nbsp;has&nbsp;a&nbsp;newer&nbsp;modtime&nbsp;than&nbsp;our\\u000a&nbsp;&nbsp;&nbsp;&nbsp;database,&nbsp;we&nbsp;should&nbsp;rebuild.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>receiptsdir</span>&nbsp;=&nbsp;<span id="ast-8">'/Library/Receipts'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>bomsdir</span>&nbsp;=&nbsp;<span id="ast-11">'/Library/Receipts/boms'</span></span><span id="ast-12"><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sl_receiptsdir</span>&nbsp;=&nbsp;<span id="ast-14">'/private/var/db/receipts'</span></span><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>installhistory</span>&nbsp;=&nbsp;<span id="ast-17">'/Library/Receipts/InstallHistory.plist'</span></span><span id="ast-18"><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>applepkgdb</span>&nbsp;=&nbsp;<span id="ast-20">'/Library/Receipts/db/a.receiptdb'</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-22">(<span id="ast-23">not</span>&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27">os</span>.path</span>.exists</span>(<span id="ast-28">pkgdbpath</span>)</span>)</span>:<span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-30">True</span></span></span><span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packagedb_modtime</span>&nbsp;=&nbsp;<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36">os</span>.stat</span>(<span id="ast-37">pkgdbpath</span>)</span>.st_mtime</span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42">os</span>.path</span>.exists</span>(<span id="ast-43" class="other_trans">receiptsdir</span>)</span>:<span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiptsdir_modtime</span>&nbsp;=&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49">os</span>.stat</span>(<span id="ast-50">receiptsdir</span>)</span>.st_mtime</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52">(<span id="ast-53" class="other_trans">packagedb_modtime</span><span id="ast-54" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-55" class="other_trans">receiptsdir_modtime</span>)</span>:<span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-57">True</span></span></span><span id="ast-58"><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiptlist</span>&nbsp;=&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62">os</span>.listdir</span>(<span id="ast-63">receiptsdir</span>)</span></span><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-65">item</span>&nbsp;in&nbsp;<span id="ast-66">receiptlist</span>:<span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70" class="other_trans">item</span>.endswith</span>(<span id="ast-71">'.pkg'</span>)</span>:<span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pkgpath</span>&nbsp;=&nbsp;<span id="ast-74"><span id="ast-75"><span id="ast-76"><span id="ast-77">os</span>.path</span>.join</span>(<span id="ast-78" class="other_trans">receiptsdir</span>,&nbsp;<span id="ast-79" class="other_trans">item</span>)</span></span><span id="ast-80"><span id="ast-81" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pkg_modtime</span>&nbsp;=&nbsp;<span id="ast-82"><span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans">os</span>.stat</span>(<span id="ast-86">pkgpath</span>)</span>.st_mtime</span></span><span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-88">(<span id="ast-89">packagedb_modtime</span><span id="ast-90" class="incorrect_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-91" class="other_trans">pkg_modtime</span>)</span>:<span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-93">True</span></span></span></span></span></span><span id="ast-94"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-95"><span id="ast-96"><span id="ast-97"><span id="ast-98">os</span>.path</span>.exists</span>(<span id="ast-99" class="other_trans">bomsdir</span>)</span>:<span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bomsdir_modtime</span>&nbsp;=&nbsp;<span id="ast-102"><span id="ast-103"><span id="ast-104"><span id="ast-105" class="other_trans">os</span>.stat</span>(<span id="ast-106">bomsdir</span>)</span>.st_mtime</span></span><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-108">(<span id="ast-109">packagedb_modtime</span><span id="ast-110" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-111">bomsdir_modtime</span>)</span>:<span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-113">True</span></span></span><span id="ast-114"><span id="ast-115" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bomlist</span>&nbsp;=&nbsp;<span id="ast-116"><span id="ast-117"><span id="ast-118" class="other_trans">os</span>.listdir</span>(<span id="ast-119" class="other_trans">bomsdir</span>)</span></span><span id="ast-120"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-121" class="other_trans">item</span>&nbsp;in&nbsp;<span id="ast-122">bomlist</span>:<span id="ast-123"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-124"><span id="ast-125"><span id="ast-126" class="other_trans">item</span>.endswith</span>(<span id="ast-127">'.bom'</span>)</span>:<span id="ast-128"><span id="ast-129" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bompath</span>&nbsp;=&nbsp;<span id="ast-130"><span id="ast-131"><span id="ast-132"><span id="ast-133">os</span>.path</span>.join</span>(<span id="ast-134">bomsdir</span>,&nbsp;<span id="ast-135" class="other_trans">item</span>)</span></span><span id="ast-136"><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bom_modtime</span>&nbsp;=&nbsp;<span id="ast-138"><span id="ast-139"><span id="ast-140"><span id="ast-141">os</span>.stat</span>(<span id="ast-142" class="other_trans">bompath</span>)</span>.st_mtime</span></span><span id="ast-143"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-144">(<span id="ast-145">packagedb_modtime</span><span id="ast-146" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-147">bom_modtime</span>)</span>:<span id="ast-148"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-149">True</span></span></span></span></span></span><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-151"><span id="ast-152"><span id="ast-153"><span id="ast-154" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-155" class="other_trans">sl_receiptsdir</span>)</span>:<span id="ast-156"><span id="ast-157"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiptsdir_modtime</span>&nbsp;=&nbsp;<span id="ast-158"><span id="ast-159"><span id="ast-160"><span id="ast-161">os</span>.stat</span>(<span id="ast-162" class="other_trans">sl_receiptsdir</span>)</span>.st_mtime</span></span><span id="ast-163"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-164">(<span id="ast-165">packagedb_modtime</span><span id="ast-166" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-167" class="other_trans">receiptsdir_modtime</span>)</span>:<span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-169">True</span></span></span><span id="ast-170"><span id="ast-171" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>receiptlist</span>&nbsp;=&nbsp;<span id="ast-172"><span id="ast-173"><span id="ast-174">os</span>.listdir</span>(<span id="ast-175">sl_receiptsdir</span>)</span></span><span id="ast-176"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-177" class="other_trans">item</span>&nbsp;in&nbsp;<span id="ast-178" class="other_trans">receiptlist</span>:<span id="ast-179"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-180">(<span id="ast-182"><span id="ast-183"><span id="ast-184">item</span>.endswith</span>(<span id="ast-185">'.bom'</span>)</span>&nbsp;or&nbsp;<span id="ast-186"><span id="ast-187"><span id="ast-188" class="other_trans">item</span>.endswith</span>(<span id="ast-189">'.plist'</span>)</span>)</span>:<span id="ast-190"><span id="ast-191" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pkgpath</span>&nbsp;=&nbsp;<span id="ast-192"><span id="ast-193"><span id="ast-194"><span id="ast-195">os</span>.path</span>.join</span>(<span id="ast-196" class="ref_node">receiptsdir&nbsp;&rarr;&nbsp;sl_receiptsdir&nbsp;</span>,&nbsp;<span id="ast-197">item</span>)</span></span><span id="ast-198"><span id="ast-199"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pkg_modtime</span>&nbsp;=&nbsp;<span id="ast-200"><span id="ast-201"><span id="ast-202"><span id="ast-203" class="other_trans">os</span>.stat</span>(<span id="ast-204" class="other_trans">pkgpath</span>)</span>.st_mtime</span></span><span id="ast-205"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-206">(<span id="ast-207">packagedb_modtime</span><span id="ast-208" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-209">pkg_modtime</span>)</span>:<span id="ast-210"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-211">True</span></span></span></span></span></span><span id="ast-212"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-213"><span id="ast-214"><span id="ast-215"><span id="ast-216">os</span>.path</span>.exists</span>(<span id="ast-217" class="other_trans">installhistory</span>)</span>:<span id="ast-218"><span id="ast-219"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>installhistory_modtime</span>&nbsp;=&nbsp;<span id="ast-220"><span id="ast-221"><span id="ast-222"><span id="ast-223">os</span>.stat</span>(<span id="ast-224" class="other_trans">installhistory</span>)</span>.st_mtime</span></span><span id="ast-225"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-226">(<span id="ast-227">packagedb_modtime</span><span id="ast-228" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-229" class="other_trans">installhistory_modtime</span>)</span>:<span id="ast-230"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-231">True</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;copy_and_tag(<span id="ast-2"><span id="ast-3" class="other_trans">variable</span>,&nbsp;<span id="ast-4" class="other_trans">role</span>,&nbsp;<span id="ast-5" class="other_trans">name</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Helper&nbsp;method&nbsp;to&nbsp;copy&nbsp;a&nbsp;variable&nbsp;and&nbsp;annotate&nbsp;it.'</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>copy</span>&nbsp;=&nbsp;<span id="ast-10"><span id="ast-11"><span id="ast-12" class="other_trans">variable</span>.copy</span>()</span></span><span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>copy</span>.name</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17"><span id="ast-18">'{}_{}_{}'</span>.format</span>(<span id="ast-19"><span id="ast-20" class="other_trans">brick</span>.name</span>,&nbsp;<span id="ast-21"><span id="ast-22">self</span>.name</span>,&nbsp;<span id="ast-23" class="other_trans">name</span>)</span></span><span id="ast-24"><span id="ast-25" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>annotations</span>&nbsp;=&nbsp;<span id="ast-26">(<span id="ast-27"><span id="ast-28" class="other_trans">getattr</span>(<span id="ast-29"><span id="ast-30" class="other_trans">copy</span>.tag</span>,&nbsp;<span id="ast-31">'annotations'</span>,&nbsp;<span id="ast-32">[]</span>)</span>&nbsp;+&nbsp;<span id="ast-34">[<span id="ast-35" class="other_trans">brick</span>,&nbsp;<span id="ast-36" class="other_trans">call</span>]</span>)</span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>copy</span>.tag</span>.annotations</span>&nbsp;=&nbsp;<span id="ast-41" class="other_trans">annotations</span></span><span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>copy</span>.tag</span>.name</span>&nbsp;=&nbsp;<span id="ast-46" class="other_trans">name</span></span><span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>VariableRole</span>.add_role</span>(<span id="ast-51" class="correct_node">variable&nbsp;&rarr;&nbsp;copy&nbsp;</span>,&nbsp;<span id="ast-52" class="other_trans">role</span>)</span></span><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-54" class="other_trans">copy</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;download(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">engine</span></span>):<span id="ast-6"><span id="ast-7"><span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>DbTk</span>.download</span>(<span id="ast-10">self</span>,&nbsp;<span id="ast-11">engine</span>)</span></span><span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.engine</span>.download_file</span>(<span id="ast-17"><span id="ast-18">self</span>.url</span>,&nbsp;<span id="ast-19">'all_Excel.zip'</span>)</span></span><span id="ast-20"><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>local_zip</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23"><span id="ast-24">zipfile</span>.ZipFile</span>(<span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28">self</span>.engine</span>.format_filename</span>(<span id="ast-29">'all_Excel.zip'</span>)</span>)</span></span><span id="ast-30"><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filelist</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans">local_zip</span>.namelist</span>()</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>local_zip</span>.close</span>()</span></span><span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.engine</span>.download_files_from_archive</span>(<span id="ast-44" class="ref_node">url&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-45">filelist</span>)</span></span><span id="ast-46"><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>filelist</span>&nbsp;=&nbsp;<span id="ast-48">[<span id="ast-49"><span id="ast-50"><span id="ast-51"><span id="ast-52">os</span>.path</span>.basename</span>(<span id="ast-53" class="other_trans">filename</span>)</span><span id="ast-54">&nbsp;for&nbsp;<span id="ast-55" class="other_trans">filename</span>&nbsp;in&nbsp;<span id="ast-56">filelist</span></span>]</span></span><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>lines</span>&nbsp;=&nbsp;<span id="ast-59">[]</span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-61" class="other_trans">filename</span>&nbsp;in&nbsp;<span id="ast-62">filelist</span>:<span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-64">(<span id="ast-65">(<span id="ast-66">'Extracting&nbsp;data&nbsp;from&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-68">filename</span>)</span>&nbsp;+&nbsp;<span id="ast-70">'&nbsp;.&nbsp;.&nbsp;.'</span>)</span></span><span id="ast-71"><span id="ast-72" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>book</span>&nbsp;=&nbsp;<span id="ast-73"><span id="ast-74"><span id="ast-75">xlrd</span>.open_workbook</span>(<span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79">self</span>.engine</span>.format_filename</span>(<span id="ast-80" class="other_trans">filename</span>)</span>)</span></span><span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sh</span>&nbsp;=&nbsp;<span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans">book</span>.sheet_by_index</span>(<span id="ast-86">0</span>)</span></span><span id="ast-87"><span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rows</span>&nbsp;=&nbsp;<span id="ast-89"><span id="ast-90">sh</span>.nrows</span></span><span id="ast-91"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-92" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-93"><span id="ast-94">range</span>(<span id="ast-95">1</span>,&nbsp;<span id="ast-96">rows</span>)</span>:<span id="ast-97"><span id="ast-98"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>thisline</span>&nbsp;=&nbsp;<span id="ast-99">[]</span></span><span id="ast-100"><span id="ast-101" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>row</span>&nbsp;=&nbsp;<span id="ast-102"><span id="ast-103"><span id="ast-104">sh</span>.row</span>(<span id="ast-105">i</span>)</span></span><span id="ast-106"><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>n</span>&nbsp;=&nbsp;<span id="ast-108">0</span></span><span id="ast-109"><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cellcount</span>&nbsp;=&nbsp;<span id="ast-111">0</span></span><span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-113" class="other_trans">cell</span>&nbsp;in&nbsp;<span id="ast-114" class="incorrect_node">row&nbsp;&rarr;&nbsp;filelist&nbsp;</span>:<span id="ast-115"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-116">(<span id="ast-117">not</span>&nbsp;<span id="ast-118"><span id="ast-119"><span id="ast-120" class="other_trans">Excel</span>.empty_cell</span>(<span id="ast-121" class="other_trans">cell</span>)</span>)</span>:<span id="ast-122"><span id="ast-123"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cellcount</span>&nbsp;+=&nbsp;<span id="ast-125">1</span></span></span></span><span id="ast-126"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-127">(<span id="ast-129">(<span id="ast-130" class="other_trans">cellcount</span><span id="ast-131" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-132">4</span>)</span>&nbsp;and&nbsp;<span id="ast-133">(<span id="ast-134">not</span>&nbsp;<span id="ast-135"><span id="ast-136"><span id="ast-137">Excel</span>.empty_cell</span>(<span id="ast-138"><span id="ast-139" class="other_trans">row</span>[<span id="ast-140"><span id="ast-141">0</span></span>]</span>)</span>)</span>)</span>:<span id="ast-142"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-143"><span id="ast-144"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>a</span>&nbsp;=&nbsp;<span id="ast-145"><span id="ast-146">int</span>(<span id="ast-147"><span id="ast-148"><span id="ast-149"><span id="ast-150"><span id="ast-151"><span id="ast-152">Excel</span>.cell_value</span>(<span id="ast-153"><span id="ast-154" class="other_trans">row</span>[<span id="ast-155"><span id="ast-156">0</span></span>]</span>)</span>.split</span>(<span id="ast-157">'.'</span>)</span>[<span id="ast-158"><span id="ast-159">0</span></span>]</span>)</span></span><span id="ast-160"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-161">cell</span>&nbsp;in&nbsp;<span id="ast-162">row</span>:<span id="ast-163"><span id="ast-164"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>n</span>&nbsp;+=&nbsp;<span id="ast-166">1</span></span><span id="ast-167"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-168">(<span id="ast-170">(<span id="ast-171">n</span><span id="ast-172" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-173">5</span>)</span>&nbsp;or&nbsp;<span id="ast-174">(<span id="ast-175" class="other_trans">n</span><span id="ast-176" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-177">12</span>)</span>)</span>:<span id="ast-178"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-179">(<span id="ast-181">(<span id="ast-182">not</span>&nbsp;<span id="ast-183"><span id="ast-184"><span id="ast-185">Excel</span>.empty_cell</span>(<span id="ast-186">cell</span>)</span>)</span>&nbsp;or&nbsp;<span id="ast-187">(<span id="ast-188" class="other_trans">n</span><span id="ast-189" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-190">13</span>)</span>)</span>:<span id="ast-191"><span id="ast-192"><span id="ast-193"><span id="ast-194"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>thisline</span>.append</span>(<span id="ast-195"><span id="ast-196"><span id="ast-197" class="other_trans">Excel</span>.cell_value</span>(<span id="ast-198">cell</span>)</span>)</span></span></span></span></span><span id="ast-199"><span id="ast-200"><span id="ast-201"><span id="ast-202" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lines</span>.append</span>(<span id="ast-203">[<span id="ast-204"><span id="ast-205"><span id="ast-206"><span id="ast-207"><span id="ast-208"><span id="ast-209">str</span>(<span id="ast-210">value</span>)</span>.title</span>()</span>.replace</span>(<span id="ast-211">'\\\\'</span>,&nbsp;<span id="ast-212">'/'</span>)</span><span id="ast-213">&nbsp;for&nbsp;<span id="ast-214">value</span>&nbsp;in&nbsp;<span id="ast-215">thisline</span></span>]</span>)</span></span><span id="ast-216"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except:<span id="ast-217"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pass</span></span></span></span></span></span><span id="ast-218"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-219">(<span id="ast-220">'Lines:&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-222"><span id="ast-223" class="other_trans">str</span>(<span id="ast-224"><span id="ast-225">len</span>(<span id="ast-226" class="other_trans">lines</span>)</span>)</span>)</span></span><span id="ast-227"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-228">'Generating&nbsp;taxonomic&nbsp;groups&nbsp;.&nbsp;.&nbsp;.'</span></span><span id="ast-229"><span id="ast-230"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tax</span>&nbsp;=&nbsp;<span id="ast-231">[]</span></span><span id="ast-232"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-233" class="other_trans">line</span>&nbsp;in&nbsp;<span id="ast-234">lines</span>:<span id="ast-235"><span id="ast-236"><span id="ast-237"><span id="ast-238"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tax</span>.append</span>(<span id="ast-239">[<span id="ast-240"><span id="ast-241" class="other_trans">line</span>[<span id="ast-242"><span id="ast-243">1</span></span>]</span>,&nbsp;<span id="ast-244"><span id="ast-245" class="other_trans">line</span>[<span id="ast-246"><span id="ast-247">2</span></span>]</span>,&nbsp;<span id="ast-248"><span id="ast-249" class="other_trans">line</span>[<span id="ast-250"><span id="ast-251">3</span></span>]</span>]</span>)</span></span></span><span id="ast-252"><span id="ast-253"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>families</span>&nbsp;=&nbsp;<span id="ast-254"><span id="ast-255" class="other_trans">dict</span>()</span></span><span id="ast-256"><span id="ast-257"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>genera</span>&nbsp;=&nbsp;<span id="ast-258"><span id="ast-259">dict</span>()</span></span><span id="ast-260"><span id="ast-261" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>species</span>&nbsp;=&nbsp;<span id="ast-262"><span id="ast-263" class="other_trans">dict</span>()</span></span><span id="ast-264"><span id="ast-265"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>familycount</span>&nbsp;=&nbsp;<span id="ast-266">0</span></span><span id="ast-267"><span id="ast-268"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>genuscount</span>&nbsp;=&nbsp;<span id="ast-269">0</span></span><span id="ast-270"><span id="ast-271"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>speciescount</span>&nbsp;=&nbsp;<span id="ast-272">0</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;set_scf_initial_guess(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">guess</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-9">(<span id="ast-10">'scf_guess'</span><span id="ast-11">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15">self</span>.fix_step</span>.params</span>[<span id="ast-16"><span id="ast-17">'rem'</span></span>]</span>)</span>&nbsp;or&nbsp;<span id="ast-18">(<span id="ast-19"><span id="ast-20">self</span>.error_step_id</span><span id="ast-21" class="ref_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-22">0</span>)</span>&nbsp;or&nbsp;<span id="ast-23">(<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28">self</span>.fix_step</span>.params</span>[<span id="ast-29"><span id="ast-30">'rem'</span></span>]</span>[<span id="ast-31"><span id="ast-32">'scf_guess'</span></span>]</span><span id="ast-33" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-34">'read'</span>)</span>)</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.fix_step</span>.set_scf_initial_guess</span>(<span id="ast-40" class="other_trans">guess</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_translation(<span id="ast-2"><span id="ast-3" class="other_trans">cls</span>,&nbsp;<span id="ast-4">language_code</span>,&nbsp;<span id="ast-5" class="other_trans">create_if_necessary</span>,&nbsp;<span id="ast-7">fallback</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;a&nbsp;translation&nbsp;instance&nbsp;for&nbsp;the&nbsp;given&nbsp;`language_id_or_code`.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;translation&nbsp;does&nbsp;not&nbsp;exist:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;if&nbsp;`create_if_necessary`&nbsp;is&nbsp;True,&nbsp;this&nbsp;function&nbsp;will&nbsp;create&nbsp;one\\u000a&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;otherwise,&nbsp;if&nbsp;`fallback`&nbsp;is&nbsp;True,&nbsp;this&nbsp;function&nbsp;will&nbsp;search&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;of&nbsp;languages&nbsp;looking&nbsp;for&nbsp;the&nbsp;first&nbsp;existing&nbsp;translation\\u000a&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;if&nbsp;all&nbsp;of&nbsp;the&nbsp;above&nbsp;fails&nbsp;to&nbsp;find&nbsp;a&nbsp;translation,&nbsp;raise&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;TranslationDoesNotExist&nbsp;exception\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>fallback</span>&nbsp;=&nbsp;<span id="ast-13">True</span></span><span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cls</span>.fill_translation_cache</span>()</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-20" class="other_trans">language_code</span><span id="ast-21" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-22" class="other_trans">None</span>)</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>language_code</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26" class="other_trans">getattr</span>(<span id="ast-27" class="other_trans">cls</span>,&nbsp;<span id="ast-28">'_default_language'</span>,&nbsp;<span id="ast-29">None</span>)</span></span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-31">(<span id="ast-32" class="other_trans">language_code</span><span id="ast-33" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-34">None</span>)</span>:<span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>language_code</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38">get_default_language</span>()</span></span></span><span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>force_language</span>&nbsp;=&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans">cls</span>._meta</span>.force_language</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-46" class="other_trans">force_language</span><span id="ast-47" class="incorrect_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-48">None</span>)</span>:<span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>language_code</span>&nbsp;=&nbsp;<span id="ast-51">force_language</span></span></span><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-53">(<span id="ast-54">language_code</span><span id="ast-55">&nbsp;in&nbsp;</span><span id="ast-56"><span id="ast-57" class="other_trans">cls</span>._translation_cache</span>)</span>:<span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-59"><span id="ast-60"><span id="ast-61"><span id="ast-62" class="other_trans">cls</span>._translation_cache</span>.get</span>(<span id="ast-63">language_code</span>,&nbsp;<span id="ast-64">None</span>)</span></span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66" class="other_trans">create_if_necessary</span>:<span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_translation</span>&nbsp;=&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans">cls</span>._meta</span>.translation_model</span>(master=<span id="ast-74" class="other_trans">cls</span>,&nbsp;language_code=<span id="ast-76">language_code</span>)</span></span><span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cls</span>._translation_cache</span>[<span id="ast-81"><span id="ast-82" class="other_trans">language_code</span></span>]</span>&nbsp;=&nbsp;<span id="ast-83" class="other_trans">new_translation</span></span><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-85" class="other_trans">new_translation</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-87">(<span id="ast-88">force_language</span><span id="ast-89" class="ref_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-90" class="other_trans">None</span>)</span>:<span id="ast-91"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-92" class="other_trans">fb_lang_code</span>&nbsp;in&nbsp;<span id="ast-93"><span id="ast-94" class="other_trans">get_fallbacks</span>(<span id="ast-95" class="other_trans">language_code</span>)</span>:<span id="ast-96"><span id="ast-97" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>trans</span>&nbsp;=&nbsp;<span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101" class="other_trans">cls</span>._translation_cache</span>.get</span>(<span id="ast-102" class="other_trans">fb_lang_code</span>,&nbsp;<span id="ast-103">None</span>)</span></span><span id="ast-104"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-105" class="other_trans">trans</span>:<span id="ast-106"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-107" class="other_trans">trans</span></span></span></span></span><span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-109"><span id="ast-110">TranslationDoesNotExist</span>(<span id="ast-111" class="other_trans">language_code</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;run_request_campaign(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">campaignID</span>,&nbsp;<span id="ast-5" class="other_trans">leadsID</span>,&nbsp;<span id="ast-6" class="other_trans">values</span></span>):<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>token_list</span>&nbsp;=&nbsp;<span id="ast-9">[<span id="ast-10">{<span id="ast-11">'name'</span>:&nbsp;<span id="ast-13">(<span id="ast-14">(<span id="ast-15">'{{'</span>&nbsp;+&nbsp;<span id="ast-17" class="other_trans">k</span>)</span>&nbsp;+&nbsp;<span id="ast-19">'}}'</span>)</span>,&nbsp;<span id="ast-12">'value'</span>:&nbsp;<span id="ast-20" class="other_trans">v</span>}</span><span id="ast-21">&nbsp;for&nbsp;<span id="ast-22">(<span id="ast-23" class="other_trans">k</span>,&nbsp;<span id="ast-24" class="other_trans">v</span>)</span>&nbsp;in&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27" class="other_trans">values</span>.items</span>()</span></span>]</span></span><span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>leads_list</span>&nbsp;=&nbsp;<span id="ast-30">[<span id="ast-31">{<span id="ast-32">'id'</span>:&nbsp;<span id="ast-33" class="other_trans">items</span>}</span><span id="ast-34">&nbsp;for&nbsp;<span id="ast-35" class="other_trans">items</span>&nbsp;in&nbsp;<span id="ast-36" class="other_trans">leadsID</span></span>]</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-39">{<span id="ast-40">'input'</span>:&nbsp;<span id="ast-41">{<span id="ast-42">'leads'</span>:&nbsp;<span id="ast-44" class="other_trans">leads_list</span>,&nbsp;<span id="ast-43">'tokens'</span>:&nbsp;<span id="ast-45" class="other_trans">token_list</span>}</span>}</span></span><span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.authenticate</span>()</span></span><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>args</span>&nbsp;=&nbsp;<span id="ast-52">{<span id="ast-53">'access_token'</span>:&nbsp;<span id="ast-54"><span id="ast-55">self</span>.token</span>}</span></span><span id="ast-56"><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>x</span>&nbsp;=&nbsp;<span id="ast-58">(<span id="ast-59">(<span id="ast-60">(<span id="ast-61">(<span id="ast-62">'https://'</span>&nbsp;+&nbsp;<span id="ast-64"><span id="ast-65">self</span>.host</span>)</span>&nbsp;+&nbsp;<span id="ast-67">'/rest/v1/campaigns/'</span>)</span>&nbsp;+&nbsp;<span id="ast-69"><span id="ast-70">str</span>(<span id="ast-71" class="other_trans">campaignID</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-73">'/trigger.json'</span>)</span></span><span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>&nbsp;=&nbsp;<span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79">HttpLib</span>()</span>.post</span>(<span id="ast-80">(<span id="ast-81">(<span id="ast-82">(<span id="ast-83">(<span id="ast-84">'https://'</span>&nbsp;+&nbsp;<span id="ast-86"><span id="ast-87">self</span>.host</span>)</span>&nbsp;+&nbsp;<span id="ast-89">'/rest/v1/campaigns/'</span>)</span>&nbsp;+&nbsp;<span id="ast-91"><span id="ast-92" class="other_trans">str</span>(<span id="ast-93" class="other_trans">campaignID</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-95">'/trigger.json'</span>)</span>,&nbsp;<span id="ast-96" class="other_trans">args</span>,&nbsp;<span id="ast-97" class="other_trans">data</span>)</span></span><span id="ast-98"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-99">(<span id="ast-100">not</span>&nbsp;<span id="ast-101"><span id="ast-102" class="other_trans">result</span>[<span id="ast-103"><span id="ast-104">'success'</span></span>]</span>)</span>:<span id="ast-105"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-106"><span id="ast-107">MarketoException</span>(<span id="ast-108"><span id="ast-109"><span id="ast-110" class="correct_node">data&nbsp;&rarr;&nbsp;result&nbsp;</span>[<span id="ast-111"><span id="ast-112">'errors'</span></span>]</span>[<span id="ast-113"><span id="ast-114">0</span></span>]</span>)</span></span></span><span id="ast-115"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-116"><span id="ast-117" class="other_trans">result</span>[<span id="ast-118"><span id="ast-119">'success'</span></span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;post(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">request</span>,&nbsp;*args,&nbsp;**kwargs</span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9">kwargs</span>.get</span>(<span id="ast-10">'name'</span>,&nbsp;<span id="ast-11" class="other_trans">None</span>)</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13">(<span id="ast-14"><span id="ast-15" class="other_trans">request</span>.content_type</span><span id="ast-16" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-17">'application/json'</span>)</span>:<span id="ast-18"><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>payload</span>&nbsp;=&nbsp;<span id="ast-20"><span id="ast-21">request</span>.DATA</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>payload</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">json</span>.loads</span>(<span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30" class="other_trans">request</span>.DATA</span>.get</span>(<span id="ast-31">'payload'</span>,&nbsp;<span id="ast-32">'{}'</span>)</span>)</span></span></span><span id="ast-33"><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>info</span>&nbsp;=&nbsp;<span id="ast-35"><span id="ast-36"><span id="ast-37">payload</span>.get</span>(<span id="ast-38">'repository'</span>,&nbsp;<span id="ast-39">{}</span>)</span></span><span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>repo</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44" class="incorrect_node">info&nbsp;&rarr;&nbsp;payload&nbsp;</span>.get</span>(<span id="ast-45">'name'</span>,&nbsp;<span id="ast-46">None</span>)</span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50"><span id="ast-51" class="other_trans">info</span>.get</span>(<span id="ast-52">'owner'</span>,&nbsp;<span id="ast-53">{}</span>)</span></span><span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">isinstance</span>(<span id="ast-57">user</span>,&nbsp;<span id="ast-58">dict</span>)</span>:<span id="ast-59"><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>user</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">user</span>.get</span>(<span id="ast-64">'name'</span>,&nbsp;<span id="ast-65" class="other_trans">None</span>)</span></span></span><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-67">(<span id="ast-69">(<span id="ast-70">not</span>&nbsp;<span id="ast-71" class="other_trans">name</span>)</span>&nbsp;and&nbsp;<span id="ast-72">(<span id="ast-73">not</span>&nbsp;<span id="ast-74">repo</span>)</span>&nbsp;and&nbsp;<span id="ast-75">(<span id="ast-76">not</span>&nbsp;<span id="ast-77" class="other_trans">user</span>)</span>)</span>:<span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-79"><span id="ast-80">ParseError</span>(<span id="ast-81">'No&nbsp;JSON&nbsp;data&nbsp;or&nbsp;URL&nbsp;argument&nbsp;:&nbsp;cannot&nbsp;identify&nbsp;hook'</span>)</span></span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook</span>&nbsp;=&nbsp;<span id="ast-85" class="other_trans">None</span></span><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-87" class="other_trans">name</span>:<span id="ast-88"><span id="ast-89" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook</span>&nbsp;=&nbsp;<span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93">Hook</span>.objects</span>.get</span>(name=<span id="ast-95" class="other_trans">name</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-97">(<span id="ast-99" class="other_trans">repo</span>&nbsp;and&nbsp;<span id="ast-100">user</span>)</span>:<span id="ast-101"><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook</span>&nbsp;=&nbsp;<span id="ast-103"><span id="ast-104"><span id="ast-105"><span id="ast-106">Hook</span>.objects</span>.get</span>(user=<span id="ast-108" class="other_trans">user</span>,&nbsp;repo=<span id="ast-110">repo</span>)</span></span></span><span id="ast-111"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-112">hook</span>:<span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-114">(<span id="ast-115" class="other_trans">hook</span><span id="ast-116" class="ref_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-117">'send-signal'</span>)</span>:<span id="ast-118"><span id="ast-119"><span id="ast-120"><span id="ast-121" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook</span>.execute</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-122"><span id="ast-123"><span id="ast-124"><span id="ast-125" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook_signal</span>.send</span>(<span id="ast-126">HookView</span>,&nbsp;hook=<span id="ast-128">hook</span>,&nbsp;info=<span id="ast-130">info</span>,&nbsp;repo=<span id="ast-132" class="other_trans">repo</span>,&nbsp;user=<span id="ast-134" class="other_trans">user</span>,&nbsp;request=<span id="ast-136">request</span>)</span></span></span></span><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-138"><span id="ast-139" class="other_trans">Hook</span>.DoesNotExist</span>:<span id="ast-140"><span id="ast-141"><span id="ast-142"><span id="ast-143" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>hook_signal</span>.send</span>(<span id="ast-144">HookView</span>,&nbsp;request=<span id="ast-146" class="other_trans">request</span>)</span></span><span id="ast-147"><span id="ast-148"><span id="ast-149"><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.debug</span>(<span id="ast-151"><span id="ast-152"><span id="ast-153">'Signal&nbsp;{}&nbsp;sent'</span>.format</span>(<span id="ast-154">hook_signal</span>)</span>)</span></span></span></span><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-156"><span id="ast-157" class="other_trans">Response</span>(<span id="ast-158">{}</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">cfg</span></span>):<span id="ast-5"><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.debug</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">cfg</span>.debug</span></span><span id="ast-10"><span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ip</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">cfg</span>.graphite_ip</span></span><span id="ast-15"><span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.port</span>&nbsp;=&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">cfg</span>.graphite_port</span></span><span id="ast-20"><span id="ast-21"><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.max_reconnects</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24" class="other_trans">cfg</span>.graphite_max_reconnects</span></span><span id="ast-25"><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.reconnect_delay</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">cfg</span>.graphite_reconnect_delay</span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-31">(<span id="ast-32"><span id="ast-33">self</span>.max_reconnects</span><span id="ast-34" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-35">0</span>)</span>:<span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.max_reconnects</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40" class="other_trans">sys</span>.maxint</span></span></span><span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.connect</span>()</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">source</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;source&nbsp;can&nbsp;be:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;vim&nbsp;buffer\\u000a&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;file&nbsp;object\\u000a&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;list&nbsp;of&nbsp;strings,&nbsp;one&nbsp;per&nbsp;line\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>nchars</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10">int</span>(<span id="ast-11"><span id="ast-12"><span id="ast-13">vim</span>.eval</span>(<span id="ast-14">'g:pad#read_nchars_from_files'</span>)</span>)</span></span><span id="ast-15"><span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.summary</span>&nbsp;=&nbsp;<span id="ast-18">''</span></span><span id="ast-19"><span id="ast-20"><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.body</span>&nbsp;=&nbsp;<span id="ast-22">''</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.isEmpty</span>&nbsp;=&nbsp;<span id="ast-26">True</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.folder</span>&nbsp;=&nbsp;<span id="ast-30">''</span></span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.id</span>&nbsp;=&nbsp;<span id="ast-34"><span id="ast-35">timestamp</span>()</span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-37">(<span id="ast-38" class="other_trans">source</span><span id="ast-39" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-40"><span id="ast-41"><span id="ast-42">vim</span>.current</span>.buffer</span>)</span>:<span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>source</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">source</span>[<span id="ast-47">:<span id="ast-48">10</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-50"><span id="ast-51" class="other_trans">isfileobject</span>(<span id="ast-52" class="other_trans">source</span>)</span>:<span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>save_dir</span>&nbsp;=&nbsp;<span id="ast-55"><span id="ast-56">get_save_dir</span>()</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-58"><span id="ast-59"><span id="ast-60"><span id="ast-61" class="other_trans">abspath</span>(<span id="ast-62"><span id="ast-63" class="other_trans">source</span>.name</span>)</span>.startswith</span>(<span id="ast-64">save_dir</span>)</span>:<span id="ast-65"><span id="ast-66" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-67">(<span id="ast-68"><span id="ast-69" class="other_trans">len</span>(<span id="ast-70"><span id="ast-71">get_save_dir</span>()</span>)</span>,&nbsp;<span id="ast-72"><span id="ast-73">len</span>(<span id="ast-74"><span id="ast-75" class="other_trans">basename</span>(<span id="ast-76"><span id="ast-77" class="other_trans">source</span>.name</span>)</span>)</span>)</span></span><span id="ast-78"><span id="ast-79"><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.folder</span>&nbsp;=&nbsp;<span id="ast-81"><span id="ast-82"><span id="ast-83" class="other_trans">abspath</span>(<span id="ast-84"><span id="ast-85" class="other_trans">source</span>.name</span>)</span>[<span id="ast-86"><span id="ast-87"><span id="ast-88">pos</span>[<span id="ast-89"><span id="ast-90">0</span></span>]</span>:<span id="ast-91">(<span id="ast-92">-</span><span id="ast-93"><span id="ast-94" class="other_trans">pos</span>[<span id="ast-95"><span id="ast-96">1</span></span>]</span>)</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-97"><span id="ast-98"><span id="ast-99"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.folder</span>&nbsp;=&nbsp;<span id="ast-100"><span id="ast-101">dirname</span>(<span id="ast-102"><span id="ast-103">relpath</span>(<span id="ast-104"><span id="ast-105" class="other_trans">source</span>.name</span>,&nbsp;<span id="ast-106"><span id="ast-107"><span id="ast-108" class="other_trans">vim</span>.eval</span>(<span id="ast-109">'getcwd()'</span>)</span>)</span>)</span></span></span><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-111">(<span id="ast-112"><span id="ast-113"><span id="ast-114">vim</span>.eval</span>(<span id="ast-115">'g:pad#title_first_line'</span>)</span><span id="ast-116" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-117">'1'</span>)</span>:<span id="ast-118"><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>source</span>&nbsp;=&nbsp;<span id="ast-120"><span id="ast-121"><span id="ast-122"><span id="ast-123"><span id="ast-124" class="other_trans">source</span>.readline</span>()</span>.split</span>(<span id="ast-125">'\\u000a'</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-126"><span id="ast-127" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>source</span>&nbsp;=&nbsp;<span id="ast-128"><span id="ast-129"><span id="ast-130"><span id="ast-131"><span id="ast-132">source</span>.read</span>(<span id="ast-133">nchars</span>)</span>.split</span>(<span id="ast-134">'\\u000a'</span>)</span></span></span></span><span id="ast-135"><span id="ast-136" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-137">[<span id="ast-138"><span id="ast-139"><span id="ast-140" class="other_trans">line</span>.strip</span>()</span><span id="ast-141">&nbsp;for&nbsp;<span id="ast-142">line</span>&nbsp;in&nbsp;<span id="ast-143">source</span>&nbsp;if&nbsp;<span id="ast-144">(<span id="ast-145" class="other_trans">line</span><span id="ast-146" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-147">''</span>)</span></span>]</span></span><span id="ast-148"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-149">(<span id="ast-150" class="other_trans">data</span><span id="ast-151" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-152">[]</span>)</span>:<span id="ast-153"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-154"><span id="ast-155"><span id="ast-156" class="other_trans">re</span>.match</span>(<span id="ast-157">'^.*&nbsp;vim:&nbsp;set&nbsp;.*:.*$'</span>,&nbsp;<span id="ast-158"><span id="ast-159">data</span>[<span id="ast-160"><span id="ast-161">0</span></span>]</span>)</span>:<span id="ast-162"><span id="ast-163" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>data</span>&nbsp;=&nbsp;<span id="ast-164"><span id="ast-165">data</span>[<span id="ast-166"><span id="ast-167">1</span>:</span>]</span></span></span><span id="ast-168"><span id="ast-169"><span id="ast-170"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.summary</span>&nbsp;=&nbsp;<span id="ast-171"><span id="ast-172"><span id="ast-173"><span id="ast-174" class="other_trans">data</span>[<span id="ast-175"><span id="ast-176">0</span></span>]</span>.strip</span>()</span></span><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-178">(<span id="ast-179"><span id="ast-180">len</span>(<span id="ast-181" class="ref_node">summary&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span><span id="ast-182" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-183">0</span>)</span>:<span id="ast-184"><span id="ast-185" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>org_tags_data&nbsp;&rarr;&nbsp;self.&nbsp;</span>&nbsp;=&nbsp;<span id="ast-186"><span id="ast-187"><span id="ast-188" class="other_trans">re</span>.search</span>(<span id="ast-189">'\\\\s+(?P&lt;tags&gt;:.*$)'</span>,&nbsp;<span id="ast-190"><span id="ast-191">self</span>.summary</span>)</span></span><span id="ast-192"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-193" class="other_trans">org_tags_data</span>:<span id="ast-194"><span id="ast-195"><span id="ast-196"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.summary</span>&nbsp;=&nbsp;<span id="ast-197"><span id="ast-198"><span id="ast-199">re</span>.sub</span>(<span id="ast-200">'\\\\s+:.*$'</span>,&nbsp;<span id="ast-201">''</span>,&nbsp;<span id="ast-202"><span id="ast-203">self</span>.summary</span>)</span></span></span><span id="ast-204"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-205">(<span id="ast-206"><span id="ast-207"><span id="ast-208">self</span>.summary</span>[<span id="ast-209"><span id="ast-210">0</span></span>]</span><span id="ast-211">&nbsp;in&nbsp;</span><span id="ast-212">(<span id="ast-213">'%'</span>,&nbsp;<span id="ast-214">'#'</span>)</span>)</span>:<span id="ast-215"><span id="ast-216"><span id="ast-217"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.summary</span>&nbsp;=&nbsp;<span id="ast-218"><span id="ast-219"><span id="ast-220"><span id="ast-221">str</span>(<span id="ast-222"><span id="ast-223"><span id="ast-224">self</span>.summary</span>[<span id="ast-225"><span id="ast-226">1</span>:</span>]</span>)</span>.strip</span>()</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;update(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">instance</span>,&nbsp;<span id="ast-5" class="other_trans">validated_data</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>lcycle</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">DatasetLifeCycleManager</span>(<span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>.context</span>[<span id="ast-14"><span id="ast-15">'request'</span></span>]</span>.user</span>,&nbsp;dataset_id=<span id="ast-17"><span id="ast-18" class="other_trans">instance</span>[<span id="ast-19"><span id="ast-20">'dataset_id'</span></span>]</span>)</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-22">(<span id="ast-24">(<span id="ast-25">'file_data'</span><span id="ast-26">&nbsp;in&nbsp;</span><span id="ast-27" class="other_trans">validated_data</span>)</span>&nbsp;and&nbsp;<span id="ast-28">(<span id="ast-29"><span id="ast-30" class="other_trans">len</span>(<span id="ast-31" class="other_trans">validated_data</span>)</span><span id="ast-32" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-33">5</span>)</span>)</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-35"><span id="ast-36"><span id="ast-37">self</span>.getDao</span>(<span id="ast-38"><span id="ast-39"><span id="ast-40" class="other_trans">lcycle</span>.update_file</span>(**<span id="ast-41" class="other_trans">validated_data</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>instance</span>.update</span>(<span id="ast-46" class="other_trans">validated_data</span>)</span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-48">(<span id="ast-49">'impl_details'</span><span id="ast-50">&nbsp;in&nbsp;</span><span id="ast-51" class="other_trans">instance</span>)</span>:<span id="ast-52"><span id="ast-53"><span id="ast-54"><span id="ast-55" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>instance&nbsp;&rarr;&nbsp;validated_data&nbsp;</span>.pop</span>(<span id="ast-56">'impl_details'</span>)</span></span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-58"><span id="ast-59"><span id="ast-60">self</span>.getDao</span>(<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">lcycle</span>.edit</span>(changed_fields=<span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans">validated_data</span>.keys</span>()</span>,&nbsp;**<span id="ast-68" class="ref_node">validated_data&nbsp;&rarr;&nbsp;instance&nbsp;</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;inverse_gmseg_to_wmseg(<span id="ast-2"><span id="ast-3" class="other_trans">gm_seg</span>,&nbsp;<span id="ast-4" class="other_trans">original_im</span>,&nbsp;<span id="ast-5">name_gm_seg</span>,&nbsp;<span id="ast-7">save</span>,&nbsp;<span id="ast-9" class="other_trans">verbose</span></span>):<span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Inverse&nbsp;a&nbsp;gray&nbsp;matter&nbsp;segmentation&nbsp;array&nbsp;image&nbsp;to&nbsp;get&nbsp;a&nbsp;white&nbsp;matter&nbsp;segmentation&nbsp;image&nbsp;and&nbsp;save&nbsp;it\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;gm_seg:&nbsp;gray&nbsp;matter&nbsp;segmentation&nbsp;to&nbsp;inverse,&nbsp;type:&nbsp;Image&nbsp;or&nbsp;np.ndarray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;original_im:&nbsp;original&nbsp;image&nbsp;croped&nbsp;around&nbsp;the&nbsp;spinal&nbsp;cord,&nbsp;type:&nbsp;Image&nbsp;or&nbsp;np.ndarray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;name_gm_seg:&nbsp;name&nbsp;of&nbsp;the&nbsp;gray&nbsp;matter&nbsp;segmentation&nbsp;(to&nbsp;save&nbsp;the&nbsp;associated&nbsp;white&nbsp;matter&nbsp;segmentation),\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type:&nbsp;string\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return&nbsp;inverted_seg:&nbsp;white&nbsp;matter&nbsp;segmentation&nbsp;image,&nbsp;if&nbsp;an&nbsp;image&nbsp;is&nbsp;inputted,&nbsp;returns&nbsp;an&nbsp;image,&nbsp;if&nbsp;only&nbsp;np.ndarrays&nbsp;are&nbsp;inputted,&nbsp;return&nbsp;a&nbsp;np.nodarray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>type_res</span>&nbsp;=&nbsp;<span id="ast-15">''</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17"><span id="ast-18">isinstance</span>(<span id="ast-19" class="other_trans">gm_seg</span>,&nbsp;<span id="ast-20">Image</span>)</span>:<span id="ast-21"><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>original_hdr</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24" class="other_trans">gm_seg</span>.hdr</span></span><span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>gm_seg_dat</span>&nbsp;=&nbsp;<span id="ast-27"><span id="ast-28">gm_seg</span>.data</span></span><span id="ast-29"><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>type_res</span>&nbsp;+=&nbsp;<span id="ast-32">'image'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-34"><span id="ast-35" class="other_trans">isinstance</span>(<span id="ast-36" class="other_trans">gm_seg</span>,&nbsp;<span id="ast-37"><span id="ast-38">np</span>.ndarray</span>)</span>:<span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>gm_seg_dat</span>&nbsp;=&nbsp;<span id="ast-41" class="other_trans">gm_seg</span></span><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>type_res</span>&nbsp;+=&nbsp;<span id="ast-45">'array'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sct</span>.printv</span>(<span id="ast-50">(<span id="ast-51">'WARNING:&nbsp;gm_seg&nbsp;is&nbsp;instance&nbsp;of&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-53"><span id="ast-54">type</span>(<span id="ast-55" class="other_trans">gm_seg</span>)</span>)</span>,&nbsp;<span id="ast-56">verbose</span>,&nbsp;<span id="ast-57">'warning'</span>)</span></span><span id="ast-58"><span id="ast-59" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>gm_seg_dat</span>&nbsp;=&nbsp;<span id="ast-60">None</span></span></span><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-62"><span id="ast-63" class="other_trans">isinstance</span>(<span id="ast-64">original_im</span>,&nbsp;<span id="ast-65">Image</span>)</span>:<span id="ast-66"><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>original_dat</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69" class="other_trans">original_im</span>.data</span></span><span id="ast-70"><span id="ast-71" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>type_res</span>&nbsp;+=&nbsp;<span id="ast-73">'image'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-75"><span id="ast-76">isinstance</span>(<span id="ast-77" class="other_trans">original_im</span>,&nbsp;<span id="ast-78"><span id="ast-79" class="other_trans">np</span>.ndarray</span>)</span>:<span id="ast-80"><span id="ast-81" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>original_dat</span>&nbsp;=&nbsp;<span id="ast-82">original_im</span></span><span id="ast-83"><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>type_res</span>&nbsp;+=&nbsp;<span id="ast-86">'array'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-87"><span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sct</span>.printv</span>(<span id="ast-91">(<span id="ast-92">'WARNING:&nbsp;original_im&nbsp;is&nbsp;instance&nbsp;of&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-94"><span id="ast-95" class="other_trans">type</span>(<span id="ast-96" class="other_trans">original_im</span>)</span>)</span>,&nbsp;<span id="ast-97" class="other_trans">verbose</span>,&nbsp;<span id="ast-98">'warning'</span>)</span></span><span id="ast-99"><span id="ast-100"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>original_dat</span>&nbsp;=&nbsp;<span id="ast-101">None</span></span></span><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-103">(<span id="ast-104"><span id="ast-105" class="incorrect_node">gm_seg_dat&nbsp;&rarr;&nbsp;original_im&nbsp;</span>.shape</span><span id="ast-106" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-107"><span id="ast-108" class="other_trans">original_dat</span>.shape</span>)</span></span><span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>binary_gm_seg_dat</span>&nbsp;=&nbsp;<span id="ast-111"><span id="ast-112"><span id="ast-113">(<span id="ast-114" class="other_trans">gm_seg_dat</span><span id="ast-115" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-116">0</span>)</span>.astype</span>(<span id="ast-117" class="other_trans">int</span>)</span></span><span id="ast-118"><span id="ast-119" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sc_dat</span>&nbsp;=&nbsp;<span id="ast-120"><span id="ast-121"><span id="ast-122">(<span id="ast-123" class="ref_node">gm_seg_dat&nbsp;&rarr;&nbsp;original_dat&nbsp;</span><span id="ast-124" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-125">0</span>)</span>.astype</span>(<span id="ast-126">int</span>)</span></span><span id="ast-127"><span id="ast-128"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>res_wm_seg</span>&nbsp;=&nbsp;<span id="ast-129"><span id="ast-130"><span id="ast-131">np</span>.asarray</span>(<span id="ast-132"><span id="ast-133"><span id="ast-134"><span id="ast-135"><span id="ast-136" class="other_trans">np</span>.absolute</span>(<span id="ast-137">(<span id="ast-138" class="other_trans">sc_dat</span>&nbsp;-&nbsp;<span id="ast-140">binary_gm_seg_dat</span>)</span>)</span>.astype</span>(<span id="ast-141">int</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_load_metadata(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">metadata</span></span>):<span id="ast-5"><span id="ast-6" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>the_metadata&nbsp;&rarr;&nbsp;self.&nbsp;</span>&nbsp;=&nbsp;<span id="ast-7" class="other_trans">metadata</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10" class="other_trans">the_metadata</span><span id="ast-11" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-12">None</span>)</span>:<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>the_metadata</span>&nbsp;=&nbsp;<span id="ast-15">{}</span></span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">isinstance</span>(<span id="ast-19" class="other_trans">the_metadata</span>,&nbsp;<span id="ast-20"><span id="ast-21">six</span>.string_types</span>)</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27" class="other_trans">os</span>.path</span>.isfile</span>(<span id="ast-28" class="other_trans">the_metadata</span>)</span>:<span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-30"><span id="ast-31">open</span>(<span id="ast-32" class="other_trans">the_metadata</span>,&nbsp;<span id="ast-33">'r'</span>)</span>&nbsp;as&nbsp;<span id="ast-34" class="other_trans">f</span>:<span id="ast-35"><span id="ast-36" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>the_metadata</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">json</span>.load</span>(<span id="ast-40">f</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-41"><span id="ast-42" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>req</span>&nbsp;=&nbsp;<span id="ast-43"><span id="ast-44"><span id="ast-45">requests</span>.get</span>(<span id="ast-46" class="other_trans">the_metadata</span>)</span></span><span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>req</span>.raise_for_status</span>()</span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>the_metadata</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans">req</span>.json</span>()</span></span></span><span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-57">(<span id="ast-58" class="other_trans">IOError</span>,&nbsp;<span id="ast-59">ValueError</span>,&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62">requests</span>.exceptions</span>.RequestException</span>)</span>&nbsp;as&nbsp;<span id="ast-63" class="other_trans">e</span>:<span id="ast-64"><span id="ast-65" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68">"Unable&nbsp;to&nbsp;load&nbsp;JSON&nbsp;at&nbsp;'{0}'"</span>.format</span>(<span id="ast-69">metadata</span>)</span></span><span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>six</span>.raise_from</span>(<span id="ast-74"><span id="ast-75">DataPackageException</span>(<span id="ast-76" class="other_trans">msg</span>)</span>,&nbsp;<span id="ast-77" class="other_trans">e</span>)</span></span></span></span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-79"><span id="ast-80">hasattr</span>(<span id="ast-81" class="other_trans">the_metadata</span>,&nbsp;<span id="ast-82">'read'</span>)</span>:<span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>the_metadata</span>&nbsp;=&nbsp;<span id="ast-85"><span id="ast-86"><span id="ast-87" class="other_trans">json</span>.load</span>(<span id="ast-88" class="other_trans">the_metadata</span>)</span></span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-90">(<span id="ast-91">not</span>&nbsp;<span id="ast-92"><span id="ast-93">isinstance</span>(<span id="ast-94" class="other_trans">the_metadata</span>,&nbsp;<span id="ast-95">dict</span>)</span>)</span>:<span id="ast-96"><span id="ast-97" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg</span>&nbsp;=&nbsp;<span id="ast-98">"Data&nbsp;must&nbsp;be&nbsp;a&nbsp;'dict',&nbsp;but&nbsp;was&nbsp;a&nbsp;'{0}'"</span></span><span id="ast-99"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-100"><span id="ast-101">DataPackageException</span>(<span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans">msg</span>.format</span>(<span id="ast-105"><span id="ast-106"><span id="ast-107" class="other_trans">type</span>(<span id="ast-108" class="ref_node">metadata&nbsp;&rarr;&nbsp;the_metadata&nbsp;</span>)</span>.__name__</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;main(<span id="ast-2"></span>):<span id="ast-3"><span id="ast-4" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>directory</span>&nbsp;=&nbsp;<span id="ast-5"><span id="ast-11"><span id="ast-12"><span id="ast-13" class="other_trans">sys</span>.argv</span>[<span id="ast-14"><span id="ast-15">1</span></span>]</span>&nbsp;if&nbsp;<span id="ast-6"><span id="ast-7"><span id="ast-8">sys</span>.argv</span>[<span id="ast-9"><span id="ast-10">1</span>:</span>]</span>&nbsp;else&nbsp;<span id="ast-16">''</span></span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>hist</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-25"><span id="ast-26"><span id="ast-27" class="other_trans">sys</span>.argv</span>[<span id="ast-28"><span id="ast-29">2</span></span>]</span>&nbsp;if&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">sys</span>.argv</span>[<span id="ast-23"><span id="ast-24">2</span>:</span>]</span>&nbsp;else&nbsp;<span id="ast-30">1</span></span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-32">(<span id="ast-33">not</span>&nbsp;<span id="ast-34" class="other_trans">directory</span>)</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-36" class="other_trans">HOME</span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>exit</span>()</span></span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41">(<span id="ast-42">not</span>&nbsp;<span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans">os</span>.path</span>.isdir</span>(<span id="ast-47" class="other_trans">directory</span>)</span>)</span>:<span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>path</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51">getpath</span>(<span id="ast-52" class="other_trans">directory</span>,&nbsp;<span id="ast-53" class="other_trans">hist</span>)</span></span><span id="ast-54"><span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dbex</span>(<span id="ast-57">'UPDATE&nbsp;dirs&nbsp;SET&nbsp;time&nbsp;=&nbsp;datetime("now")&nbsp;WHERE&nbsp;path&nbsp;=&nbsp;?'</span>,&nbsp;<span id="ast-58">(<span id="ast-59" class="other_trans">path</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-60"><span id="ast-61" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>path</span>&nbsp;=&nbsp;<span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">os</span>.path</span>.abspath</span>(<span id="ast-66" class="other_trans">directory</span>)</span></span><span id="ast-67"><span id="ast-68"><span id="ast-69" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>dbex</span>(<span id="ast-70">'INSERT&nbsp;OR&nbsp;REPLACE&nbsp;INTO&nbsp;dirs&nbsp;VALUES(?,&nbsp;?,&nbsp;datetime("now"))'</span>,&nbsp;<span id="ast-71">(<span id="ast-72" class="other_trans">path</span>,&nbsp;<span id="ast-73"><span id="ast-74"><span id="ast-75"><span id="ast-76">os</span>.path</span>.basename</span>(<span id="ast-77" class="correct_node">directory&nbsp;&rarr;&nbsp;path&nbsp;</span>)</span>)</span>)</span></span></span><span id="ast-78"><span id="ast-79"><span id="ast-80"><span id="ast-81" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>db</span>.commit</span>()</span></span><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-83" class="other_trans">path</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;slide_seek_bar(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">id_or_name</span>,&nbsp;<span id="ast-5" class="other_trans">endX</span>,&nbsp;<span id="ast-6" class="other_trans">endY</span>,&nbsp;<span id="ast-7" class="other_trans">tap_count</span>,&nbsp;<span id="ast-9" class="other_trans">startX</span>,&nbsp;<span id="ast-11" class="other_trans">startY</span></span>):<span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Slide&nbsp;seek&nbsp;bar&nbsp;'</span></span><span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>driver</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19">self</span>._current_application</span>()</span></span><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>element</span>&nbsp;=&nbsp;<span id="ast-22"><span id="ast-23" class="correct_node">_find_element_by_tag_name&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-24">'seekBar'</span>,&nbsp;<span id="ast-25" class="other_trans">id_or_name</span>)</span></span><span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>args</span>&nbsp;=&nbsp;<span id="ast-28">{<span id="ast-29">'startX'</span>:&nbsp;<span id="ast-36"><span id="ast-37">float</span>(<span id="ast-38" class="other_trans">startX</span>)</span>,&nbsp;<span id="ast-30">'startY'</span>:&nbsp;<span id="ast-39"><span id="ast-40" class="other_trans">float</span>(<span id="ast-41" class="other_trans">startY</span>)</span>,&nbsp;<span id="ast-31">'endX'</span>:&nbsp;<span id="ast-42"><span id="ast-43" class="other_trans">float</span>(<span id="ast-44" class="other_trans">endX</span>)</span>,&nbsp;<span id="ast-32">'endY'</span>:&nbsp;<span id="ast-45"><span id="ast-46">float</span>(<span id="ast-47" class="other_trans">endY</span>)</span>,&nbsp;<span id="ast-33">'tapCount'</span>:&nbsp;<span id="ast-48"><span id="ast-49" class="other_trans">int</span>(<span id="ast-50" class="other_trans">tap_count</span>)</span>,&nbsp;<span id="ast-34">'element'</span>:&nbsp;<span id="ast-51"><span id="ast-52" class="other_trans">element</span>.id</span>,&nbsp;<span id="ast-35">'duration'</span>:&nbsp;<span id="ast-53">1</span>}</span></span><span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>driver</span>.execute_script</span>(<span id="ast-58">'mobile:&nbsp;flick'</span>,&nbsp;<span id="ast-59" class="other_trans">args</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;validate_pk_params(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6">not</span>&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9" class="other_trans">number</span>.isPrime</span>(<span id="ast-10"><span id="ast-11">self</span>.p</span>)</span>)</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">Exception</span>(<span id="ast-15">'p&nbsp;is&nbsp;not&nbsp;prime.'</span>)</span></span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17">(<span id="ast-18">not</span>&nbsp;<span id="ast-19">(<span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">number</span>.size</span>(<span id="ast-23"><span id="ast-24">self</span>.p</span>)</span><span id="ast-25" class="incorrect_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-26">2048</span>)</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">Exception</span>(<span id="ast-30">'p&nbsp;of&nbsp;insufficient&nbsp;length.&nbsp;Should&nbsp;be&nbsp;2048&nbsp;bits&nbsp;or&nbsp;greater.'</span>)</span></span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-32">(<span id="ast-33">not</span>&nbsp;<span id="ast-34"><span id="ast-35"><span id="ast-36" class="other_trans">number</span>.isPrime</span>(<span id="ast-37"><span id="ast-38">self</span>.q</span>)</span>)</span>:<span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-40"><span id="ast-41" class="other_trans">Exception</span>(<span id="ast-42">'q&nbsp;is&nbsp;not&nbsp;prime.'</span>)</span></span></span><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-44">(<span id="ast-45">not</span>&nbsp;<span id="ast-46">(<span id="ast-47"><span id="ast-48"><span id="ast-49" class="other_trans">number</span>.size</span>(<span id="ast-50"><span id="ast-51">self</span>.q</span>)</span><span id="ast-52" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-53">256</span>)</span>)</span>:<span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">Exception</span>(<span id="ast-57">'q&nbsp;of&nbsp;insufficient&nbsp;length.&nbsp;Should&nbsp;be&nbsp;256&nbsp;bits&nbsp;or&nbsp;greater.'</span>)</span></span></span><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59">(<span id="ast-60"><span id="ast-61" class="other_trans">pow</span>(<span id="ast-62"><span id="ast-63">self</span>.g</span>,&nbsp;<span id="ast-64"><span id="ast-65">self</span>.q</span>,&nbsp;<span id="ast-66"><span id="ast-67">self</span>.p</span>)</span><span id="ast-68" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-69">1</span>)</span>:<span id="ast-70"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-71"><span id="ast-72" class="other_trans">Exception</span>(<span id="ast-73">'g&nbsp;does&nbsp;not&nbsp;generate&nbsp;subgroup&nbsp;of&nbsp;order&nbsp;q.'</span>)</span></span></span><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-75">(<span id="ast-76">not</span>&nbsp;<span id="ast-77">(<span id="ast-78">1</span><span id="ast-79" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-81"><span id="ast-82">self</span>.g</span><span id="ast-80" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-83">(<span id="ast-84"><span id="ast-85">self</span>.p</span>&nbsp;-&nbsp;<span id="ast-87">1</span>)</span>)</span>)</span>:<span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-89"><span id="ast-90" class="other_trans">Exception</span>(<span id="ast-91">'g&nbsp;out&nbsp;of&nbsp;range.'</span>)</span></span></span><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-93">(<span id="ast-94">not</span>&nbsp;<span id="ast-95">(<span id="ast-96">1</span><span id="ast-97" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-99"><span id="ast-100">self</span>.y</span><span id="ast-98" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-101">(<span id="ast-102" class="ref_node">p&nbsp;&rarr;&nbsp;self.&nbsp;</span>&nbsp;-&nbsp;<span id="ast-104">1</span>)</span>)</span>)</span>:<span id="ast-105"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-106"><span id="ast-107" class="other_trans">Exception</span>(<span id="ast-108">'y&nbsp;out&nbsp;of&nbsp;range.'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_normalize_address(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">region</span>,&nbsp;<span id="ast-5" class="other_trans">addr</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;stack&nbsp;address,&nbsp;we&nbsp;convert&nbsp;it&nbsp;to&nbsp;a&nbsp;correct&nbsp;region&nbsp;and&nbsp;address\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;addr:&nbsp;Absolute&nbsp;address\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return:&nbsp;a&nbsp;tuple&nbsp;of&nbsp;(region_id,&nbsp;normalized_address,&nbsp;is_stack,&nbsp;related_function_addr)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10">not</span>&nbsp;<span id="ast-11"><span id="ast-12">self</span>._stack_address_to_region</span>)</span>:<span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-14">(<span id="ast-15">region</span>,&nbsp;<span id="ast-16">addr</span>,&nbsp;<span id="ast-17">False</span>,&nbsp;<span id="ast-18">None</span>)</span></span></span><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>stack_base</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23"><span id="ast-24">self</span>._stack_address_to_region</span>[<span id="ast-25"><span id="ast-26">0</span></span>]</span>[<span id="ast-27"><span id="ast-28">0</span></span>]</span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32" class="other_trans">region</span>.startswith</span>(<span id="ast-33">'stack'</span>)</span>:<span id="ast-34"><span id="ast-35" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>addr</span>&nbsp;+=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39">self</span>._stack_region_to_address</span>[<span id="ast-40"><span id="ast-41" class="incorrect_node">region&nbsp;&rarr;&nbsp;i&nbsp;</span></span>]</span></span><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-44">0</span></span><span id="ast-45"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-46" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-47"><span id="ast-48">xrange</span>(<span id="ast-49">(<span id="ast-50"><span id="ast-51">len</span>(<span id="ast-52"><span id="ast-53">self</span>._stack_address_to_region</span>)</span>&nbsp;-&nbsp;<span id="ast-55">1</span>)</span>,&nbsp;<span id="ast-56">0</span>,&nbsp;<span id="ast-57">-1</span>)</span>:<span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59">(<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63">self</span>._stack_address_to_region</span>[<span id="ast-64"><span id="ast-65" class="other_trans">i</span></span>]</span>[<span id="ast-66"><span id="ast-67">0</span></span>]</span><span id="ast-68" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-69">addr</span>)</span>:<span id="ast-70"><span id="ast-71" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-72" class="other_trans">i</span></span><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>break</span></span></span><span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_region</span>&nbsp;=&nbsp;<span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79">self</span>._stack_address_to_region</span>[<span id="ast-80"><span id="ast-81" class="other_trans">pos</span></span>]</span>[<span id="ast-82"><span id="ast-83">1</span></span>]</span></span><span id="ast-84"><span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_addr</span>&nbsp;=&nbsp;<span id="ast-86">(<span id="ast-87" class="other_trans">addr</span>&nbsp;-&nbsp;<span id="ast-89"><span id="ast-90"><span id="ast-91"><span id="ast-92">self</span>._stack_address_to_region</span>[<span id="ast-93"><span id="ast-94" class="other_trans">pos</span></span>]</span>[<span id="ast-95"><span id="ast-96">0</span></span>]</span>)</span></span><span id="ast-97"><span id="ast-98" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>related_function_addr</span>&nbsp;=&nbsp;<span id="ast-99"><span id="ast-100"><span id="ast-101"><span id="ast-102">self</span>._stack_address_to_region</span>[<span id="ast-103"><span id="ast-104" class="other_trans">pos</span></span>]</span>[<span id="ast-105"><span id="ast-106">2</span></span>]</span></span><span id="ast-107"><span id="ast-108"><span id="ast-109"><span id="ast-110" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>l</span>.debug</span>(<span id="ast-111">'%s&nbsp;0x%08x&nbsp;is&nbsp;normalized&nbsp;to&nbsp;%s&nbsp;%08x,&nbsp;region&nbsp;base&nbsp;addr&nbsp;is&nbsp;0x%08x'</span>,&nbsp;<span id="ast-112">region</span>,&nbsp;<span id="ast-113" class="other_trans">addr</span>,&nbsp;<span id="ast-114" class="other_trans">new_region</span>,&nbsp;<span id="ast-115">new_addr</span>,&nbsp;<span id="ast-116"><span id="ast-117"><span id="ast-118"><span id="ast-119">self</span>._stack_address_to_region</span>[<span id="ast-120"><span id="ast-121" class="other_trans">pos</span></span>]</span>[<span id="ast-122"><span id="ast-123">0</span></span>]</span>)</span></span><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-125">(<span id="ast-126" class="other_trans">new_region</span>,&nbsp;<span id="ast-127" class="other_trans">new_addr</span>,&nbsp;<span id="ast-128">True</span>,&nbsp;<span id="ast-129" class="other_trans">related_function_addr</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-130"><span id="ast-131"><span id="ast-132"><span id="ast-133" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>l</span>.debug</span>(<span id="ast-134">'Got&nbsp;address&nbsp;%s&nbsp;0x%x'</span>,&nbsp;<span id="ast-135" class="other_trans">region</span>,&nbsp;<span id="ast-136" class="other_trans">addr</span>)</span></span><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-138">(<span id="ast-140">(<span id="ast-141" class="other_trans">addr</span><span id="ast-142" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-143" class="other_trans">stack_base</span>)</span>&nbsp;and&nbsp;<span id="ast-144">(<span id="ast-145">addr</span><span id="ast-146" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-147">(<span id="ast-148" class="other_trans">stack_base</span>&nbsp;-&nbsp;<span id="ast-150"><span id="ast-151">self</span>._stack_size</span>)</span>)</span>)</span>:<span id="ast-152"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-153"><span id="ast-154"><span id="ast-155">self</span>._normalize_address</span>(<span id="ast-156"><span id="ast-157"><span id="ast-158"><span id="ast-159">self</span>._stack_address_to_region</span>[<span id="ast-160"><span id="ast-161">0</span></span>]</span>[<span id="ast-162"><span id="ast-163">1</span></span>]</span>,&nbsp;<span id="ast-164">(<span id="ast-165" class="other_trans">addr</span>&nbsp;-&nbsp;<span id="ast-167" class="other_trans">stack_base</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-169">(<span id="ast-170" class="other_trans">region</span>,&nbsp;<span id="ast-171" class="other_trans">addr</span>,&nbsp;<span id="ast-172">False</span>,&nbsp;<span id="ast-173" class="other_trans">None</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_unpack_tar(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">file_name</span>,&nbsp;<span id="ast-5" class="other_trans">file_location</span>,&nbsp;<span id="ast-6">tmp_dir</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-9" class="other_trans">root_name</span>,&nbsp;<span id="ast-10" class="other_trans">_</span>)</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13"><span id="ast-14">os</span>.path</span>.splitext</span>(<span id="ast-15">file_name</span>)</span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>kernel_fn</span>&nbsp;=&nbsp;<span id="ast-18">None</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ramdisk_fn</span>&nbsp;=&nbsp;<span id="ast-21">None</span></span><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>root_img_fn</span>&nbsp;=&nbsp;<span id="ast-24">None</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28">contextlib</span>.closing</span>(<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">tarfile</span>.open</span>(<span id="ast-32" class="other_trans">file_location</span>,&nbsp;<span id="ast-33">'r'</span>)</span>)</span>&nbsp;as&nbsp;<span id="ast-34">tfh</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-36">tmemb</span>&nbsp;in&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">tfh</span>.getmembers</span>()</span>:<span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>fn</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43">tmemb</span>.name</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47">KERNEL_FN_MATCH</span>.match</span>(<span id="ast-48" class="other_trans">fn</span>)</span>:<span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>kernel_fn</span>&nbsp;=&nbsp;<span id="ast-51" class="other_trans">fn</span></span><span id="ast-52"><span id="ast-53"><span id="ast-54"><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-56">(<span id="ast-57">'Found&nbsp;kernel:&nbsp;%r'</span>&nbsp;%&nbsp;<span id="ast-59">fn</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">RAMDISK_FN_MATCH</span>.match</span>(<span id="ast-64">fn</span>)</span>:<span id="ast-65"><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ramdisk_fn</span>&nbsp;=&nbsp;<span id="ast-67">fn</span></span><span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-72">(<span id="ast-73">'Found&nbsp;ram&nbsp;disk:&nbsp;%r'</span>&nbsp;%&nbsp;<span id="ast-75" class="other_trans">fn</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-77"><span id="ast-78"><span id="ast-79">IMAGE_FN_MATCH</span>.match</span>(<span id="ast-80">fn</span>)</span>:<span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>root_img_fn</span>&nbsp;=&nbsp;<span id="ast-83">fn</span></span><span id="ast-84"><span id="ast-85"><span id="ast-86"><span id="ast-87"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-88">(<span id="ast-89">'Found&nbsp;root&nbsp;image:&nbsp;%r'</span>&nbsp;%&nbsp;<span id="ast-91">fn</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-92"><span id="ast-93"><span id="ast-94"><span id="ast-95"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-96">(<span id="ast-97">'Unknown&nbsp;member&nbsp;%r&nbsp;-&nbsp;skipping'</span>&nbsp;%&nbsp;<span id="ast-99">fn</span>)</span>)</span></span></span></span></span><span id="ast-100"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-101">(<span id="ast-102">not</span>&nbsp;<span id="ast-103">root_img_fn</span>)</span>:<span id="ast-104"><span id="ast-105"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg</span>&nbsp;=&nbsp;<span id="ast-106">(<span id="ast-107">'Image&nbsp;%r&nbsp;has&nbsp;no&nbsp;root&nbsp;image&nbsp;member'</span>&nbsp;%&nbsp;<span id="ast-109" class="other_trans">file_name</span>)</span></span><span id="ast-110"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-111"><span id="ast-112">RuntimeError</span>(<span id="ast-113">msg</span>)</span></span></span><span id="ast-114"><span id="ast-115" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>extract_dir</span>&nbsp;=&nbsp;<span id="ast-116"><span id="ast-117"><span id="ast-118">sh</span>.joinpths</span>(<span id="ast-119">tmp_dir</span>,&nbsp;<span id="ast-120" class="other_trans">root_name</span>)</span></span><span id="ast-121"><span id="ast-122"><span id="ast-123"><span id="ast-124" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>sh</span>.mkdir</span>(<span id="ast-125" class="other_trans">extract_dir</span>)</span></span><span id="ast-126"><span id="ast-127"><span id="ast-128"><span id="ast-129"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.info</span>(<span id="ast-130">'Extracting&nbsp;to&nbsp;%r'</span>,&nbsp;<span id="ast-131" class="other_trans">extract_dir</span>)</span></span><span id="ast-132"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-133"><span id="ast-134"><span id="ast-135">contextlib</span>.closing</span>(<span id="ast-136"><span id="ast-137"><span id="ast-138" class="other_trans">tarfile</span>.open</span>(<span id="ast-139" class="other_trans">file_location</span>,&nbsp;<span id="ast-140">'r'</span>)</span>)</span>&nbsp;as&nbsp;<span id="ast-141" class="other_trans">tfh</span>:<span id="ast-142"><span id="ast-143"><span id="ast-144"><span id="ast-145"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tfh</span>.extractall</span>(<span id="ast-146" class="other_trans">extract_dir</span>)</span></span></span><span id="ast-147"><span id="ast-148"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>locations</span>&nbsp;=&nbsp;<span id="ast-149"><span id="ast-150" class="other_trans">dict</span>()</span></span><span id="ast-151"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-152">kernel_fn</span>:<span id="ast-153"><span id="ast-154"><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>locations</span>[<span id="ast-156"><span id="ast-157">'kernel'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-158"><span id="ast-159"><span id="ast-160">sh</span>.joinpths</span>(<span id="ast-161" class="other_trans">extract_dir</span>,&nbsp;<span id="ast-162" class="other_trans">kernel_fn</span>)</span></span></span><span id="ast-163"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-164" class="other_trans">ramdisk_fn</span>:<span id="ast-165"><span id="ast-166"><span id="ast-167"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>locations</span>[<span id="ast-168"><span id="ast-169">'ramdisk'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-170"><span id="ast-171"><span id="ast-172">sh</span>.joinpths</span>(<span id="ast-173" class="incorrect_node">extract_dir&nbsp;&rarr;&nbsp;ramdisk_fn&nbsp;</span>,&nbsp;<span id="ast-174" class="ref_node">kernel_fn&nbsp;&rarr;&nbsp;ramdisk_fn&nbsp;</span>)</span></span></span><span id="ast-175"><span id="ast-176"><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>locations</span>[<span id="ast-178"><span id="ast-179">'image'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-180"><span id="ast-181"><span id="ast-182">sh</span>.joinpths</span>(<span id="ast-183" class="other_trans">extract_dir</span>,&nbsp;<span id="ast-184" class="other_trans">root_img_fn</span>)</span></span><span id="ast-185"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-186" class="other_trans">locations</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;intensify(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">challengers</span>,&nbsp;<span id="ast-5" class="other_trans">incumbent</span>,&nbsp;<span id="ast-6" class="other_trans">run_history</span>,&nbsp;<span id="ast-7">objective</span>,&nbsp;<span id="ast-8" class="other_trans">time_bound</span></span>):<span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;running&nbsp;intensification&nbsp;to&nbsp;determine&nbsp;the&nbsp;incumbent&nbsp;configuration\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Side&nbsp;effect:&nbsp;adds&nbsp;runs&nbsp;to&nbsp;run_history\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Implementation&nbsp;of&nbsp;Procedure&nbsp;2&nbsp;in&nbsp;Hutter&nbsp;et&nbsp;al.&nbsp;(2011).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;challengers&nbsp;:&nbsp;list&nbsp;of&nbsp;ConfigSpace.config\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promising&nbsp;configurations\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incumbent&nbsp;:&nbsp;ConfigSpace.config\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best&nbsp;configuration&nbsp;so&nbsp;far\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_history&nbsp;:&nbsp;runhistory\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all&nbsp;runs&nbsp;on&nbsp;all&nbsp;instance,seed&nbsp;pairs&nbsp;for&nbsp;incumbent\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time_bound&nbsp;:&nbsp;int,&nbsp;optional&nbsp;(default=2&nbsp;**&nbsp;31&nbsp;-&nbsp;1)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time&nbsp;in&nbsp;[sec]&nbsp;available&nbsp;to&nbsp;perform&nbsp;intensify\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incumbent:&nbsp;Configuration()\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current&nbsp;(maybe&nbsp;new)&nbsp;incumbent&nbsp;configuration\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-12"><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.start_time</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans">time</span>.time</span>()</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-20" class="other_trans">time_bound</span><span id="ast-21" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-22">0.01</span>)</span>:<span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-24"><span id="ast-25" class="other_trans">ValueError</span>(<span id="ast-26">'time_bound&nbsp;must&nbsp;be&nbsp;&gt;=&nbsp;0.01'</span>)</span></span></span><span id="ast-27"><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>num_run</span>&nbsp;=&nbsp;<span id="ast-29">0</span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-31" class="other_trans">challenger</span>&nbsp;in&nbsp;<span id="ast-32" class="other_trans">challengers</span>:<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.logger</span>.debug</span>(<span id="ast-38">'Intensify&nbsp;on&nbsp;%s'</span>,&nbsp;<span id="ast-39" class="other_trans">challenger</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41"><span id="ast-42">hasattr</span>(<span id="ast-43" class="other_trans">challenger</span>,&nbsp;<span id="ast-44">'origin'</span>)</span>:<span id="ast-45"><span id="ast-46"><span id="ast-47"><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.logger</span>.debug</span>(<span id="ast-50">'Configuration&nbsp;origin:&nbsp;%s'</span>,&nbsp;<span id="ast-51"><span id="ast-52" class="other_trans">challenger</span>.origin</span>)</span></span></span><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>inc_runs</span>&nbsp;=&nbsp;<span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans">run_history</span>.get_runs_for_config</span>(<span id="ast-58" class="other_trans">incumbent</span>)</span></span><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-60">(<span id="ast-61"><span id="ast-62">len</span>(<span id="ast-63" class="other_trans">inc_runs</span>)</span><span id="ast-64" class="location_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-65"><span id="ast-66">self</span>.maxR</span>)</span>:<span id="ast-67"><span id="ast-68" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>inc_inst</span>&nbsp;=&nbsp;<span id="ast-69">[<span id="ast-70"><span id="ast-71" class="other_trans">s</span>.instance</span><span id="ast-72">&nbsp;for&nbsp;<span id="ast-73">s</span>&nbsp;in&nbsp;<span id="ast-74" class="other_trans">inc_runs</span></span>]</span></span><span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>inc_inst</span>&nbsp;=&nbsp;<span id="ast-77"><span id="ast-78">list</span>(<span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82">Counter</span>(<span id="ast-83" class="other_trans">inc_inst</span>)</span>.items</span>()</span>)</span></span><span id="ast-84"><span id="ast-85"><span id="ast-86"><span id="ast-87" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>inc_inst</span>.sort</span>(key=<span id="ast-89">lambda&nbsp;<span id="ast-90"><span id="ast-91" class="other_trans">x</span></span>:&nbsp;<span id="ast-92"><span id="ast-93" class="other_trans">x</span>[<span id="ast-94"><span id="ast-95">1</span></span>]</span></span>,&nbsp;reverse=<span id="ast-97">True</span>)</span></span><span id="ast-98"><span id="ast-99" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>max_runs</span>&nbsp;=&nbsp;<span id="ast-100"><span id="ast-101"><span id="ast-102" class="other_trans">inc_inst</span>[<span id="ast-103"><span id="ast-104">0</span></span>]</span>[<span id="ast-105"><span id="ast-106">1</span></span>]</span></span><span id="ast-107"><span id="ast-108" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>inc_inst</span>&nbsp;=&nbsp;<span id="ast-109"><span id="ast-110">set</span>(<span id="ast-111">[<span id="ast-112"><span id="ast-113" class="other_trans">x</span>[<span id="ast-114"><span id="ast-115">0</span></span>]</span><span id="ast-116">&nbsp;for&nbsp;<span id="ast-117">x</span>&nbsp;in&nbsp;<span id="ast-118" class="other_trans">inc_inst</span>&nbsp;if&nbsp;<span id="ast-119">(<span id="ast-120"><span id="ast-121" class="other_trans">x</span>[<span id="ast-122"><span id="ast-123">1</span></span>]</span><span id="ast-124" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-125" class="other_trans">max_runs</span>)</span></span>]</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_read_field(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Read&nbsp;a&nbsp;single&nbsp;byte&nbsp;for&nbsp;field&nbsp;type,&nbsp;then&nbsp;read&nbsp;the&nbsp;value.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ftype</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>._input</span>[<span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>._pos</span></span>]</span></span><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._pos</span>&nbsp;+=&nbsp;<span id="ast-18">1</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>reader</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22" class="correct_node">field_type_map&nbsp;&rarr;&nbsp;self.&nbsp;</span>[<span id="ast-23"><span id="ast-24" class="other_trans">ftype</span></span>]</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26" class="other_trans">reader</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">reader</span>(<span id="ast-30">self</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;crypto_box_afternm(<span id="ast-2"><span id="ast-3" class="other_trans">msg</span>,&nbsp;<span id="ast-4" class="other_trans">nonce</span>,&nbsp;<span id="ast-5" class="other_trans">k</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Encrypts&nbsp;a&nbsp;given&nbsp;a&nbsp;message,&nbsp;using&nbsp;partial&nbsp;computed&nbsp;data\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10"><span id="ast-11" class="other_trans">len</span>(<span id="ast-12" class="other_trans">k</span>)</span><span id="ast-13" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-14">crypto_box_BEFORENMBYTES</span>)</span>:<span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-16"><span id="ast-17" class="other_trans">ValueError</span>(<span id="ast-18">'Invalid&nbsp;shared&nbsp;key'</span>)</span></span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-20">(<span id="ast-21"><span id="ast-22">len</span>(<span id="ast-23" class="other_trans">nonce</span>)</span><span id="ast-24" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-25" class="other_trans">crypto_box_NONCEBYTES</span>)</span>:<span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-27"><span id="ast-28" class="other_trans">ValueError</span>(<span id="ast-29">'Invalid&nbsp;nonce'</span>)</span></span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pad</span>&nbsp;=&nbsp;<span id="ast-32">(<span id="ast-33">(<span id="ast-34">'\\u0000'</span>&nbsp;*&nbsp;<span id="ast-36">crypto_box_ZEROBYTES</span>)</span>&nbsp;+&nbsp;<span id="ast-38" class="other_trans">msg</span>)</span></span><span id="ast-39"><span id="ast-40" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ctxt</span>&nbsp;=&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43">ctypes</span>.create_string_buffer</span>(<span id="ast-44"><span id="ast-45" class="other_trans">len</span>(<span id="ast-46" class="other_trans">pad</span>)</span>)</span></span><span id="ast-47"><span id="ast-48" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ret</span>&nbsp;=&nbsp;<span id="ast-49"><span id="ast-50"><span id="ast-51" class="other_trans">nacl</span>.crypto_box_afternm</span>(<span id="ast-52" class="other_trans">ctxt</span>,&nbsp;<span id="ast-53" class="correct_node">msg&nbsp;&rarr;&nbsp;pad&nbsp;</span>,&nbsp;<span id="ast-54"><span id="ast-55"><span id="ast-56" class="other_trans">ctypes</span>.c_ulonglong</span>(<span id="ast-57"><span id="ast-58" class="other_trans">len</span>(<span id="ast-59" class="other_trans">pad</span>)</span>)</span>,&nbsp;<span id="ast-60" class="other_trans">nonce</span>,&nbsp;<span id="ast-61" class="other_trans">k</span>)</span></span><span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-63" class="other_trans">ret</span>:<span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-65"><span id="ast-66">ValueError</span>(<span id="ast-67">'Unable&nbsp;to&nbsp;encrypt&nbsp;messsage'</span>)</span></span></span><span id="ast-68"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans">ctxt</span>.raw</span>[<span id="ast-72"><span id="ast-73">crypto_box_BOXZEROBYTES</span>:</span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_process_multiple_environments(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4">created_env_files</span>,&nbsp;<span id="ast-5">added_files</span>,&nbsp;<span id="ast-6" class="other_trans">tht_root</span>,&nbsp;<span id="ast-7">user_tht_root</span>,&nbsp;<span id="ast-8">cleanup</span></span>):<span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>env_files</span>&nbsp;=&nbsp;<span id="ast-12">{}</span></span><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>localenv</span>&nbsp;=&nbsp;<span id="ast-15">{}</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-17" class="other_trans">env_path</span>&nbsp;in&nbsp;<span id="ast-18">created_env_files</span>:<span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-24">(<span id="ast-25">'Processing&nbsp;environment&nbsp;files&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-27">env_path</span>)</span>)</span></span><span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>abs_env_path</span>&nbsp;=&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33">os</span>.path</span>.abspath</span>(<span id="ast-34">env_path</span>)</span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-36"><span id="ast-37"><span id="ast-38">abs_env_path</span>.startswith</span>(<span id="ast-39" class="other_trans">user_tht_root</span>)</span>:<span id="ast-40"><span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_env_path</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44">abs_env_path</span>.replace</span>(<span id="ast-45">user_tht_root</span>,&nbsp;<span id="ast-46" class="other_trans">tht_root</span>)</span></span><span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50"><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-52">(<span id="ast-53">'Redirecting&nbsp;env&nbsp;file&nbsp;%s&nbsp;to&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-55">(<span id="ast-56">abs_env_path</span>,&nbsp;<span id="ast-57">new_env_path</span>)</span>)</span>)</span></span><span id="ast-58"><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_path</span>&nbsp;=&nbsp;<span id="ast-60" class="other_trans">new_env_path</span></span></span><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-62"><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-64">files</span>,&nbsp;<span id="ast-65" class="other_trans">env</span>)</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68">template_utils</span>.process_environment_and_files</span>(env_path=<span id="ast-70">env_path</span>)</span></span><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-72"><span id="ast-73">hc_exc</span>.CommandError</span>&nbsp;as&nbsp;<span id="ast-74">ex</span>:<span id="ast-75"><span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-80">(<span id="ast-81">'Error&nbsp;%s&nbsp;processing&nbsp;environment&nbsp;file&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-83">(<span id="ast-84"><span id="ast-85"><span id="ast-86">six</span>.text_type</span>(<span id="ast-87" class="other_trans">ex</span>)</span>,&nbsp;<span id="ast-88">env_path</span>)</span>)</span>)</span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-90"><span id="ast-91" class="other_trans">open</span>(<span id="ast-92" class="other_trans">abs_env_path</span>,&nbsp;<span id="ast-93">'r'</span>)</span>&nbsp;as&nbsp;<span id="ast-94" class="other_trans">f</span>:<span id="ast-95"><span id="ast-96" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_map</span>&nbsp;=&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99">yaml</span>.safe_load</span>(<span id="ast-100">f</span>)</span></span></span><span id="ast-101"><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_registry</span>&nbsp;=&nbsp;<span id="ast-103"><span id="ast-104"><span id="ast-105" class="other_trans">env_map</span>.get</span>(<span id="ast-106">'resource_registry'</span>,&nbsp;<span id="ast-107">{}</span>)</span></span><span id="ast-108"><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_dirname</span>&nbsp;=&nbsp;<span id="ast-110"><span id="ast-111"><span id="ast-112"><span id="ast-113">os</span>.path</span>.dirname</span>(<span id="ast-114"><span id="ast-115"><span id="ast-116"><span id="ast-117" class="other_trans">os</span>.path</span>.abspath</span>(<span id="ast-118">env_path</span>)</span>)</span></span><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-120">(<span id="ast-121">rsrc</span>,&nbsp;<span id="ast-122">rsrc_path</span>)</span>&nbsp;in&nbsp;<span id="ast-123"><span id="ast-124"><span id="ast-125">six</span>.iteritems</span>(<span id="ast-126">env_registry</span>)</span>:<span id="ast-127"><span id="ast-128"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>abs_rsrc_path</span>&nbsp;=&nbsp;<span id="ast-129"><span id="ast-130"><span id="ast-131"><span id="ast-132">os</span>.path</span>.normpath</span>(<span id="ast-133"><span id="ast-134"><span id="ast-135"><span id="ast-136">os</span>.path</span>.join</span>(<span id="ast-137">env_dirname</span>,&nbsp;<span id="ast-138" class="other_trans">rsrc_path</span>)</span>)</span></span><span id="ast-139"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-140"><span id="ast-141"><span id="ast-142">abs_rsrc_path</span>.startswith</span>(<span id="ast-143" class="other_trans">user_tht_root</span>)</span>:<span id="ast-144"><span id="ast-145"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>new_rsrc_path</span>&nbsp;=&nbsp;<span id="ast-146"><span id="ast-147"><span id="ast-148" class="other_trans">abs_rsrc_path</span>.replace</span>(<span id="ast-149">user_tht_root</span>,&nbsp;<span id="ast-150">tht_root</span>)</span></span><span id="ast-151"><span id="ast-152"><span id="ast-153"><span id="ast-154"><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-156">(<span id="ast-157">'Rewriting&nbsp;%s&nbsp;%s&nbsp;path&nbsp;to&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-159">(<span id="ast-160">env_path</span>,&nbsp;<span id="ast-161" class="other_trans">rsrc</span>,&nbsp;<span id="ast-162" class="other_trans">new_rsrc_path</span>)</span>)</span>)</span></span><span id="ast-163"><span id="ast-164"><span id="ast-165" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_registry&nbsp;&rarr;&nbsp;env_map&nbsp;</span>[<span id="ast-166"><span id="ast-167" class="other_trans">rsrc</span></span>]</span>&nbsp;=&nbsp;<span id="ast-168" class="other_trans">new_rsrc_path</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-169"><span id="ast-170"><span id="ast-171"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_registry</span>[<span id="ast-172"><span id="ast-173" class="other_trans">rsrc</span></span>]</span>&nbsp;=&nbsp;<span id="ast-174" class="ref_node">rsrc_path&nbsp;&rarr;&nbsp;abs_rsrc_path&nbsp;</span></span></span></span><span id="ast-175"><span id="ast-176"><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_map</span>[<span id="ast-178"><span id="ast-179">'resource_registry'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-180" class="other_trans">env_registry</span></span><span id="ast-181"><span id="ast-182"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>f_name</span>&nbsp;=&nbsp;<span id="ast-183"><span id="ast-184"><span id="ast-185"><span id="ast-186">os</span>.path</span>.basename</span>(<span id="ast-187"><span id="ast-188"><span id="ast-189"><span id="ast-190"><span id="ast-191">os</span>.path</span>.splitext</span>(<span id="ast-192">abs_env_path</span>)</span>[<span id="ast-193"><span id="ast-194">0</span></span>]</span>)</span></span><span id="ast-195"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-196"><span id="ast-197"><span id="ast-198">tempfile</span>.NamedTemporaryFile</span>(dir=<span id="ast-200" class="other_trans">tht_root</span>,&nbsp;prefix=<span id="ast-202">(<span id="ast-203">'env-%s-'</span>&nbsp;%&nbsp;<span id="ast-205" class="other_trans">f_name</span>)</span>,&nbsp;suffix=<span id="ast-207">'.yaml'</span>,&nbsp;mode=<span id="ast-209">'w'</span>,&nbsp;delete=<span id="ast-211">cleanup</span>)</span>&nbsp;as&nbsp;<span id="ast-212" class="other_trans">f</span>:<span id="ast-213"><span id="ast-214"><span id="ast-215"><span id="ast-216"><span id="ast-217"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-218">(<span id="ast-219">'Rewriting&nbsp;%s&nbsp;environment&nbsp;to&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-221">(<span id="ast-222">env_path</span>,&nbsp;<span id="ast-223"><span id="ast-224">f</span>.name</span>)</span>)</span>)</span></span><span id="ast-225"><span id="ast-226"><span id="ast-227"><span id="ast-228" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>f</span>.write</span>(<span id="ast-229"><span id="ast-230"><span id="ast-231" class="other_trans">yaml</span>.safe_dump</span>(<span id="ast-232" class="other_trans">env_map</span>,&nbsp;default_flow_style=<span id="ast-234">False</span>)</span>)</span></span><span id="ast-235"><span id="ast-236"><span id="ast-237"><span id="ast-238" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>f</span>.flush</span>()</span></span><span id="ast-239"><span id="ast-240"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-241" class="other_trans">files</span>,&nbsp;<span id="ast-242">env</span>)</span>&nbsp;=&nbsp;<span id="ast-243"><span id="ast-244"><span id="ast-245">template_utils</span>.process_environment_and_files</span>(env_path=<span id="ast-247"><span id="ast-248">f</span>.name</span>)</span></span></span></span></span><span id="ast-249"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-250" class="other_trans">files</span>:<span id="ast-251"><span id="ast-252"><span id="ast-253"><span id="ast-254"><span id="ast-255"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-256">(<span id="ast-257">'Adding&nbsp;files&nbsp;%s&nbsp;for&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-259">(<span id="ast-260" class="other_trans">files</span>,&nbsp;<span id="ast-261" class="other_trans">env_path</span>)</span>)</span>)</span></span><span id="ast-262"><span id="ast-263"><span id="ast-264"><span id="ast-265" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env_files</span>.update</span>(<span id="ast-266">files</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;lzc_get_bookmarks(<span id="ast-2"><span id="ast-3" class="other_trans">fsname</span>,&nbsp;<span id="ast-4" class="other_trans">props</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Retrieve&nbsp;a&nbsp;list&nbsp;of&nbsp;bookmarks&nbsp;for&nbsp;the&nbsp;given&nbsp;file&nbsp;system.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;str&nbsp;fsname:&nbsp;a&nbsp;name&nbsp;of&nbsp;the&nbsp;filesystem.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;props:&nbsp;a&nbsp;`list`&nbsp;of&nbsp;properties&nbsp;that&nbsp;will&nbsp;be&nbsp;returned&nbsp;for&nbsp;each&nbsp;bookmark.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;props:&nbsp;list&nbsp;of&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return:&nbsp;a&nbsp;`dict`&nbsp;that&nbsp;maps&nbsp;the&nbsp;bookmarks'&nbsp;short&nbsp;names&nbsp;to&nbsp;their&nbsp;properties.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:rtype:&nbsp;dict&nbsp;of&nbsp;str:dict\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:raises&nbsp;FilesystemNotFound:&nbsp;if&nbsp;the&nbsp;filesystem&nbsp;is&nbsp;not&nbsp;found.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;following&nbsp;are&nbsp;valid&nbsp;properties&nbsp;on&nbsp;bookmarks:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;guid&nbsp;:&nbsp;integer\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;globally&nbsp;unique&nbsp;identifier&nbsp;of&nbsp;the&nbsp;snapshot&nbsp;the&nbsp;bookmark&nbsp;refers&nbsp;to\\u000a&nbsp;&nbsp;&nbsp;&nbsp;createtxg&nbsp;:&nbsp;integer\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txg&nbsp;when&nbsp;the&nbsp;snapshot&nbsp;the&nbsp;bookmark&nbsp;refers&nbsp;to&nbsp;was&nbsp;created\\u000a&nbsp;&nbsp;&nbsp;&nbsp;creation&nbsp;:&nbsp;integer\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timestamp&nbsp;when&nbsp;the&nbsp;snapshot&nbsp;the&nbsp;bookmark&nbsp;refers&nbsp;to&nbsp;was&nbsp;created\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>bmarks</span>&nbsp;=&nbsp;<span id="ast-9">{}</span></span><span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>props_dict</span>&nbsp;=&nbsp;<span id="ast-12">{<span id="ast-13" class="other_trans">name</span>:&nbsp;<span id="ast-14" class="other_trans">None</span><span id="ast-15">&nbsp;for&nbsp;<span id="ast-16" class="other_trans">name</span>&nbsp;in&nbsp;<span id="ast-17" class="other_trans">props</span></span>}</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-19"><span id="ast-20" class="other_trans">nvlist_in</span>(<span id="ast-21" class="other_trans">props_dict</span>)</span>&nbsp;as&nbsp;<span id="ast-22" class="other_trans">nvlist</span>:<span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-24"><span id="ast-25">nvlist_out</span>(<span id="ast-26" class="other_trans">bmarks</span>)</span>&nbsp;as&nbsp;<span id="ast-27" class="other_trans">bmarks_nvlist</span>:<span id="ast-28"><span id="ast-29" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ret</span>&nbsp;=&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32">_lib</span>.lzc_get_bookmarks</span>(<span id="ast-33" class="other_trans">fsname</span>,&nbsp;<span id="ast-34" class="other_trans">nvlist</span>,&nbsp;<span id="ast-35" class="other_trans">bmarks_nvlist</span>)</span></span></span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-37">(<span id="ast-38" class="other_trans">ret</span><span id="ast-39" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-40">0</span>)</span>:<span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44">{<span id="ast-45"><span id="ast-46" class="other_trans">errno</span>.ENOENT</span>:&nbsp;<span id="ast-47"><span id="ast-48">FilesystemNotFound</span>(<span id="ast-49" class="other_trans">fsname</span>)</span>}</span>.get</span>(<span id="ast-50" class="other_trans">ret</span>,&nbsp;<span id="ast-51"><span id="ast-52">genericException</span>(<span id="ast-53" class="other_trans">ret</span>,&nbsp;<span id="ast-54" class="location_node">name&nbsp;&rarr;&nbsp;fsname,&nbsp;pred:&nbsp;nvlist&nbsp;</span>,&nbsp;<span id="ast-55">'Failed&nbsp;to&nbsp;list&nbsp;bookmarks'</span>)</span>)</span></span></span><span id="ast-56"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-57" class="other_trans">bmarks</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;delete(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">resource</span>,&nbsp;<span id="ast-5" class="other_trans">user_id</span>,&nbsp;<span id="ast-6" class="other_trans">record_id</span></span>):<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>resource_name</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10" class="incorrect_node">classname&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-11" class="other_trans">resource</span>)</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>existing</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.get</span>(<span id="ast-17" class="other_trans">resource</span>,&nbsp;<span id="ast-18" class="other_trans">user_id</span>,&nbsp;<span id="ast-19" class="other_trans">record_id</span>)</span></span><span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._bump_timestamp</span>(<span id="ast-24" class="ref_node">resource_name&nbsp;&rarr;&nbsp;resource&nbsp;</span>,&nbsp;<span id="ast-25" class="other_trans">user_id</span>)</span></span><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31"><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._store</span>[<span id="ast-33"><span id="ast-34" class="other_trans">resource_name</span></span>]</span>[<span id="ast-35"><span id="ast-36" class="other_trans">user_id</span></span>]</span>.pop</span>(<span id="ast-37" class="other_trans">record_id</span>)</span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-39" class="other_trans">existing</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__call__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">cb</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-7" class="other_trans">parts</span>,&nbsp;<span id="ast-8" class="other_trans">badchar</span>)</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">process</span>.clinetoargv</span>(<span id="ast-12"><span id="ast-13">self</span>.cline</span>,&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.kwargs</span>[<span id="ast-17"><span id="ast-18">'cwd'</span></span>]</span>)</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-20">(<span id="ast-21" class="other_trans">parts</span><span id="ast-22" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-23" class="other_trans">None</span>)</span>:<span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-25"><span id="ast-26" class="other_trans">DataError</span>(<span id="ast-27">(<span id="ast-28">"native&nbsp;command&nbsp;'%s':&nbsp;shell&nbsp;metacharacter&nbsp;'%s'&nbsp;in&nbsp;command&nbsp;line"</span>&nbsp;%&nbsp;<span id="ast-30">(<span id="ast-31" class="correct_node">cline&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-32" class="other_trans">badchar</span>)</span>)</span>,&nbsp;<span id="ast-33"><span id="ast-34">self</span>.loc</span>)</span></span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-36">(<span id="ast-37"><span id="ast-38" class="other_trans">len</span>(<span id="ast-39" class="other_trans">parts</span>)</span><span id="ast-40" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-41">2</span>)</span>:<span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-43"><span id="ast-44" class="other_trans">DataError</span>(<span id="ast-45">(<span id="ast-46">"native&nbsp;command&nbsp;'%s':&nbsp;no&nbsp;method&nbsp;name&nbsp;specified"</span>&nbsp;%&nbsp;<span id="ast-48" class="other_trans">cline</span>)</span>,&nbsp;<span id="ast-49"><span id="ast-50">self</span>.loc</span>)</span></span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>module</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">parts</span>[<span id="ast-55"><span id="ast-56">0</span></span>]</span></span><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>method</span>&nbsp;=&nbsp;<span id="ast-59"><span id="ast-60" class="other_trans">parts</span>[<span id="ast-61"><span id="ast-62">1</span></span>]</span></span><span id="ast-63"><span id="ast-64" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cline_list</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">parts</span>[<span id="ast-67"><span id="ast-68">2</span>:</span>]</span></span><span id="ast-69"><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.usercb</span>&nbsp;=&nbsp;<span id="ast-72" class="other_trans">cb</span></span><span id="ast-73"><span id="ast-74"><span id="ast-75"><span id="ast-76" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>process</span>.call_native</span>(<span id="ast-77" class="other_trans">module</span>,&nbsp;<span id="ast-78" class="other_trans">method</span>,&nbsp;<span id="ast-79" class="other_trans">cline_list</span>,&nbsp;loc=<span id="ast-81"><span id="ast-82">self</span>.loc</span>,&nbsp;cb=<span id="ast-84"><span id="ast-85">self</span>._cb</span>,&nbsp;context=<span id="ast-87"><span id="ast-88">self</span>.context</span>,&nbsp;pycommandpath=<span id="ast-90"><span id="ast-91">self</span>.pycommandpath</span>,&nbsp;**<span id="ast-92"><span id="ast-93">self</span>.kwargs</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;search(<span id="ast-2"><span id="ast-3" class="other_trans">cls</span>,&nbsp;<span id="ast-4" class="other_trans">schema</span>,&nbsp;<span id="ast-5" class="other_trans">query</span>,&nbsp;<span id="ast-6" class="other_trans">search_opts</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Search&nbsp;for&nbsp;prefixes.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>xmlrpc</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12" class="other_trans">XMLRPCConnection</span>()</span></span><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>search_result</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans">xmlrpc</span>.connection</span>.search_prefix</span>(<span id="ast-19">{<span id="ast-20">'id'</span>:&nbsp;<span id="ast-21"><span id="ast-22" class="other_trans">schema</span>.id</span>}</span>,&nbsp;<span id="ast-23" class="other_trans">query</span>,&nbsp;<span id="ast-24" class="other_trans">search_opts</span>)</span></span><span id="ast-25"><span id="ast-26" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>&nbsp;=&nbsp;<span id="ast-27"><span id="ast-28" class="other_trans">dict</span>()</span></span><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>[<span id="ast-32"><span id="ast-33">'result'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-34">[]</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>[<span id="ast-38"><span id="ast-39">'search_options'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-40"><span id="ast-41" class="other_trans">search_result</span>[<span id="ast-42"><span id="ast-43">'search_options'</span></span>]</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-45" class="other_trans">prefix</span>&nbsp;in&nbsp;<span id="ast-46"><span id="ast-47" class="correct_node">result&nbsp;&rarr;&nbsp;search_result&nbsp;</span>[<span id="ast-48"><span id="ast-49">'prefix_list'</span></span>]</span>:<span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>p</span>&nbsp;=&nbsp;<span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans">Prefix</span>.from_dict</span>(<span id="ast-55" class="other_trans">prefix</span>)</span></span><span id="ast-56"><span id="ast-57"><span id="ast-58"><span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>result</span>[<span id="ast-61"><span id="ast-62">'result'</span></span>]</span>.append</span>(<span id="ast-63" class="other_trans">p</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_password(<span id="ast-2"><span id="ast-3">username</span>,&nbsp;<span id="ast-4" class="other_trans">resource</span>,&nbsp;<span id="ast-5" class="other_trans">_lock</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"tries&nbsp;to&nbsp;access&nbsp;saved&nbsp;password&nbsp;or&nbsp;asks&nbsp;user&nbsp;for&nbsp;it\\u000a&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;try&nbsp;the&nbsp;following&nbsp;in&nbsp;this&nbsp;order:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;read&nbsp;password&nbsp;from&nbsp;netrc&nbsp;(and&nbsp;only&nbsp;the&nbsp;password,&nbsp;username\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;netrc&nbsp;will&nbsp;be&nbsp;ignored)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;read&nbsp;password&nbsp;from&nbsp;keyring&nbsp;(keyring&nbsp;needs&nbsp;to&nbsp;be&nbsp;installed)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3a&nbsp;ask&nbsp;user&nbsp;for&nbsp;the&nbsp;password\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;save&nbsp;in&nbsp;keyring&nbsp;if&nbsp;installed&nbsp;and&nbsp;user&nbsp;agrees\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;username:&nbsp;user's&nbsp;name&nbsp;on&nbsp;the&nbsp;server\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;username:&nbsp;str/unicode\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;resource:&nbsp;a&nbsp;resource&nbsp;to&nbsp;which&nbsp;the&nbsp;user&nbsp;has&nbsp;access&nbsp;via&nbsp;password,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;be&nbsp;shortened&nbsp;to&nbsp;just&nbsp;the&nbsp;hostname.&nbsp;It&nbsp;is&nbsp;assumed\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;each&nbsp;unique&nbsp;username/hostname&nbsp;combination&nbsp;only&nbsp;ever\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uses&nbsp;the&nbsp;same&nbsp;password.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;resource:&nbsp;str/unicode\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:return:&nbsp;password\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:rtype:&nbsp;str/unicode\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12" class="other_trans">ctx</span>:<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password_cache</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans">ctx</span>.obj</span>.setdefault</span>(<span id="ast-19">'passwords'</span>,&nbsp;<span id="ast-20">{}</span>)</span></span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-22" class="other_trans">_lock</span>:<span id="ast-23"><span id="ast-24" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>host</span>&nbsp;=&nbsp;<span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28">urlparse</span>.urlsplit</span>(<span id="ast-29" class="other_trans">resource</span>)</span>.hostname</span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-31" class="other_trans">func</span>&nbsp;in&nbsp;<span id="ast-32">(<span id="ast-33">_password_from_cache</span>,&nbsp;<span id="ast-34">_password_from_netrc</span>,&nbsp;<span id="ast-35" class="other_trans">_password_from_keyring</span>)</span>:<span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password</span>&nbsp;=&nbsp;<span id="ast-38"><span id="ast-39" class="other_trans">func</span>(<span id="ast-40" class="other_trans">username</span>,&nbsp;<span id="ast-41" class="other_trans">host</span>)</span></span><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-43">(<span id="ast-44" class="other_trans">password</span><span id="ast-45" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-46">None</span>)</span>:<span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.debug</span>(<span id="ast-51"><span id="ast-52"><span id="ast-53">'Got&nbsp;password&nbsp;for&nbsp;{}&nbsp;from&nbsp;{}'</span>.format</span>(<span id="ast-54" class="other_trans">username</span>,&nbsp;<span id="ast-55"><span id="ast-56" class="other_trans">func</span>.__doc__</span>)</span>)</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-58" class="other_trans">password</span></span></span></span><span id="ast-59"><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>prompt</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">'Server&nbsp;password&nbsp;for&nbsp;{}&nbsp;at&nbsp;host&nbsp;{}'</span>.format</span>(<span id="ast-64" class="other_trans">username</span>,&nbsp;<span id="ast-65">host</span>)</span></span><span id="ast-66"><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70">click</span>.prompt</span>(<span id="ast-71">prompt</span>,&nbsp;hide_input=<span id="ast-73">True</span>)</span></span><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-75">(<span id="ast-77">ctx</span>&nbsp;and&nbsp;<span id="ast-78">(<span id="ast-79" class="incorrect_node">func&nbsp;&rarr;&nbsp;password&nbsp;</span><span id="ast-80" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-81" class="other_trans">_password_from_cache</span>)</span>)</span>:<span id="ast-82"><span id="ast-83"><span id="ast-84" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>password_cache</span>[<span id="ast-85"><span id="ast-86">(<span id="ast-87" class="other_trans">username</span>,&nbsp;<span id="ast-88" class="other_trans">host</span>)</span></span>]</span>&nbsp;=&nbsp;<span id="ast-89" class="other_trans">password</span></span><span id="ast-90"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-91">(<span id="ast-93">(<span id="ast-94" class="other_trans">keyring</span><span id="ast-95" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-96" class="other_trans">None</span>)</span>&nbsp;and&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99">click</span>.confirm</span>(<span id="ast-100">'Save&nbsp;this&nbsp;password&nbsp;in&nbsp;the&nbsp;keyring?'</span>,&nbsp;default=<span id="ast-102">False</span>)</span>)</span>:<span id="ast-103"><span id="ast-104"><span id="ast-105"><span id="ast-106" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>keyring</span>.set_password</span>(<span id="ast-107">(<span id="ast-108" class="other_trans">password_key_prefix</span>&nbsp;+&nbsp;<span id="ast-110" class="ref_node">resource&nbsp;&rarr;&nbsp;host&nbsp;</span>)</span>,&nbsp;<span id="ast-111" class="other_trans">username</span>,&nbsp;<span id="ast-112" class="other_trans">password</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_response_matches_request(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">response</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Return&nbsp;true&nbsp;if&nbsp;the&nbsp;response&nbsp;is&nbsp;to&nbsp;a&nbsp;diagnostic&nbsp;request,&nbsp;and&nbsp;the&nbsp;bus,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;id,&nbsp;mode&nbsp;match.&nbsp;If&nbsp;the&nbsp;request&nbsp;was&nbsp;successful,&nbsp;the&nbsp;PID&nbsp;echo&nbsp;is&nbsp;also\\u000a&nbsp;&nbsp;&nbsp;&nbsp;checked.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8">(<span id="ast-10">(<span id="ast-11">'bus'</span><span id="ast-12">&nbsp;in&nbsp;</span><span id="ast-13"><span id="ast-14">self</span>.diagnostic_request</span>)</span>&nbsp;and&nbsp;<span id="ast-15">(<span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans">response</span>.get</span>(<span id="ast-19">'bus'</span>,&nbsp;<span id="ast-20" class="other_trans">None</span>)</span><span id="ast-21" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-22"><span id="ast-23"><span id="ast-24">self</span>.diagnostic_request</span>[<span id="ast-25"><span id="ast-26">'bus'</span></span>]</span>)</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-28">False</span></span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30">(<span id="ast-32">(<span id="ast-33"><span id="ast-34"><span id="ast-35">self</span>.diagnostic_request</span>[<span id="ast-36"><span id="ast-37">'id'</span></span>]</span><span id="ast-38" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-39">2015</span>)</span>&nbsp;and&nbsp;<span id="ast-40">(<span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans">response</span>.get</span>(<span id="ast-44">'id'</span>,&nbsp;<span id="ast-45" class="other_trans">None</span>)</span><span id="ast-46" class="correct_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-47"><span id="ast-48"><span id="ast-49">self</span>.diagnostic_request</span>[<span id="ast-50"><span id="ast-51">'id'</span></span>]</span>)</span>)</span>:<span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-53">False</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;ping(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Keep-alive&nbsp;for&nbsp;the&nbsp;farmer.&nbsp;Validation&nbsp;can&nbsp;take&nbsp;a&nbsp;long&nbsp;time,&nbsp;so\\u000a&nbsp;&nbsp;&nbsp;&nbsp;we&nbsp;just&nbsp;want&nbsp;to&nbsp;know&nbsp;if&nbsp;they&nbsp;are&nbsp;still&nbsp;there.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>farmer</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>.lookup</span>()</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>time_limit</span>&nbsp;=&nbsp;<span id="ast-13">(<span id="ast-14"><span id="ast-15">(<span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans">datetime</span>.utcnow</span>()</span>&nbsp;-&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">farmer</span>.last_seen</span>)</span>.seconds</span><span id="ast-22" class="location_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-23"><span id="ast-24"><span id="ast-25" class="other_trans">app</span>.config</span>[<span id="ast-26"><span id="ast-27">'MAX_PING'</span></span>]</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;pop(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Get&nbsp;the&nbsp;next&nbsp;request'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>now</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">time</span>.time</span>()</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-12">True</span>:<span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-15">next</span>,&nbsp;<span id="ast-16" class="other_trans">when</span>)</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20">self</span>.pldQueue</span>.peek</span>(withscores=<span id="ast-22">True</span>)</span></span><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-24">(<span id="ast-25">not</span>&nbsp;<span id="ast-26" class="other_trans">next</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-28" class="other_trans">None</span></span></span><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-30">(<span id="ast-31" class="other_trans">when</span><span id="ast-32" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-33" class="other_trans">now</span>)</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-35">(<span id="ast-36"><span id="ast-37">self</span>.timer</span><span id="ast-38" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-39">None</span>)</span>:<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.debug</span>(<span id="ast-44">(<span id="ast-45">'Waiting&nbsp;%f&nbsp;seconds'</span>&nbsp;%&nbsp;<span id="ast-47">(<span id="ast-48" class="other_trans">when</span>&nbsp;-&nbsp;<span id="ast-50" class="other_trans">now</span>)</span>)</span>)</span></span><span id="ast-51"><span id="ast-52"><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.timer</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55"><span id="ast-56" class="other_trans">reactor</span>.callLater</span>(<span id="ast-57">(<span id="ast-58">when</span>&nbsp;-&nbsp;<span id="ast-60" class="other_trans">now</span>)</span>,&nbsp;<span id="ast-61"><span id="ast-62">self</span>.serveNext</span>)</span></span></span><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-64">None</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-65"><span id="ast-66" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>next</span>&nbsp;=&nbsp;<span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70">self</span>.pldQueue</span>.pop</span>()</span></span><span id="ast-71"><span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.timer</span>&nbsp;=&nbsp;<span id="ast-74">None</span></span><span id="ast-75"><span id="ast-76" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>q</span>&nbsp;=&nbsp;<span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans">qr</span>.Queue</span>(<span id="ast-80" class="other_trans">next</span>)</span></span><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-82"><span id="ast-83" class="other_trans">len</span>(<span id="ast-84" class="other_trans">q</span>)</span>:<span id="ast-85"><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>robot</span>&nbsp;=&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89">reppy</span>.findRobot</span>(<span id="ast-90" class="location_node">v&nbsp;&rarr;&nbsp;next,&nbsp;pred:&nbsp;when&nbsp;</span>)</span></span><span id="ast-91"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-92">(<span id="ast-94"><span id="ast-95">self</span>.allowAll</span>&nbsp;and&nbsp;<span id="ast-96">(<span id="ast-98">(<span id="ast-99">not</span>&nbsp;<span id="ast-100" class="other_trans">robot</span>)</span>&nbsp;or&nbsp;<span id="ast-101"><span id="ast-102" class="other_trans">robot</span>.expired</span>)</span>)</span>:<span id="ast-103"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-104"><span id="ast-105" class="other_trans">RobotsRequest</span>(<span id="ast-106">(<span id="ast-107">(<span id="ast-108">'http://'</span>&nbsp;+&nbsp;<span id="ast-110" class="other_trans">v</span>)</span>&nbsp;+&nbsp;<span id="ast-112">'/robots.txt'</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-113"><span id="ast-114" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>v</span>&nbsp;=&nbsp;<span id="ast-115"><span id="ast-116"><span id="ast-117" class="other_trans">q</span>.pop</span>()</span></span><span id="ast-118"><span id="ast-119"><span id="ast-120" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>v</span>._originalKey</span>&nbsp;=&nbsp;<span id="ast-121" class="other_trans">next</span></span><span id="ast-122"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-123" class="other_trans">v</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span></span></span><span id="ast-125"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-126">None</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_buildMetadata(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;set&nbsp;up&nbsp;capabilities&nbsp;metadata&nbsp;objects&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>serviceelem</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>._capabilities</span>.find</span>(<span id="ast-12">'Service'</span>)</span></span><span id="ast-13"><span id="ast-14"><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.identification</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17" class="other_trans">ServiceIdentification</span>(<span id="ast-18">serviceelem</span>,&nbsp;<span id="ast-19"><span id="ast-20">self</span>.version</span>)</span></span><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.provider</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25" class="other_trans">ServiceProvider</span>(<span id="ast-26">serviceelem</span>)</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.operations</span>&nbsp;=&nbsp;<span id="ast-30">[]</span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-32" class="other_trans">elem</span>&nbsp;in&nbsp;<span id="ast-33"><span id="ast-34"><span id="ast-35"><span id="ast-36"><span id="ast-37">self</span>._capabilities</span>.find</span>(<span id="ast-38">'Capability/Request'</span>)</span>[<span id="ast-39">:</span>]</span>:<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.operations</span>.append</span>(<span id="ast-45"><span id="ast-46" class="other_trans">OperationMetadata</span>(<span id="ast-47" class="other_trans">elem</span>)</span>)</span></span></span><span id="ast-48"><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.contents</span>&nbsp;=&nbsp;<span id="ast-51">{}</span></span><span id="ast-52"><span id="ast-53" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>caps</span>&nbsp;=&nbsp;<span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57">self</span>._capabilities</span>.find</span>(<span id="ast-58">'Capability'</span>)</span></span><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-60" class="other_trans">elem</span>&nbsp;in&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">caps</span>.findall</span>(<span id="ast-64">'Layer'</span>)</span>:<span id="ast-65"><span id="ast-66" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>cm</span>&nbsp;=&nbsp;<span id="ast-67"><span id="ast-68" class="other_trans">ContentMetadata</span>(<span id="ast-69">elem</span>)</span></span><span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.contents</span>[<span id="ast-74"><span id="ast-75"><span id="ast-76" class="other_trans">cm</span>.id</span></span>]</span>&nbsp;=&nbsp;<span id="ast-77" class="other_trans">cm</span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-79" class="other_trans">subelem</span>&nbsp;in&nbsp;<span id="ast-80"><span id="ast-81"><span id="ast-82" class="other_trans">elem</span>.findall</span>(<span id="ast-83">'Layer'</span>)</span>:<span id="ast-84"><span id="ast-85" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subcm</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-87">ContentMetadata</span>(<span id="ast-88" class="other_trans">subelem</span>,&nbsp;<span id="ast-89" class="other_trans">cm</span>)</span></span><span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.contents</span>[<span id="ast-94"><span id="ast-95"><span id="ast-96" class="other_trans">subcm</span>.id</span></span>]</span>&nbsp;=&nbsp;<span id="ast-97" class="other_trans">subcm</span></span><span id="ast-98"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-99" class="other_trans">subsubelem</span>&nbsp;in&nbsp;<span id="ast-100"><span id="ast-101"><span id="ast-102" class="other_trans">subelem</span>.findall</span>(<span id="ast-103">'Layer'</span>)</span>:<span id="ast-104"><span id="ast-105" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>subsubcm</span>&nbsp;=&nbsp;<span id="ast-106"><span id="ast-107">ContentMetadata</span>(<span id="ast-108">subsubelem</span>,&nbsp;<span id="ast-109" class="correct_node">cm&nbsp;&rarr;&nbsp;subcm&nbsp;</span>)</span></span><span id="ast-110"><span id="ast-111"><span id="ast-112"><span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.contents</span>[<span id="ast-114"><span id="ast-115"><span id="ast-116">subsubcm</span>.id</span></span>]</span>&nbsp;=&nbsp;<span id="ast-117" class="other_trans">subsubcm</span></span></span></span></span><span id="ast-118"><span id="ast-119"><span id="ast-120"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.exceptions</span>&nbsp;=&nbsp;<span id="ast-121">[<span id="ast-122"><span id="ast-123" class="other_trans">f</span>.text</span><span id="ast-124">&nbsp;for&nbsp;<span id="ast-125" class="other_trans">f</span>&nbsp;in&nbsp;<span id="ast-126"><span id="ast-127"><span id="ast-128"><span id="ast-129">self</span>._capabilities</span>.findall</span>(<span id="ast-130">'Capability/Exception/Format'</span>)</span></span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;open(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">name</span>,&nbsp;<span id="ast-5" class="other_trans">mode</span>,&nbsp;*args,&nbsp;**kwargs</span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Find&nbsp;a&nbsp;resource&nbsp;and&nbsp;return&nbsp;a&nbsp;file&nbsp;object,&nbsp;or&nbsp;raise&nbsp;IOError.&nbsp;'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>fname</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>.lookup</span>(<span id="ast-14" class="other_trans">name</span>)</span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16">(<span id="ast-17">not</span>&nbsp;<span id="ast-18" class="other_trans">fname</span>)</span>:<span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">IOError</span>(<span id="ast-22">(<span id="ast-23">'Resource&nbsp;%r&nbsp;not&nbsp;found.'</span>&nbsp;%&nbsp;<span id="ast-25" class="other_trans">name</span>)</span>)</span></span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-27"><span id="ast-28"><span id="ast-29">self</span>.opener</span>(<span id="ast-30" class="correct_node">name&nbsp;&rarr;&nbsp;fname&nbsp;</span>,&nbsp;mode=<span id="ast-32" class="other_trans">mode</span>,&nbsp;*<span id="ast-33" class="other_trans">args</span>,&nbsp;**<span id="ast-34" class="other_trans">kwargs</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_reconnect_delay(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;Calculate&nbsp;reconnection&nbsp;delay.&nbsp;'</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-9"><span id="ast-10">self</span>.RECONNECT_ON_ERROR</span>&nbsp;and&nbsp;<span id="ast-11"><span id="ast-12">self</span>.RECONNECT_DELAYED</span>)</span>:<span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-14">(<span id="ast-15"><span id="ast-16">self</span>._reconnect_attempts</span><span id="ast-17" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-18"><span id="ast-19" class="other_trans">len</span>(<span id="ast-20"><span id="ast-21">self</span>.RECONNECT_DELAYS</span>)</span>)</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-23"><span id="ast-24"><span id="ast-25">self</span>.RECONNECT_DELAYS</span>[<span id="ast-26"><span id="ast-27">-1</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-29"><span id="ast-30"><span id="ast-31">self</span>.RECONNECT_DELAYS</span>[<span id="ast-32"><span id="ast-33"><span id="ast-34">self</span>._reconnect_attempts</span></span>]</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-36">0</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;runTest(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;most&nbsp;basic&nbsp;python&nbsp;test&nbsp;possible,&nbsp;checks&nbsp;that&nbsp;the&nbsp;files&nbsp;we&nbsp;have&nbsp;written\\u000a&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;importable&nbsp;in&nbsp;python,&nbsp;this&nbsp;is&nbsp;a&nbsp;basic&nbsp;sanity&nbsp;check\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;=&nbsp;<span id="ast-8">[]</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-10">(<span id="ast-11" class="other_trans">root</span>,&nbsp;<span id="ast-12">dirs</span>,&nbsp;<span id="ast-13">files</span>)</span>&nbsp;in&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">os</span>.walk</span>(<span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20">os</span>.path</span>.realpath</span>(<span id="ast-21">(<span id="ast-22">__file__</span>&nbsp;+&nbsp;<span id="ast-24">'/../../../'</span>)</span>)</span>)</span>:<span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-27">'.git'</span><span id="ast-28">&nbsp;in&nbsp;</span><span id="ast-29">root</span>)</span>:<span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-32" class="other_trans">f</span>&nbsp;in&nbsp;<span id="ast-33">files</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-35">(<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">f</span>.endswith</span>(<span id="ast-40">'.png'</span>)</span>&nbsp;or&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans">f</span>.endswith</span>(<span id="ast-44">'.ppt'</span>)</span>&nbsp;or&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47" class="other_trans">f</span>.endswith</span>(<span id="ast-48">'.pptx'</span>)</span>&nbsp;or&nbsp;<span id="ast-49"><span id="ast-50"><span id="ast-51">f</span>.endswith</span>(<span id="ast-52">'.css'</span>)</span>&nbsp;or&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55">f</span>.endswith</span>(<span id="ast-56">'.svg'</span>)</span>&nbsp;or&nbsp;<span id="ast-57"><span id="ast-58"><span id="ast-59" class="other_trans">f</span>.endswith</span>(<span id="ast-60">'.jpeg'</span>)</span>&nbsp;or&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">f</span>.endswith</span>(<span id="ast-64">'.jpg'</span>)</span>&nbsp;or&nbsp;<span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans">f</span>.endswith</span>(<span id="ast-68">'.bmp'</span>)</span>&nbsp;or&nbsp;<span id="ast-69"><span id="ast-70"><span id="ast-71">f</span>.endswith</span>(<span id="ast-72">'.pdf'</span>)</span>&nbsp;or&nbsp;<span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans">f</span>.endswith</span>(<span id="ast-76">'.pyc'</span>)</span>)</span>:<span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-79">(<span id="ast-80" class="other_trans">f</span><span id="ast-81">&nbsp;in&nbsp;</span><span id="ast-82"><span id="ast-83">self</span>.ignore</span>)</span>:<span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-85"><span id="ast-86" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;=&nbsp;<span id="ast-87">(<span id="ast-88" class="other_trans">found</span>&nbsp;+&nbsp;<span id="ast-90"><span id="ast-91"><span id="ast-92">self</span>.findversion</span>(<span id="ast-93"><span id="ast-94"><span id="ast-95"><span id="ast-96" class="other_trans">os</span>.path</span>.join</span>(<span id="ast-97">root</span>,&nbsp;<span id="ast-98" class="other_trans">f</span>)</span>)</span>)</span></span></span></span><span id="ast-99"><span id="ast-100" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;=&nbsp;<span id="ast-101">[<span id="ast-102">i</span><span id="ast-103">&nbsp;for&nbsp;<span id="ast-104">i</span>&nbsp;in&nbsp;<span id="ast-105">found</span>&nbsp;if&nbsp;<span id="ast-106">(<span id="ast-108">(<span id="ast-109" class="other_trans">i</span><span id="ast-110" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-111">None</span>)</span>&nbsp;and&nbsp;<span id="ast-112"><span id="ast-113">len</span>(<span id="ast-114" class="ref_node">found&nbsp;&rarr;&nbsp;i&nbsp;</span>)</span>)</span></span>]</span></span><span id="ast-115"><span id="ast-116" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>ifound</span>&nbsp;=&nbsp;<span id="ast-117">[]</span></span><span id="ast-118"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-119" class="other_trans">f</span>&nbsp;in&nbsp;<span id="ast-120" class="other_trans">found</span>:<span id="ast-121"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-122">(<span id="ast-124"><span id="ast-125"><span id="ast-126"><span id="ast-127" class="other_trans">f</span>[<span id="ast-128"><span id="ast-129">0</span></span>]</span>.endswith</span>(<span id="ast-130">'Welcome.banner'</span>)</span>&nbsp;and&nbsp;<span id="ast-131">(<span id="ast-133"><span id="ast-134"><span id="ast-135"><span id="ast-136">self</span>.checkAgainst</span>.endswith</span>(<span id="ast-137">'-Pre'</span>)</span>&nbsp;and&nbsp;<span id="ast-138">(<span id="ast-139">not</span>&nbsp;<span id="ast-140"><span id="ast-141"><span id="ast-142"><span id="ast-143"><span id="ast-144" class="other_trans">f</span>[<span id="ast-145"><span id="ast-146">-1</span></span>]</span>[<span id="ast-147"><span id="ast-148">0</span></span>]</span>.endswith</span>(<span id="ast-149">'-Pre'</span>)</span>)</span>)</span>)</span>:<span id="ast-150"><span id="ast-151"><span id="ast-152"><span id="ast-153"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ifound</span>.append</span>(<span id="ast-154">(<span id="ast-155"><span id="ast-156">f</span>[<span id="ast-157"><span id="ast-158">0</span></span>]</span>,&nbsp;<span id="ast-159"><span id="ast-160">f</span>[<span id="ast-161"><span id="ast-162">1</span></span>]</span>,&nbsp;<span id="ast-163">(<span id="ast-164">(<span id="ast-165"><span id="ast-166"><span id="ast-167">f</span>[<span id="ast-168"><span id="ast-169">2</span></span>]</span>[<span id="ast-170"><span id="ast-171">0</span></span>]</span>&nbsp;+&nbsp;<span id="ast-173">'-Pre'</span>)</span>,&nbsp;<span id="ast-174">'-Pre'</span>)</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-175"><span id="ast-176"><span id="ast-177"><span id="ast-178" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ifound</span>.append</span>(<span id="ast-179" class="other_trans">f</span>)</span></span></span></span><span id="ast-180"><span id="ast-181" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>found</span>&nbsp;=&nbsp;<span id="ast-182">ifound</span></span><span id="ast-183"><span id="ast-184" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>foundn</span>&nbsp;=&nbsp;<span id="ast-185">[<span id="ast-186"><span id="ast-187"><span id="ast-188">i</span>[<span id="ast-189"><span id="ast-190">-1</span></span>]</span>[<span id="ast-191"><span id="ast-192">0</span></span>]</span><span id="ast-193">&nbsp;for&nbsp;<span id="ast-194">i</span>&nbsp;in&nbsp;<span id="ast-195">found</span></span>]</span></span><span id="ast-196"><span id="ast-197"><span id="ast-198"><span id="ast-199"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.assertTrue</span>(<span id="ast-200">(<span id="ast-201"><span id="ast-202">len</span>(<span id="ast-203"><span id="ast-204" class="other_trans">set</span>(<span id="ast-205">foundn</span>)</span>)</span><span id="ast-206" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-207">1</span>)</span>,&nbsp;<span id="ast-208">(<span id="ast-209">'Mis-matching&nbsp;version&nbsp;numbers&nbsp;found!&nbsp;\\u000a\\u0009'</span>&nbsp;+&nbsp;<span id="ast-211"><span id="ast-212"><span id="ast-213">'\\u000a\\u0009'</span>.join</span>(<span id="ast-214">[<span id="ast-215"><span id="ast-216">str</span>(<span id="ast-217" class="other_trans">i</span>)</span><span id="ast-218">&nbsp;for&nbsp;<span id="ast-219" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-220">found</span></span>]</span>)</span>)</span>)</span></span><span id="ast-221"><span id="ast-222" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>foundp</span>&nbsp;=&nbsp;<span id="ast-223">[<span id="ast-224" class="other_trans">i</span><span id="ast-225">&nbsp;for&nbsp;<span id="ast-226" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-227">foundn</span>&nbsp;if&nbsp;<span id="ast-228">(<span id="ast-229" class="other_trans">i</span><span id="ast-230" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-231"><span id="ast-232">self</span>.checkAgainst</span>)</span></span>]</span></span><span id="ast-233"><span id="ast-234"><span id="ast-235"><span id="ast-236"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.assertFalse</span>(<span id="ast-237"><span id="ast-238">len</span>(<span id="ast-239"><span id="ast-240">set</span>(<span id="ast-241" class="incorrect_node">foundp&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span>)</span>,&nbsp;<span id="ast-242">(<span id="ast-243">(<span id="ast-244">(<span id="ast-245">'Versions&nbsp;match,&nbsp;but&nbsp;are&nbsp;not&nbsp;what&nbsp;was&nbsp;expected:&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-247"><span id="ast-248">self</span>.checkAgainst</span>)</span>&nbsp;+&nbsp;<span id="ast-250">'&nbsp;\\u000a\\u0009'</span>)</span>&nbsp;+&nbsp;<span id="ast-252"><span id="ast-253"><span id="ast-254">'\\u000a\\u0009'</span>.join</span>(<span id="ast-255">[<span id="ast-256"><span id="ast-257">str</span>(<span id="ast-258">i</span>)</span><span id="ast-259">&nbsp;for&nbsp;<span id="ast-260" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-261">found</span></span>]</span>)</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">conano_filepath</span>,&nbsp;<span id="ast-5" class="other_trans">name</span>,&nbsp;<span id="ast-7" class="other_trans">namespace</span>,&nbsp;<span id="ast-9" class="other_trans">check_validity</span>,&nbsp;<span id="ast-11" class="other_trans">precedence</span>,&nbsp;<span id="ast-13" class="other_trans">connected</span></span>):<span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;reads&nbsp;a&nbsp;Conano&nbsp;XML&nbsp;file&nbsp;and&nbsp;converts&nbsp;it&nbsp;into&nbsp;a&nbsp;multidigraph.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;conano_filepath&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative&nbsp;or&nbsp;absolute&nbsp;path&nbsp;to&nbsp;a&nbsp;Conano&nbsp;XML&nbsp;file\\u000a&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;:&nbsp;str&nbsp;or&nbsp;None\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;name&nbsp;or&nbsp;ID&nbsp;of&nbsp;the&nbsp;graph&nbsp;to&nbsp;be&nbsp;generated.&nbsp;If&nbsp;no&nbsp;name&nbsp;is\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given,&nbsp;the&nbsp;basename&nbsp;of&nbsp;the&nbsp;input&nbsp;file&nbsp;is&nbsp;used.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;namespace&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;namespace&nbsp;of&nbsp;the&nbsp;graph&nbsp;(default:&nbsp;conano)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;check_validity&nbsp;:&nbsp;bool\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checks,&nbsp;if&nbsp;the&nbsp;tokenization&nbsp;in&nbsp;the&nbsp;graph&nbsp;matches&nbsp;the&nbsp;one&nbsp;in\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;Conano&nbsp;file&nbsp;(converted&nbsp;to&nbsp;plain&nbsp;text)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;precedence&nbsp;:&nbsp;bool\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;precedence&nbsp;relation&nbsp;edges&nbsp;(root&nbsp;precedes&nbsp;token1,&nbsp;which&nbsp;precedes\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token2&nbsp;etc.)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;connected&nbsp;:&nbsp;bool\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Make&nbsp;the&nbsp;graph&nbsp;connected,&nbsp;i.e.&nbsp;add&nbsp;an&nbsp;edge&nbsp;from&nbsp;root&nbsp;to&nbsp;each\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token&nbsp;that&nbsp;isn't&nbsp;part&nbsp;of&nbsp;any&nbsp;span.&nbsp;This&nbsp;doesn't&nbsp;do&nbsp;anything,&nbsp;if\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;precendence=True.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>super</span>(<span id="ast-22" class="other_trans">DiscourseDocumentGraph</span>,&nbsp;<span id="ast-23">self</span>)</span>.__init__</span>()</span></span><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-25">(<span id="ast-26" class="other_trans">name</span><span id="ast-27" class="correct_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-28" class="other_trans">None</span>)</span>:<span id="ast-29"><span id="ast-30"><span id="ast-31"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.name</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34"><span id="ast-35" class="other_trans">os</span>.path</span>.basename</span>(<span id="ast-36" class="other_trans">conano_filepath</span>)</span></span></span><span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ns</span>&nbsp;=&nbsp;<span id="ast-40" class="other_trans">namespace</span></span><span id="ast-41"><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.root</span>&nbsp;=&nbsp;<span id="ast-44">(<span id="ast-45"><span id="ast-46">self</span>.ns</span>&nbsp;+&nbsp;<span id="ast-48">':root_node'</span>)</span></span><span id="ast-49"><span id="ast-50"><span id="ast-51"><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.add_node</span>(<span id="ast-53"><span id="ast-54">self</span>.root</span>,&nbsp;layers=<span id="ast-56">{<span id="ast-57"><span id="ast-58">self</span>.ns</span>}</span>)</span></span><span id="ast-59"><span id="ast-60"><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tokens</span>&nbsp;=&nbsp;<span id="ast-62">[]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_complete_string(<span id="ast-2"><span id="ast-3" class="other_trans">key</span>,&nbsp;<span id="ast-4" class="other_trans">haystack</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"&nbsp;Returns&nbsp;valid&nbsp;string&nbsp;completions\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Takes&nbsp;the&nbsp;string&nbsp;'key'&nbsp;and&nbsp;compares&nbsp;it&nbsp;to&nbsp;each&nbsp;of&nbsp;the&nbsp;strings&nbsp;in\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'haystack'.&nbsp;The&nbsp;ones&nbsp;which&nbsp;beginns&nbsp;with&nbsp;'key'&nbsp;are&nbsp;returned&nbsp;as&nbsp;result.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8">(<span id="ast-9"><span id="ast-10" class="other_trans">len</span>(<span id="ast-11" class="incorrect_node">key&nbsp;&rarr;&nbsp;haystack&nbsp;</span>)</span><span id="ast-12" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-13">0</span>)</span>:<span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-15" class="other_trans">haystack</span></span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>&nbsp;=&nbsp;<span id="ast-18">[]</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-20" class="other_trans">straw</span>&nbsp;in&nbsp;<span id="ast-21" class="other_trans">haystack</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24"><span id="ast-25"><span id="ast-26" class="other_trans">string</span>.find</span>(<span id="ast-27" class="other_trans">straw</span>,&nbsp;<span id="ast-28" class="other_trans">key</span>)</span><span id="ast-29" class="ref_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-30">0</span>)</span>:<span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>match</span>.append</span>(<span id="ast-35" class="other_trans">straw</span>)</span></span></span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-37" class="other_trans">match</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;clean_requires(<span id="ast-2"><span id="ast-3" class="other_trans">reqs</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"Removes&nbsp;requirements&nbsp;that&nbsp;aren't&nbsp;needed&nbsp;in&nbsp;newer&nbsp;python&nbsp;versions."</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8"><span id="ast-9"><span id="ast-10" class="other_trans">sys</span>.version_info</span>[<span id="ast-11">:<span id="ast-12">2</span></span>]</span><span id="ast-13" class="correct_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-14">(<span id="ast-15">2</span>,&nbsp;<span id="ast-16">7</span>)</span>)</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-18" class="other_trans">reqs</span></span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-20">[<span id="ast-21" class="other_trans">req</span><span id="ast-22">&nbsp;for&nbsp;<span id="ast-23" class="other_trans">req</span>&nbsp;in&nbsp;<span id="ast-24" class="other_trans">reqs</span>&nbsp;if&nbsp;<span id="ast-25">(<span id="ast-26">not</span>&nbsp;<span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">req</span>.startswith</span>(<span id="ast-30">'importlib'</span>)</span>)</span></span>]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;changelist_view(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;*args,&nbsp;**kwargs</span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Redirect&nbsp;to&nbsp;the&nbsp;add&nbsp;view&nbsp;if&nbsp;no&nbsp;records&nbsp;exist&nbsp;or&nbsp;the&nbsp;change&nbsp;view&nbsp;if&nbsp;\\u000a&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;singlton&nbsp;instance&nbsp;exists.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>singleton</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>.model</span>.objects</span>.get</span>()</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.model</span>.MultipleObjectsReturned</span>:<span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22" class="other_trans">super</span>(<span id="ast-23" class="other_trans">SingletonAdmin</span>,&nbsp;<span id="ast-24">self</span>)</span>.changelist_view</span>(*<span id="ast-25" class="other_trans">args</span>,&nbsp;**<span id="ast-26" class="other_trans">kwargs</span>)</span></span></span><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-28"><span id="ast-29"><span id="ast-30">self</span>.model</span>.DoesNotExist</span>:<span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>add_url</span>&nbsp;=&nbsp;<span id="ast-33"><span id="ast-34" class="other_trans">admin_url</span>(<span id="ast-35" class="correct_node">model&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-36">'add'</span>)</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-38"><span id="ast-39" class="other_trans">HttpResponseRedirect</span>(<span id="ast-40" class="other_trans">add_url</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;mult(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">cik</span>,&nbsp;<span id="ast-5" class="other_trans">commands</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-7"><span id="ast-8" class="correct_node">_exomult&nbsp;&rarr;&nbsp;self.&nbsp;</span>(<span id="ast-9" class="other_trans">cik</span>,&nbsp;<span id="ast-10" class="other_trans">commands</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;run(<span id="ast-2"><span id="ast-3" class="other_trans">args</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>global&nbsp;collected_logs,&nbsp;error_count,&nbsp;options</span><span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>collected_logs</span>&nbsp;=&nbsp;<span id="ast-7">[]</span></span><span id="ast-8"><span id="ast-9" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>error_count</span>&nbsp;=&nbsp;<span id="ast-10">0</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>options</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15">parser</span>.parse_args</span>(<span id="ast-16" class="other_trans">args</span>)</span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18">(<span id="ast-19"><span id="ast-20" class="other_trans">len</span>(<span id="ast-21"><span id="ast-22">options</span>.args</span>)</span><span id="ast-23" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-24">1</span>)</span>:<span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-26">"Test&nbsp;runner&nbsp;for&nbsp;Meson.&nbsp;Do&nbsp;not&nbsp;run&nbsp;on&nbsp;your&nbsp;own,&nbsp;mmm'kay?"</span></span><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-28">(<span id="ast-29">'%s&nbsp;[data&nbsp;file]'</span>&nbsp;%&nbsp;<span id="ast-31"><span id="ast-32"><span id="ast-33">sys</span>.argv</span>[<span id="ast-34"><span id="ast-35">0</span></span>]</span>)</span></span></span><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-37">(<span id="ast-38"><span id="ast-39" class="other_trans">options</span>.wd</span><span id="ast-40" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-41" class="other_trans">None</span>)</span>:<span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>os</span>.chdir</span>(<span id="ast-46"><span id="ast-47" class="other_trans">options</span>.wd</span>)</span></span></span><span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>datafile</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52" class="other_trans">options</span>.args</span>[<span id="ast-53"><span id="ast-54">0</span></span>]</span></span><span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>logfilename</span>&nbsp;=&nbsp;<span id="ast-57"><span id="ast-58">run_tests</span>(<span id="ast-59" class="other_trans">datafile</span>)</span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62"><span id="ast-63">len</span>(<span id="ast-64" class="other_trans">collected_logs</span>)</span><span id="ast-65" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-66">0</span>)</span>:<span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-68">(<span id="ast-69"><span id="ast-70">len</span>(<span id="ast-71" class="other_trans">collected_logs</span>)</span><span id="ast-72" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-73">10</span>)</span>:<span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-75">'\\u000aThe&nbsp;output&nbsp;from&nbsp;10&nbsp;first&nbsp;failed&nbsp;tests:\\u000a'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-77">'\\u000aThe&nbsp;output&nbsp;from&nbsp;the&nbsp;failed&nbsp;tests:\\u000a'</span></span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-79" class="other_trans">log</span>&nbsp;in&nbsp;<span id="ast-80"><span id="ast-81" class="other_trans">collected_logs</span>[<span id="ast-82">:<span id="ast-83">10</span></span>]</span>:<span id="ast-84"><span id="ast-85" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lines</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88" class="other_trans">log</span>.splitlines</span>()</span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-90">(<span id="ast-91"><span id="ast-92">len</span>(<span id="ast-93" class="other_trans">lines</span>)</span><span id="ast-94" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-95">100</span>)</span>:<span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-97"><span id="ast-98" class="correct_node">line&nbsp;&rarr;&nbsp;lines&nbsp;</span>[<span id="ast-99"><span id="ast-100">0</span></span>]</span></span><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-102">'---&nbsp;Listing&nbsp;only&nbsp;the&nbsp;last&nbsp;100&nbsp;lines&nbsp;from&nbsp;a&nbsp;long&nbsp;log.&nbsp;---'</span></span><span id="ast-103"><span id="ast-104" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lines</span>&nbsp;=&nbsp;<span id="ast-105"><span id="ast-106">lines</span>[<span id="ast-107"><span id="ast-108">-99</span>:</span>]</span></span></span><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-110" class="other_trans">line</span>&nbsp;in&nbsp;<span id="ast-111" class="other_trans">lines</span>:<span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-113" class="other_trans">line</span></span></span></span></span><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-115">(<span id="ast-116">'Full&nbsp;log&nbsp;written&nbsp;to&nbsp;%s.'</span>&nbsp;%&nbsp;<span id="ast-118" class="other_trans">logfilename</span>)</span></span><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-120">error_count</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_poll_status_async(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">link</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>u</span>&nbsp;=&nbsp;<span id="ast-7">yield&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>.session</span>.upload_status_async</span>(<span id="ast-12" class="other_trans">link</span>)</span></span></span><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-14">(<span id="ast-16">(<span id="ast-17"><span id="ast-18" class="other_trans">u</span>[<span id="ast-19"><span id="ast-20">'status'</span></span>]</span><span id="ast-21" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-22">'completed'</span>)</span>&nbsp;or&nbsp;<span id="ast-23">(<span id="ast-24"><span id="ast-25" class="other_trans">u</span>[<span id="ast-26"><span id="ast-27">'status'</span></span>]</span><span id="ast-28" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-29">'error'</span>)</span>)</span>:<span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>defer</span>.returnValue</span>(<span id="ast-34" class="other_trans">u</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-35"><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>yield&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39" class="other_trans">task</span>.deferLater</span>(<span id="ast-40" class="other_trans">reactor</span>,&nbsp;<span id="ast-41">5.0</span>,&nbsp;<span id="ast-42" class="ref_node">_poll_status_async&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-43" class="incorrect_node">link&nbsp;&rarr;&nbsp;u&nbsp;</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;is_look_alike(<span id="ast-2"><span id="ast-3" class="other_trans">image_path</span>,&nbsp;<span id="ast-4" class="other_trans">other_image_path</span>,&nbsp;<span id="ast-5" class="other_trans">tolerance</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;True&nbsp;if&nbsp;the&nbsp;hamming&nbsp;distance&nbsp;between\\u000a&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;image&nbsp;hashes&nbsp;are&nbsp;less&nbsp;than&nbsp;the&nbsp;given&nbsp;tolerance.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-10">(<span id="ast-11"><span id="ast-12" class="other_trans">distance</span>(<span id="ast-13" class="other_trans">image_path</span>,&nbsp;<span id="ast-14" class="other_trans">other_image_path</span>)</span><span id="ast-15" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-16" class="other_trans">tolerance</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;*args,&nbsp;**kwargs</span>):<span id="ast-4"><span id="ast-5"><span id="ast-6"><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>super</span>(<span id="ast-9" class="other_trans">WidgyPageAdminForm</span>,&nbsp;<span id="ast-10">self</span>)</span>.__init__</span>(*<span id="ast-11" class="other_trans">args</span>,&nbsp;**<span id="ast-12" class="other_trans">kwargs</span>)</span></span><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.fields</span>[<span id="ast-18"><span id="ast-19">'publish_date'</span></span>]</span>.help_text</span>&nbsp;=&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">_</span>(<span id="ast-22">'If&nbsp;you&nbsp;enter&nbsp;a&nbsp;date&nbsp;here,&nbsp;the&nbsp;page&nbsp;will&nbsp;not&nbsp;be&nbsp;viewable&nbsp;on&nbsp;the&nbsp;site&nbsp;until&nbsp;then'</span>)</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.fields</span>[<span id="ast-28"><span id="ast-29">'expiry_date'</span></span>]</span>.help_text</span>&nbsp;=&nbsp;<span id="ast-30"><span id="ast-31" class="other_trans">_</span>(<span id="ast-32">'If&nbsp;you&nbsp;enter&nbsp;a&nbsp;date&nbsp;here,&nbsp;the&nbsp;page&nbsp;will&nbsp;not&nbsp;be&nbsp;viewable&nbsp;after&nbsp;this&nbsp;time'</span>)</span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-34">(<span id="ast-35"><span id="ast-36"><span id="ast-37">self</span>.instance</span>.pk</span><span id="ast-38" class="correct_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-39" class="other_trans">None</span>)</span>:<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.instance</span>.status</span>&nbsp;=&nbsp;<span id="ast-44" class="other_trans">CONTENT_STATUS_DRAFT</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;filter(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">context</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>max_width</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8" class="other_trans">context</span>[<span id="ast-9"><span id="ast-10">'max_abbr_width'</span></span>]</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-13" class="other_trans">max_width</span><span id="ast-14" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-15">0</span>)</span>:<span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">context</span>[<span id="ast-19"><span id="ast-20">'candidates'</span></span>]</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;login(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">force</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Logs&nbsp;in&nbsp;to&nbsp;a&nbsp;Review&nbsp;Board&nbsp;server,&nbsp;prompting&nbsp;the&nbsp;user&nbsp;for&nbsp;login\\u000a&nbsp;&nbsp;&nbsp;&nbsp;information&nbsp;if&nbsp;needed.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-11">(<span id="ast-12"><span id="ast-13" class="other_trans">options</span>.diff_filename</span><span id="ast-14" class="incorrect_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-15">'-'</span>)</span>&nbsp;and&nbsp;<span id="ast-16">(<span id="ast-17">not</span>&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">options</span>.username</span>)</span>&nbsp;and&nbsp;<span id="ast-20">(<span id="ast-21">not</span>&nbsp;<span id="ast-22"><span id="ast-23" class="other_trans">options</span>.submit_as</span>)</span>&nbsp;and&nbsp;<span id="ast-24">(<span id="ast-25">not</span>&nbsp;<span id="ast-26"><span id="ast-27" class="other_trans">options</span>.password</span>)</span>)</span>:<span id="ast-28"><span id="ast-29"><span id="ast-30" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>die</span>(<span id="ast-31">'Authentication&nbsp;information&nbsp;needs&nbsp;to&nbsp;be&nbsp;provided&nbsp;on&nbsp;the&nbsp;command&nbsp;line&nbsp;when&nbsp;using&nbsp;--diff-filename=-'</span>)</span></span></span><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-33">'==&gt;&nbsp;Review&nbsp;Board&nbsp;Login&nbsp;Required'</span></span><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-35">(<span id="ast-36">'Enter&nbsp;username&nbsp;and&nbsp;password&nbsp;for&nbsp;Review&nbsp;Board&nbsp;at&nbsp;%s'</span>&nbsp;%&nbsp;<span id="ast-38"><span id="ast-39">self</span>.url</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41"><span id="ast-42" class="other_trans">options</span>.username</span>:<span id="ast-43"><span id="ast-44" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>username</span>&nbsp;=&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">options</span>.username</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-48"><span id="ast-49" class="other_trans">options</span>.submit_as</span>:<span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>username</span>&nbsp;=&nbsp;<span id="ast-52"><span id="ast-53" class="other_trans">options</span>.submit_as</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-55">(<span id="ast-57">(<span id="ast-58">not</span>&nbsp;<span id="ast-59" class="other_trans">force</span>)</span>&nbsp;and&nbsp;<span id="ast-60"><span id="ast-61" class="ref_node">has_valid_cookie&nbsp;&rarr;&nbsp;self.&nbsp;</span>()</span>)</span>:<span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-63"><span id="ast-64" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>username</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">raw_input</span>(<span id="ast-67">'Username:&nbsp;'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;latest(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>versions</span>&nbsp;=&nbsp;<span id="ast-6">[<span id="ast-7">(<span id="ast-8"><span id="ast-9" class="other_trans">int</span>(<span id="ast-10"><span id="ast-11" class="other_trans">v</span>[<span id="ast-12"><span id="ast-13">4</span>:<span id="ast-14">6</span></span>]</span>)</span>,&nbsp;<span id="ast-15"><span id="ast-16" class="other_trans">int</span>(<span id="ast-17">(<span id="ast-19"><span id="ast-20" class="other_trans">v</span>[<span id="ast-21"><span id="ast-22">8</span>:</span>]</span>&nbsp;or&nbsp;<span id="ast-23">0</span>)</span>)</span>)</span><span id="ast-24">&nbsp;for&nbsp;<span id="ast-25" class="other_trans">v</span>&nbsp;in&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28">self</span>.versions</span>()</span></span>]</span></span><span id="ast-29"><span id="ast-30" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>combo</span>&nbsp;=&nbsp;<span id="ast-31"><span id="ast-32"><span id="ast-33" class="other_trans">sorted</span>(<span id="ast-34" class="other_trans">versions</span>,&nbsp;key=<span id="ast-36">lambda&nbsp;<span id="ast-37"><span id="ast-38" class="other_trans">x</span></span>:&nbsp;<span id="ast-39">(<span id="ast-40"><span id="ast-41" class="other_trans">x</span>[<span id="ast-42"><span id="ast-43">0</span></span>]</span>,&nbsp;<span id="ast-44"><span id="ast-45" class="other_trans">x</span>[<span id="ast-46"><span id="ast-47">1</span></span>]</span>)</span></span>)</span>[<span id="ast-48"><span id="ast-49">-1</span></span>]</span></span><span id="ast-50"><span id="ast-51" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>version</span>&nbsp;=&nbsp;<span id="ast-52"><span id="ast-53"><span id="ast-54">'GRCh{v}'</span>.format</span>(v=<span id="ast-56"><span id="ast-57" class="other_trans">combo</span>[<span id="ast-58"><span id="ast-59">0</span></span>]</span>,&nbsp;patch=<span id="ast-61"><span id="ast-62" class="other_trans">combo</span>[<span id="ast-63"><span id="ast-64">1</span></span>]</span>)</span></span><span id="ast-65"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-66">(<span id="ast-67"><span id="ast-68" class="other_trans">combo</span>[<span id="ast-69"><span id="ast-70">1</span></span>]</span><span id="ast-71" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-72">0</span>)</span>:<span id="ast-73"><span id="ast-74" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>version</span>&nbsp;+=&nbsp;<span id="ast-76">(<span id="ast-77">'.p'</span>&nbsp;+&nbsp;<span id="ast-79"><span id="ast-80" class="other_trans">combo</span>[<span id="ast-81"><span id="ast-82">1</span></span>]</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;emit_event(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">event</span>,&nbsp;<span id="ast-5" class="other_trans">sender</span>,&nbsp;<span id="ast-7" class="other_trans">level</span>,&nbsp;<span id="ast-9" class="other_trans">formatted</span>,&nbsp;<span id="ast-11" class="other_trans">data</span></span>):<span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-14">(<span id="ast-15">not</span>&nbsp;<span id="ast-16" class="other_trans">sender</span>)</span>:<span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sender</span>&nbsp;=&nbsp;<span id="ast-19">self</span></span></span><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-22">(<span id="ast-23">(<span id="ast-24"><span id="ast-25"><span id="ast-26" class="other_trans">time</span>.time</span>()</span>&nbsp;-&nbsp;<span id="ast-28"><span id="ast-29">self</span>.last_log_time</span>)</span><span id="ast-30" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34">self</span>.config</span>.get</span>(<span id="ast-35">'log_interval'</span>,&nbsp;<span id="ast-36">0</span>)</span>)</span>:<span id="ast-37"><span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.last_log_time</span>&nbsp;=&nbsp;<span id="ast-40"><span id="ast-41"><span id="ast-42" class="other_trans">time</span>.time</span>()</span></span><span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46"><span id="ast-47"><span id="ast-48"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.bot</span>.event_manager</span>.emit</span>(<span id="ast-49" class="other_trans">event</span>,&nbsp;sender=<span id="ast-51" class="other_trans">sender</span>,&nbsp;level=<span id="ast-53" class="other_trans">level</span>,&nbsp;formatted=<span id="ast-55" class="other_trans">formatted</span>,&nbsp;data=<span id="ast-57" class="other_trans">data</span>)</span></span></span><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-59" class="other_trans">AttributeError</span>:<span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62">(<span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">time</span>.time</span>()</span>&nbsp;-&nbsp;<span id="ast-67"><span id="ast-68">self</span>.last_log_time</span>)</span><span id="ast-69" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-70">0</span>)</span>:<span id="ast-71"><span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.last_log_time</span>&nbsp;=&nbsp;<span id="ast-74"><span id="ast-75"><span id="ast-76" class="other_trans">time</span>.time</span>()</span></span><span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.bot</span>.event_manager</span>.emit</span>(<span id="ast-83" class="other_trans">event</span>,&nbsp;sender=<span id="ast-85" class="other_trans">sender</span>,&nbsp;level=<span id="ast-87" class="other_trans">level</span>,&nbsp;formatted=<span id="ast-89" class="other_trans">formatted</span>,&nbsp;data=<span id="ast-91" class="other_trans">data</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;filter(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">context</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>max_width</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8" class="other_trans">context</span>[<span id="ast-9"><span id="ast-10">'max_menu_width'</span></span>]</span></span><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-12">(<span id="ast-14">(<span id="ast-15">not</span>&nbsp;<span id="ast-16"><span id="ast-17" class="other_trans">context</span>[<span id="ast-18"><span id="ast-19">'candidates'</span></span>]</span>)</span>&nbsp;or&nbsp;<span id="ast-20">(<span id="ast-21">'menu'</span><span id="ast-22">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-23"><span id="ast-24"><span id="ast-25" class="other_trans">context</span>[<span id="ast-26"><span id="ast-27">'candidates'</span></span>]</span>[<span id="ast-28"><span id="ast-29">0</span></span>]</span>)</span>&nbsp;or&nbsp;<span id="ast-30">(<span id="ast-31" class="other_trans">max_width</span><span id="ast-32" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-33">0</span>)</span>)</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-35"><span id="ast-36" class="other_trans">context</span>[<span id="ast-37"><span id="ast-38">'candidates'</span></span>]</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;is_ready(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-5">(<span id="ast-6"><span id="ast-7" class="other_trans">len</span>(<span id="ast-8"><span id="ast-9">self</span>.ready_validators</span>)</span><span id="ast-10" class="location_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;>,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-11">(<span id="ast-12">(<span id="ast-13"><span id="ast-14" class="other_trans">len</span>(<span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.contract</span>.validators</span>)</span>&nbsp;*&nbsp;<span id="ast-19">2</span>)</span>&nbsp;/&nbsp;<span id="ast-21">3.0</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;flush(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6"><span id="ast-7" class="other_trans">len</span>(<span id="ast-8"><span id="ast-9">self</span>.batch</span>)</span><span id="ast-10" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-11">0</span>)</span>:<span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.queue</span>.send_message</span>(<span id="ast-17">(<span id="ast-18">(<span id="ast-19">'['</span>&nbsp;+&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23">','</span>.join</span>(<span id="ast-24" class="correct_node">batch&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-26">']'</span>)</span>)</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batch</span>&nbsp;=&nbsp;<span id="ast-30">[]</span></span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batch_size</span>&nbsp;=&nbsp;<span id="ast-34">2</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.batch_count</span>&nbsp;=&nbsp;<span id="ast-38">0</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;run_command_hooks(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">message</span>,&nbsp;<span id="ast-5" class="other_trans">private</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>addressed</span>&nbsp;=&nbsp;<span id="ast-8">False</span></span><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-10">(<span id="ast-11" class="other_trans">mod_name</span>,&nbsp;<span id="ast-12" class="other_trans">f</span>,&nbsp;<span id="ast-13" class="other_trans">cmd</span>)</span>&nbsp;in&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16">plugin</span>.hook_get_commands</span>()</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18" class="other_trans">private</span>:<span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>m</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23" class="other_trans">re</span>.search</span>(<span id="ast-24">(<span id="ast-25">'^%s$|^%s\\\\s(.*)$'</span>&nbsp;%&nbsp;<span id="ast-27">(<span id="ast-28" class="other_trans">cmd</span>,&nbsp;<span id="ast-29" class="other_trans">cmd</span>)</span>)</span>,&nbsp;<span id="ast-30" class="other_trans">message</span>,&nbsp;<span id="ast-31"><span id="ast-32">re</span>.I</span>)</span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-34" class="other_trans">m</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.run_hook_command</span>(<span id="ast-39" class="other_trans">mod_name</span>,&nbsp;<span id="ast-40" class="other_trans">f</span>,&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans">m</span>.group</span>(<span id="ast-44">1</span>)</span>,&nbsp;private=<span id="ast-46" class="other_trans">private</span>,&nbsp;addressed=<span id="ast-48">addressed</span>,&nbsp;full_message=<span id="ast-50" class="other_trans">message</span>)</span></span></span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans">message</span>.startswith</span>(<span id="ast-55"><span id="ast-56">self</span>.command_prefix</span>)</span>:<span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg_rest</span>&nbsp;=&nbsp;<span id="ast-59"><span id="ast-60" class="other_trans">message</span>[<span id="ast-61"><span id="ast-62"><span id="ast-63" class="other_trans">len</span>(<span id="ast-64"><span id="ast-65">self</span>.command_prefix</span>)</span>:</span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg_start_upper</span>&nbsp;=&nbsp;<span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans">message</span>[<span id="ast-72">:<span id="ast-73">(<span id="ast-74"><span id="ast-75">len</span>(<span id="ast-76"><span id="ast-77">self</span>.nick</span>)</span>&nbsp;+&nbsp;<span id="ast-79">1</span>)</span></span>]</span>.upper</span>()</span></span><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-81">(<span id="ast-82" class="other_trans">msg_start_upper</span><span id="ast-83" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-84">(<span id="ast-85"><span id="ast-86"><span id="ast-87" class="correct_node">nick&nbsp;&rarr;&nbsp;self.&nbsp;</span>.upper</span>()</span>&nbsp;+&nbsp;<span id="ast-89">':'</span>)</span>)</span>:<span id="ast-90"><span id="ast-91" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>msg_rest</span>&nbsp;=&nbsp;<span id="ast-92"><span id="ast-93"><span id="ast-94">re</span>.sub</span>(<span id="ast-95">'^\\\\s+'</span>,&nbsp;<span id="ast-96">''</span>,&nbsp;<span id="ast-97"><span id="ast-98" class="other_trans">message</span>[<span id="ast-99"><span id="ast-100">(<span id="ast-101"><span id="ast-102" class="other_trans">len</span>(<span id="ast-103"><span id="ast-104">self</span>.nick</span>)</span>&nbsp;+&nbsp;<span id="ast-106">1</span>)</span>:</span>]</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-108"><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>addressed</span>&nbsp;=&nbsp;<span id="ast-110">True</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;set_lp(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">url</span>,&nbsp;<span id="ast-5" class="other_trans">check</span></span>):<span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8" class="other_trans">check</span>:<span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-10">(<span id="ast-11">not</span>&nbsp;<span id="ast-12"><span id="ast-13">self</span>.lp_set</span>)</span></span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-15"><span id="ast-16">self</span>.lp_set</span>:<span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>server</span>&nbsp;=&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23">self</span>.pool</span>.get_entry</span>(<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27">self</span>.pool</span>.get_current</span>()</span>)</span></span><span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-29">(<span id="ast-30"><span id="ast-31" class="other_trans">url</span>[<span id="ast-32"><span id="ast-33">0</span></span>]</span><span id="ast-34" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-35">'/'</span>)</span>:<span id="ast-36"><span id="ast-37" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lp_address</span>&nbsp;=&nbsp;<span id="ast-38">(<span id="ast-39"><span id="ast-40" class="other_trans">str</span>(<span id="ast-41"><span id="ast-42" class="other_trans">server</span>[<span id="ast-43"><span id="ast-44">'mine_address'</span></span>]</span>)</span>&nbsp;+&nbsp;<span id="ast-46"><span id="ast-47" class="other_trans">str</span>(<span id="ast-48" class="other_trans">url</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-49"><span id="ast-50" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>lp_address</span>&nbsp;=&nbsp;<span id="ast-51"><span id="ast-52" class="other_trans">str</span>(<span id="ast-53" class="other_trans">url</span>)</span></span></span><span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.bitHopper</span>.log_msg</span>(<span id="ast-59">(<span id="ast-60">'LP&nbsp;Call&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-62" class="other_trans">lp_address</span>)</span>)</span></span><span id="ast-63"><span id="ast-64" class="ref_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>lp_set&nbsp;&rarr;&nbsp;self.&nbsp;</span>&nbsp;=&nbsp;<span id="ast-65">True</span></span><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>work&nbsp;&rarr;&nbsp;self.&nbsp;</span>.jsonrpc_lpcall</span>(<span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74">self</span>.bitHopper</span>.get_lp_agent</span>()</span>,&nbsp;<span id="ast-75" class="other_trans">server</span>,&nbsp;<span id="ast-76" class="other_trans">lp_address</span>,&nbsp;<span id="ast-77"><span id="ast-78">self</span>.update_lp</span>)</span></span><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-80" class="other_trans">Exception</span>&nbsp;as&nbsp;<span id="ast-81" class="other_trans">e</span>:<span id="ast-82"><span id="ast-83"><span id="ast-84"><span id="ast-85"><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.bitHopper</span>.log_dbg</span>(<span id="ast-87">'set_lp&nbsp;error'</span>)</span></span><span id="ast-88"><span id="ast-89"><span id="ast-90"><span id="ast-91"><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.bitHopper</span>.log_dbg</span>(<span id="ast-93" class="other_trans">e</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;on_data(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">text</span></span>):<span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-6">(<span id="ast-7">not</span>&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>.instance</span>.port</span>)</span>:<span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>m</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans">re</span>.match</span>(<span id="ast-16">'^Serving&nbsp;.*?&nbsp;on&nbsp;http://.*?:(\\\\d+)'</span>,&nbsp;<span id="ast-17" class="other_trans">text</span>)</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19" class="other_trans">m</span>:<span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.instance</span>.port</span>&nbsp;=&nbsp;<span id="ast-24"><span id="ast-25" class="other_trans">int</span>(<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">m</span>.groups</span>()</span>[<span id="ast-30"><span id="ast-31">0</span></span>]</span>)</span></span><span id="ast-32"><span id="ast-33"><span id="ast-34"><span id="ast-35" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>_logger</span>.debug</span>(<span id="ast-36">(<span id="ast-37">'captured&nbsp;pub&nbsp;serve&nbsp;port:&nbsp;%d'</span>&nbsp;%&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41">self</span>.instance</span>.port</span>)</span>)</span></span><span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>_logger</span>.debug</span>(<span id="ast-46">'starting&nbsp;dartium...'</span>)</span></span><span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50"><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.panel</span>.write</span>(<span id="ast-52">'Starting&nbsp;Dartium...\\u000a'</span>)</span></span><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;=&nbsp;<span id="ast-55">(<span id="ast-56">'http://localhost:'</span>&nbsp;+&nbsp;<span id="ast-58"><span id="ast-59" class="other_trans">str</span>(<span id="ast-60"><span id="ast-61"><span id="ast-62">self</span>.instance</span>.port</span>)</span>)</span></span><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-64"><span id="ast-65">self</span>.path</span>:<span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>url</span>&nbsp;+=&nbsp;<span id="ast-69">(<span id="ast-70">'/'</span>&nbsp;+&nbsp;<span id="ast-72" class="correct_node">path&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span></span></span><span id="ast-73"><span id="ast-74"><span id="ast-75"><span id="ast-76"><span id="ast-77" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>Dartium</span>()</span>.start</span>(<span id="ast-78" class="other_trans">url</span>)</span></span></span></span><span id="ast-79"><span id="ast-80"><span id="ast-81"><span id="ast-82"><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.panel</span>.write</span>(<span id="ast-84" class="other_trans">text</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;resolve_redirects(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">resp</span>,&nbsp;<span id="ast-5" class="other_trans">req</span>,&nbsp;<span id="ast-6" class="other_trans">stream</span>,&nbsp;<span id="ast-8" class="other_trans">timeout</span>,&nbsp;<span id="ast-10" class="other_trans">verify</span>,&nbsp;<span id="ast-12" class="other_trans">cert</span>,&nbsp;<span id="ast-14" class="other_trans">proxies</span></span>):<span id="ast-16"><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Receives&nbsp;a&nbsp;Response.&nbsp;Returns&nbsp;a&nbsp;generator&nbsp;of&nbsp;Responses.'</span></span><span id="ast-18"><span id="ast-19" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>i</span>&nbsp;=&nbsp;<span id="ast-20">0</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-22">(<span id="ast-24">(<span id="ast-25">'location'</span><span id="ast-26">&nbsp;in&nbsp;</span><span id="ast-27"><span id="ast-28" class="other_trans">resp</span>.headers</span>)</span>&nbsp;and&nbsp;<span id="ast-29">(<span id="ast-30"><span id="ast-31" class="other_trans">resp</span>.status_code</span><span id="ast-32">&nbsp;in&nbsp;</span><span id="ast-33" class="other_trans">REDIRECT_STATI</span>)</span>)</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-35" class="other_trans">cookie</span>&nbsp;in&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">resp</span>.cookies</span>:<span id="ast-38"><span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.cookies</span>.set_cookie</span>(<span id="ast-43" class="other_trans">cookie</span>)</span></span></span><span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>resp</span>.content</span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-48">(<span id="ast-49" class="other_trans">i</span><span id="ast-50" class="correct_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-51"><span id="ast-52">self</span>.max_redirects</span>)</span>:<span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-54"><span id="ast-55" class="other_trans">TooManyRedirects</span>(<span id="ast-56">(<span id="ast-57">'Exceeded&nbsp;%s&nbsp;redirects.'</span>&nbsp;%&nbsp;<span id="ast-59"><span id="ast-60">self</span>.max_redirects</span>)</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">anaphora_filepath</span>,&nbsp;<span id="ast-5" class="other_trans">name</span>,&nbsp;<span id="ast-7" class="other_trans">namespace</span></span>):<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>"\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Reads&nbsp;an&nbsp;abstract&nbsp;anaphora&nbsp;annotation&nbsp;file,&nbsp;creates&nbsp;a&nbsp;directed\\u000a&nbsp;&nbsp;&nbsp;&nbsp;graph&nbsp;and&nbsp;adds&nbsp;a&nbsp;node&nbsp;for&nbsp;each&nbsp;token,&nbsp;as&nbsp;well&nbsp;as&nbsp;an&nbsp;edge&nbsp;from\\u000a&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;root&nbsp;node&nbsp;to&nbsp;each&nbsp;token.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;a&nbsp;token&nbsp;is&nbsp;annotated,&nbsp;it&nbsp;will&nbsp;have&nbsp;an&nbsp;attribute&nbsp;'annotation',\\u000a&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;maps&nbsp;to&nbsp;a&nbsp;dict&nbsp;with&nbsp;the&nbsp;keys&nbsp;'anaphoricity'&nbsp;(str)&nbsp;and\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'certainty'&nbsp;(float).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'anaphoricity'&nbsp;is&nbsp;one&nbsp;of&nbsp;the&nbsp;following:&nbsp;'abstract',&nbsp;'nominal',\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'pleonastic'&nbsp;or&nbsp;'relative'.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;anaphora_filepath&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;relative&nbsp;or&nbsp;absolute&nbsp;path&nbsp;to&nbsp;an&nbsp;anaphora&nbsp;annotation&nbsp;file.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;format&nbsp;of&nbsp;the&nbsp;file&nbsp;was&nbsp;created&nbsp;ad-hoc&nbsp;by&nbsp;one&nbsp;of&nbsp;our\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;students&nbsp;for&nbsp;his&nbsp;diploma&nbsp;thesis.&nbsp;It&nbsp;consists&nbsp;of&nbsp;tokenized\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plain&nbsp;text&nbsp;(one&nbsp;sentence&nbsp;per&nbsp;line&nbsp;with&nbsp;spaces&nbsp;between\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tokens).\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;token&nbsp;is&nbsp;annotated&nbsp;by&nbsp;appending&nbsp;'/'&nbsp;and&nbsp;one&nbsp;of&nbsp;the&nbsp;letters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'a'&nbsp;(abstract),&nbsp;'n'&nbsp;(nominal),&nbsp;'p'&nbsp;(pleonastic),\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'r'&nbsp;(relative&nbsp;pronoun)&nbsp;and&nbsp;optionally&nbsp;a&nbsp;question&nbsp;mark&nbsp;to\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signal&nbsp;uncertainty.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;:&nbsp;str&nbsp;or&nbsp;None\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;name&nbsp;or&nbsp;ID&nbsp;of&nbsp;the&nbsp;graph&nbsp;to&nbsp;be&nbsp;generated.&nbsp;If&nbsp;no&nbsp;name&nbsp;is\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;given,&nbsp;the&nbsp;basename&nbsp;of&nbsp;the&nbsp;input&nbsp;file&nbsp;is&nbsp;used.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;namespace&nbsp;:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;namespace&nbsp;of&nbsp;the&nbsp;graph&nbsp;(default:&nbsp;anaphoricity)\\u000a&nbsp;&nbsp;&nbsp;&nbsp;"</span></span><span id="ast-11"><span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>super</span>(<span id="ast-16" class="other_trans">AnaphoraDocumentGraph</span>,&nbsp;<span id="ast-17">self</span>)</span>.__init__</span>()</span></span><span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-20" class="other_trans">name</span><span id="ast-21" class="correct_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-22" class="other_trans">None</span>)</span>:<span id="ast-23"><span id="ast-24"><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.name</span>&nbsp;=&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">os</span>.path</span>.basename</span>(<span id="ast-30" class="other_trans">anaphora_filepath</span>)</span></span></span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ns</span>&nbsp;=&nbsp;<span id="ast-34" class="other_trans">namespace</span></span><span id="ast-35"><span id="ast-36"><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.root</span>&nbsp;=&nbsp;<span id="ast-38">(<span id="ast-39"><span id="ast-40">self</span>.ns</span>&nbsp;+&nbsp;<span id="ast-42">':root_node'</span>)</span></span><span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.add_node</span>(<span id="ast-47"><span id="ast-48">self</span>.root</span>,&nbsp;layers=<span id="ast-50">{<span id="ast-51"><span id="ast-52">self</span>.ns</span>}</span>)</span></span><span id="ast-53"><span id="ast-54"><span id="ast-55"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tokens</span>&nbsp;=&nbsp;<span id="ast-56">[]</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;compile_template(<span id="ast-2"><span id="ast-3">name</span>,&nbsp;<span id="ast-4" class="other_trans">path</span>,&nbsp;<span id="ast-5">node_path</span>,&nbsp;<span id="ast-6">cache_dir</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tmpl</span>&nbsp;=&nbsp;<span id="ast-9">''</span></span><span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-12" class="other_trans">dir</span>,&nbsp;<span id="ast-13">tname</span>)</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">os</span>.path</span>.split</span>(<span id="ast-18" class="other_trans">path</span>)</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>tname</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23"><span id="ast-24">os</span>.path</span>.join</span>(<span id="ast-25" class="other_trans">cache_dir</span>,&nbsp;<span id="ast-26">(<span id="ast-27">'%s-%s-%s'</span>&nbsp;%&nbsp;<span id="ast-29">(<span id="ast-30" class="other_trans">name</span>,&nbsp;<span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34"><span id="ast-35" class="other_trans">os</span>.path</span>.split</span>(<span id="ast-36">dir</span>)</span>[<span id="ast-37"><span id="ast-38">-1</span></span>]</span>,&nbsp;<span id="ast-39" class="other_trans">tname</span>)</span>)</span>)</span></span><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-41">(<span id="ast-43">(<span id="ast-44">not</span>&nbsp;<span id="ast-45"><span id="ast-46"><span id="ast-47"><span id="ast-48" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-49" class="other_trans">tname</span>)</span>)</span>&nbsp;or&nbsp;<span id="ast-50">(<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans">os</span>.path</span>.getmtime</span>(<span id="ast-55" class="other_trans">path</span>)</span><span id="ast-56" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-57"><span id="ast-58"><span id="ast-59"><span id="ast-60" class="other_trans">os</span>.path</span>.getmtime</span>(<span id="ast-61" class="other_trans">tname</span>)</span>)</span>)</span>:<span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-63"><span id="ast-64" class="other_trans">open</span>(<span id="ast-65" class="other_trans">tname</span>,&nbsp;<span id="ast-66">'wb'</span>)</span>&nbsp;as&nbsp;<span id="ast-67" class="other_trans">f</span>:<span id="ast-68"><span id="ast-69"><span id="ast-70"><span id="ast-71" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>f</span>.write</span>(<span id="ast-72"><span id="ast-73"><span id="ast-74"><span id="ast-75">open</span>(<span id="ast-76" class="other_trans">path</span>,&nbsp;<span id="ast-77">'rb'</span>)</span>.read</span>()</span>)</span></span></span></span><span id="ast-78"><span id="ast-79" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>i18n</span>&nbsp;=&nbsp;<span id="ast-80">[]</span></span><span id="ast-81"><span id="ast-82" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>cname</span>&nbsp;=&nbsp;<span id="ast-83">(<span id="ast-84">'%s.js'</span>&nbsp;%&nbsp;<span id="ast-86">tname</span>)</span></span><span id="ast-87"><span id="ast-88" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>iname</span>&nbsp;=&nbsp;<span id="ast-89">(<span id="ast-90">'%s.i18n'</span>&nbsp;%&nbsp;<span id="ast-92" class="other_trans">tname</span>)</span></span><span id="ast-93"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-94">(<span id="ast-96"><span id="ast-97"><span id="ast-98"><span id="ast-99">os</span>.path</span>.exists</span>(<span id="ast-100" class="other_trans">cname</span>)</span>&nbsp;and&nbsp;<span id="ast-101">(<span id="ast-102"><span id="ast-103"><span id="ast-104"><span id="ast-105" class="other_trans">os</span>.path</span>.getmtime</span>(<span id="ast-106" class="incorrect_node">tname&nbsp;&rarr;&nbsp;cname&nbsp;</span>)</span><span id="ast-107" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-108"><span id="ast-109"><span id="ast-110"><span id="ast-111" class="other_trans">os</span>.path</span>.getmtime</span>(<span id="ast-112" class="other_trans">cname</span>)</span>)</span>)</span>:<span id="ast-113"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-114"><span id="ast-115" class="other_trans">open</span>(<span id="ast-116" class="other_trans">cname</span>,&nbsp;<span id="ast-117">'rb'</span>)</span>&nbsp;as&nbsp;<span id="ast-118" class="other_trans">f</span>:<span id="ast-119"><span id="ast-120" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>tmpl</span>&nbsp;=&nbsp;<span id="ast-121"><span id="ast-122">text_</span>(<span id="ast-123"><span id="ast-124"><span id="ast-125" class="other_trans">f</span>.read</span>()</span>,&nbsp;<span id="ast-126">'utf-8'</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_brkpt_str(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">targetKey</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;'</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-10" class="other_trans">targetKey</span><span id="ast-11" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-12">None</span>)</span>:<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>brkptStr</span>&nbsp;=&nbsp;<span id="ast-15">''</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-17" class="other_trans">key</span>&nbsp;in&nbsp;<span id="ast-18"><span id="ast-19">self</span>.genomicBrkpts</span>:<span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>brkptStr</span>&nbsp;+=&nbsp;<span id="ast-23">(<span id="ast-24">','</span>&nbsp;+&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28">self</span>.get_brkpt_str</span>(<span id="ast-29" class="other_trans">key</span>)</span>)</span></span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-31" class="other_trans">brkptStr</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-32"><span id="ast-33" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>brkptStr</span>&nbsp;=&nbsp;<span id="ast-34">[]</span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-36" class="other_trans">genomicBrkpts</span>&nbsp;in&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39">self</span>.genomicBrkpts</span>[<span id="ast-40"><span id="ast-41" class="correct_node">key&nbsp;&rarr;&nbsp;targetKey&nbsp;</span></span>]</span>:<span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>chrom</span>&nbsp;=&nbsp;<span id="ast-44"><span id="ast-45" class="other_trans">genomicBrkpts</span>[<span id="ast-46"><span id="ast-47">0</span></span>]</span></span><span id="ast-48"><span id="ast-49" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bps</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51" class="other_trans">genomicBrkpts</span>[<span id="ast-52"><span id="ast-53">1</span>:</span>]</span></span><span id="ast-54"><span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>brkptStr</span>.append</span>(<span id="ast-58">(<span id="ast-59">(<span id="ast-60" class="other_trans">chrom</span>&nbsp;+&nbsp;<span id="ast-62">':'</span>)</span>&nbsp;+&nbsp;<span id="ast-64"><span id="ast-65"><span id="ast-66">'-'</span>.join</span>(<span id="ast-67">[<span id="ast-68"><span id="ast-69" class="other_trans">str</span>(<span id="ast-70" class="other_trans">x</span>)</span><span id="ast-71">&nbsp;for&nbsp;<span id="ast-72" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-73" class="other_trans">bps</span></span>]</span>)</span>)</span>)</span></span></span><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77">','</span>.join</span>(<span id="ast-78" class="other_trans">brkptStr</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;addition_actually_works(<span id="ast-2"><span id="ast-3" class="other_trans">x</span>,&nbsp;<span id="ast-8" class="other_trans">y</span></span>):<span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>the_sum</span>&nbsp;=&nbsp;<span id="ast-15">(<span id="ast-16" class="other_trans">x</span>&nbsp;+&nbsp;<span id="ast-18" class="other_trans">y</span>)</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>assert&nbsp;<span id="ast-20">(<span id="ast-22">(<span id="ast-23" class="other_trans">the_sum</span><span id="ast-24" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-25" class="other_trans">x</span>)</span>&nbsp;and&nbsp;<span id="ast-26">(<span id="ast-27" class="other_trans">the_sum</span><span id="ast-28" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;<=&nbsp;</span><span id="ast-29" class="other_trans">y</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;apt_get_localinstall(<span id="ast-2"><span id="ast-3" class="other_trans">cls</span>,&nbsp;<span id="ast-4" class="other_trans">package</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'install&nbsp;deb&nbsp;file&nbsp;with&nbsp;dpkg&nbsp;then&nbsp;resolve&nbsp;dependencies\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>dpkg_ret</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">cls</span>.dpkg_install</span>(<span id="ast-12" class="other_trans">package</span>)</span></span><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pkgname</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans">re</span>.sub</span>(<span id="ast-18">'_.*$'</span>,&nbsp;<span id="ast-19">''</span>,&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">basename</span>(<span id="ast-22" class="correct_node">pkgname&nbsp;&rarr;&nbsp;package&nbsp;</span>)</span>)</span></span><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-24">(<span id="ast-25">not</span>&nbsp;<span id="ast-26"><span id="ast-27" class="other_trans">dpkg_ret</span>.success</span>)</span>:<span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.debug</span>(<span id="ast-32"><span id="ast-33"><span id="ast-34">'failure:{0.command}&nbsp;:{0.std_err}'</span>.format</span>(<span id="ast-35"><span id="ast-36" class="other_trans">dpkg_ret</span>.result</span>)</span>)</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>aptitude_ret</span>&nbsp;=&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41" class="other_trans">cls</span>.aptitude</span>(<span id="ast-42">'hold'</span>,&nbsp;<span id="ast-43" class="other_trans">pkgname</span>)</span></span><span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-46">not</span>&nbsp;<span id="ast-47"><span id="ast-48" class="other_trans">aptitude_ret</span>.success</span>)</span>:<span id="ast-49"><span id="ast-50"><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.debug</span>(<span id="ast-53"><span id="ast-54"><span id="ast-55">'failure:{0.command}&nbsp;:{0.std_err}'</span>.format</span>(<span id="ast-56"><span id="ast-57" class="other_trans">aptitude_ret</span>.result</span>)</span>)</span></span></span><span id="ast-58"><span id="ast-59" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>apt_ret</span>&nbsp;=&nbsp;<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63">super</span>(<span id="ast-64" class="other_trans">AptitudeProvisionerPlugin</span>,&nbsp;<span id="ast-65" class="other_trans">cls</span>)</span>.apt_get_install</span>(<span id="ast-66">'--fix-missing'</span>)</span></span><span id="ast-67"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-68">(<span id="ast-69">not</span>&nbsp;<span id="ast-70"><span id="ast-71" class="other_trans">apt_ret</span>.success</span>)</span>:<span id="ast-72"><span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>log</span>.debug</span>(<span id="ast-76"><span id="ast-77"><span id="ast-78">'failure:{0.command}&nbsp;:{0.std_err}'</span>.format</span>(<span id="ast-79"><span id="ast-80" class="other_trans">apt_ret</span>.result</span>)</span>)</span></span></span><span id="ast-81"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-82" class="other_trans">apt_ret</span></span></span><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-84" class="other_trans">dpkg_ret</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;TransformString(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">variable</span>,&nbsp;<span id="ast-5" class="other_trans">s</span>,&nbsp;<span id="ast-6" class="other_trans">policy</span></span>):<span id="ast-7"><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Applies&nbsp;the&nbsp;transforms&nbsp;of&nbsp;a&nbsp;naming&nbsp;policy&nbsp;to&nbsp;a&nbsp;string.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Takes&nbsp;a&nbsp;string&nbsp;(usually&nbsp;a&nbsp;wireName)&nbsp;which&nbsp;might&nbsp;be&nbsp;in&nbsp;any&nbsp;case&nbsp;and&nbsp;have\\u000a&nbsp;&nbsp;&nbsp;&nbsp;reserved&nbsp;characters&nbsp;in&nbsp;it&nbsp;and&nbsp;transforms&nbsp;by&nbsp;the&nbsp;rules&nbsp;specified.&nbsp;The&nbsp;string\\u000a&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;divided&nbsp;into&nbsp;parts&nbsp;at&nbsp;reserved&nbsp;characters,&nbsp;then&nbsp;each&nbsp;part&nbsp;is&nbsp;transformed\\u000a&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;the&nbsp;case&nbsp;rule&nbsp;and&nbsp;then&nbsp;the&nbsp;parts&nbsp;are&nbsp;joined&nbsp;by&nbsp;the&nbsp;reserved&nbsp;character\\u000a&nbsp;&nbsp;&nbsp;&nbsp;replacement.&nbsp;&nbsp;Multiple&nbsp;reserved&nbsp;characters&nbsp;in&nbsp;a&nbsp;row&nbsp;are&nbsp;treated&nbsp;as&nbsp;one.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Note&nbsp;that&nbsp;the&nbsp;camel&nbsp;case&nbsp;transformations&nbsp;preserve&nbsp;existing&nbsp;case&nbsp;except&nbsp;for\\u000a&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;first&nbsp;character&nbsp;of&nbsp;each&nbsp;word.&nbsp;This&nbsp;provides&nbsp;good&nbsp;results&nbsp;for&nbsp;cases\\u000a&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;the&nbsp;use&nbsp;has&nbsp;provided&nbsp;a&nbsp;camel&nbsp;cased&nbsp;or&nbsp;proper&nbsp;name.&nbsp;E.g.&nbsp;maxResults,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;YouTube,&nbsp;NASA.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Note:&nbsp;Do&nbsp;we&nbsp;need&nbsp;rule&nbsp;that&nbsp;transforms&nbsp;NASA&nbsp;to&nbsp;Nasa&nbsp;and&nbsp;nasa&nbsp;when&nbsp;in&nbsp;the\\u000a&nbsp;&nbsp;&nbsp;&nbsp;upper&nbsp;and&nbsp;lower&nbsp;camel&nbsp;variations?&nbsp;&nbsp;That&nbsp;is,&nbsp;if&nbsp;you&nbsp;specify&nbsp;something&nbsp;in\\u000a&nbsp;&nbsp;&nbsp;&nbsp;ALL&nbsp;CAPS,&nbsp;we&nbsp;assume&nbsp;it&nbsp;is&nbsp;not&nbsp;a&nbsp;mixed&nbsp;case&nbsp;spelling.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Args:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable:&nbsp;(CodeObject)&nbsp;The&nbsp;template&nbsp;variable&nbsp;this&nbsp;string&nbsp;came&nbsp;from.&nbsp;This\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;used&nbsp;to&nbsp;extract&nbsp;details&nbsp;about&nbsp;the&nbsp;variable&nbsp;which&nbsp;may&nbsp;be&nbsp;useful&nbsp;in\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;building&nbsp;a&nbsp;name,&nbsp;such&nbsp;as&nbsp;the&nbsp;module&nbsp;it&nbsp;belongs&nbsp;to.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s:&nbsp;(str)&nbsp;A&nbsp;string&nbsp;to&nbsp;transform.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;policy:&nbsp;(NamingPolicy)&nbsp;The&nbsp;naming&nbsp;policy&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;transform.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns:\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transformed&nbsp;string.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>.ApplyCaseTransform</span>(<span id="ast-14" class="other_trans">s</span>,&nbsp;<span id="ast-15" class="other_trans">policy</span>)</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-17"><span id="ast-18" class="other_trans">policy</span>.format_string</span>:<span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>name</span>&nbsp;=&nbsp;<span id="ast-21"><span id="ast-22"><span id="ast-23">self</span>.ApplyFormat</span>(<span id="ast-24" class="other_trans">variable</span>,&nbsp;<span id="ast-25" class="other_trans">name</span>,&nbsp;<span id="ast-26" class="other_trans">policy</span>)</span></span></span><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-28">(<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">name</span>.lower</span>()</span><span id="ast-32">&nbsp;in&nbsp;</span><span id="ast-33"><span id="ast-34">self</span>.reserved_words</span>)</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">policy</span>.conflict_policy</span>:<span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-39"><span id="ast-40"><span id="ast-41">self</span>.TransformString</span>(<span id="ast-42" class="other_trans">variable</span>,&nbsp;<span id="ast-43" class="other_trans">s</span>,&nbsp;<span id="ast-44"><span id="ast-45" class="other_trans">policy</span>.conflict_policy</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-47">(<span id="ast-48" class="correct_node">s&nbsp;&rarr;&nbsp;name&nbsp;</span>&nbsp;+&nbsp;<span id="ast-50">'__'</span>)</span></span></span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-52" class="other_trans">name</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;run(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">monitor</span>,&nbsp;<span id="ast-6" class="other_trans">display</span>,&nbsp;<span id="ast-8" class="other_trans">is_train</span></span>):<span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13"><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.stat</span>.load_model</span>()</span></span><span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18"><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.target_network</span>.hard_copy_from</span>(<span id="ast-20"><span id="ast-21">self</span>.pred_network</span>)</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23" class="other_trans">monitor</span>:<span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.env</span>.monitor</span>.start</span>(<span id="ast-30">(<span id="ast-31">'/tmp/%s-%s'</span>&nbsp;%&nbsp;<span id="ast-33">(<span id="ast-34"><span id="ast-35">self</span>.env_name</span>,&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">get_timestamp</span>()</span>)</span>)</span>)</span></span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-39"><span id="ast-40">self</span>.idx_episode</span>&nbsp;in&nbsp;<span id="ast-41"><span id="ast-42" class="other_trans">xrange</span>(<span id="ast-43"><span id="ast-44">self</span>.max_episodes</span>)</span>:<span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>state</span>&nbsp;=&nbsp;<span id="ast-47"><span id="ast-48"><span id="ast-49"><span id="ast-50">self</span>.env</span>.reset</span>()</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-52" class="other_trans">t</span>&nbsp;in&nbsp;<span id="ast-53"><span id="ast-54" class="other_trans">xrange</span>(<span id="ast-55">0</span>,&nbsp;<span id="ast-56"><span id="ast-57">self</span>.max_steps</span>)</span>:<span id="ast-58"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-59" class="other_trans">display</span>:<span id="ast-60"><span id="ast-61"><span id="ast-62"><span id="ast-63" class="correct_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>env&nbsp;&rarr;&nbsp;self.&nbsp;</span>.render</span>()</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__getitem__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">index</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;an&nbsp;item&nbsp;from&nbsp;the&nbsp;array&nbsp;through&nbsp;indexing.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Supports&nbsp;basic&nbsp;indexing&nbsp;with&nbsp;slices&nbsp;and&nbsp;ints,&nbsp;or&nbsp;advanced\\u000a&nbsp;&nbsp;&nbsp;&nbsp;indexing&nbsp;with&nbsp;lists&nbsp;or&nbsp;ndarrays&nbsp;of&nbsp;integers.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Mixing&nbsp;basic&nbsp;and&nbsp;advanced&nbsp;indexing&nbsp;across&nbsp;axes&nbsp;is&nbsp;not\\u000a&nbsp;&nbsp;&nbsp;&nbsp;currently&nbsp;supported.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Parameters\\u000a&nbsp;&nbsp;&nbsp;&nbsp;----------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;:&nbsp;tuple&nbsp;of&nbsp;slices,&nbsp;ints,&nbsp;list,&nbsp;tuple,&nbsp;or&nbsp;ndarrays\\u000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;One&nbsp;or&nbsp;more&nbsp;index&nbsp;specifications\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Returns\\u000a&nbsp;&nbsp;&nbsp;&nbsp;-------\\u000a&nbsp;&nbsp;&nbsp;&nbsp;BoltSparkArray\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>index</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10">list</span>(<span id="ast-11"><span id="ast-12">tupleize</span>(<span id="ast-13">index</span>)</span>)</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-15">(<span id="ast-16"><span id="ast-17" class="other_trans">len</span>(<span id="ast-18">index</span>)</span><span id="ast-19" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-20"><span id="ast-21">self</span>.ndim</span>)</span>:<span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-23"><span id="ast-24">ValueError</span>(<span id="ast-25">'Too&nbsp;many&nbsp;indices&nbsp;for&nbsp;array'</span>)</span></span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-27">(<span id="ast-28">not</span>&nbsp;<span id="ast-29"><span id="ast-30">all</span>(<span id="ast-31">[<span id="ast-32"><span id="ast-33">isinstance</span>(<span id="ast-34">i</span>,&nbsp;<span id="ast-35">(<span id="ast-36">slice</span>,&nbsp;<span id="ast-37">int</span>,&nbsp;<span id="ast-38">list</span>,&nbsp;<span id="ast-39">tuple</span>,&nbsp;<span id="ast-40">ndarray</span>)</span>)</span><span id="ast-41">&nbsp;for&nbsp;<span id="ast-42" class="other_trans">i</span>&nbsp;in&nbsp;<span id="ast-43" class="other_trans">index</span></span>]</span>)</span>)</span>:<span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-45"><span id="ast-46">ValueError</span>(<span id="ast-47">'Each&nbsp;index&nbsp;must&nbsp;either&nbsp;be&nbsp;a&nbsp;slice,&nbsp;int,&nbsp;list,&nbsp;set,&nbsp;or&nbsp;ndarray'</span>)</span></span></span><span id="ast-48"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-49">(<span id="ast-50"><span id="ast-51">len</span>(<span id="ast-52">index</span>)</span><span id="ast-53" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-54"><span id="ast-55">self</span>.ndim</span>)</span>:<span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>index</span>&nbsp;+=&nbsp;<span id="ast-59"><span id="ast-60" class="other_trans">tuple</span>(<span id="ast-61">[<span id="ast-62"><span id="ast-63" class="other_trans">slice</span>(<span id="ast-64">0</span>,&nbsp;<span id="ast-65">None</span>,&nbsp;<span id="ast-66" class="other_trans">None</span>)</span><span id="ast-67">&nbsp;for&nbsp;<span id="ast-68" class="other_trans">_</span>&nbsp;in&nbsp;<span id="ast-69"><span id="ast-70">range</span>(<span id="ast-71">(<span id="ast-72"><span id="ast-73">self</span>.ndim</span>&nbsp;-&nbsp;<span id="ast-75"><span id="ast-76">len</span>(<span id="ast-77" class="other_trans">index</span>)</span>)</span>)</span></span>]</span>)</span></span></span><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-79">(<span id="ast-80" class="other_trans">n</span>,&nbsp;<span id="ast-81" class="other_trans">idx</span>)</span>&nbsp;in&nbsp;<span id="ast-82"><span id="ast-83">enumerate</span>(<span id="ast-84">index</span>)</span>:<span id="ast-85"><span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>size</span>&nbsp;=&nbsp;<span id="ast-87"><span id="ast-88"><span id="ast-89">self</span>.shape</span>[<span id="ast-90"><span id="ast-91">n</span></span>]</span></span><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-93"><span id="ast-94">isinstance</span>(<span id="ast-95" class="other_trans">idx</span>,&nbsp;<span id="ast-96">slice</span>)</span>:<span id="ast-97"><span id="ast-98" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>minval</span>&nbsp;=&nbsp;<span id="ast-99"><span id="ast-105">0</span>&nbsp;if&nbsp;<span id="ast-100">(<span id="ast-101"><span id="ast-102">idx</span>.start</span><span id="ast-103" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-104" class="other_trans">None</span>)</span>&nbsp;else&nbsp;<span id="ast-106"><span id="ast-107">idx</span>.start</span></span></span><span id="ast-108"><span id="ast-109"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>maxval</span>&nbsp;=&nbsp;<span id="ast-110"><span id="ast-116" class="other_trans">size</span>&nbsp;if&nbsp;<span id="ast-111">(<span id="ast-112"><span id="ast-113">idx</span>.stop</span><span id="ast-114" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-115">None</span>)</span>&nbsp;else&nbsp;<span id="ast-117"><span id="ast-118">idx</span>.stop</span></span></span><span id="ast-119"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-120">(<span id="ast-121" class="other_trans">minval</span><span id="ast-122" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-123">0</span>)</span>:<span id="ast-124"><span id="ast-125" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>minval</span>&nbsp;=&nbsp;<span id="ast-126">(<span id="ast-127" class="other_trans">size</span>&nbsp;+&nbsp;<span id="ast-129" class="other_trans">minval</span>)</span></span></span><span id="ast-130"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-131">(<span id="ast-132" class="other_trans">maxval</span><span id="ast-133" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-134">0</span>)</span>:<span id="ast-135"><span id="ast-136" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>maxval</span>&nbsp;=&nbsp;<span id="ast-137">(<span id="ast-138">size</span>&nbsp;+&nbsp;<span id="ast-140" class="incorrect_node">maxval&nbsp;&rarr;&nbsp;minval&nbsp;</span>)</span></span></span><span id="ast-141"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-142">(<span id="ast-143">minval</span><span id="ast-144" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-145">0</span>)</span>:<span id="ast-146"><span id="ast-147"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>minval</span>&nbsp;=&nbsp;<span id="ast-148">0</span></span></span><span id="ast-149"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-150">(<span id="ast-151">maxval</span><span id="ast-152" class="ref_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;>&nbsp;</span><span id="ast-153">size</span>)</span>:<span id="ast-154"><span id="ast-155" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>maxval</span>&nbsp;=&nbsp;<span id="ast-156" class="other_trans">size</span></span></span><span id="ast-157"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-158">(<span id="ast-160">(<span id="ast-161" class="other_trans">minval</span><span id="ast-162" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-163">(<span id="ast-164">size</span>&nbsp;-&nbsp;<span id="ast-166">1</span>)</span>)</span>&nbsp;or&nbsp;<span id="ast-167">(<span id="ast-168" class="other_trans">maxval</span><span id="ast-169" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-170">1</span>)</span>&nbsp;or&nbsp;<span id="ast-171">(<span id="ast-172">minval</span><span id="ast-173" class="other_trans">&nbsp;&gt;=&nbsp;</span><span id="ast-174" class="other_trans">maxval</span>)</span>)</span>:<span id="ast-175"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-176"><span id="ast-177">ValueError</span>(<span id="ast-178"><span id="ast-179"><span id="ast-180">'Index&nbsp;{}&nbsp;in&nbsp;in&nbsp;dimension&nbsp;{}&nbsp;with&nbsp;shape&nbsp;{}&nbsp;would&nbsp;produce&nbsp;an&nbsp;empty&nbsp;dimension'</span>.format</span>(<span id="ast-181">idx</span>,&nbsp;<span id="ast-182">n</span>,&nbsp;<span id="ast-183" class="other_trans">size</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-184"><span id="ast-185"><span id="ast-186"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>index</span>[<span id="ast-187"><span id="ast-188" class="other_trans">n</span></span>]</span>&nbsp;=&nbsp;<span id="ast-189"><span id="ast-190">slice</span>(<span id="ast-191">minval</span>,&nbsp;<span id="ast-192">maxval</span>,&nbsp;<span id="ast-193"><span id="ast-194">idx</span>.step</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-195"><span id="ast-196"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos</span>&nbsp;=&nbsp;<span id="ast-197">[<span id="ast-198"><span id="ast-203">(<span id="ast-204" class="other_trans">size</span>&nbsp;+&nbsp;<span id="ast-206">i</span>)</span>&nbsp;if&nbsp;<span id="ast-199">(<span id="ast-200">i</span><span id="ast-201" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-202">0</span>)</span>&nbsp;else&nbsp;<span id="ast-207">i</span></span><span id="ast-208">&nbsp;for&nbsp;<span id="ast-209">i</span>&nbsp;in&nbsp;<span id="ast-210"><span id="ast-211"><span id="ast-212"><span id="ast-213">array</span>(<span id="ast-214" class="other_trans">idx</span>)</span>.flatten</span>()</span></span>]</span></span><span id="ast-215"><span id="ast-216"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>minval</span>&nbsp;=&nbsp;<span id="ast-217"><span id="ast-218" class="other_trans">min</span>(<span id="ast-219">pos</span>)</span></span><span id="ast-220"><span id="ast-221" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>maxval</span>&nbsp;=&nbsp;<span id="ast-222"><span id="ast-223">max</span>(<span id="ast-224" class="other_trans">pos</span>)</span></span><span id="ast-225"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-226">(<span id="ast-228">(<span id="ast-229" class="other_trans">minval</span><span id="ast-230" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-231">0</span>)</span>&nbsp;or&nbsp;<span id="ast-232">(<span id="ast-233">maxval</span><span id="ast-234" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-235">(<span id="ast-236">size</span>&nbsp;-&nbsp;<span id="ast-238">1</span>)</span>)</span>)</span>:<span id="ast-239"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-240"><span id="ast-241">ValueError</span>(<span id="ast-242"><span id="ast-243"><span id="ast-244">'Index&nbsp;{}&nbsp;out&nbsp;of&nbsp;bounds&nbsp;in&nbsp;dimension&nbsp;{}&nbsp;with&nbsp;shape&nbsp;{}'</span>.format</span>(<span id="ast-245" class="other_trans">idx</span>,&nbsp;<span id="ast-246" class="other_trans">n</span>,&nbsp;<span id="ast-247">size</span>)</span>)</span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;open_spikes(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Open&nbsp;a&nbsp;HDF5&nbsp;kwik&nbsp;file.'</span></span><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8">not</span>&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11"><span id="ast-12" class="other_trans">os</span>.path</span>.exists</span>(<span id="ast-13"><span id="ast-14">self</span>.filename_kwik</span>)</span>)</span>:<span id="ast-15"><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>klusters_to_hdf5</span>(<span id="ast-18" class="correct_node">filename&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-19"><span id="ast-20">self</span>.klusters_to_hdf5_progress_report</span>)</span></span></span><span id="ast-21"><span id="ast-22"><span id="ast-23"><span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.initialize_logfile</span>()</span></span><span id="ast-25"><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.similarity_measure</span>&nbsp;=&nbsp;<span id="ast-28">(<span id="ast-30"><span id="ast-31"><span id="ast-32">self</span>.userpref</span>[<span id="ast-33"><span id="ast-34">'similarity_measure'</span></span>]</span>&nbsp;or&nbsp;<span id="ast-35">'gaussian'</span>)</span></span><span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>debug</span>(<span id="ast-39"><span id="ast-40"><span id="ast-41">'Similarity&nbsp;measure:&nbsp;{0:s}.'</span>.format</span>(<span id="ast-42"><span id="ast-43">self</span>.similarity_measure</span>)</span>)</span></span><span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>info</span>(<span id="ast-47"><span id="ast-48"><span id="ast-49">'Opening&nbsp;{0:s}.'</span>.format</span>(<span id="ast-50"><span id="ast-51">self</span>.filename</span>)</span>)</span></span><span id="ast-52"><span id="ast-53"><span id="ast-54"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.kwik</span>&nbsp;=&nbsp;<span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans">tb</span>.openFile</span>(<span id="ast-58"><span id="ast-59">self</span>.filename</span>,&nbsp;mode=<span id="ast-61">'r+'</span>)</span></span><span id="ast-62"><span id="ast-63"><span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.shanks</span>&nbsp;=&nbsp;<span id="ast-65"><span id="ast-66" class="other_trans">list</span>(<span id="ast-67"><span id="ast-68"><span id="ast-69"><span id="ast-70">self</span>.kwik</span>.getNodeAttr</span>(<span id="ast-71">'/metadata'</span>,&nbsp;<span id="ast-72">'SHANKS'</span>)</span>)</span></span><span id="ast-73"><span id="ast-74"><span id="ast-75"><span id="ast-76"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.read_metadata</span>()</span></span><span id="ast-77"><span id="ast-78"><span id="ast-79"><span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.set_shank</span>(<span id="ast-81"><span id="ast-82"><span id="ast-83">self</span>.shanks</span>[<span id="ast-84"><span id="ast-85">0</span></span>]</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__build_magic(<span id="ast-2"><span id="ast-3" class="other_trans">magic</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6"><span id="ast-7" class="other_trans">sys</span>.version_info</span><span id="ast-8" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;<&nbsp;</span><span id="ast-9">(<span id="ast-10">3</span>,&nbsp;<span id="ast-11">0</span>)</span>)</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15" class="other_trans">struct</span>.pack</span>(<span id="ast-16">'Hcc'</span>,&nbsp;<span id="ast-17" class="other_trans">magic</span>,&nbsp;<span id="ast-18"><span id="ast-19" class="other_trans">bytes</span>(<span id="ast-20">'\\u000d'</span>,&nbsp;<span id="ast-21">'utf-8'</span>)</span>,&nbsp;<span id="ast-22"><span id="ast-23" class="other_trans">bytes</span>(<span id="ast-24">'\\u000a'</span>,&nbsp;<span id="ast-25">'utf-8'</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-27"><span id="ast-28"><span id="ast-29" class="other_trans">struct</span>.pack</span>(<span id="ast-30">'Hcc'</span>,&nbsp;<span id="ast-31" class="other_trans">magic</span>,&nbsp;<span id="ast-32">'\\u000d'</span>,&nbsp;<span id="ast-33">'\\u000a'</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_mendeley_percent_of_products(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6">not</span>&nbsp;<span id="ast-7"><span id="ast-8">self</span>.all_products</span>)</span>:<span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-10" class="other_trans">None</span></span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>count</span>&nbsp;=&nbsp;<span id="ast-13">0</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-15" class="other_trans">p</span>&nbsp;in&nbsp;<span id="ast-16"><span id="ast-17">self</span>.all_products</span>:<span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-21"><span id="ast-22" class="other_trans">p</span>.mendeley_api_raw</span>&nbsp;and&nbsp;<span id="ast-23">(<span id="ast-24">'reader_count'</span><span id="ast-25">&nbsp;in&nbsp;</span><span id="ast-26"><span id="ast-27" class="other_trans">p</span>.mendeley_api_raw</span>)</span>)</span>:<span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-29">(<span id="ast-30"><span id="ast-31"><span id="ast-32" class="other_trans">p</span>.mendeley_api_raw</span>[<span id="ast-33"><span id="ast-34">'reader_count'</span></span>]</span><span id="ast-35" class="location_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-36">1</span>)</span>:<span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>count</span>&nbsp;+=&nbsp;<span id="ast-40">1</span></span></span></span></span><span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-42">(<span id="ast-43"><span id="ast-44" class="other_trans">float</span>(<span id="ast-45" class="other_trans">count</span>)</span>&nbsp;/&nbsp;<span id="ast-47"><span id="ast-48" class="other_trans">len</span>(<span id="ast-49"><span id="ast-50">self</span>.all_products</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;train(<span id="ast-2"><span id="ast-3" class="other_trans">module</span>,&nbsp;<span id="ast-4" class="other_trans">train_file_list</span>,&nbsp;<span id="ast-5" class="other_trans">model_file</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>training_data</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">list</span>(<span id="ast-10"><span id="ast-11" class="other_trans">readTrainingData</span>(<span id="ast-12" class="other_trans">train_file_list</span>,&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">module</span>.GROUP_LABEL</span>)</span>)</span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16">(<span id="ast-17">not</span>&nbsp;<span id="ast-18" class="other_trans">training_data</span>)</span>:<span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-20">'ERROR:&nbsp;No&nbsp;training&nbsp;data&nbsp;found.&nbsp;Perhaps&nbsp;double&nbsp;check&nbsp;your&nbsp;training&nbsp;data&nbsp;filepaths?'</span></span><span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-24" class="other_trans">model_file</span><span id="ast-25" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-26" class="other_trans">None</span>)</span>:<span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>model_path</span>&nbsp;=&nbsp;<span id="ast-29">(<span id="ast-30">(<span id="ast-31"><span id="ast-32" class="other_trans">module</span>.__name__</span>&nbsp;+&nbsp;<span id="ast-34">'/'</span>)</span>&nbsp;+&nbsp;<span id="ast-36"><span id="ast-37" class="other_trans">module</span>.MODEL_FILE</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-38"><span id="ast-39" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>model_path</span>&nbsp;=&nbsp;<span id="ast-40" class="other_trans">model_file</span></span></span><span id="ast-41"><span id="ast-42"><span id="ast-43" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>renameModelFile</span>(<span id="ast-44" class="other_trans">model_path</span>)</span></span><span id="ast-45"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48">'\\u000atraining&nbsp;model&nbsp;on&nbsp;{num}&nbsp;training&nbsp;examples&nbsp;from&nbsp;{file_list}'</span>.format</span>(num=<span id="ast-50"><span id="ast-51">len</span>(<span id="ast-52" class="other_trans">training_data</span>)</span>,&nbsp;file_list=<span id="ast-54" class="other_trans">train_file_list</span>)</span></span><span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>trainModel</span>(<span id="ast-58" class="other_trans">training_data</span>,&nbsp;<span id="ast-59" class="other_trans">module</span>,&nbsp;<span id="ast-60" class="ref_node">model_file&nbsp;&rarr;&nbsp;model_path&nbsp;</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;create_ids_with_align(<span id="ast-2"><span id="ast-3">corpus</span>,&nbsp;<span id="ast-4">id_</span>,&nbsp;<span id="ast-5">vocab</span>,&nbsp;<span id="ast-6" class="other_trans">args</span></span>):<span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8">(<span id="ast-10">(<span id="ast-11" class="other_trans">id_</span><span id="ast-12" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-13">(<span id="ast-14"><span id="ast-15" class="other_trans">len</span>(<span id="ast-16"><span id="ast-17" class="other_trans">args</span>.extensions</span>)</span>&nbsp;-&nbsp;<span id="ast-19">1</span>)</span>)</span>&nbsp;and&nbsp;<span id="ast-20">(<span id="ast-21" class="other_trans">id_</span><span id="ast-22" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-23">0</span>)</span>&nbsp;and&nbsp;<span id="ast-24">(<span id="ast-25">'train'</span><span id="ast-26">&nbsp;in&nbsp;</span><span id="ast-27" class="other_trans">corpus</span>)</span>)</span>:<span id="ast-28"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-29">corpus</span></span><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>align_file</span>&nbsp;=&nbsp;<span id="ast-32"><span id="ast-33"><span id="ast-34">'{}.{}'</span>.format</span>(<span id="ast-35">corpus</span>,&nbsp;<span id="ast-36">'align'</span>)</span></span><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>align_lines</span>&nbsp;=&nbsp;<span id="ast-39">[<span id="ast-40"><span id="ast-41"><span id="ast-42" class="other_trans">line</span>.split</span>()</span><span id="ast-43">&nbsp;for&nbsp;<span id="ast-44">line</span>&nbsp;in&nbsp;<span id="ast-45"><span id="ast-46" class="other_trans">open</span>(<span id="ast-47">align_file</span>)</span></span>]</span></span><span id="ast-48"><span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>filename</span>&nbsp;=&nbsp;<span id="ast-50"><span id="ast-51"><span id="ast-52">'{}.{}'</span>.format</span>(<span id="ast-53" class="other_trans">corpus</span>,&nbsp;<span id="ast-54"><span id="ast-55"><span id="ast-56">args</span>.extensions</span>[<span id="ast-57"><span id="ast-58" class="other_trans">id_</span></span>]</span>)</span></span><span id="ast-59"><span id="ast-60" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>output_filename</span>&nbsp;=&nbsp;<span id="ast-61"><span id="ast-62"><span id="ast-63">'{}.ids{}.{}'</span>.format</span>(<span id="ast-64" class="other_trans">corpus</span>,&nbsp;<span id="ast-65"><span id="ast-66"><span id="ast-67">args</span>.vocab_size</span>[<span id="ast-68"><span id="ast-69" class="other_trans">id_</span></span>]</span>,&nbsp;<span id="ast-70"><span id="ast-71"><span id="ast-72" class="other_trans">args</span>.extensions</span>[<span id="ast-73"><span id="ast-74" class="other_trans">id_</span></span>]</span>)</span></span><span id="ast-75"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-76"><span id="ast-77">open</span>(<span id="ast-78">filename</span>)</span>&nbsp;as&nbsp;<span id="ast-79">input_file</span>:<span id="ast-80"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-81"><span id="ast-82">open</span>(<span id="ast-83">output_filename</span>,&nbsp;<span id="ast-84">'w'</span>)</span>&nbsp;as&nbsp;<span id="ast-85" class="other_trans">output_file</span>:<span id="ast-86"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-87">(<span id="ast-88">i</span>,&nbsp;<span id="ast-89" class="other_trans">line</span>)</span>&nbsp;in&nbsp;<span id="ast-90"><span id="ast-91">enumerate</span>(<span id="ast-92" class="other_trans">input_file</span>)</span>:<span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ids</span>&nbsp;=&nbsp;<span id="ast-95">[]</span></span><span id="ast-96"><span id="ast-97" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>align_pair</span>&nbsp;=&nbsp;<span id="ast-98"><span id="ast-99">dict</span>(<span id="ast-100">(<span id="ast-101"><span id="ast-102"><span id="ast-103">item</span>.split</span>(<span id="ast-104">'-'</span>)</span><span id="ast-105">&nbsp;for&nbsp;<span id="ast-106">item</span>&nbsp;in&nbsp;<span id="ast-107"><span id="ast-108">align_lines</span>[<span id="ast-109"><span id="ast-110">i</span></span>]</span></span>)</span>)</span></span><span id="ast-111"><span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>align_pair</span>&nbsp;=&nbsp;<span id="ast-113">{<span id="ast-114"><span id="ast-115">int</span>(<span id="ast-116" class="other_trans">v</span>)</span>:&nbsp;<span id="ast-117"><span id="ast-118" class="other_trans">int</span>(<span id="ast-119" class="other_trans">k</span>)</span><span id="ast-120">&nbsp;for&nbsp;<span id="ast-121">(<span id="ast-122">k</span>,&nbsp;<span id="ast-123" class="other_trans">v</span>)</span>&nbsp;in&nbsp;<span id="ast-124"><span id="ast-125"><span id="ast-126" class="other_trans">align_pair</span>.items</span>()</span></span>}</span></span><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-128">(<span id="ast-129">j</span>,&nbsp;<span id="ast-130">w</span>)</span>&nbsp;in&nbsp;<span id="ast-131"><span id="ast-132">enumerate</span>(<span id="ast-133"><span id="ast-134"><span id="ast-135">line</span>.split</span>()</span>)</span>:<span id="ast-136"><span id="ast-137"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>token</span>&nbsp;=&nbsp;<span id="ast-138"><span id="ast-139"><span id="ast-140">vocab</span>.get</span>(<span id="ast-141">w</span>,&nbsp;<span id="ast-142">UNK_ID</span>)</span></span><span id="ast-143"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-144">(<span id="ast-145" class="other_trans">token</span><span id="ast-146" class="incorrect_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-147">UNK_ID</span>)</span>:<span id="ast-148"><span id="ast-149" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>pos_source</span>&nbsp;=&nbsp;<span id="ast-150"><span id="ast-151"><span id="ast-152" class="other_trans">align_pair</span>.get</span>(<span id="ast-153">j</span>,&nbsp;<span id="ast-154">(<span id="ast-155" class="other_trans">j</span>&nbsp;+&nbsp;<span id="ast-157">8</span>)</span>)</span></span><span id="ast-158"><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>offset</span>&nbsp;=&nbsp;<span id="ast-160">(<span id="ast-161"><span id="ast-162" class="other_trans">int</span>(<span id="ast-163">pos_source</span>)</span>&nbsp;-&nbsp;<span id="ast-165"><span id="ast-166">int</span>(<span id="ast-167">j</span>)</span>)</span></span><span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-169">(<span id="ast-170"><span id="ast-171">abs</span>(<span id="ast-172" class="other_trans">offset</span>)</span><span id="ast-173" class="ref_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=&nbsp;</span><span id="ast-174">7</span>)</span>:<span id="ast-175"><span id="ast-176"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>token</span>&nbsp;=&nbsp;<span id="ast-177"><span id="ast-178">UNKS</span>[<span id="ast-179"><span id="ast-180">(<span id="ast-181">7</span>&nbsp;+&nbsp;<span id="ast-183">offset</span>)</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-184"><span id="ast-185"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>token</span>&nbsp;=&nbsp;<span id="ast-186"><span id="ast-187" class="other_trans">UNKS</span>[<span id="ast-188"><span id="ast-189">15</span></span>]</span></span></span></span><span id="ast-190"><span id="ast-191"><span id="ast-192"><span id="ast-193"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ids</span>.append</span>(<span id="ast-194"><span id="ast-195">str</span>(<span id="ast-196" class="other_trans">token</span>)</span>)</span></span></span><span id="ast-197"><span id="ast-198"><span id="ast-199"><span id="ast-200" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>output_file</span>.write</span>(<span id="ast-201">(<span id="ast-202"><span id="ast-203"><span id="ast-204">'&nbsp;'</span>.join</span>(<span id="ast-205" class="other_trans">ids</span>)</span>&nbsp;+&nbsp;<span id="ast-207">'\\u000a'</span>)</span>)</span></span></span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-208"><span id="ast-209"><span id="ast-210" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>create_ids</span>(<span id="ast-211">corpus</span>,&nbsp;<span id="ast-212" class="other_trans">id_</span>,&nbsp;<span id="ast-213">vocab</span>,&nbsp;<span id="ast-214" class="other_trans">args</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;add_common_vars(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">host_groups</span>,&nbsp;<span id="ast-5" class="other_trans">layout</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>common_vars</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">layout</span>[<span id="ast-10"><span id="ast-11">'vars'</span></span>]</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-13" class="other_trans">group</span>&nbsp;in&nbsp;<span id="ast-14" class="other_trans">host_groups</span>:<span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>items</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20" class="other_trans">dict</span>(<span id="ast-21"><span id="ast-22"><span id="ast-23" class="correct_node">config&nbsp;&rarr;&nbsp;self.&nbsp;</span>.items</span>(<span id="ast-24" class="other_trans">group</span>)</span>)</span>.keys</span>()</span></span><span id="ast-25"><span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.config</span>.remove_section</span>(<span id="ast-30" class="other_trans">group</span>)</span></span><span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34"><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.config</span>.add_section</span>(<span id="ast-36" class="other_trans">group</span>)</span></span><span id="ast-37"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-38" class="other_trans">item</span>&nbsp;in&nbsp;<span id="ast-39" class="other_trans">items</span>:<span id="ast-40"><span id="ast-41"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>host_string</span>&nbsp;=&nbsp;<span id="ast-42" class="other_trans">item</span></span><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-44" class="other_trans">var</span>&nbsp;in&nbsp;<span id="ast-45" class="other_trans">common_vars</span>:<span id="ast-46"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-47">(<span id="ast-48"><span id="ast-49" class="other_trans">common_vars</span>[<span id="ast-50"><span id="ast-51" class="other_trans">var</span></span>]</span><span id="ast-52" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-53">'__IP__'</span>)</span>:<span id="ast-54"><span id="ast-55" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>host_string</span>&nbsp;+=&nbsp;<span id="ast-57">(<span id="ast-58">(<span id="ast-59">(<span id="ast-60">(<span id="ast-61">'&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-63" class="other_trans">var</span>)</span>&nbsp;+&nbsp;<span id="ast-65">'='</span>)</span>&nbsp;+&nbsp;<span id="ast-67" class="other_trans">item</span>)</span>&nbsp;+&nbsp;<span id="ast-69">'&nbsp;'</span>)</span></span></span></span><span id="ast-70"><span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.config</span>.set</span>(<span id="ast-75" class="other_trans">group</span>,&nbsp;<span id="ast-76" class="other_trans">host_string</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;new_block(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">blockheight</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Notification&nbsp;that&nbsp;a&nbsp;new&nbsp;block&nbsp;height&nbsp;has&nbsp;been&nbsp;reached.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11"><span id="ast-12"><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>Payout</span>.query</span>.filter</span>(<span id="ast-15">(<span id="ast-16"><span id="ast-17" class="other_trans">Payout</span>.block</span><span id="ast-18" class="location_node">&nbsp;&lt;=&nbsp;&nbsp;&rarr;&nbsp;<,&nbsp;pred:&nbsp;==&nbsp;</span><span id="ast-19">(<span id="ast-20" class="other_trans">blockheight</span>&nbsp;-&nbsp;<span id="ast-22">120</span>)</span>)</span>)</span>.update</span>(<span id="ast-23">{<span id="ast-24"><span id="ast-25" class="other_trans">Payout</span>.mature</span>:&nbsp;<span id="ast-26">True</span>}</span>)</span></span><span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>db</span>.session</span>.commit</span>()</span></span><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-33" class="other_trans">Exception</span>&nbsp;as&nbsp;<span id="ast-34" class="other_trans">exc</span>:<span id="ast-35"><span id="ast-36"><span id="ast-37"><span id="ast-38" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.error</span>(<span id="ast-39">'Unhandled&nbsp;exception&nbsp;in&nbsp;new_block'</span>,&nbsp;exc_info=<span id="ast-41">True</span>)</span></span><span id="ast-42"><span id="ast-43"><span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>db</span>.session</span>.rollback</span>()</span></span><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-48"><span id="ast-49"><span id="ast-50">self</span>.retry</span>(exc=<span id="ast-52" class="other_trans">exc</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;map_constant(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">x</span>,&nbsp;<span id="ast-5" class="other_trans">enclosing_prec</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>import&nbsp;<span id="ast-7">numpy</span></span><span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9"><span id="ast-10" class="other_trans">isinstance</span>(<span id="ast-11" class="other_trans">x</span>,&nbsp;<span id="ast-12" class="other_trans">complex</span>)</span>:<span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-14">(<span id="ast-15">'std::complex&lt;%s&gt;(%s,&nbsp;%s)'</span>&nbsp;%&nbsp;<span id="ast-17">(<span id="ast-18" class="correct_node">complex_constant_base_type&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-19"><span id="ast-20"><span id="ast-21">self</span>.constant_mapper</span>(<span id="ast-22"><span id="ast-23" class="other_trans">x</span>.real</span>)</span>,&nbsp;<span id="ast-24"><span id="ast-25"><span id="ast-26">self</span>.constant_mapper</span>(<span id="ast-27"><span id="ast-28" class="other_trans">x</span>.imag</span>)</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-29"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-30"><span id="ast-31"><span id="ast-32" class="other_trans">SimplifyingSortingStringifyMapper</span>.map_constant</span>(<span id="ast-33">self</span>,&nbsp;<span id="ast-34" class="other_trans">x</span>,&nbsp;<span id="ast-35" class="other_trans">enclosing_prec</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__getitem__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">index</span></span>):<span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-6"><span id="ast-7" class="other_trans">isinstance</span>(<span id="ast-8" class="other_trans">index</span>,&nbsp;<span id="ast-9" class="other_trans">slice</span>)</span>:<span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-11"><span id="ast-12"><span id="ast-13">self</span>._get_slice</span>(<span id="ast-14" class="other_trans">index</span>)</span></span></span><span id="ast-15"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-16">(<span id="ast-17" class="other_trans">index</span><span id="ast-18" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;>=&nbsp;</span><span id="ast-19">(<span id="ast-20"><span id="ast-21">self</span>.page_size</span>&nbsp;*&nbsp;<span id="ast-23"><span id="ast-24">self</span>.max_pages</span>)</span>)</span>:<span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-26"><span id="ast-27" class="other_trans">IndexError</span>(<span id="ast-28">'list&nbsp;index&nbsp;out&nbsp;of&nbsp;range'</span>)</span></span></span><span id="ast-29"><span id="ast-30" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>normalized_index</span>&nbsp;=&nbsp;<span id="ast-31">(<span id="ast-32" class="other_trans">index</span>&nbsp;%&nbsp;<span id="ast-34"><span id="ast-35">self</span>.page_size</span>)</span></span><span id="ast-36"><span id="ast-37" class="incorrect_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>target_page&nbsp;&rarr;&nbsp;self.&nbsp;</span>&nbsp;=&nbsp;<span id="ast-38">(<span id="ast-39"><span id="ast-40"><span id="ast-41" class="other_trans">math</span>.ceil</span>(<span id="ast-42">(<span id="ast-43">(<span id="ast-44" class="other_trans">index</span>&nbsp;+&nbsp;<span id="ast-46">1</span>)</span>&nbsp;/&nbsp;<span id="ast-48"><span id="ast-49">self</span>.page_size</span>)</span>)</span>&nbsp;-&nbsp;<span id="ast-51">1</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_get_rw_functions_rs(<span id="ast-2"><span id="ast-3">reg_name</span>,&nbsp;<span id="ast-4">reg_base</span>,&nbsp;<span id="ast-5" class="other_trans">nwords</span>,&nbsp;<span id="ast-6" class="other_trans">busword</span>,&nbsp;<span id="ast-7" class="other_trans">read_only</span></span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;=&nbsp;<span id="ast-10">''</span></span><span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-14">(<span id="ast-15">(<span id="ast-16">(<span id="ast-17">(<span id="ast-18">'&nbsp;&nbsp;&nbsp;&nbsp;pub&nbsp;const&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22">reg_name</span>.upper</span>()</span>)</span>&nbsp;+&nbsp;<span id="ast-24">'_ADDR:&nbsp;*mut&nbsp;u32&nbsp;=&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-26"><span id="ast-27" class="other_trans">hex</span>(<span id="ast-28">reg_base</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-30">'&nbsp;as&nbsp;*mut&nbsp;u32;\\u000a'</span>)</span></span><span id="ast-31"><span id="ast-32" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-34">(<span id="ast-35">(<span id="ast-36">(<span id="ast-37">(<span id="ast-38">'&nbsp;&nbsp;&nbsp;&nbsp;pub&nbsp;const&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-40"><span id="ast-41"><span id="ast-42" class="other_trans">reg_name</span>.upper</span>()</span>)</span>&nbsp;+&nbsp;<span id="ast-44">'_SIZE:&nbsp;usize&nbsp;=&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-46"><span id="ast-47">str</span>(<span id="ast-48">nwords</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-50">';\\u000a\\u000a'</span>)</span></span><span id="ast-51"><span id="ast-52" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>size</span>&nbsp;=&nbsp;<span id="ast-53">(<span id="ast-54" class="other_trans">nwords</span>&nbsp;*&nbsp;<span id="ast-56" class="other_trans">busword</span>)</span></span><span id="ast-57"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-58">(<span id="ast-59" class="other_trans">size</span><span id="ast-60" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-61">64</span>)</span>:<span id="ast-62"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-63" class="other_trans">r</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-65">(<span id="ast-66" class="other_trans">size</span><span id="ast-67" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-68">32</span>)</span>:<span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rstype</span>&nbsp;=&nbsp;<span id="ast-71">'u64'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-73">(<span id="ast-74" class="other_trans">size</span><span id="ast-75" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-76">16</span>)</span>:<span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rstype</span>&nbsp;=&nbsp;<span id="ast-79">'u32'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-81">(<span id="ast-82" class="other_trans">size</span><span id="ast-83" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-84">8</span>)</span>:<span id="ast-85"><span id="ast-86" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rstype</span>&nbsp;=&nbsp;<span id="ast-87">'u16'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-89">(<span id="ast-90">size</span><span id="ast-91" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-92">1</span>)</span>:<span id="ast-93"><span id="ast-94"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rstype</span>&nbsp;=&nbsp;<span id="ast-95">'u8'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-96"><span id="ast-97" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rstype</span>&nbsp;=&nbsp;<span id="ast-98">'bool'</span></span></span><span id="ast-99"><span id="ast-100"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>rsname</span>&nbsp;=&nbsp;<span id="ast-101">(<span id="ast-102"><span id="ast-103"><span id="ast-104" class="other_trans">reg_name</span>.upper</span>()</span>&nbsp;+&nbsp;<span id="ast-106">'_ADDR'</span>)</span></span><span id="ast-107"><span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-110">'&nbsp;&nbsp;&nbsp;&nbsp;#[inline(always)]\\u000a'</span></span><span id="ast-111"><span id="ast-112"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-114">(<span id="ast-115">(<span id="ast-116">(<span id="ast-117">(<span id="ast-118">'&nbsp;&nbsp;&nbsp;&nbsp;pub&nbsp;unsafe&nbsp;fn&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-120" class="other_trans">reg_name</span>)</span>&nbsp;+&nbsp;<span id="ast-122">'_read()&nbsp;-&gt;&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-124" class="other_trans">rstype</span>)</span>&nbsp;+&nbsp;<span id="ast-126">'&nbsp;{\\u000a'</span>)</span></span><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-128">(<span id="ast-129" class="ref_node">size&nbsp;&rarr;&nbsp;nwords&nbsp;</span><span id="ast-130" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-131">1</span>)</span>:<span id="ast-132"><span id="ast-133" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-135">(<span id="ast-136">(<span id="ast-137">(<span id="ast-138">(<span id="ast-139">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;r&nbsp;=&nbsp;read_volatile('</span>&nbsp;+&nbsp;<span id="ast-141" class="other_trans">rsname</span>)</span>&nbsp;+&nbsp;<span id="ast-143">')&nbsp;as&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-145" class="other_trans">rstype</span>)</span>&nbsp;+&nbsp;<span id="ast-147">';\\u000a'</span>)</span></span><span id="ast-148"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-149" class="other_trans">word</span>&nbsp;in&nbsp;<span id="ast-150"><span id="ast-151" class="other_trans">range</span>(<span id="ast-152">1</span>,&nbsp;<span id="ast-153" class="incorrect_node">nwords&nbsp;&rarr;&nbsp;size&nbsp;</span>)</span>:<span id="ast-154"><span id="ast-155"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-157">(<span id="ast-158">(<span id="ast-159">(<span id="ast-160">(<span id="ast-161">(<span id="ast-162">(<span id="ast-163">(<span id="ast-164">(<span id="ast-165">(<span id="ast-166">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;r&nbsp;=&nbsp;r&nbsp;&lt;&lt;&nbsp;'</span>&nbsp;+&nbsp;<span id="ast-168"><span id="ast-169" class="other_trans">str</span>(<span id="ast-170" class="other_trans">busword</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-172">'&nbsp;|&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-174">'read_volatile('</span>)</span>&nbsp;+&nbsp;<span id="ast-176" class="other_trans">rsname</span>)</span>&nbsp;+&nbsp;<span id="ast-178">'.offset('</span>)</span>&nbsp;+&nbsp;<span id="ast-180"><span id="ast-181">str</span>(<span id="ast-182">word</span>)</span>)</span>&nbsp;+&nbsp;<span id="ast-184">'))&nbsp;as&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-186">rstype</span>)</span>&nbsp;+&nbsp;<span id="ast-188">';\\u000a'</span>)</span></span></span><span id="ast-189"><span id="ast-190"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-192">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r\\u000a'</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-193"><span id="ast-194" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-196">(<span id="ast-197">(<span id="ast-198">(<span id="ast-199">(<span id="ast-200">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_volatile('</span>&nbsp;+&nbsp;<span id="ast-202" class="other_trans">rsname</span>)</span>&nbsp;+&nbsp;<span id="ast-204">')&nbsp;as&nbsp;'</span>)</span>&nbsp;+&nbsp;<span id="ast-206">rstype</span>)</span>&nbsp;+&nbsp;<span id="ast-208">'\\u000a'</span>)</span></span></span><span id="ast-209"><span id="ast-210" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>r</span>&nbsp;+=&nbsp;<span id="ast-212">'&nbsp;&nbsp;&nbsp;&nbsp;}\\u000a\\u000a'</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;detail_pages(<span id="ast-2"><span id="ast-3" class="other_trans">f</span>,&nbsp;<span id="ast-4" class="other_trans">e</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Generate&nbsp;detail&nbsp;pages&nbsp;of&nbsp;individual&nbsp;posts'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>template</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">e</span>.get_template</span>(<span id="ast-12"><span id="ast-13" class="other_trans">TEMPLATES</span>[<span id="ast-14"><span id="ast-15">'detail'</span></span>]</span>)</span></span><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-17" class="other_trans">file</span>&nbsp;in&nbsp;<span id="ast-18" class="other_trans">f</span>:<span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>write_file</span>(<span id="ast-22"><span id="ast-23" class="other_trans">file</span>[<span id="ast-24"><span id="ast-25">'url'</span></span>]</span>,&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans">template</span>.render</span>(entry=<span id="ast-30" class="correct_node">f&nbsp;&rarr;&nbsp;file&nbsp;</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;__init__(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">connection</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Constructor&nbsp;for&nbsp;new&nbsp;commands.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;called&nbsp;once&nbsp;when&nbsp;the&nbsp;command&nbsp;is&nbsp;loaded&nbsp;(from\\u000a&nbsp;&nbsp;&nbsp;&nbsp;commands._load_command()).&nbsp;`connection`&nbsp;is&nbsp;a&nbsp;Connection&nbsp;object,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;allowing&nbsp;us&nbsp;to&nbsp;do&nbsp;self.connection.say(),&nbsp;self.connection.send(),&nbsp;etc,\\u000a&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;within&nbsp;a&nbsp;method.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.connection</span>&nbsp;=&nbsp;<span id="ast-10" class="other_trans">connection</span></span><span id="ast-11"><span id="ast-12"><span id="ast-13"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.logger</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16" class="other_trans">logging</span>.getLogger</span>(<span id="ast-17"><span id="ast-18"><span id="ast-19">'.'</span>.join</span>(<span id="ast-20">(<span id="ast-21">'commands'</span>,&nbsp;<span id="ast-22" class="correct_node">name&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span>)</span>)</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.logger</span>.setLevel</span>(<span id="ast-28"><span id="ast-29" class="other_trans">logging</span>.DEBUG</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_progress(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">msg</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;progress&nbsp;indicator.&nbsp;Prints&nbsp;the&nbsp;progress&nbsp;message&nbsp;if&nbsp;stdout\\u000a&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;connected&nbsp;to&nbsp;a&nbsp;tty&nbsp;(i.e.&nbsp;run&nbsp;from&nbsp;the&nbsp;command&nbsp;prompt),\\u000a&nbsp;&nbsp;&nbsp;&nbsp;logging&nbsp;at&nbsp;info&nbsp;level&nbsp;otherwise.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:param&nbsp;msg:&nbsp;the&nbsp;progress&nbsp;message&nbsp;to&nbsp;be&nbsp;printed.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;:type&nbsp;msg:&nbsp;str\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans">sys</span>.stdout</span>.isatty</span>()</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-13" class="other_trans">msg</span></span><span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>sys</span>.stdout</span>.flush</span>()</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22" class="correct_node"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger&nbsp;&rarr;&nbsp;self.&nbsp;</span>.info</span>(<span id="ast-23" class="other_trans">msg</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_process_agenda_item(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">item</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>uid</span>&nbsp;=&nbsp;<span id="ast-7"><span id="ast-8"><span id="ast-9">self</span>._generate_base_agenda_uid</span>(<span id="ast-10" class="other_trans">item</span>)</span></span><span id="ast-11"><span id="ast-12" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>paper_number</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15">self</span>._get_paper_number</span>(<span id="ast-16" class="other_trans">item</span>)</span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18">(<span id="ast-19"><span id="ast-20" class="other_trans">len</span>(<span id="ast-21"><span id="ast-22" class="other_trans">item</span>[<span id="ast-23"><span id="ast-24">'links'</span></span>]</span>)</span><span id="ast-25" class="correct_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-26">2</span>)</span>:<span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-28">(<span id="ast-29">'English'</span><span id="ast-30">&nbsp;in&nbsp;</span><span id="ast-31"><span id="ast-32"><span id="ast-33" class="other_trans">item</span>[<span id="ast-34"><span id="ast-35">'links'</span></span>]</span>[<span id="ast-36"><span id="ast-37">0</span></span>]</span>)</span>:<span id="ast-38"><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-40">title_en</span>,&nbsp;<span id="ast-41" class="other_trans">url_en</span>)</span>&nbsp;=&nbsp;<span id="ast-42"><span id="ast-43"><span id="ast-44" class="other_trans">item</span>[<span id="ast-45"><span id="ast-46">'links'</span></span>]</span>[<span id="ast-47"><span id="ast-48">0</span></span>]</span></span><span id="ast-49"><span id="ast-50"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-51" class="other_trans">title_cn</span>,&nbsp;<span id="ast-52" class="other_trans">url_cn</span>)</span>&nbsp;=&nbsp;<span id="ast-53"><span id="ast-54"><span id="ast-55" class="other_trans">item</span>[<span id="ast-56"><span id="ast-57">'links'</span></span>]</span>[<span id="ast-58"><span id="ast-59">1</span></span>]</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-60"><span id="ast-61"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-62" class="other_trans">title_en</span>,&nbsp;<span id="ast-63" class="other_trans">url_en</span>)</span>&nbsp;=&nbsp;<span id="ast-64"><span id="ast-65"><span id="ast-66" class="other_trans">item</span>[<span id="ast-67"><span id="ast-68">'links'</span></span>]</span>[<span id="ast-69"><span id="ast-70">1</span></span>]</span></span><span id="ast-71"><span id="ast-72"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-73">title_cn</span>,&nbsp;<span id="ast-74">url_cn</span>)</span>&nbsp;=&nbsp;<span id="ast-75"><span id="ast-76"><span id="ast-77" class="other_trans">item</span>[<span id="ast-78"><span id="ast-79">'links'</span></span>]</span>[<span id="ast-80"><span id="ast-81">0</span></span>]</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-82"><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-84" class="other_trans">en</span>,&nbsp;<span id="ast-85" class="other_trans">cn</span>)</span>&nbsp;=&nbsp;<span id="ast-86"><span id="ast-87"><span id="ast-88">self</span>._filter_links</span>(<span id="ast-89"><span id="ast-90" class="other_trans">item</span>[<span id="ast-91"><span id="ast-92">'links'</span></span>]</span>)</span></span><span id="ast-93"><span id="ast-94"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-95" class="other_trans">title_en</span>,&nbsp;<span id="ast-96" class="other_trans">url_en</span>)</span>&nbsp;=&nbsp;<span id="ast-97" class="other_trans">en</span></span><span id="ast-98"><span id="ast-99"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-100" class="other_trans">title_cn</span>,&nbsp;<span id="ast-101" class="other_trans">url_cn</span>)</span>&nbsp;=&nbsp;<span id="ast-102" class="other_trans">cn</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;gen_packet(<span id="ast-2"><span id="ast-3">hue</span>,&nbsp;<span id="ast-4" class="other_trans">sat</span>,&nbsp;<span id="ast-5" class="other_trans">bri</span>,&nbsp;<span id="ast-6" class="other_trans">kel</span>,&nbsp;<span id="ast-7" class="other_trans">seq_num</span></span>):<span id="ast-8"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-9">(<span id="ast-11">(<span id="ast-12" class="other_trans">hue</span><span id="ast-13" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-14">0</span>)</span>&nbsp;or&nbsp;<span id="ast-15">(<span id="ast-16" class="other_trans">hue</span><span id="ast-17" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-18">360</span>)</span>)</span>:<span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-20"><span id="ast-21" class="other_trans">Exception</span>(<span id="ast-22">'Invalid&nbsp;hue:&nbsp;0-360'</span>)</span></span></span><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-24">(<span id="ast-26">(<span id="ast-27" class="other_trans">sat</span><span id="ast-28" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-29">0</span>)</span>&nbsp;or&nbsp;<span id="ast-30">(<span id="ast-31" class="other_trans">sat</span><span id="ast-32" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-33">100</span>)</span>)</span>:<span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-35"><span id="ast-36" class="other_trans">Exception</span>(<span id="ast-37">'Invalid&nbsp;sat:&nbsp;0-100'</span>)</span></span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-39">(<span id="ast-41">(<span id="ast-42" class="other_trans">bri</span><span id="ast-43" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-44">0</span>)</span>&nbsp;or&nbsp;<span id="ast-45">(<span id="ast-46" class="other_trans">bri</span><span id="ast-47" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-48">100</span>)</span>)</span>:<span id="ast-49"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-50"><span id="ast-51">Exception</span>(<span id="ast-52">'Invalid&nbsp;bri:&nbsp;0-100'</span>)</span></span></span><span id="ast-53"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-54">(<span id="ast-56">(<span id="ast-57" class="other_trans">kel</span><span id="ast-58" class="other_trans">&nbsp;&lt;&nbsp;</span><span id="ast-59">2500</span>)</span>&nbsp;or&nbsp;<span id="ast-60">(<span id="ast-61" class="ref_node">bri&nbsp;&rarr;&nbsp;kel&nbsp;</span><span id="ast-62" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-63">9000</span>)</span>)</span>:<span id="ast-64"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-65"><span id="ast-66">Exception</span>(<span id="ast-67">'Invalid&nbsp;kel:&nbsp;2500-9000'</span>)</span></span></span><span id="ast-68"><span id="ast-69" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>calc_hue</span>&nbsp;=&nbsp;<span id="ast-70">lambda&nbsp;<span id="ast-71"><span id="ast-72" class="other_trans">hue</span></span>:&nbsp;<span id="ast-73"><span id="ast-74" class="other_trans">int</span>(<span id="ast-75">(<span id="ast-76">(<span id="ast-77" class="other_trans">hue</span>&nbsp;/&nbsp;<span id="ast-79">360.0</span>)</span>&nbsp;*&nbsp;<span id="ast-81">65535</span>)</span>)</span></span></span><span id="ast-82"><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>calc_sat</span>&nbsp;=&nbsp;<span id="ast-84">lambda&nbsp;<span id="ast-85"><span id="ast-86" class="other_trans">sat</span></span>:&nbsp;<span id="ast-87"><span id="ast-88" class="other_trans">int</span>(<span id="ast-89">(<span id="ast-90">(<span id="ast-91" class="other_trans">sat</span>&nbsp;/&nbsp;<span id="ast-93">100.0</span>)</span>&nbsp;*&nbsp;<span id="ast-95">65535</span>)</span>)</span></span></span><span id="ast-96"><span id="ast-97"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>calc_bri</span>&nbsp;=&nbsp;<span id="ast-98">lambda&nbsp;<span id="ast-99"><span id="ast-100" class="other_trans">bri</span></span>:&nbsp;<span id="ast-101"><span id="ast-102">int</span>(<span id="ast-103">(<span id="ast-104">(<span id="ast-105" class="other_trans">bri</span>&nbsp;/&nbsp;<span id="ast-107">100.0</span>)</span>&nbsp;*&nbsp;<span id="ast-109">65535</span>)</span>)</span></span></span><span id="ast-110"><span id="ast-111" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;=&nbsp;<span id="ast-112">'1\\u0000\\u00004\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000'</span></span><span id="ast-113"><span id="ast-114" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-116"><span id="ast-117">pack</span>(<span id="ast-118">'&gt;B'</span>,&nbsp;<span id="ast-119">3</span>)</span></span><span id="ast-120"><span id="ast-121" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-123"><span id="ast-124">pack</span>(<span id="ast-125">'&lt;B'</span>,&nbsp;<span id="ast-126" class="other_trans">seq_num</span>)</span></span><span id="ast-127"><span id="ast-128" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-130">'\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000\\u0000f\\u0000\\u0000\\u0000\\u0000'</span></span><span id="ast-131"><span id="ast-132" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-134"><span id="ast-135">pack</span>(<span id="ast-136">'&lt;H'</span>,&nbsp;<span id="ast-137"><span id="ast-138" class="other_trans">calc_hue</span>(<span id="ast-139" class="other_trans">hue</span>)</span>)</span></span><span id="ast-140"><span id="ast-141"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-143"><span id="ast-144">pack</span>(<span id="ast-145">'&lt;H'</span>,&nbsp;<span id="ast-146"><span id="ast-147">calc_sat</span>(<span id="ast-148">sat</span>)</span>)</span></span><span id="ast-149"><span id="ast-150"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-152"><span id="ast-153">pack</span>(<span id="ast-154">'&lt;H'</span>,&nbsp;<span id="ast-155"><span id="ast-156">calc_bri</span>(<span id="ast-157" class="other_trans">bri</span>)</span>)</span></span><span id="ast-158"><span id="ast-159"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>packet</span>&nbsp;+=&nbsp;<span id="ast-161"><span id="ast-162">pack</span>(<span id="ast-163">'&lt;H'</span>,&nbsp;<span id="ast-164"><span id="ast-165">int</span>(<span id="ast-166" class="incorrect_node">kel&nbsp;&rarr;&nbsp;seq_num&nbsp;</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>while&nbsp;<span id="ast-5"><span id="ast-6" class="other_trans">len</span>(<span id="ast-7"><span id="ast-8">self</span>.connections</span>)</span>:<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-11" class="other_trans">conn</span>,&nbsp;<span id="ast-12" class="other_trans">expires</span>)</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16">self</span>.connections</span>.popleft</span>()</span></span><span id="ast-17"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-18">(<span id="ast-19" class="other_trans">expires</span><span id="ast-20" class="location_node">&nbsp;&gt;=&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;>&nbsp;</span><span id="ast-21"><span id="ast-22"><span id="ast-23" class="other_trans">time</span>.time</span>()</span>)</span>:<span id="ast-24"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-25" class="other_trans">conn</span></span></span></span><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-27" class="other_trans">None</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;pil_crop_rect(<span id="ast-2"><span id="ast-3" class="other_trans">rect_tup</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'&nbsp;x,&nbsp;y,&nbsp;w,&nbsp;h&nbsp;-&gt;&nbsp;x,&nbsp;y,&nbsp;x+w,&nbsp;x+h\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-8" class="other_trans">x</span>,&nbsp;<span id="ast-9" class="other_trans">y</span>,&nbsp;<span id="ast-10" class="other_trans">w</span>,&nbsp;<span id="ast-11" class="other_trans">h</span>)</span>&nbsp;=&nbsp;<span id="ast-12">[<span id="ast-13"><span id="ast-14" class="other_trans">int</span>(<span id="ast-15" class="other_trans">x</span>)</span><span id="ast-16">&nbsp;for&nbsp;<span id="ast-17" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-18" class="other_trans">rect_tup</span></span>]</span></span><span id="ast-19"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-20">(<span id="ast-21" class="other_trans">x</span>,&nbsp;<span id="ast-22" class="other_trans">y</span>,&nbsp;<span id="ast-23">(<span id="ast-24" class="other_trans">x</span>&nbsp;+&nbsp;<span id="ast-26" class="other_trans">w</span>)</span>,&nbsp;<span id="ast-27">(<span id="ast-28" class="correct_node">x&nbsp;&rarr;&nbsp;y&nbsp;</span>&nbsp;+&nbsp;<span id="ast-30" class="other_trans">h</span>)</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_filter_down(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">stop_at</span></span>):<span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-7">(<span id="ast-8">stop_at</span><span id="ast-9" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-10" class="other_trans">None</span>)</span>:<span id="ast-11"><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>stop_at</span>&nbsp;=&nbsp;<span id="ast-13"><span id="ast-14" class="other_trans">float</span>(<span id="ast-15">'inf'</span>)</span></span></span><span id="ast-16"><span id="ast-17" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>applied</span>&nbsp;=&nbsp;<span id="ast-18">[]</span></span><span id="ast-19"><span id="ast-20" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>to_execute</span>&nbsp;=&nbsp;<span id="ast-21">[]</span></span><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>scripts_in_directory</span>&nbsp;=&nbsp;<span id="ast-24">[]</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>already_applied</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31"><span id="ast-32"><span id="ast-33">Migration</span>.objects</span>.all</span>()</span>.order_by</span>(<span id="ast-34">'migration_label'</span>)</span></span><span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-36" class="other_trans">x</span>&nbsp;in&nbsp;<span id="ast-37" class="other_trans">already_applied</span>:<span id="ast-38"><span id="ast-39"><span id="ast-40"><span id="ast-41" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>applied</span>.append</span>(<span id="ast-42"><span id="ast-43" class="other_trans">x</span>.migration_label</span>)</span></span></span><span id="ast-44"><span id="ast-45" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>in_directory</span>&nbsp;=&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48">os</span>.listdir</span>(<span id="ast-49"><span id="ast-50">self</span>.path</span>)</span></span><span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>in_directory</span>.sort</span>()</span></span><span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>applied</span>.sort</span>()</span></span><span id="ast-59"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-60" class="other_trans">script</span>&nbsp;in&nbsp;<span id="ast-61" class="other_trans">in_directory</span>:<span id="ast-62"><span id="ast-63"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-64">name</span>,&nbsp;<span id="ast-65">ext</span>)</span>&nbsp;=&nbsp;<span id="ast-66"><span id="ast-67"><span id="ast-68"><span id="ast-69" class="other_trans">os</span>.path</span>.splitext</span>(<span id="ast-70" class="other_trans">script</span>)</span></span><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-72"><span id="ast-73"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>number</span>&nbsp;=&nbsp;<span id="ast-74"><span id="ast-75">int</span>(<span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans">name</span>.split</span>(<span id="ast-80">'_'</span>)</span>[<span id="ast-81"><span id="ast-82">0</span></span>]</span>)</span></span><span id="ast-83"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-84">ValueError</span>:<span id="ast-85"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-86"><span id="ast-87">MigrationError</span>(<span id="ast-88">'Invalid&nbsp;migration&nbsp;file&nbsp;prefix&nbsp;(must&nbsp;begin&nbsp;with&nbsp;a&nbsp;number)'</span>)</span></span></span></span><span id="ast-89"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-90">(<span id="ast-91">ext</span><span id="ast-92">&nbsp;in&nbsp;</span><span id="ast-93">[<span id="ast-94">'.sql'</span>,&nbsp;<span id="ast-95">'.py'</span>]</span>)</span>:<span id="ast-96"><span id="ast-97"><span id="ast-98"><span id="ast-99" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>scripts_in_directory</span>.append</span>(<span id="ast-100">(<span id="ast-101">number</span>,&nbsp;<span id="ast-102" class="other_trans">script</span>)</span>)</span></span></span></span><span id="ast-103"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-104">(<span id="ast-105">number</span>,&nbsp;<span id="ast-106" class="other_trans">script</span>)</span>&nbsp;in&nbsp;<span id="ast-107" class="other_trans">scripts_in_directory</span>:<span id="ast-108"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-109">(<span id="ast-111">(<span id="ast-112" class="other_trans">script</span><span id="ast-113">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-114" class="other_trans">applied</span>)</span>&nbsp;and&nbsp;<span id="ast-115">(<span id="ast-116">number</span><span id="ast-117" class="location_node">&nbsp;&lt;&nbsp;&nbsp;&rarr;&nbsp;<=,&nbsp;pred:&nbsp;>=&nbsp;</span><span id="ast-118" class="other_trans">stop_at</span>)</span>)</span>:<span id="ast-119"><span id="ast-120"><span id="ast-121"><span id="ast-122" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>to_execute</span>.append</span>(<span id="ast-123" class="other_trans">script</span>)</span></span></span></span><span id="ast-124"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-125">OSError</span>&nbsp;as&nbsp;<span id="ast-126" class="other_trans">e</span>:<span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>print&nbsp;<span id="ast-128"><span id="ast-129" class="other_trans">str</span>(<span id="ast-130" class="other_trans">e</span>)</span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_load_features(<span id="ast-2"><span id="ast-3">filename</span>,&nbsp;<span id="ast-4">imread_mode</span>,&nbsp;<span id="ast-6" class="other_trans">size</span>,&nbsp;**kwargs</span>):<span id="ast-8"><span id="ast-9"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'\\u000a&nbsp;&nbsp;&nbsp;&nbsp;Loads&nbsp;filename,&nbsp;optionally&nbsp;resizes&nbsp;it,&nbsp;and&nbsp;calls&nbsp;get_features.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;should&nbsp;be&nbsp;either&nbsp;None&nbsp;or&nbsp;a&nbsp;(width,&nbsp;height)&nbsp;tuple,&nbsp;where&nbsp;having&nbsp;one\\u000a&nbsp;&nbsp;&nbsp;&nbsp;element&nbsp;be&nbsp;None&nbsp;means&nbsp;that&nbsp;the&nbsp;relevant&nbsp;entry&nbsp;is&nbsp;chosen&nbsp;so&nbsp;as&nbsp;to&nbsp;maintain\\u000a&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;aspect&nbsp;ratio.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-10"><span id="ast-11"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-12">_</span>,&nbsp;<span id="ast-13" class="other_trans">imread</span>)</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15" class="other_trans">_find_working_imread</span>(<span id="ast-16" class="other_trans">imread_mode</span>)</span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>img</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20" class="other_trans">imread</span>(<span id="ast-21" class="other_trans">filename</span>)</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-23">(<span id="ast-25">(<span id="ast-26" class="other_trans">size</span><span id="ast-27" class="other_trans">&nbsp;is&nbsp;not&nbsp;</span><span id="ast-28">None</span>)</span>&nbsp;and&nbsp;<span id="ast-29">(<span id="ast-30" class="other_trans">size</span><span id="ast-31" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-32">(<span id="ast-33" class="other_trans">None</span>,&nbsp;<span id="ast-34" class="other_trans">None</span>)</span>)</span>)</span>:<span id="ast-35"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>import&nbsp;<span id="ast-36">skimage.transform</span></span><span id="ast-37"><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-39" class="other_trans">curr_x</span>,&nbsp;<span id="ast-40" class="other_trans">curr_y</span>)</span>&nbsp;=&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43">img</span>.shape</span>[<span id="ast-44">:<span id="ast-45">2</span></span>]</span></span><span id="ast-46"><span id="ast-47"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-48">new_y</span>,&nbsp;<span id="ast-49" class="other_trans">new_x</span>)</span>&nbsp;=&nbsp;<span id="ast-50">size</span></span><span id="ast-51"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-52">(<span id="ast-53">new_x</span><span id="ast-54" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-55">None</span>)</span>:<span id="ast-56"><span id="ast-57" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>newsize</span>&nbsp;=&nbsp;<span id="ast-58">(<span id="ast-59"><span id="ast-60" class="other_trans">int</span>(<span id="ast-61"><span id="ast-62"><span id="ast-63">np</span>.round</span>(<span id="ast-64">(<span id="ast-65">(<span id="ast-66" class="other_trans">curr_x</span>&nbsp;*&nbsp;<span id="ast-68" class="other_trans">new_y</span>)</span>&nbsp;/&nbsp;<span id="ast-70" class="other_trans">curr_y</span>)</span>)</span>)</span>,&nbsp;<span id="ast-71" class="other_trans">new_y</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>elif&nbsp;<span id="ast-73">(<span id="ast-74" class="other_trans">new_y</span><span id="ast-75" class="incorrect_node">&nbsp;is&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;not&nbsp;</span><span id="ast-76">None</span>)</span>:<span id="ast-77"><span id="ast-78" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>newsize</span>&nbsp;=&nbsp;<span id="ast-79">(<span id="ast-80">new_x</span>,&nbsp;<span id="ast-81"><span id="ast-82" class="other_trans">int</span>(<span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans">np</span>.round</span>(<span id="ast-86">(<span id="ast-87">(<span id="ast-88" class="other_trans">curr_y</span>&nbsp;*&nbsp;<span id="ast-90" class="other_trans">new_x</span>)</span>&nbsp;/&nbsp;<span id="ast-92" class="ref_node">curr_y&nbsp;&rarr;&nbsp;curr_x&nbsp;</span>)</span>)</span>)</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-93"><span id="ast-94" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>newsize</span>&nbsp;=&nbsp;<span id="ast-95">size</span></span></span><span id="ast-96"><span id="ast-97" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>img</span>&nbsp;=&nbsp;<span id="ast-98"><span id="ast-99"><span id="ast-100"><span id="ast-101">skimage</span>.transform</span>.resize</span>(<span id="ast-102" class="other_trans">img</span>,&nbsp;<span id="ast-103" class="other_trans">newsize</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;is_leaf(<span id="ast-2"><span id="ast-3" class="other_trans">node</span></span>):<span id="ast-4"><span id="ast-5"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Returns&nbsp;``True``&nbsp;if&nbsp;`node`&nbsp;has&nbsp;no&nbsp;element&nbsp;children.\\u000a&nbsp;&nbsp;&nbsp;&nbsp;'</span></span><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>child</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9" class="other_trans">next</span>(<span id="ast-10"><span id="ast-11" class="other_trans">iterchildren</span>(<span id="ast-12" class="other_trans">node</span>)</span>,&nbsp;<span id="ast-13" class="other_trans">None</span>)</span></span><span id="ast-14"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-15">(<span id="ast-16" class="other_trans">child</span><span id="ast-17" class="correct_node">&nbsp;is&nbsp;not&nbsp;&nbsp;&rarr;&nbsp;is&nbsp;</span><span id="ast-18" class="other_trans">None</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;send_message(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">job_json</span></span>):<span id="ast-5"><span id="ast-6" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>entries_too_long</span>&nbsp;=&nbsp;<span id="ast-7">(<span id="ast-8">(<span id="ast-9"><span id="ast-10" class="other_trans">len</span>(<span id="ast-11" class="correct_node">entries&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span>&nbsp;+&nbsp;<span id="ast-13">1</span>)</span><span id="ast-14" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-15"><span id="ast-16">self</span>.max_batch_len</span>)</span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>entries_too_large</span>&nbsp;=&nbsp;<span id="ast-19">(<span id="ast-20">(<span id="ast-21"><span id="ast-22" class="other_trans">len</span>(<span id="ast-23" class="other_trans">job_json</span>)</span>&nbsp;+&nbsp;<span id="ast-25"><span id="ast-26">self</span>.entries_size</span>)</span><span id="ast-27" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-28"><span id="ast-29">self</span>.max_batch_bytes</span>)</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;get_high_priority_jobs(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>jobs</span>&nbsp;=&nbsp;<span id="ast-6">[]</span></span><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-8" class="other_trans">job</span>&nbsp;in&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11" class="correct_node">all_jobs&nbsp;&rarr;&nbsp;self.&nbsp;</span>.values</span>()</span>:<span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-13">(<span id="ast-14"><span id="ast-15" class="other_trans">job</span>.priority</span><span id="ast-16" class="other_trans">&nbsp;&gt;&nbsp;</span><span id="ast-17">0</span>)</span>:<span id="ast-18"><span id="ast-19"><span id="ast-20"><span id="ast-21" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>jobs</span>.append</span>(<span id="ast-22" class="other_trans">job</span>)</span></span></span></span><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-24" class="other_trans">jobs</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;main(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5"><span id="ast-6" class="other_trans">hasattr</span>(<span id="ast-7">self</span>,&nbsp;<span id="ast-8">'server'</span>)</span>:<span id="ast-9"><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-11"><span id="ast-12">self</span>.host</span>,&nbsp;<span id="ast-13"><span id="ast-14">self</span>.path</span>)</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16"><span id="ast-17"><span id="ast-18">self</span>.server</span>.split</span>(<span id="ast-19">':'</span>,&nbsp;<span id="ast-20">1</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-21"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-22"><span id="ast-23" class="other_trans">fuse</span>.FuseError</span>,&nbsp;<span id="ast-24">'No&nbsp;server&nbsp;specified'</span></span></span><span id="ast-25"><span id="ast-26"><span id="ast-27"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.mcl</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">TCPMountClient</span>(<span id="ast-30"><span id="ast-31">self</span>.host</span>)</span></span><span id="ast-32"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>try:<span id="ast-33"><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-35" class="other_trans">status</span>,&nbsp;<span id="ast-36" class="other_trans">dirhandle</span>)</span>&nbsp;=&nbsp;<span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40">self</span>.mcl</span>.Mnt</span>(<span id="ast-41"><span id="ast-42">self</span>.path</span>)</span></span><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-44">(<span id="ast-45" class="other_trans">status</span><span id="ast-46" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-47" class="other_trans">NFS_OK</span>)</span>:<span id="ast-48"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-49"><span id="ast-50">NFSError</span>(<span id="ast-51" class="other_trans">status</span>)</span></span></span><span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>except&nbsp;<span id="ast-53">NFSError</span>&nbsp;as&nbsp;<span id="ast-54" class="other_trans">e</span>:<span id="ast-55"><span id="ast-56" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>no</span>&nbsp;=&nbsp;<span id="ast-57"><span id="ast-58"><span id="ast-59" class="other_trans">e</span>.errno</span>()</span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-61"><span id="ast-62" class="other_trans">IOError</span>(<span id="ast-63" class="other_trans">no</span>,&nbsp;<span id="ast-64"><span id="ast-65"><span id="ast-66" class="other_trans">os</span>.strerror</span>(<span id="ast-67" class="other_trans">no</span>)</span>,&nbsp;<span id="ast-68"><span id="ast-69">self</span>.path</span>)</span></span></span></span><span id="ast-70"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-71"><span id="ast-72" class="other_trans">hasattr</span>(<span id="ast-73">self</span>,&nbsp;<span id="ast-74">'hide'</span>)</span>:<span id="ast-75"><span id="ast-76"><span id="ast-77"><span id="ast-78"><span id="ast-79"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.mcl</span>.Umnt</span>(<span id="ast-80"><span id="ast-81">self</span>.path</span>)</span></span></span><span id="ast-82"><span id="ast-83"><span id="ast-84"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.rootdh</span>&nbsp;=&nbsp;<span id="ast-85" class="incorrect_node">dirhandle&nbsp;&rarr;&nbsp;status&nbsp;</span></span><span id="ast-86"><span id="ast-87"><span id="ast-88"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ncl</span>&nbsp;=&nbsp;<span id="ast-89"><span id="ast-90" class="other_trans">EvilNFSClient</span>(<span id="ast-91"><span id="ast-92">self</span>.host</span>)</span></span><span id="ast-93"><span id="ast-94"><span id="ast-95"><span id="ast-96"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ncl</span>.fuid</span>,&nbsp;<span id="ast-97"><span id="ast-98"><span id="ast-99">self</span>.ncl</span>.fgid</span>&nbsp;=&nbsp;<span id="ast-100">0</span></span><span id="ast-101"><span id="ast-102"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-103" class="other_trans">status</span>,&nbsp;<span id="ast-104" class="other_trans">fattr</span>)</span>&nbsp;=&nbsp;<span id="ast-105"><span id="ast-106"><span id="ast-107"><span id="ast-108">self</span>.ncl</span>.Getattr</span>(<span id="ast-109"><span id="ast-110">self</span>.rootdh</span>)</span></span><span id="ast-111"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-112">(<span id="ast-113" class="other_trans">status</span><span id="ast-114" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-115" class="other_trans">NFS_OK</span>)</span>:<span id="ast-116"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>raise&nbsp;<span id="ast-117"><span id="ast-118">NFSError</span>(<span id="ast-119" class="other_trans">status</span>)</span></span></span><span id="ast-120"><span id="ast-121"><span id="ast-122"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.rootattr</span>&nbsp;=&nbsp;<span id="ast-123" class="other_trans">fattr</span></span><span id="ast-124"><span id="ast-125"><span id="ast-126"><span id="ast-127"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ncl</span>.fuid</span>&nbsp;=&nbsp;<span id="ast-128"><span id="ast-129"><span id="ast-130">self</span>.rootattr</span>[<span id="ast-131"><span id="ast-132">3</span></span>]</span></span><span id="ast-133"><span id="ast-134"><span id="ast-135"><span id="ast-136"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ncl</span>.fgid</span>&nbsp;=&nbsp;<span id="ast-137"><span id="ast-138"><span id="ast-139">self</span>.rootattr</span>[<span id="ast-140"><span id="ast-141">4</span></span>]</span></span><span id="ast-142"><span id="ast-143"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-144" class="other_trans">status</span>,&nbsp;<span id="ast-145" class="other_trans">rest</span>)</span>&nbsp;=&nbsp;<span id="ast-146"><span id="ast-147"><span id="ast-148"><span id="ast-149">self</span>.ncl</span>.Statfs</span>(<span id="ast-150"><span id="ast-151">self</span>.rootdh</span>)</span></span><span id="ast-152"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-153">(<span id="ast-154" class="other_trans">status</span><span id="ast-155" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-156">NFS_OK</span>)</span>:<span id="ast-157"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-158">(<span id="ast-159">-</span><span id="ast-160" class="other_trans">ENOSYS</span>)</span></span></span><span id="ast-161"><span id="ast-162"><span id="ast-163"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tsize</span>&nbsp;=&nbsp;<span id="ast-164"><span id="ast-165" class="other_trans">rest</span>[<span id="ast-166"><span id="ast-167">0</span></span>]</span></span><span id="ast-168"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-169">(<span id="ast-170">not</span>&nbsp;<span id="ast-171"><span id="ast-172">self</span>.tsize</span>)</span>:<span id="ast-173"><span id="ast-174"><span id="ast-175"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.tsize</span>&nbsp;=&nbsp;<span id="ast-176">4096</span></span></span><span id="ast-177"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-178"><span id="ast-179">hasattr</span>(<span id="ast-180">self</span>,&nbsp;<span id="ast-181">'cache'</span>)</span>:<span id="ast-182"><span id="ast-183"><span id="ast-184"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.handles</span>&nbsp;=&nbsp;<span id="ast-185"><span id="ast-186" class="other_trans">LRU</span>(<span id="ast-187" class="ref_node">cache&nbsp;&rarr;&nbsp;self.&nbsp;</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-188"><span id="ast-189"><span id="ast-190"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.handles</span>&nbsp;=&nbsp;<span id="ast-191"><span id="ast-192" class="other_trans">LRU</span>(<span id="ast-193">100</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;motors(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">bot_angle</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Used&nbsp;to&nbsp;update&nbsp;the&nbsp;motors&nbsp;speed&nbsp;and&nbsp;angular&nbsp;motion.'</span></span><span id="ast-7"><span id="ast-8" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>std_angle</span>&nbsp;=&nbsp;<span id="ast-9">7</span></span><span id="ast-10"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-11">(<span id="ast-12" class="other_trans">bot_angle</span><span id="ast-13" class="ref_node">&nbsp;&gt;&nbsp;&nbsp;&rarr;&nbsp;<&nbsp;</span><span id="ast-14" class="other_trans">std_angle</span>)</span>:<span id="ast-15"><span id="ast-16" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>translate_angle</span>&nbsp;=&nbsp;<span id="ast-17"><span id="ast-18">self</span>.strafe_error</span></span><span id="ast-19"><span id="ast-20"><span id="ast-21"><span id="ast-22"><span id="ast-23"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.driver</span>.move</span>(<span id="ast-24" class="incorrect_node">translate_speed&nbsp;&rarr;&nbsp;self.&nbsp;</span>,&nbsp;<span id="ast-25" class="other_trans">translate_angle</span>)</span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-26"><span id="ast-27" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>rotate_speed</span>&nbsp;=&nbsp;<span id="ast-28"><span id="ast-29" class="other_trans">max</span>(<span id="ast-30">-100</span>,&nbsp;<span id="ast-31"><span id="ast-32" class="other_trans">min</span>(<span id="ast-33">100</span>,&nbsp;<span id="ast-34"><span id="ast-35">self</span>.rotate_error</span>)</span>)</span></span><span id="ast-36"><span id="ast-37"><span id="ast-38"><span id="ast-39"><span id="ast-40"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.driver</span>.rotate</span>(<span id="ast-41" class="other_trans">rotate_speed</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;check_reqs_latest_version(<span id="ast-2"><span id="ast-3">check_path</span>,&nbsp;<span id="ast-4">installed_pkgs</span></span>):<span id="ast-6"><span id="ast-7"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>'Check&nbsp;requirements&nbsp;latest&nbsp;version.'</span></span><span id="ast-8"><span id="ast-9"><span id="ast-10"><span id="ast-11" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.info</span>(<span id="ast-12">'Starting&nbsp;check&nbsp;requirements&nbsp;latest&nbsp;version&nbsp;...'</span>)</span></span><span id="ast-13"><span id="ast-14" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>files</span>&nbsp;=&nbsp;<span id="ast-15"><span id="ast-16" class="other_trans">list</span>()</span></span><span id="ast-17"><span id="ast-18" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>reqs</span>&nbsp;=&nbsp;<span id="ast-19"><span id="ast-20">dict</span>()</span></span><span id="ast-21"><span id="ast-22" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>pkg_versions</span>&nbsp;=&nbsp;<span id="ast-23"><span id="ast-24" class="other_trans">list</span>()</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26"><span id="ast-27"><span id="ast-28"><span id="ast-29">os</span>.path</span>.isdir</span>(<span id="ast-30" class="other_trans">check_path</span>)</span>:<span id="ast-31"><span id="ast-32"><span id="ast-33"><span id="ast-34"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.info</span>(<span id="ast-35"><span id="ast-36"><span id="ast-37">'Search&nbsp;*requirements.txt&nbsp;in&nbsp;"{0}"&nbsp;...'</span>.format</span>(<span id="ast-38" class="other_trans">check_path</span>)</span>)</span></span><span id="ast-39"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-40" class="other_trans">fn</span>&nbsp;in&nbsp;<span id="ast-41"><span id="ast-42"><span id="ast-43">os</span>.listdir</span>(<span id="ast-44" class="other_trans">check_path</span>)</span>:<span id="ast-45"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-46"><span id="ast-47"><span id="ast-48">fnmatch</span>.fnmatch</span>(<span id="ast-49" class="other_trans">fn</span>,&nbsp;<span id="ast-50">'*requirements.txt'</span>)</span>:<span id="ast-51"><span id="ast-52"><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>files</span>.append</span>(<span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58">os</span>.path</span>.abspath</span>(<span id="ast-59" class="other_trans">fn</span>)</span>)</span></span></span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62">not</span>&nbsp;<span id="ast-63" class="ref_node">reqs&nbsp;&rarr;&nbsp;files&nbsp;</span>)</span>:<span id="ast-64"><span id="ast-65"><span id="ast-66"><span id="ast-67" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>logger</span>.warning</span>(<span id="ast-68">'Requirements&nbsp;file&nbsp;not&nbsp;found,&nbsp;generate&nbsp;requirements&nbsp;...'</span>)</span></span><span id="ast-69"><span id="ast-70" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>save_path</span>&nbsp;=&nbsp;<span id="ast-71"><span id="ast-72"><span id="ast-73"><span id="ast-74" class="other_trans">os</span>.path</span>.join</span>(<span id="ast-75" class="other_trans">check_path</span>,&nbsp;<span id="ast-76">'requirements.txt'</span>)</span></span><span id="ast-77"><span id="ast-78"><span id="ast-79" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>generate_reqs</span>(<span id="ast-80" class="other_trans">save_path</span>,&nbsp;<span id="ast-81" class="other_trans">check_path</span>)</span></span><span id="ast-82"><span id="ast-83"><span id="ast-84"><span id="ast-85" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>files</span>.append</span>(<span id="ast-86" class="other_trans">save_path</span>)</span></span></span><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>else:<span id="ast-87"><span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>files</span>.append</span>(<span id="ast-91" class="incorrect_node">check_path&nbsp;&rarr;&nbsp;save_path&nbsp;</span>)</span></span></span><span id="ast-92"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-93" class="other_trans">fpath</span>&nbsp;in&nbsp;<span id="ast-94" class="other_trans">files</span>:<span id="ast-95"><span id="ast-96"><span id="ast-97"><span id="ast-98" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>reqs</span>.update</span>(<span id="ast-99"><span id="ast-100" class="other_trans">parse_reqs</span>(<span id="ast-101" class="other_trans">fpath</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;to_json(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-5">(<span id="ast-6"><span id="ast-7"><span id="ast-8"><span id="ast-9">self</span>._doc</span>.get</span>(<span id="ast-10"><span id="ast-11">self</span>._doc_type_attr</span>)</span><span id="ast-12" class="other_trans">&nbsp;is&nbsp;</span><span id="ast-13" class="other_trans">None</span>)</span>:<span id="ast-14"><span id="ast-15" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>doc_type</span>&nbsp;=&nbsp;<span id="ast-16"><span id="ast-17" class="other_trans">getattr</span>(<span id="ast-18">self</span>,&nbsp;<span id="ast-19">'_doc_type'</span>,&nbsp;<span id="ast-20"><span id="ast-21"><span id="ast-22">self</span>.__class__</span>.__name__</span>)</span></span><span id="ast-23"><span id="ast-24"><span id="ast-25"><span id="ast-26"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>._doc</span>[<span id="ast-27"><span id="ast-28" class="correct_node">_doc_type_attr&nbsp;&rarr;&nbsp;self.&nbsp;</span></span>]</span>&nbsp;=&nbsp;<span id="ast-29" class="other_trans">doc_type</span></span></span><span id="ast-30"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-31"><span id="ast-32">self</span>._doc</span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_update_self_made_marks(<span id="ast-2"><span id="ast-3">self</span></span>):<span id="ast-4"><span id="ast-5"><span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>LOG</span>.debug</span>(<span id="ast-8">'Update&nbsp;self-made&nbsp;marks'</span>)</span></span><span id="ast-9"><span id="ast-10" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>patch_id_to_user_id</span>&nbsp;=&nbsp;<span id="ast-11">{}</span></span><span id="ast-12"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-13" class="other_trans">record</span>&nbsp;in&nbsp;<span id="ast-14"><span id="ast-15"><span id="ast-16"><span id="ast-17">self</span>.runtime_storage_inst</span>.get_all_records</span>()</span>:<span id="ast-18"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-19">(<span id="ast-20"><span id="ast-21" class="other_trans">record</span>[<span id="ast-22"><span id="ast-23">'record_type'</span></span>]</span><span id="ast-24" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-25">'patch'</span>)</span>:<span id="ast-26"><span id="ast-27"><span id="ast-28" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>patch_id_to_user_id</span>[<span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans">record</span>[<span id="ast-32"><span id="ast-33">'primary_key'</span></span>]</span></span>]</span>&nbsp;=&nbsp;<span id="ast-34"><span id="ast-35" class="other_trans">record</span>[<span id="ast-36"><span id="ast-37">'user_id'</span></span>]</span></span></span></span><span id="ast-38"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>for&nbsp;<span id="ast-39" class="other_trans">record</span>&nbsp;in&nbsp;<span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43">self</span>.runtime_storage_inst</span>.get_all_records</span>()</span>:<span id="ast-44"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-45">(<span id="ast-46"><span id="ast-47" class="other_trans">record</span>[<span id="ast-48"><span id="ast-49">'record_type'</span></span>]</span><span id="ast-50" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-51">'mark'</span>)</span>:<span id="ast-52"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>continue</span></span><span id="ast-53"><span id="ast-54" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>patch_id</span>&nbsp;=&nbsp;<span id="ast-55"><span id="ast-56"><span id="ast-57" class="other_trans">utils</span>.get_patch_id</span>(<span id="ast-58"><span id="ast-59" class="other_trans">record</span>[<span id="ast-60"><span id="ast-61">'review_id'</span></span>]</span>,&nbsp;<span id="ast-62"><span id="ast-63" class="other_trans">record</span>[<span id="ast-64"><span id="ast-65">'patch'</span></span>]</span>)</span></span><span id="ast-66"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-67">(<span id="ast-68"><span id="ast-69" class="other_trans">record</span>[<span id="ast-70"><span id="ast-71">'user_id'</span></span>]</span><span id="ast-72" class="other_trans">&nbsp;==&nbsp;</span><span id="ast-73"><span id="ast-74"><span id="ast-75" class="other_trans">patch_id_to_user_id</span>.get</span>(<span id="ast-76" class="other_trans">patch_id</span>)</span>)</span>:<span id="ast-77"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-78">(<span id="ast-79"><span id="ast-80"><span id="ast-81" class="other_trans">record</span>[<span id="ast-82"><span id="ast-83">'type'</span></span>]</span>[<span id="ast-84">:<span id="ast-85">5</span></span>]</span><span id="ast-86" class="ref_node">&nbsp;==&nbsp;&nbsp;&rarr;&nbsp;!=&nbsp;</span><span id="ast-87">'Self-'</span>)</span>:<span id="ast-88"><span id="ast-89"><span id="ast-90" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>record</span>[<span id="ast-91"><span id="ast-92">'type'</span></span>]</span>&nbsp;=&nbsp;<span id="ast-93">(<span id="ast-94">'Self-%s'</span>&nbsp;%&nbsp;<span id="ast-96"><span id="ast-97" class="other_trans">record</span>[<span id="ast-98"><span id="ast-99">'type'</span></span>]</span>)</span></span><span id="ast-100"><span id="ast-101"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>yield&nbsp;<span id="ast-102" class="other_trans">record</span></span></span></span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;_check_node_boot_configuration(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">node</span></span>):<span id="ast-5"><span id="ast-6"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>(<span id="ast-7" class="other_trans">kernel_id</span>,&nbsp;<span id="ast-8" class="other_trans">ramdisk_id</span>)</span>&nbsp;=&nbsp;<span id="ast-9"><span id="ast-10"><span id="ast-11">self</span>._image_ids</span>()</span></span><span id="ast-12"><span id="ast-13"><span id="ast-14"><span id="ast-15"><span id="ast-16"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.debug</span>(<span id="ast-17"><span id="ast-18"><span id="ast-19">'Doing&nbsp;boot&nbsp;checks&nbsp;for&nbsp;{}'</span>.format</span>(<span id="ast-20"><span id="ast-21" class="other_trans">node</span>.uuid</span>)</span>)</span></span><span id="ast-22"><span id="ast-23" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>message</span>&nbsp;=&nbsp;<span id="ast-24">'Node&nbsp;uuid={uuid}&nbsp;has&nbsp;an&nbsp;incorrectly&nbsp;configured&nbsp;{property}.&nbsp;Expected&nbsp;"{expected}"&nbsp;but&nbsp;got&nbsp;"{actual}".'</span></span><span id="ast-25"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-26">(<span id="ast-27"><span id="ast-28"><span id="ast-29"><span id="ast-30" class="other_trans">node</span>.driver_info</span>.get</span>(<span id="ast-31">'deploy_ramdisk'</span>)</span><span id="ast-32" class="incorrect_node">&nbsp;!=&nbsp;&nbsp;&rarr;&nbsp;==&nbsp;</span><span id="ast-33" class="other_trans">ramdisk_id</span>)</span>:<span id="ast-34"><span id="ast-35"><span id="ast-36"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.predeploy_errors</span>&nbsp;+=&nbsp;<span id="ast-38">1</span></span><span id="ast-39"><span id="ast-40"><span id="ast-41"><span id="ast-42"><span id="ast-43"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.error</span>(<span id="ast-44"><span id="ast-45"><span id="ast-46" class="other_trans">message</span>.format</span>(uuid=<span id="ast-48"><span id="ast-49" class="other_trans">node</span>.uuid</span>,&nbsp;property=<span id="ast-51">'driver_info/deploy_ramdisk'</span>,&nbsp;expected=<span id="ast-53" class="other_trans">ramdisk_id</span>,&nbsp;actual=<span id="ast-55"><span id="ast-56"><span id="ast-57"><span id="ast-58" class="other_trans">node</span>.driver_info</span>.get</span>(<span id="ast-59">'deploy_ramdisk'</span>)</span>)</span>)</span></span></span><span id="ast-60"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-61">(<span id="ast-62"><span id="ast-63"><span id="ast-64"><span id="ast-65" class="other_trans">node</span>.driver_info</span>.get</span>(<span id="ast-66">'deploy_kernel'</span>)</span><span id="ast-67" class="other_trans">&nbsp;!=&nbsp;</span><span id="ast-68" class="other_trans">kernel_id</span>)</span>:<span id="ast-69"><span id="ast-70"><span id="ast-71"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.predeploy_errors</span>&nbsp;+=&nbsp;<span id="ast-73">1</span></span><span id="ast-74"><span id="ast-75"><span id="ast-76"><span id="ast-77"><span id="ast-78"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.error</span>(<span id="ast-79"><span id="ast-80"><span id="ast-81" class="other_trans">message</span>.format</span>(uuid=<span id="ast-83"><span id="ast-84" class="other_trans">node</span>.uuid</span>,&nbsp;property=<span id="ast-86">'driver_info/deploy_kernel'</span>,&nbsp;expected=<span id="ast-88" class="ref_node">ramdisk_id&nbsp;&rarr;&nbsp;kernel_id&nbsp;</span>,&nbsp;actual=<span id="ast-90"><span id="ast-91"><span id="ast-92"><span id="ast-93" class="other_trans">node</span>.driver_info</span>.get</span>(<span id="ast-94">'deploy_kernel'</span>)</span>)</span>)</span></span></span><span id="ast-95"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>if&nbsp;<span id="ast-96">(<span id="ast-97">'boot_option:local'</span><span id="ast-98">&nbsp;not&nbsp;in&nbsp;</span><span id="ast-99"><span id="ast-100"><span id="ast-101"><span id="ast-102" class="other_trans">node</span>.properties</span>.get</span>(<span id="ast-103">'capabilities'</span>,&nbsp;<span id="ast-104">''</span>)</span>)</span>:<span id="ast-105"><span id="ast-106"><span id="ast-107"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.predeploy_warnings</span>&nbsp;+=&nbsp;<span id="ast-109">1</span></span><span id="ast-110"><span id="ast-111"><span id="ast-112"><span id="ast-113"><span id="ast-114"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.log</span>.warning</span>(<span id="ast-115"><span id="ast-116"><span id="ast-117" class="other_trans">message</span>.format</span>(uuid=<span id="ast-119"><span id="ast-120" class="other_trans">node</span>.uuid</span>,&nbsp;property=<span id="ast-122">'properties/capabilities'</span>,&nbsp;expected=<span id="ast-124">'boot_option:local'</span>,&nbsp;actual=<span id="ast-126"><span id="ast-127"><span id="ast-128"><span id="ast-129" class="other_trans">node</span>.properties</span>.get</span>(<span id="ast-130">'capabilities'</span>)</span>)</span>)</span></span></span></span></span></span><br /><br /><hr />
<span id="ast" class="ast"><span id="ast-0"><span id="ast-1">def&nbsp;put(<span id="ast-2"><span id="ast-3">self</span>,&nbsp;<span id="ast-4" class="other_trans">path</span>,&nbsp;<span id="ast-5" class="other_trans">bytes</span></span>):<span id="ast-6"><span id="ast-7" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>file_abspath</span>&nbsp;=&nbsp;<span id="ast-8"><span id="ast-9"><span id="ast-10">self</span>.normalize_path</span>(<span id="ast-11" class="other_trans">path</span>)</span></span><span id="ast-12"><span id="ast-13" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>file_dir_abspath</span>&nbsp;=&nbsp;<span id="ast-14"><span id="ast-15" class="other_trans">dirname</span>(<span id="ast-16" class="other_trans">file_abspath</span>)</span></span><span id="ast-17"><span id="ast-18"><span id="ast-19"><span id="ast-20"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>self</span>.ensure_dir</span>(<span id="ast-21" class="other_trans">file_dir_abspath</span>)</span></span><span id="ast-22"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>with&nbsp;<span id="ast-23"><span id="ast-24" class="other_trans">open</span>(<span id="ast-25" class="incorrect_node">file_abspath&nbsp;&rarr;&nbsp;file_dir_abspath&nbsp;</span>,&nbsp;<span id="ast-26">'w'</span>)</span>&nbsp;as&nbsp;<span id="ast-27" class="other_trans">_file</span>:<span id="ast-28"><span id="ast-29"><span id="ast-30"><span id="ast-31" class="other_trans"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>_file</span>.write</span>(<span id="ast-32" class="other_trans">bytes</span>)</span></span></span><span id="ast-33"><span class="whitespace"><br />
&nbsp;&nbsp;&nbsp;&nbsp;</span>return&nbsp;<span id="ast-34" class="ref_node">file_abspath&nbsp;&rarr;&nbsp;path&nbsp;</span></span></span></span></span><br /><br /><hr />
</body></html>
